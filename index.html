<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플랜비 - 은퇴설계 커뮤니티</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Meta Tags for SEO -->
    <meta name="description" content="은퇴생활비 계산기와 커뮤니티 플랫폼. 같은 고민을 가진 사람들과 소통하세요.">
    <meta name="keywords" content="은퇴생활비, 재무설계, 커뮤니티, 은퇴계획, 플랜비">
    <meta name="author" content="플랜비">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">
    
    <!-- 플랜비 전용 스타일 -->
    <style>
        /* 기본 폰트 및 배경 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            font-size: 18px;
            line-height: 1.6;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        /* 카드 스타일 (원본 그대로) */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 16px;
        }

        /* 버튼 스타일들 (원본 그대로) */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 인풋 스타일 개선 */
        input[type="text"], 
        input[type="number"], 
        select, 
        textarea {
            transition: all 0.2s;
        }

        input[type="text"]:focus, 
        input[type="number"]:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 체크박스 스타일 개선 */
        input[type="checkbox"] {
            accent-color: #3b82f6;
            /* transform: scale(1.2); 클릭 문제로 임시 제거 */
        }
        
        /* 전문가 등록 체크박스 강제 스타일 */
        .expert-checkbox {
            pointer-events: auto !important;
            position: relative !important;
            z-index: 999 !important;
        }

        /* 호버 효과 */
        .hover-lift {
            transition: transform 0.2s;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
        }

        /* 반응형 조정 */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            
            .card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .btn-primary {
                padding: 14px 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
                border-radius: 12px;
            }
            
            .btn-primary {
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        /* 한글 줄바뀜 방지 */
        .no-break-korean {
            word-break: keep-all;
            white-space: nowrap;
        }

        .break-keep {
            word-break: keep-all;
        }

        /* 모바일에서 텍스트 자동 크기 조정 */
        .responsive-text {
            font-size: clamp(0.75rem, 3vw, 1rem);
        }

        .responsive-text-sm {
            font-size: clamp(0.65rem, 2.5vw, 0.875rem);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // 이메일 알림 시스템
        const sendExpertNotification = async (expert, action, reason = '') => {
            try {
                // 실제 서비스에서는 이메일 서비스 연동 필요 (예: Supabase Edge Functions)
                const emailData = {
                    to: expert.email,
                    subject: action === 'approve' ? 
                        '[플랜비] 전문가 승인 완료 🎉' : 
                        '[플랜비] 전문가 신청 검토 결과',
                    html: action === 'approve' ? 
                        `<h2>🎉 전문가 승인이 완료되었습니다!</h2>
                         <p>안녕하세요 ${expert.nickname}님,</p>
                         <p>플랜비 전문가 신청이 <strong>승인</strong>되었습니다.</p>
                         <p><strong>승인 사유:</strong> ${reason || '전문가 자격 요건을 충족합니다.'}</p>
                         <p>이제 플랜비에서 전문가로 활동하실 수 있습니다!</p>
                         <p><a href="https://jwpaparoy.github.io/planB/" style="background-color: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">플랜비 바로가기</a></p>
                         <p>감사합니다.<br/>플랜비 운영팀</p>` :
                        `<h2>전문가 신청 검토 결과</h2>
                         <p>안녕하세요 ${expert.nickname}님,</p>
                         <p>플랜비 전문가 신청을 검토한 결과를 안내드립니다.</p>
                         <p><strong>검토 결과:</strong> 승인 보류</p>
                         <p><strong>사유:</strong> ${reason || '자격 요건 미달'}</p>
                         <p>추가 자격증이나 경력을 보완하신 후 다시 신청해주세요.</p>
                         <p>감사합니다.<br/>플랜비 운영팀</p>`
                };
                
                console.log('이메일 발송 예정:', emailData);
                
                // TODO: 실제 이메일 발송 구현
                // const { data, error } = await supabase.functions.invoke('send-email', { body: emailData });
                
                return { success: true, message: '알림 이메일이 발송되었습니다.' };
            } catch (error) {
                console.error('이메일 발송 오류:', error);
                return { success: false, message: '이메일 발송에 실패했습니다.' };
            }
        };

        // AmountInput 컴포넌트 (외부에서 정의하여 재생성 방지)
        const AmountInput = ({ label, value, onChange, placeholder }) => {
            const formatAmount = (value) => {
                if (!value || value === '' || value === '0') return '💰 0원';
                const num = parseInt(value);
                if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                return `💰 ${num.toLocaleString()}만원`;
            };

            return (
                <div className="mb-6">
                    <label className="block text-xl font-semibold text-gray-800 mb-3">{label}</label>
                    <input
                        type="text"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        value={value}
                        onChange={(e) => {
                            const numValue = e.target.value.replace(/[^0-9]/g, '');
                            onChange(numValue);
                        }}
                        className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                        placeholder={placeholder}
                        autoComplete="off"
                    />
                    <div className="text-green-600 font-semibold text-lg mt-1">
                        {formatAmount(value)}
                    </div>
                </div>
            );
        };

        // Supabase 설정 (플랜비 전용)
        const supabaseUrl = 'https://iopidkmpoxcctixchkmv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvcGlka21wb3hjY3RpeGNoa212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTY0MDIsImV4cCI6MjA3MTIzMjQwMn0.M_bvNzXqPFxmyj4n5xGi3L_eV5yP_8ex-5z8rhjltrQ';
        const supabase = window.supabase?.createClient ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;

        // 익명 세션 관리 시스템
        class AnonymousSessionManager {
            constructor() {
                this.currentSession = null;
                this.tokenKey = 'planb_session_token';
            }

            // 보안 토큰 생성
            generateSecureToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // 계산 결과 해시 생성 (조작 방지)
            async hashCalculationResult(result) {
                const dataString = JSON.stringify({
                    monthlyLivingCost: result.monthlyLivingCost,
                    totalAssets: result.totalAssets,
                    assetSufficiencyYears: result.assetSufficiencyYears,
                    housingType: result.housingType
                });
                
                const encoder = new TextEncoder();
                const data = encoder.encode(dataString);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // 그룹 자동 배정
            assignGroup(calculationResult) {
                const monthlyBudget = calculationResult.monthlyLivingCost;
                const assetYears = calculationResult.assetSufficiencyYears;
                
                // 복합 지표로 은밀하게 분류
                if (monthlyBudget < 200 || assetYears < 15) return 'prudent';
                if (monthlyBudget < 400 || assetYears < 25) return 'balanced';
                return 'premium';
            }

            // 익명 닉네임 생성
            generateNickname(group) {
                const groupNames = {
                    'prudent': '알뜰라이프',
                    'balanced': '밸런스라이프', 
                    'premium': '프리미엄라이프'
                };
                const randomNum = Math.floor(Math.random() * 999) + 1;
                return `${groupNames[group]}${randomNum.toString().padStart(3, '0')}`;
            }

            // 계산 완료시 익명 세션 생성
            async createSession(calculationResult) {
                try {
                    const sessionToken = this.generateSecureToken();
                    const calculationHash = await this.hashCalculationResult(calculationResult);
                    const assignedGroup = this.assignGroup(calculationResult);
                    const nickname = this.generateNickname(assignedGroup);

                    const sessionData = {
                        session_token: sessionToken,
                        calculation_hash: calculationHash,
                        assigned_group: assignedGroup,
                        nickname: nickname,
                        monthly_budget: calculationResult.monthlyLivingCost,
                        asset_years: calculationResult.assetSufficiencyYears,
                        housing_type: calculationResult.housingType,
                        created_at: new Date().toISOString(),
                        expires_at: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString(),
                        last_active: new Date().toISOString(),
                        community_posts_count: 0
                    };

                    if (supabase) {
                        // 서버에 익명 세션 저장
                        const { data, error } = await supabase
                            .from('anonymous_sessions')
                            .insert([sessionData])
                            .select();

                        if (error) throw error;
                        
                        // 로컬에는 토큰만 저장
                        localStorage.setItem(this.tokenKey, sessionToken);
                        this.currentSession = data[0];
                        
                        console.log(`익명 세션 생성: ${nickname} (${assignedGroup} 그룹)`);
                        return this.currentSession;
                    } else {
                        // 오프라인 모드: localStorage에 전체 데이터 저장
                        const fallbackSession = { ...sessionData, id: Date.now() };
                        localStorage.setItem(this.tokenKey, sessionToken);
                        localStorage.setItem(`planb_session_${sessionToken}`, JSON.stringify(fallbackSession));
                        this.currentSession = fallbackSession;
                        return this.currentSession;
                    }
                } catch (error) {
                    console.error('세션 생성 실패:', error);
                    // 로컬 폴백
                    return this.createLocalFallbackSession(calculationResult);
                }
            }

            // 세션 복구
            async restoreSession() {
                try {
                    const token = localStorage.getItem(this.tokenKey);
                    if (!token) return null;

                    if (supabase) {
                        // 서버에서 세션 조회
                        const { data, error } = await supabase
                            .from('anonymous_sessions')
                            .select('*')
                            .eq('session_token', token)
                            .single();

                        if (error) {
                            if (error.code === 'PGRST116') { // 세션 없음
                                localStorage.removeItem(this.tokenKey);
                                return null;
                            }
                            throw error;
                        }

                        // 만료 확인
                        if (new Date(data.expires_at) < new Date()) {
                            await this.deleteSession(token);
                            return null;
                        }

                        // 마지막 활동 시간 업데이트
                        await supabase
                            .from('anonymous_sessions')
                            .update({ last_active: new Date().toISOString() })
                            .eq('session_token', token);

                        this.currentSession = data;
                        console.log(`세션 복구: ${data.nickname} (${data.assigned_group} 그룹)`);
                        return this.currentSession;
                    } else {
                        // 오프라인 모드: localStorage에서 복구
                        const sessionData = localStorage.getItem(`planb_session_${token}`);
                        if (sessionData) {
                            this.currentSession = JSON.parse(sessionData);
                            return this.currentSession;
                        }
                        return null;
                    }
                } catch (error) {
                    console.error('세션 복구 실패:', error);
                    return this.getLocalFallbackSession();
                }
            }

            // 세션 연장
            async extendSession() {
                if (!this.currentSession) return;

                try {
                    const newExpiryDate = new Date(Date.now() + (30 * 24 * 60 * 60 * 1000));
                    
                    if (supabase) {
                        await supabase
                            .from('anonymous_sessions')
                            .update({ 
                                expires_at: newExpiryDate.toISOString(),
                                last_active: new Date().toISOString()
                            })
                            .eq('session_token', this.currentSession.session_token);
                    }
                    
                    this.currentSession.expires_at = newExpiryDate.toISOString();
                    console.log('세션 30일 연장됨');
                } catch (error) {
                    console.error('세션 연장 실패:', error);
                }
            }

            // 커뮤니티 활동 기록
            async recordCommunityActivity(activityType = 'general') {
                if (!this.currentSession) return;

                try {
                    if (supabase) {
                        const updates = { 
                            last_active: new Date().toISOString()
                        };

                        if (activityType === 'post') {
                            updates.community_posts_count = (this.currentSession.community_posts_count || 0) + 1;
                        }

                        await supabase
                            .from('anonymous_sessions')
                            .update(updates)
                            .eq('session_token', this.currentSession.session_token);

                        this.currentSession = { ...this.currentSession, ...updates };
                    }
                } catch (error) {
                    console.error('활동 기록 실패:', error);
                }
            }

            // 세션 삭제
            async deleteSession(token = null) {
                const targetToken = token || this.currentSession?.session_token;
                if (!targetToken) return;

                try {
                    if (supabase) {
                        await supabase
                            .from('anonymous_sessions')
                            .delete()
                            .eq('session_token', targetToken);
                    }
                    
                    localStorage.removeItem(this.tokenKey);
                    localStorage.removeItem(`planb_session_${targetToken}`);
                    this.currentSession = null;
                } catch (error) {
                    console.error('세션 삭제 실패:', error);
                }
            }

            // 커뮤니티 접근 권한 확인
            checkCommunityAccess() {
                if (!this.currentSession) {
                    return {
                        hasAccess: false,
                        message: "은퇴생활비 계산을 완료하시면 커뮤니티를 이용하실 수 있습니다",
                        action: "redirect_to_calculator"
                    };
                }

                // 세션 만료 확인
                if (new Date(this.currentSession.expires_at) < new Date()) {
                    return {
                        hasAccess: false,
                        message: "커뮤니티 이용권이 만료되었습니다. 간단히 재계산해주세요",
                        action: "redirect_to_calculator"
                    };
                }

                return {
                    hasAccess: true,
                    userGroup: this.currentSession.assigned_group,
                    nickname: this.currentSession.nickname,
                    session: this.currentSession
                };
            }

            // QR 코드용 링크 생성 (다중 기기 연동)
            generateDeviceLink() {
                if (!this.currentSession) return null;
                
                const baseUrl = window.location.origin;
                return `${baseUrl}/?link_token=${this.currentSession.session_token}`;
            }

            // 로컬 폴백 세션 생성
            createLocalFallbackSession(calculationResult) {
                const assignedGroup = this.assignGroup(calculationResult);
                const nickname = this.generateNickname(assignedGroup);
                const token = this.generateSecureToken();

                const fallbackSession = {
                    session_token: token,
                    assigned_group: assignedGroup,
                    nickname: nickname,
                    monthly_budget: calculationResult.monthlyLivingCost,
                    asset_years: calculationResult.assetSufficiencyYears,
                    created_at: new Date().toISOString(),
                    expires_at: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString(),
                    is_local_fallback: true
                };

                localStorage.setItem(this.tokenKey, token);
                localStorage.setItem(`planb_session_${token}`, JSON.stringify(fallbackSession));
                this.currentSession = fallbackSession;
                
                console.log(`로컬 폴백 세션 생성: ${nickname} (${assignedGroup} 그룹)`);
                return this.currentSession;
            }
        }

        // sessionManager 인스턴스 생성
        const sessionManager = new AnonymousSessionManager();

        // Supabase는 이미 위에서 초기화되었음

        // 랜덤 닉네임 생성기 
        class NicknameGenerator {
            constructor() {
                this.adjectives = [
                    // 감정/성격 관련 (200개)
                    '행복한', '여유로운', '지혜로운', '활기찬', '당당한', '멋진', '우아한', '든든한', 
                    '빛나는', '평온한', '건강한', '따뜻한', '자유로운', '늠름한', '친근한', '성실한',
                    '단아한', '차분한', '용감한', '씩씩한', '명랑한', '쾌활한', '밝은', '즐거운',
                    '활발한', '생기찬', '발랄한', '기운찬', '힘찬', '건장한', '튼튼한', '강한',
                    '신나는', '기쁜', '즐거운', '유쾌한', '솜씨좋은', '능숙한', '재능있는', '똑똑한',
                    '영리한', '슬기로운', '현명한', '총명한', '기특한', '예쁜', '이쁜', '곱단정한',
                    '수려한', '아름다운', '고운', '청순한', '깔끔한', '단정한', '정갈한', '깨끗한',
                    '맑은', '투명한', '순수한', '순진한', '천진한', '귀여운', '사랑스러운', '포근한',
                    '부드러운', '온화한', '따스한', '다정한', '친절한', '상냥한', '고마운', '고귀한',
                    '품격있는', '우수한', '뛰어난', '훌륭한', '대단한', '놀라운', '신기한', '특별한',
                    '소중한', '귀중한', '값진', '빼어난', '독특한', '개성있는', '창의적인', '예술적인',
                    '감각적인', '세련된', '모던한', '트렌디한', '스타일리시한', '참신한', '신선한', '새로운',
                    '깊은', '진한', '짙은', '고요한', '조용한', '침착한', '안정된', '편안한',
                    '느긋한', '여유있는', '낙천적인', '긍정적인', '적극적인', '열정적인', '의욕적인', '열심인',
                    '부지런한', '성실한', '꼼꼼한', '세심한', '정성스런', '신중한', '조심스런', '체계적인',
                    '계획적인', '논리적인', '합리적인', '현실적인', '실용적인', '효율적인', '전문적인', '숙련된',
                    '경험많은', '노련한', '베테랑', '실력있는', '유능한', '탁월한', '출중한', '일류의',
                    '최고의', '완벽한', '정확한', '정밀한', '섬세한', '예민한', '민감한', '세련된',
                    '고급스런', '품위있는', '우품있는', '점잖은', '차근한', '꾸준한', '지속적인', '변함없는',
                    '한결같은', '일관된', '충실한', '진실한', '솔직한', '정직한', '순수한', '깨끗한',
                    '맑고깨끗한', '투명한', '화사한', '환한', '반짝이는', '번쩍이는', '반들반들한', '윤이나는',
                    '매끄러운', '부드럽고매끄러운', '실크같은', '벨벳같은', '목화같은', '구름같은', '솜털같은', '보들보들한',
                    '포근포근한', '폭신폭신한', '말랑말랑한', '탄탄한', '견고한', '튼튼한', '단단한',
                    '야무진', '씩씩한', '용기있는', '담대한', '과감한', '결단력있는', '추진력있는', '실행력있는',
                    '리더십있는', '카리스마있는', '매력적인', '인상적인', '기억에남는', '잊지못할', '감동적인', '인상깊은'
                ];
                
                this.nouns = [
                    // 자연 (1000개)
                    '나무', '꽃', '풀', '잎', '뿌리', '줄기', '가지', '열매', '씨앗', '새싹',
                    '장미', '백합', '국화', '튤립', '해바라기', '개나리', '진달래', '벚꽃', '매화', '연꽃',
                    '소나무', '은행나무', '플라타너스', '단풍나무', '느티나무', '버드나무', '대나무', '참나무', '밤나무', '감나무',
                    '바다', '강', '호수', '계곡', '폭포', '개천', '샘', '우물', '연못', '늪',
                    '산', '언덕', '고원', '평야', '들판', '초원', '사막', '숲', '정글', '밀림',
                    '하늘', '구름', '별', '달', '태양', '무지개', '번개', '천둥', '비', '눈',
                    '바람', '미풍', '산들바람', '봄바람', '가을바람', '겨울바람', '여름바람', '해풍', '육풍', '골바람',
                    '새', '참새', '비둘기', '까치', '까마귀', '제비', '독수리', '매', '학', '갈매기',
                    '나비', '벌', '꿀벌', '잠자리', '메뚜기', '개미', '딱정벌레', '무당벌레', '거미', '지렁이',
                    
                    // 동물 (1500개)
                    '고양이', '강아지', '토끼', '다람쿠지', '청설모', '햄스터', '기니피그', '앵무새', '카나리아', '금붕어',
                    '사자', '호랑이', '표범', '치타', '재규어', '쿠거', '팬더', '북극곰', '갈색곰', '흑곰',
                    '코끼리', '기린', '하마', '코뿔소', '얼룩말', '말', '당나귀', '낙타', '알파카', '라마',
                    '원숭이', '침팬지', '오랑우탄', '고릴라', '원숭이', '여우원숭이', '갈매기', '펠리컨', '플라밍고', '공작',
                    '돌고래', '고래', '상어', '가오리', '바다거북', '바다표범', '바다사자', '펭귄', '알바트로스', '바닷새',
                    '개구리', '두꺼비', '도마뱀', '거북이', '뱀', '악어', '이구아나', '카멜레온', '도마뱀붙이', '제코',
                    
                    // 직업 (1000개)
                    '의사', '간호사', '교사', '교수', '학자', '연구원', '과학자', '엔지니어', '개발자', '디자이너',
                    '예술가', '화가', '조각가', '음악가', '피아니스트', '바이올리니스트', '첼리스트', '플루티스트', '드러머', '기타리스트',
                    '가수', '성악가', '작곡가', '작사가', '편곡가', '프로듀서', '지휘자', '연주자', '무용가', '발레리나',
                    '배우', '연출가', '감독', '작가', '소설가', '시인', '수필가', '기자', '아나운서', '성우',
                    '요리사', '베이커', '파티셰', '바리스타', '소믈리에', '영양사', '농부', '목축업자', '어부', '사냥꾼',
                    '건축가', '건설업자', '목수', '전기기사', '배관공', '용접공', '기계공', '정비사', '운전기사', '택시기사',
                    '변호사', '판사', '검사', '경찰관', '소방관', '군인', '파일럿', '승무원', '선장', '항해사',
                    '사업가', '기업가', 'CEO', '관리자', '팀장', '부장', '이사', '회장', '사장', '대표',
                    '회계사', '세무사', '은행원', '증권맨', '보험설계사', '부동산중개인', '컨설턴트', '애널리스트', '마케터', '영업맨',
                    
                    // 사물/도구 (2000개)
                    '책', '펜', '연필', '지우개', '자', '컴퍼스', '계산기', '컴퓨터', '노트북', '태블릿',
                    '휴대폰', '스마트폰', '텔레비전', '라디오', '스피커', '헤드폰', '이어폰', '마이크', '카메라', '캠코더',
                    '시계', '알람시계', '벽시계', '손목시계', '스마트워치', '달력', '수첩', '다이어리', '메모장', '노트',
                    '가방', '배낭', '여행가방', '핸드백', '숄더백', '크로스백', '토트백', '클러치', '지갑', '파우치',
                    '자동차', '버스', '지하철', '기차', '비행기', '헬리콥터', '배', '요트', '자전거', '오토바이',
                    '침대', '의자', '책상', '소파', '테이블', '서랍장', '옷장', '냉장고', '세탁기', '에어컨',
                    '텐트', 'sleeping bag', '배낭', '등산화', '캠핑용품', '랜턴', '손전등', '나침반', '망원경', '쌍안경',
                    '악기', '피아노', '기타', '바이올린', '첼로', '플루트', '색소폰', '트럼펫', '드럼', '하모니카',
                    '공', '축구공', '농구공', '야구공', '테니스공', '탁구공', '배드민턴', '골프공', '볼링공', '럭비공',
                    '운동화', '구두', '슬리퍼', '샌들', '부츠', '하이힐', '스니커즈', '로퍼', '옥스퍼드', '모카신',
                    
                    // 음식 (1500개)
                    '밥', '국', '김치', '불고기', '갈비', '삼겹살', '냉면', '비빔밥', '김밥', '라면',
                    '우동', '짜장면', '짬뻐', '탕수육', '만두', '떡볶이', '순대', '어묵', '붕어빵', '호떡',
                    '치킨', '피자', '햄버거', '파스타', '스테이크', '샐러드', '샌드위치', '토스트', '베이글', '크루아상',
                    '케이크', '쿠키', '마카롱', '도넛', '머핀', '파이', '타르트', '푸딩', '젤리', '초콜릿',
                    '사과', '배', '복숭아', '포도', '딸기', '바나나', '오렌지', '귤', '자몽', '레몬',
                    '수박', '메론', '참외', '키위', '파인애플', '망고', '아보카도', '블루베리', '체리', '자두',
                    '커피', '차', '물', '주스', '우유', '요구르트', '맥주', '와인', '소주', '막걸리',
                    '빵', '식빵', '바게트', '롤빵', '단팥빵', '크림빵', '소보로빵', '마요네즈빵', '초코빵', '치즈빵',
                    '면', '쌀국수', '메밀국수', '칼국수', '수제비', '잔치국수', '소면', '중면', '굵은면', '납작면',
                    '고기', '소고기', '돼지고기', '닭고기', '양고기', '오리고기', '생선', '연어', '참치', '고등어',
                    
                    // 장소 (1000개)
                    '집', '학교', '병원', '은행', '우체국', '도서관', '박물관', '미술관', '극장', '영화관',
                    '공원', '놀이터', '운동장', '체육관', '수영장', '골프장', '테니스장', '축구장', '야구장', '농구장',
                    '카페', '레스토랑', '음식점', '술집', '바', '클럽', '노래방', 'PC방', '찜질방', '사우나',
                    '백화점', '마트', '편의점', '약국', '빵집', '꽃집', '서점', '문구점', '옷가게', '신발가게',
                    '해변', '바닷가', '산', '계곡', '폭포', '동굴', '섬', '항구', '부두', '다리',
                    '도시', '마을', '시골', '농촌', '어촌', '산촌', '동네', '골목', '길', '거리',
                    '버스정류장', '지하철역', '기차역', '공항', '항공기', '선착장', '주차장', '터널', '육교', '지하도',
                    '사무실', '회사', '공장', '창고', '상점', '시장', '전통시장', '재래시장', '농수산시장', '벼룩시장',
                    '호텔', '모텔', '펜션', '리조트', '캠핑장', '글램핑', '게스트하우스', '민박', '여관', '숙박업소',
                    '교실', '강당', '체육관', '운동장', '도서실', '과학실', '음악실', '미술실', '컴퓨터실', '방송실'
                ];
            }
            
            generate() {
                const adj = this.adjectives[Math.floor(Math.random() * this.adjectives.length)];
                const noun = this.nouns[Math.floor(Math.random() * this.nouns.length)];
                // 천만개 조합으로 숫자 없이도 충분하므로 숫자 제거
                return `${adj}${noun}`;
            }
        }

        // 회원 인증 매니저
        class AuthManager {
            constructor() {
                this.nicknameGen = new NicknameGenerator();
                this.currentUser = null;
            }
            
            // 회원가입
            async signUp(email, password, nickname = null) {
                try {
                    const finalNickname = nickname || this.nicknameGen.generate();
                    
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                nickname: finalNickname
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    // 사용자 프로필 생성
                    if (data.user) {
                        const { error: profileError } = await supabase
                            .from('user_profiles')
                            .insert({
                                id: data.user.id,
                                email: email,
                                nickname: finalNickname,
                                privacy_consent: true,
                                privacy_consent_date: new Date().toISOString(),
                                created_at: new Date().toISOString()
                            });
                        
                        if (profileError) throw profileError;
                    }
                    
                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 로그인
            async signIn(email, password) {
                try {
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    this.currentUser = data.user;
                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 이메일 중복 체크 (단순 중복 확인)
            async checkEmail(email) {
                try {
                    // 기존 user_profiles 테이블에서 이메일 확인
                    const { data: existingUser, error } = await supabase
                        .from('user_profiles')
                        .select('id, email')
                        .eq('email', email)
                        .single();
                    
                    if (existingUser) {
                        // 이미 존재하는 이메일
                        return { 
                            success: false, 
                            error: '이미 등록된 이메일입니다. 다른 이메일을 사용해주세요.'
                        };
                    }
                    
                    return { success: true };
                } catch (error) {
                    // 사용자가 없는 경우 (정상적인 상황)
                    return { success: true };
                }
            }

            // 로그아웃
            async signOut() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    
                    this.currentUser = null;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 현재 사용자 정보 가져오기
            async getCurrentUser() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    this.currentUser = user;
                    return user;
                } catch (error) {
                    console.error('Error getting current user:', error);
                    return null;
                }
            }
            
            // 닉네임 업데이트
            async updateNickname(newNickname) {
                try {
                    if (!this.currentUser) throw new Error('로그인이 필요합니다');
                    
                    const { error } = await supabase
                        .from('user_profiles')
                        .update({ nickname: newNickname })
                        .eq('id', this.currentUser.id);
                    
                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        // 전역 인증 매니저 인스턴스
        const authManager = new AuthManager();

        // 개인정보동의 체크박스 컴포넌트
        const PrivacyConsentCheckbox = ({ checked, onChange }) => {
            return (
                <label className="flex items-start space-x-3 cursor-pointer">
                    <input
                        type="checkbox"
                        checked={checked}
                        onChange={(e) => onChange(e.target.checked)}
                        onClick={(e) => {
                            const newValue = !checked;
                            onChange(newValue);
                        }}
                        className="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                    />
                    <div className="flex-1">
                        <span className="text-sm text-gray-800 font-medium">
                            개인정보 수집·이용에 동의합니다 
                            <span className="text-red-500 ml-1">(필수)</span>
                        </span>
                        <p className="text-xs text-gray-500 mt-1">
                            위 개인정보 수집·이용에 대한 내용을 읽고 동의합니다
                        </p>
                    </div>
                </label>
            );
        };

        // 전문가용 개인정보수집이용동의서 컴포넌트
        const ExpertPrivacyConsentComponent = ({ checked, onChange }) => {
            const [showFullText, setShowFullText] = useState(false);

            return (
                <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div className="mb-4">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">개인정보 수집·이용 동의서</h3>
                        <div className="text-sm text-gray-700 space-y-2">
                            <div className="bg-white p-3 rounded border">
                                <p><strong>• 수집항목:</strong> 성명, 이메일, 연락처, 전문분야, 자격증·경력정보, 사업자등록증</p>
                                <p><strong>• 수집목적:</strong> 전문가 신원확인, 자격검증, 상담서비스 제공, 수수료 정산</p>
                                <p><strong>• 보유기간:</strong> 서비스 탈퇴 후 3년 (전자상거래법)</p>
                                <p><strong>• 제3자 제공:</strong> 상담 매칭을 위한 최소정보만 고객에게 제공</p>
                                <p className="text-red-600"><strong>• 동의거부권:</strong> 동의를 거부할 수 있으나, 서비스 이용이 제한됩니다</p>
                            </div>
                            
                            <button
                                type="button"
                                onClick={() => setShowFullText(!showFullText)}
                                className="text-blue-600 hover:text-blue-800 text-sm underline"
                            >
                                {showFullText ? '간략히 보기' : '전문 보기'}
                            </button>
                            
                            {showFullText && (
                                <div className="bg-white border border-gray-200 rounded p-4 text-xs text-gray-600 max-h-60 overflow-y-auto">
                                    <h4 className="font-semibold mb-2">개인정보 수집·이용 동의서 (전문)</h4>
                                    
                                    <div className="space-y-3">
                                        <div>
                                            <h5 className="font-medium">1. 개인정보의 수집 및 이용목적</h5>
                                            <p>- 전문가 신원 확인 및 자격 검증</p>
                                            <p>- 상담 서비스 제공 및 매칭</p>
                                            <p>- 수수료 정산 및 세금계산서 발행</p>
                                            <p>- 서비스 품질 향상을 위한 통계 분석</p>
                                            <p>- 법령상 의무이행 (전자상거래법, 소득세법 등)</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">2. 수집하는 개인정보의 항목</h5>
                                            <p><strong>필수항목:</strong> 성명, 이메일, 연락처(휴대폰), 전문분야, 경력년수, 자격증 정보</p>
                                            <p><strong>선택항목:</strong> 프로필 사진, 상세 이력, 사업자등록번호</p>
                                            <p><strong>자동수집:</strong> IP주소, 쿠키, 접속 로그, 서비스 이용기록</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">3. 개인정보의 보유 및 이용기간</h5>
                                            <p>- 서비스 이용기간 중</p>
                                            <p>- 서비스 탈퇴 후 3년 (전자상거래 등에서의 소비자보호에 관한 법률)</p>
                                            <p>- 세법에 따른 장부보관의무: 5년</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">4. 개인정보의 제3자 제공</h5>
                                            <p>- 상담 신청 고객에게 전문가 프로필 정보 제공 (성명, 전문분야, 경력, 후기)</p>
                                            <p>- 세무 신고를 위한 국세청 제공 (법정의무사항)</p>
                                            <p>- 기타 법령에 의한 제공</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">5. 개인정보처리의 위탁</h5>
                                            <p>- 결제대행사: 수수료 정산 (PG사)</p>
                                            <p>- 클라우드 서비스: 데이터 저장 (Supabase)</p>
                                            <p>- 알림톡 발송: 예약 확인 알림 (문자서비스)</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">6. 정보주체의 권리·의무</h5>
                                            <p>- 개인정보 열람·정정·삭제·처리정지 요구권</p>
                                            <p>- 손해배상청구권</p>
                                            <p>- 개인정보보호위원회 신고권 (privacy.go.kr, 국번없이 182)</p>
                                        </div>
                                        
                                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2">
                                            <p className="text-red-700 font-medium">※ 위 사항에 대한 동의를 거부할 수 있으나, 동의 거부 시 전문가 등록 및 서비스 이용이 제한됩니다.</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="p-3 border rounded-lg" style={{
                        borderColor: checked ? '#ea580c' : '#d1d5db',
                        backgroundColor: checked ? '#fff7ed' : 'white'
                    }}>
                        <label className="flex items-center space-x-3 cursor-pointer">
                            <input
                                type="checkbox"
                                checked={!!checked}
                                onClick={(e) => {
                                    const newValue = !checked;
                                    if (onChange) {
                                        onChange(newValue);
                                    }
                                }}
                                onChange={() => {
                                    // onClick에서 처리하므로 빈 함수
                                }}
                                className="expert-checkbox mt-1 w-4 h-4 text-orange-600 border-2 border-gray-300 rounded focus:ring-orange-500 focus:ring-2 cursor-pointer"
                                style={{
                                    accentColor: '#ea580c'
                                }}
                            />
                            <div className="flex-1 text-sm text-gray-800 font-medium select-none">
                                위 개인정보 수집·이용에 동의합니다
                                <span className="text-red-500 ml-1">*</span>
                            </div>
                        </label>
                    </div>
                </div>
            );
        };

        // 휴대폰 번호 자동 포맷팅 함수
        const formatPhoneNumber = (value) => {
            // 숫자만 추출
            const numbers = value.replace(/[^\d]/g, '');
            
            // 11자리 초과시 자르기
            if (numbers.length > 11) {
                return numbers.slice(0, 11);
            }
            
            // 포맷팅
            if (numbers.length <= 3) {
                return numbers;
            } else if (numbers.length <= 7) {
                return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
            } else {
                return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7)}`;
            }
        };

        // 비밀번호 유효성 검사 함수
        const validatePassword = (password) => {
            const checks = {
                length: password.length >= 8,
                hasLetter: /[A-Za-z]/.test(password),
                hasNumber: /[0-9]/.test(password),
                hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };
            
            const typeCount = [checks.hasLetter, checks.hasNumber, checks.hasSpecial].filter(Boolean).length;
            
            return {
                isValid: checks.length && typeCount >= 2,
                checks: checks,
                typeCount: typeCount
            };
        };

        // 전문가 프로필 폼 컴포넌트
        const ExpertProfileForm = ({ 
            expertProfile, updateExpertProfile, expertCategories,
            specialtyInput, setSpecialtyInput, credentialInput, setCredentialInput,
            addSpecialty, addCredential, removeSpecialty, removeCredential 
        }) => {
            return (
                <div className="space-y-6">
                    {/* 전문가 카테고리 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-3">전문 분야 *</label>
                        <div className="grid grid-cols-1 gap-3">
                            {Object.entries(expertCategories).map(([key, category]) => (
                                <div key={key} 
                                     className="border-2 rounded-lg p-4 transition-all duration-200 hover:bg-gray-50"
                                     style={{
                                         borderColor: expertProfile.expertType === key ? '#ea580c' : '#d1d5db',
                                         backgroundColor: expertProfile.expertType === key ? '#fff7ed' : 'white'
                                     }}>
                                    <label className="flex items-center gap-4 cursor-pointer">
                                        <input
                                            type="radio"
                                            name="expertType"
                                            value={key}
                                            checked={expertProfile.expertType === key}
                                            onClick={() => {
                                                updateExpertProfile('expertType', key);
                                                // specialties 배열도 동시 업데이트 (기존 검증 로직과 호환성)
                                                updateExpertProfile('specialties', [expertCategories[key].name]);
                                            }}
                                            onChange={() => {}}
                                            className="w-5 h-5 text-orange-600 border-2 border-gray-300 focus:ring-2 focus:ring-orange-500 cursor-pointer"
                                        />
                                        <div className="flex-1">
                                            <div className="text-lg font-medium">{category.icon} {category.name}</div>
                                            <div className="text-sm text-gray-500">{category.description}</div>
                                        </div>
                                    </label>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 직책/타이틀 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">직책/타이틀 *</label>
                        <input
                            type="text"
                            required
                            value={expertProfile.title}
                            onChange={(e) => updateExpertProfile('title', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="예: 시니어 여행 전문 플래너"
                        />
                    </div>

                    {/* 경력 년수 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">경력 (년) *</label>
                        <input
                            type="number"
                            required
                            min="1"
                            max="50"
                            value={expertProfile.experienceYears}
                            onChange={(e) => updateExpertProfile('experienceYears', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="경력 년수"
                        />
                    </div>

                    {/* 소개 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">자기소개</label>
                        <textarea
                            rows="3"
                            value={expertProfile.bio}
                            onChange={(e) => updateExpertProfile('bio', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="간단한 자기소개를 작성해주세요"
                        />
                    </div>

                    {/* 전문분야 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">전문분야 *</label>
                        <div className="flex gap-2 mt-1">
                            <input
                                type="text"
                                value={specialtyInput}
                                onChange={(e) => setSpecialtyInput(e.target.value)}
                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                placeholder="전문분야 입력 후 추가 버튼"
                                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addSpecialty())}
                            />
                            <button
                                type="button"
                                onClick={addSpecialty}
                                className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                            >
                                추가
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {expertProfile.specialties.map((specialty, index) => (
                                <span key={index} className="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
                                    {specialty}
                                    <button
                                        type="button"
                                        onClick={() => removeSpecialty(index)}
                                        className="ml-2 text-orange-600 hover:text-orange-800"
                                    >
                                        ×
                                    </button>
                                </span>
                            ))}
                        </div>
                    </div>

                    {/* 자격증/경력 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">자격증/경력증명 *</label>
                        <div className="flex gap-2 mt-1">
                            <input
                                type="text"
                                value={credentialInput}
                                onChange={(e) => setCredentialInput(e.target.value)}
                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                placeholder="자격증/경력 입력 후 추가 버튼"
                                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addCredential())}
                            />
                            <button
                                type="button"
                                onClick={addCredential}
                                className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                            >
                                추가
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {expertProfile.credentials.map((credential, index) => (
                                <span key={index} className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                    {credential}
                                    <button
                                        type="button"
                                        onClick={() => removeCredential(index)}
                                        className="ml-2 text-blue-600 hover:text-blue-800"
                                    >
                                        ×
                                    </button>
                                </span>
                            ))}
                        </div>
                    </div>


                    {/* 상담 방식 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-3">제공 가능한 상담 방식 *</label>
                        <div className="space-y-2">
                            {[
                                { value: 'phone', label: '📞 전화 상담', desc: '음성 통화로 상담' },
                                { value: 'video', label: '📹 화상 상담', desc: 'Zoom, Meet 등 화상 통화' },
                                { value: 'chat', label: '💬 채팅 상담', desc: '텍스트 기반 상담' }
                            ].map(({ value, label, desc }) => (
                                <div key={value} 
                                     className="border-2 rounded-lg p-3 transition-all duration-200 hover:bg-gray-50"
                                     style={{
                                         borderColor: expertProfile.availableTypes.includes(value) ? '#ea580c' : '#d1d5db',
                                         backgroundColor: expertProfile.availableTypes.includes(value) ? '#fff7ed' : 'white'
                                     }}>
                                    <label className="flex items-center gap-4 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={expertProfile.availableTypes.includes(value)}
                                            onClick={() => {
                                                const isCurrentlyChecked = expertProfile.availableTypes.includes(value);
                                                const types = isCurrentlyChecked
                                                    ? expertProfile.availableTypes.filter(t => t !== value)
                                                    : [...expertProfile.availableTypes, value];
                                                updateExpertProfile('availableTypes', types);
                                            }}
                                            onChange={() => {}}
                                            className="w-5 h-5 text-orange-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-orange-500 cursor-pointer"
                                        />
                                        <div className="flex-1">
                                            <div className="font-medium">{label}</div>
                                            <div className="text-sm text-gray-500">{desc}</div>
                                        </div>
                                    </label>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 연락처 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">휴대폰 번호 *</label>
                        <input
                            type="tel"
                            required
                            value={expertProfile.phone}
                            onChange={(e) => {
                                const formatted = formatPhoneNumber(e.target.value);
                                updateExpertProfile('phone', formatted);
                            }}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="010-1234-5678"
                        />
                        <p className="text-xs text-gray-500 mt-1">상담 예약 확인 및 본인 인증용</p>
                    </div>


                    {/* 자격 검증 섹션 */}
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            🔒 자격 검증 (다음 중 하나 이상 필수)
                        </h4>
                        
                        <div className="space-y-6">
                            {/* 옵션 1: 사업자등록증 */}
                            <div className="border border-gray-200 rounded-lg p-4">
                                <h5 className="font-medium text-gray-800 mb-3">📄 옵션 1: 사업자등록 정보</h5>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">사업자등록번호</label>
                                        <input
                                            type="text"
                                            value={expertProfile.businessLicense}
                                            onChange={(e) => {
                                                const value = e.target.value.replace(/[^0-9]/g, '');
                                                const formatted = value.length >= 10 ? 
                                                    `${value.slice(0,3)}-${value.slice(3,5)}-${value.slice(5,10)}` : 
                                                    value;
                                                updateExpertProfile('businessLicense', formatted);
                                            }}
                                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                            placeholder="1234567890 또는 123-45-67890"
                                            maxLength="12"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">개인사업자 또는 법인사업자 등록번호</p>
                                    </div>
                                    {expertProfile.businessLicense && expertProfile.businessLicense.length >= 10 && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 text-red-600">사업자등록증 업로드 *</label>
                                            <input
                                                type="file"
                                                accept="image/*,.pdf"
                                                onChange={(e) => {
                                                    const file = e.target.files[0];
                                                    if (file) {
                                                        // 파일 크기 제한 (5MB)
                                                        if (file.size > 5 * 1024 * 1024) {
                                                            alert('파일 크기는 5MB 이하로 업로드해주세요');
                                                            return;
                                                        }
                                                        updateExpertProfile('businessLicenseFile', file);
                                                    }
                                                }}
                                                className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">사업자등록증 이미지 또는 PDF (최대 5MB)</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 옵션 2: 국가자격증 */}
                            <div className="border border-gray-200 rounded-lg p-4">
                                <h5 className="font-medium text-gray-800 mb-3">🎓 옵션 2: 국가자격증</h5>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">자격증 번호</label>
                                        <input
                                            type="text"
                                            value={expertProfile.qualificationNumber}
                                            onChange={(e) => updateExpertProfile('qualificationNumber', e.target.value)}
                                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                            placeholder="예: 관광통역안내사 제12345호"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">국가자격증, 민간자격증 또는 전문 라이선스 번호</p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">자격증/면허증 사본 업로드</label>
                                        <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-orange-400 transition-colors">
                                            <div className="space-y-1 text-center">
                                                <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                                                </svg>
                                                <div className="flex text-sm text-gray-600">
                                                    <label htmlFor="license-upload" className="relative cursor-pointer bg-white rounded-md font-medium text-orange-600 hover:text-orange-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-orange-500">
                                                        <span>자격증 파일 업로드</span>
                                                        <input id="license-upload" name="license-upload" type="file" className="sr-only" 
                                                               accept=".jpg,.jpeg,.png,.pdf"
                                                               onChange={(e) => {
                                                                   const file = e.target.files[0];
                                                                   if (file) {
                                                                       // 파일 크기 제한 (5MB)
                                                                       if (file.size > 5 * 1024 * 1024) {
                                                                           alert('파일 크기는 5MB 이하로 제한됩니다.');
                                                                           return;
                                                                       }
                                                                       updateExpertProfile('licenseFile', file);
                                                                   }
                                                               }}
                                                        />
                                                    </label>
                                                    <p className="pl-1">또는 드래그 앤 드롭</p>
                                                </div>
                                                <p className="text-xs text-gray-500">JPG, PNG, PDF (최대 5MB)</p>
                                                {expertProfile.licenseFile && (
                                                    <p className="text-sm text-green-600 font-medium mt-2">
                                                        ✓ {expertProfile.licenseFile.name}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 옵션 3: 개인 전문가 */}
                            <div className="border border-gray-200 rounded-lg p-4">
                                <h5 className="font-medium text-gray-800 mb-3">👤 옵션 3: 개인 전문가 (추가 심사)</h5>
                                <div className="space-y-3">
                                    <div className="bg-blue-50 border border-blue-200 rounded p-3">
                                        <p className="text-sm text-blue-800">
                                            <strong>ℹ️ 개인 전문가 심사 기준:</strong>
                                        </p>
                                        <ul className="text-xs text-blue-700 mt-1 space-y-1">
                                            <li>• 해당 분야 5년 이상 실무 경험</li>
                                            <li>• 포트폴리오, 경력증명서, 추천서 등 제출</li>
                                            <li>• 심화 인터뷰 또는 실무 테스트 진행</li>
                                            <li>• 심사 기간: 영업일 기준 7-10일</li>
                                        </ul>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">경력/포트폴리오 파일 업로드</label>
                                        <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-orange-400 transition-colors">
                                            <div className="space-y-1 text-center">
                                                <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                                                </svg>
                                                <div className="flex text-sm text-gray-600">
                                                    <label htmlFor="portfolio-upload" className="relative cursor-pointer bg-white rounded-md font-medium text-orange-600 hover:text-orange-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-orange-500">
                                                        <span>경력증명 파일 업로드</span>
                                                        <input id="portfolio-upload" name="portfolio-upload" type="file" className="sr-only" 
                                                               accept=".jpg,.jpeg,.png,.pdf,.doc,.docx"
                                                               multiple
                                                               onChange={(e) => {
                                                                   const files = Array.from(e.target.files);
                                                                   const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                                                                   if (totalSize > 20 * 1024 * 1024) {
                                                                       alert('전체 파일 크기는 20MB 이하로 제한됩니다.');
                                                                       return;
                                                                   }
                                                                   updateExpertProfile('portfolioFiles', files);
                                                               }}
                                                        />
                                                    </label>
                                                    <p className="pl-1">또는 드래그 앤 드롭</p>
                                                </div>
                                                <p className="text-xs text-gray-500">JPG, PNG, PDF, DOC (전체 최대 20MB, 여러 파일 가능)</p>
                                                {expertProfile.portfolioFiles && expertProfile.portfolioFiles.length > 0 && (
                                                    <div className="mt-2 space-y-1">
                                                        {Array.from(expertProfile.portfolioFiles).map((file, index) => (
                                                            <p key={index} className="text-sm text-green-600 font-medium">
                                                                ✓ {file.name}
                                                            </p>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">전문성 설명</label>
                                        <textarea
                                            rows="4"
                                            value={expertProfile.expertiseDescription || ''}
                                            onChange={(e) => updateExpertProfile('expertiseDescription', e.target.value)}
                                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                            placeholder="자격증이나 사업자등록이 없지만 해당 분야의 전문가인 이유를 상세히 설명해주세요. (경력, 실적, 전문성을 구체적으로 기술)"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">최소 200자 이상 상세 기술 권장</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white border border-orange-200 rounded p-3">
                                <p className="text-sm text-orange-800">
                                    <strong>⚠️ 검증 안내:</strong> 
                                </p>
                                <ul className="text-xs text-orange-700 mt-1 space-y-1">
                                    <li>• 옵션 1,2: 사업자등록번호는 국세청, 자격증은 발급기관에서 검증</li>
                                    <li>• 옵션 3: 제출 서류 및 심화 심사를 통해 전문성 검증</li>
                                    <li>• 허위 정보 제출시 등록 거부 및 서비스 이용 제한</li>
                                    <li>• 검토 기간: 옵션 1,2는 3-5일, 옵션 3은 7-10일</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // 마이페이지 컴포넌트
        const MyPageComponent = ({ currentUser, onClose, getUserType, getUserTypeName, isAdminUser, isGuest }) => {
            const [userType, setUserType] = useState('member');
            const [userTypeName, setUserTypeName] = useState('일반회원');
            const [activeTab, setActiveTab] = useState('profile');
            
            // 사용자 타입 확인 (async)
            useEffect(() => {
                const checkUserType = async () => {
                    const type = await getUserType(currentUser);
                    const typeName = getUserTypeName(type);
                    setUserType(type);
                    setUserTypeName(typeName);
                };
                
                if (currentUser) {
                    checkUserType();
                }
            }, [currentUser]);

            // 게스트 사용자는 내 정보만 사용 가능 - currentUser.isGuest 사용
            const isCurrentUserGuest = currentUser?.isGuest;
            const tabs = [
                { id: 'profile', name: '내 정보', icon: '👤' },
                // 게스트가 아니거나 전문가/관리자인 경우에만 표시
                ...(!isCurrentUserGuest ? [
                    { id: 'activity', name: '활동 내역', icon: '📊' },
                    { id: 'contact', name: '연락처 교환', icon: '📞' }
                ] : []),
                // 관리자는 모든 탭 접근 가능, 전문가는 전문가 탭만
                ...(userType === 'expert' || userType === 'admin' ? [{ id: 'expert', name: '전문가 관리', icon: '🎯' }] : []),
                ...(userType === 'admin' ? [{ id: 'admin', name: '관리자', icon: '👑' }] : [])
            ];

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* 헤더 */}
                    <div className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-4xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                                        <span className="text-white font-bold text-lg">
                                            {userType === 'admin' ? '👑' : userType === 'expert' ? '🎯' : '👤'}
                                        </span>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-800">마이페이지</h1>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-gray-600">{currentUser?.nickname || currentUser?.email}</span>
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                userType === 'admin' ? 'bg-red-100 text-red-800' :
                                                userType === 'expert' ? 'bg-orange-100 text-orange-800' :
                                                'bg-blue-100 text-blue-800'
                                            }`}>
                                                {userTypeName}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 탭 메뉴 */}
                    <div className="bg-white border-b border-gray-200">
                        <div className="max-w-4xl mx-auto px-4">
                            <div className="flex space-x-8">
                                {tabs.map((tab) => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-4 px-2 border-b-2 font-medium text-sm transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        {tab.icon} {tab.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* 탭 컨텐츠 */}
                    <div className="max-w-4xl mx-auto px-4 py-8">
                        {activeTab === 'profile' && (
                            <ProfileTab currentUser={currentUser} userType={userType} userTypeName={userTypeName} />
                        )}
                        {/* 게스트가 아니거나 전문가/관리자인 경우에만 표시 */}
                        {activeTab === 'activity' && !isCurrentUserGuest && (
                            <ActivityTab 
                                currentUser={currentUser} 
                                userType={userType}
                                setCurrentView={setCurrentView}
                                setFormData={setFormData}
                                setCalculatorResult={setCalculatorResult}
                                setCalculatorStep={setCalculatorStep}
                                showNotification={showNotification}
                                onClose={onClose}
                            />
                        )}
                        {activeTab === 'contact' && !isCurrentUserGuest && (
                            <ContactExchangeComponent currentUser={currentUser} isAdminUser={isAdminUser} />
                        )}
                        {activeTab === 'expert' && userType === 'expert' && (
                            <ExpertTab currentUser={currentUser} />
                        )}
                        {activeTab === 'admin' && userType === 'admin' && (
                            <AdminTab currentUser={currentUser} />
                        )}
                        
                        {/* 게스트가 제한된 탭에 접근한 경우 안내 메시지 */}
                        {isCurrentUserGuest && (activeTab === 'activity' || activeTab === 'contact') && (
                            <div className="text-center py-12">
                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-8 max-w-md mx-auto">
                                    <div className="text-4xl mb-4">🚫</div>
                                    <h3 className="text-lg font-semibold text-amber-800 mb-2">게스트 사용 제한</h3>
                                    <p className="text-amber-600 mb-4">이 기능은 정식 회원만 사용할 수 있습니다.</p>
                                    <button 
                                        onClick={() => {
                                            setAuthMode('signup');
                                            setCurrentView('login');
                                            setShowAuthForm(true);
                                        }}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        회원가입하기
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 내 정보 탭
        const ProfileTab = ({ currentUser, userType, userTypeName }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">기본 정보</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">{currentUser?.email}</div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">닉네임</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">{currentUser?.nickname || '설정되지 않음'}</div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">회원 유형</label>
                            <div className="p-3 bg-gray-50 rounded-lg">
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                    userType === 'admin' ? 'bg-red-100 text-red-800' :
                                    userType === 'expert' ? 'bg-orange-100 text-orange-800' :
                                    'bg-blue-100 text-blue-800'
                                }`}>
                                    {userTypeName}
                                </span>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">가입일</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {currentUser?.created_at ? new Date(currentUser.created_at).toLocaleDateString() : '정보 없음'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        // 활동 내역 탭
        const ActivityTab = ({ currentUser, userType, setCurrentView, setFormData, setCalculatorResult, setCalculatorStep, showNotification, onClose }) => {
            const [bookingHistory, setBookingHistory] = React.useState([]);
            const [paymentHistory, setPaymentHistory] = React.useState([]);
            const [calculationHistory, setCalculationHistory] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [activeSubTab, setActiveSubTab] = React.useState('calculations');

            // 저장된 계산 결과 불러오기 및 예시 데이터
            React.useEffect(() => {
                const loadCalculationHistory = async () => {
                    try {
                        let calculations = [];
                        
                        console.log('🔍 계산 이력 로딩 시작...', { currentUser: currentUser?.email });
                        
                        // 1. localStorage에서 현재 계산 결과 불러오기
                        const savedLocal = localStorage.getItem('planb_calculation_result');
                        console.log('📱 localStorage 데이터:', savedLocal ? 'Found' : 'Not found');
                        
                        if (savedLocal) {
                            try {
                                const localData = JSON.parse(savedLocal);
                                calculations.push({
                                    id: 'local-' + Date.now(),
                                    source: 'local',
                                    created_at: localData.calculatedAt || new Date().toISOString(),
                                    ...localData
                                });
                                console.log('✅ localStorage 계산 결과 추가:', localData.formData?.age);
                            } catch (error) {
                                console.error('localStorage 계산 결과 파싱 실패:', error);
                            }
                        }
                        
                        // 2. Supabase에서 사용자의 모든 계산 결과 불러오기 (회원인 경우)
                        if (currentUser && !currentUser.isGuest && supabase) {
                            console.log('🔍 Supabase에서 계산 결과 조회 중...', currentUser.id);
                            try {
                                const { data, error } = await supabase
                                    .from('user_calculations')
                                    .select('*')
                                    .eq('user_id', currentUser.id)
                                    .order('created_at', { ascending: false });
                                
                                if (error) {
                                    console.error('❌ Supabase 계산 결과 조회 실패:', error);
                                } else if (data) {
                                    console.log('📊 Supabase 계산 결과 개수:', data.length);
                                    const supabaseCalculations = data.map(item => ({
                                        id: item.id,
                                        source: 'database',
                                        created_at: item.created_at,
                                        formData: {
                                            age: item.age,
                                            health: item.health_status,
                                            lifeMode: item.life_mode,
                                            housingType: item.housing_type,
                                            housingValue: Math.floor(item.housing_value / 10000) || 0,
                                            financialAssets: Math.floor(item.financial_assets / 10000) || 0,
                                            severancePay: Math.floor(item.severance_pay / 10000) || 0,
                                            debt: Math.floor(item.debt / 10000) || 0,
                                            nationalPension: Math.floor(item.national_pension / 10000) || 0,
                                            privatePension: Math.floor(item.private_pension / 10000) || 0
                                        },
                                        calculationResult: item.calculation_result,
                                        totalAssets: item.calculation_result?.totalAssets || 0,
                                        monthlyLivingCost: item.calculation_result?.monthlyLivingCost || 0,
                                        assetSufficiencyYears: item.calculation_result?.assetSufficiencyYears || 0
                                    }));
                                    calculations = [...calculations, ...supabaseCalculations];
                                }
                            } catch (error) {
                                console.error('❌ 데이터베이스 계산 결과 로딩 실패:', error);
                            }
                        }
                        
                        // 중복 제거 및 날짜순 정렬
                        const uniqueCalculations = calculations
                            .filter((calc, index, self) => 
                                index === self.findIndex(c => 
                                    Math.abs(new Date(c.created_at) - new Date(calc.created_at)) < 60000
                                )
                            )
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        
                        console.log('📈 최종 계산 결과 개수:', uniqueCalculations.length);
                        setCalculationHistory(uniqueCalculations);
                    } catch (error) {
                        console.error('❌ 계산 이력 로딩 실패:', error);
                        // 오류 발생 시에도 빈 배열을 설정하여 UI가 표시되도록 함
                        setCalculationHistory([]);
                    }
                };
                
                loadCalculationHistory();
                
                // 모의 예약 내역 데이터
                const mockBookings = [
                    {
                        id: 1,
                        expertName: '김전문가',
                        consultationType: '투자 상담',
                        date: '2025-08-20',
                        time: '14:00',
                        status: 'completed',
                        price: 50000,
                        duration: 60,
                        rating: 5,
                        review: '매우 유용한 상담이었습니다.'
                    },
                    {
                        id: 2,
                        expertName: '이전문가',
                        consultationType: '부동산 상담',
                        date: '2025-08-18',
                        time: '16:30',
                        status: 'completed',
                        price: 75000,
                        duration: 90,
                        rating: 4,
                        review: null
                    },
                    {
                        id: 3,
                        expertName: '박전문가',
                        consultationType: '세금 상담',
                        date: '2025-08-25',
                        time: '10:00',
                        status: 'scheduled',
                        price: 60000,
                        duration: 60,
                        rating: null,
                        review: null
                    }
                ];

                // 모의 결제 내역 데이터
                const mockPayments = [
                    {
                        id: 1,
                        bookingId: 1,
                        date: '2025-08-19',
                        amount: 50000,
                        method: '신용카드',
                        status: 'completed',
                        transactionId: 'TXN123456789'
                    },
                    {
                        id: 2,
                        bookingId: 2,
                        date: '2025-08-17',
                        amount: 75000,
                        method: '계좌이체',
                        status: 'completed',
                        transactionId: 'TXN987654321'
                    },
                    {
                        id: 3,
                        bookingId: 3,
                        date: '2025-08-24',
                        amount: 60000,
                        method: '신용카드',
                        status: 'pending',
                        transactionId: 'TXN456789123'
                    }
                ];

                setTimeout(() => {
                    setBookingHistory(mockBookings);
                    setPaymentHistory(mockPayments);
                    setLoading(false);
                }, 1000);
            }, []);

            const getStatusBadge = (status) => {
                const statusConfig = {
                    completed: { bg: 'bg-green-100', text: 'text-green-800', label: '완료' },
                    scheduled: { bg: 'bg-blue-100', text: 'text-blue-800', label: '예정' },
                    cancelled: { bg: 'bg-red-100', text: 'text-red-800', label: '취소' },
                    pending: { bg: 'bg-yellow-100', text: 'text-yellow-800', label: '대기중' }
                };
                const config = statusConfig[status] || statusConfig.pending;
                return (
                    <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${config.bg} ${config.text}`}>
                        {config.label}
                    </span>
                );
            };

            const renderStars = (rating) => {
                if (!rating) return null;
                return (
                    <div className="flex items-center">
                        {[...Array(5)].map((_, i) => (
                            <svg
                                key={i}
                                className={`w-4 h-4 ${i < rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                        ))}
                        <span className="ml-1 text-sm text-gray-600">({rating}/5)</span>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    {/* 활동 통계 */}
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-semibold mb-4">내 활동 통계</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-2xl font-bold text-blue-600">{calculationHistory.length}</div>
                                <div className="text-sm text-gray-600">계산 결과</div>
                            </div>
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-2xl font-bold text-green-600">{bookingHistory.filter(b => b.status === 'completed').length}</div>
                                <div className="text-sm text-gray-600">완료된 상담</div>
                            </div>
                            <div className="text-center p-4 bg-purple-50 rounded-lg">
                                <div className="text-2xl font-bold text-purple-600">
                                    {paymentHistory.reduce((sum, p) => p.status === 'completed' ? sum + p.amount : sum, 0).toLocaleString()}원
                                </div>
                                <div className="text-sm text-gray-600">총 결제 금액</div>
                            </div>
                            <div className="text-center p-4 bg-orange-50 rounded-lg">
                                <div className="text-2xl font-bold text-orange-600">
                                    {calculationHistory.length > 0 && calculationHistory[0].totalAssets ? 
                                        Math.floor(calculationHistory[0].totalAssets / 100000000) : 0}억
                                </div>
                                <div className="text-sm text-gray-600">최신 총 자산</div>
                            </div>
                        </div>
                    </div>

                    {/* 서브탭 네비게이션 */}
                    <div className="bg-white rounded-lg shadow">
                        <div className="border-b border-gray-200">
                            <nav className="flex space-x-8 px-6">
                                {[
                                    { id: 'calculations', label: '📊 내 계산 결과' },
                                    { id: 'bookings', label: '💬 상담 내역' },
                                    { id: 'payments', label: '💳 결제 내역' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveSubTab(tab.id)}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                            activeSubTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        {tab.label}
                                    </button>
                                ))}
                            </nav>
                        </div>

                        <div className="p-6">
                            {loading ? (
                                <div className="text-center py-8">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <p className="mt-2 text-gray-600">로딩 중...</p>
                                </div>
                            ) : (
                                <>
                                    {/* 계산 결과 탭 */}
                                    {activeSubTab === 'calculations' && (
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center">
                                                <h3 className="text-lg font-semibold">저장된 계산 결과</h3>
                                                <button
                                                    onClick={() => {
                                                        // 계산기로 이동
                                                        setCurrentView('calculator');
                                                        onClose();
                                                    }}
                                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                                >
                                                    새 계산하기
                                                </button>
                                            </div>
                                            
                                            {calculationHistory.length === 0 ? (
                                                <div className="text-center py-12">
                                                    <div className="text-gray-400 text-6xl mb-4">📊</div>
                                                    <h4 className="text-lg font-semibold text-gray-900 mb-2">계산 결과가 없습니다</h4>
                                                    <p className="text-gray-600 mb-6">은퇴생활비를 계산해보세요!</p>
                                                    <button
                                                        onClick={() => {
                                                            setCurrentView('calculator');
                                                            onClose();
                                                        }}
                                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                                    >
                                                        계산하러 가기
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    {calculationHistory.map((calculation, index) => (
                                                        <div key={calculation.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                                            <div className="flex justify-between items-start mb-4">
                                                                <div>
                                                                    <div className="flex items-center space-x-2">
                                                                        <h4 className="text-lg font-semibold">
                                                                            {index === 0 ? '💫 최신' : `📋 ${index + 1}번째`} 계산
                                                                        </h4>
                                                                        {calculation.source === 'local' && (
                                                                            <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">로컬</span>
                                                                        )}
                                                                        {calculation.source === 'database' && (
                                                                            <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">클라우드</span>
                                                                        )}
                                                                    </div>
                                                                    <p className="text-sm text-gray-600 mt-1">
                                                                        계산일: {new Date(calculation.created_at).toLocaleDateString('ko-KR', {
                                                                            year: 'numeric',
                                                                            month: 'long',
                                                                            day: 'numeric',
                                                                            hour: '2-digit',
                                                                            minute: '2-digit'
                                                                        })}
                                                                    </p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-2xl font-bold text-blue-600">
                                                                        {calculation.formData?.age || 0}세
                                                                    </div>
                                                                    <div className="text-xs text-gray-500">
                                                                        {calculation.formData?.health || '정보없음'} 
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* 주요 결과 요약 */}
                                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                                                <div className="bg-blue-50 p-4 rounded-lg">
                                                                    <div className="text-sm text-blue-600 font-medium">총 자산</div>
                                                                    <div className="text-xl font-bold text-blue-900">
                                                                        {Math.floor((calculation.totalAssets || 0) / 10000).toLocaleString()}억원
                                                                    </div>
                                                                </div>
                                                                <div className="bg-green-50 p-4 rounded-lg">
                                                                    <div className="text-sm text-green-600 font-medium">월 생활비</div>
                                                                    <div className="text-xl font-bold text-green-900">
                                                                        {(calculation.monthlyLivingCost || 0).toLocaleString()}만원
                                                                    </div>
                                                                </div>
                                                                <div className="bg-purple-50 p-4 rounded-lg">
                                                                    <div className="text-sm text-purple-600 font-medium">자산 지속 기간</div>
                                                                    <div className="text-xl font-bold text-purple-900">
                                                                        {Math.round(calculation.assetSufficiencyYears || 0)}년
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* 상세 자산 정보 */}
                                                            {calculation.formData && (
                                                                <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                                                    <h5 className="font-medium text-gray-900 mb-3">입력한 자산 정보</h5>
                                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                        <div>
                                                                            <span className="text-gray-600">주택:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.housingValue || 0).toLocaleString()}만원</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">금융자산:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.financialAssets || 0).toLocaleString()}만원</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">퇴직금:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.severancePay || 0).toLocaleString()}만원</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">부채:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.debt || 0).toLocaleString()}만원</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">국민연금:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.nationalPension || 0).toLocaleString()}만원/월</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">사적연금:</span>
                                                                            <span className="ml-1 font-medium">{(calculation.formData.privatePension || 0).toLocaleString()}만원/월</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">주거형태:</span>
                                                                            <span className="ml-1 font-medium">{calculation.formData.housingType || '정보없음'}</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-gray-600">라이프스타일:</span>
                                                                            <span className="ml-1 font-medium">{calculation.formData.lifeMode || '정보없음'}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {/* 액션 버튼들 */}
                                                            <div className="flex space-x-3 pt-4 border-t border-gray-100">
                                                                <button
                                                                    onClick={() => {
                                                                        // 이 계산 결과로 계산기 복원
                                                                        if (calculation.formData) {
                                                                            setFormData(calculation.formData);
                                                                            setCalculatorResult(calculation);
                                                                            setCalculatorStep(4);
                                                                            setCurrentView('calculator');
                                                                            onClose();
                                                                            showNotification('계산 결과 복원', '선택한 계산 결과로 이동했습니다!', 'success');
                                                                        }
                                                                    }}
                                                                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                                                                >
                                                                    📊 이 계산으로 이동
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        // 이 계산 결과를 기반으로 새 계산 시작
                                                                        if (calculation.formData) {
                                                                            setFormData(calculation.formData);
                                                                            setCalculatorStep(1);
                                                                            setCurrentView('calculator');
                                                                            onClose();
                                                                            showNotification('새 계산 시작', '이전 정보로 새 계산을 시작합니다!', 'info');
                                                                        }
                                                                    }}
                                                                    className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
                                                                >
                                                                    🔄 이 정보로 새 계산
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* 상담 내역 탭 */}
                                    {activeSubTab === 'bookings' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-semibold">최근 활동</h3>
                                            <div className="space-y-3">
                                                {bookingHistory.slice(0, 3).map(booking => (
                                                    <div key={booking.id} className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                                        <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                                        <div className="flex-1">
                                                            <div className="text-sm font-medium">{booking.consultationType} - {booking.expertName}</div>
                                                            <div className="text-xs text-gray-500">{booking.date} {booking.time}</div>
                                                        </div>
                                                        {getStatusBadge(booking.status)}
                                                    </div>
                                                ))}
                                                {bookingHistory.length === 0 && (
                                                    <div className="text-center text-gray-500 py-4">
                                                        아직 상담 내역이 없습니다
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* 상담 내역 탭 */}
                                    {activeSubTab === 'bookings' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-semibold">전체 상담 내역</h3>
                                            <div className="space-y-4">
                                                {bookingHistory.map(booking => (
                                                    <div key={booking.id} className="border border-gray-200 rounded-lg p-4">
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div>
                                                                <h4 className="font-semibold text-lg">{booking.consultationType}</h4>
                                                                <p className="text-gray-600">전문가: {booking.expertName}</p>
                                                                <p className="text-sm text-gray-500">
                                                                    {booking.date} {booking.time} ({booking.duration}분)
                                                                </p>
                                                            </div>
                                                            <div className="text-right">
                                                                {getStatusBadge(booking.status)}
                                                                <p className="text-lg font-bold text-gray-900 mt-1">
                                                                    {booking.price.toLocaleString()}원
                                                                </p>
                                                            </div>
                                                        </div>
                                                        {booking.rating && (
                                                            <div className="mt-3 pt-3 border-t border-gray-100">
                                                                <div className="flex items-center justify-between">
                                                                    <div>
                                                                        <p className="text-sm font-medium">내 평가:</p>
                                                                        {renderStars(booking.rating)}
                                                                    </div>
                                                                </div>
                                                                {booking.review && (
                                                                    <p className="mt-2 text-sm text-gray-700 italic">"{booking.review}"</p>
                                                                )}
                                                            </div>
                                                        )}
                                                        {booking.status === 'scheduled' && (
                                                            <div className="mt-3 pt-3 border-t border-gray-100 flex space-x-2">
                                                                <button className="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                                                                    상담 준비하기
                                                                </button>
                                                                <button className="px-4 py-2 border border-gray-300 text-gray-700 text-sm rounded-md hover:bg-gray-50">
                                                                    일정 변경
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                                {bookingHistory.length === 0 && (
                                                    <div className="text-center text-gray-500 py-8">
                                                        <p>아직 상담 내역이 없습니다</p>
                                                        <button className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                            첫 상담 예약하기
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* 결제 내역 탭 */}
                                    {activeSubTab === 'payments' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-semibold">결제 내역</h3>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">결제일</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상담 유형</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">금액</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">결제 방법</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">거래번호</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {paymentHistory.map(payment => {
                                                            const booking = bookingHistory.find(b => b.id === payment.bookingId);
                                                            return (
                                                                <tr key={payment.id}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{payment.date}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                        {booking?.consultationType || '상담'}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                                        {payment.amount.toLocaleString()}원
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{payment.method}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap">{getStatusBadge(payment.status)}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                                                                        {payment.transactionId}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                {paymentHistory.length === 0 && (
                                                    <div className="text-center text-gray-500 py-8">
                                                        결제 내역이 없습니다
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 전문가 관리 탭
        const ExpertTab = ({ currentUser }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">전문가 대시보드</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="text-center p-4 bg-orange-50 rounded-lg">
                            <div className="text-2xl font-bold text-orange-600">8</div>
                            <div className="text-sm text-gray-600">총 상담 건수</div>
                        </div>
                        <div className="text-center p-4 bg-green-50 rounded-lg">
                            <div className="text-2xl font-bold text-green-600">4.8</div>
                            <div className="text-sm text-gray-600">평균 평점</div>
                        </div>
                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                            <div className="text-2xl font-bold text-blue-600">95%</div>
                            <div className="text-sm text-gray-600">응답률</div>
                        </div>
                    </div>
                </div>
                
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">예약 관리</h2>
                    <div className="text-center text-gray-500 py-8">
                        예약 관리 기능은 준비 중입니다
                    </div>
                </div>
            </div>
        );

        // 관리자 탭
        const AdminTab = ({ currentUser }) => {
            const [activeSection, setActiveSection] = useState('dashboard');
            const [stats, setStats] = useState({
                totalUsers: 156,
                totalExperts: 12,
                totalPosts: 234,
                completedCalculations: 89,
                totalRevenue: 2450000,
                pendingSettlements: 5,
                thisMonthRevenue: 890000,
                platformFee: 245000
            });

            return (
                <div className="space-y-6">
                    {/* 탭 메뉴 */}
                    <div className="bg-white rounded-lg shadow">
                        <div className="border-b border-gray-200">
                            <div className="flex space-x-8 px-6">
                                {[
                                    { id: 'dashboard', name: '대시보드', icon: '📊' },
                                    { id: 'settlements', name: '수수료 관리', icon: '💰' },
                                    { id: 'experts', name: '전문가 관리', icon: '🎯' },
                                    { id: 'users', name: '회원 관리', icon: '👥' }
                                ].map((tab) => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveSection(tab.id)}
                                        className={`py-4 px-2 border-b-2 font-medium text-sm transition-colors ${
                                            activeSection === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        {tab.icon} {tab.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6">
                            {activeSection === 'dashboard' && <AdminDashboard stats={stats} setActiveSection={setActiveSection} />}
                            {activeSection === 'settlements' && <FeeManagementSection currentUser={currentUser} />}
                            {activeSection === 'experts' && <ExpertManagementSection currentUser={currentUser} />}
                            {activeSection === 'users' && <UserManagementSection currentUser={currentUser} />}
                        </div>
                    </div>
                </div>
            );
        };

        // 관리자 대시보드 컴포넌트
        const AdminDashboard = ({ stats, setActiveSection }) => (
            <div className="space-y-6">
                <h2 className="text-xl font-semibold">📊 플랫폼 현황</h2>
                
                {/* 주요 지표 */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div className="text-center p-4 bg-red-50 rounded-lg">
                        <div className="text-2xl font-bold text-red-600">{stats.totalUsers}</div>
                        <div className="text-sm text-gray-600">전체 회원수</div>
                    </div>
                    <div className="text-center p-4 bg-orange-50 rounded-lg">
                        <div className="text-2xl font-bold text-orange-600">{stats.totalExperts}</div>
                        <div className="text-sm text-gray-600">등록된 전문가</div>
                    </div>
                    <div className="text-center p-4 bg-blue-50 rounded-lg">
                        <div className="text-2xl font-bold text-blue-600">{stats.totalPosts}</div>
                        <div className="text-sm text-gray-600">총 게시글</div>
                    </div>
                    <div className="text-center p-4 bg-green-50 rounded-lg">
                        <div className="text-2xl font-bold text-green-600">{stats.completedCalculations}</div>
                        <div className="text-sm text-gray-600">계산 완료</div>
                    </div>
                </div>

                {/* 수익 지표 */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div className="text-center p-4 bg-purple-50 rounded-lg">
                        <div className="text-2xl font-bold text-purple-600">{stats.totalRevenue.toLocaleString()}원</div>
                        <div className="text-sm text-gray-600">누적 거래액</div>
                    </div>
                    <div className="text-center p-4 bg-indigo-50 rounded-lg">
                        <div className="text-2xl font-bold text-indigo-600">{stats.thisMonthRevenue.toLocaleString()}원</div>
                        <div className="text-sm text-gray-600">이번 달 거래액</div>
                    </div>
                    <div className="text-center p-4 bg-emerald-50 rounded-lg">
                        <div className="text-2xl font-bold text-emerald-600">{stats.platformFee.toLocaleString()}원</div>
                        <div className="text-sm text-gray-600">플랫폼 수수료</div>
                    </div>
                    <div className="text-center p-4 bg-amber-50 rounded-lg">
                        <div className="text-2xl font-bold text-amber-600">{stats.pendingSettlements}</div>
                        <div className="text-sm text-gray-600">대기 중인 정산</div>
                    </div>
                </div>

                {/* 빠른 액션 */}
                <div className="bg-gray-50 rounded-lg p-4">
                    <h3 className="font-medium mb-4">📋 빠른 작업</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button className="p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-left text-sm">
                            <div className="font-medium text-blue-600">💰 정산 처리</div>
                            <div className="text-gray-500">대기 중인 정산 확인</div>
                        </button>
                        <button className="p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-left text-sm">
                            <div className="font-medium text-green-600">📊 월간 리포트</div>
                            <div className="text-gray-500">월간 수익 보고서 생성</div>
                        </button>
                        <button 
                            onClick={() => setActiveSection('experts')}
                            className="p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-left text-sm cursor-pointer hover:border-purple-300 transition-colors"
                        >
                            <div className="font-medium text-purple-600">👑 전문가 승인</div>
                            <div className="text-gray-500">신규 전문가 검토</div>
                        </button>
                    </div>
                </div>
            </div>
        );

        // 수수료 관리 섹션
        const FeeManagementSection = ({ currentUser }) => {
            const [settlements, setSettlements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedPeriod, setSelectedPeriod] = useState('current');
            const [showCreateSettlement, setShowCreateSettlement] = useState(false);

            // 정산 목록 로드
            const loadSettlements = async () => {
                try {
                    setLoading(true);
                    // 실제로는 Supabase에서 데이터를 가져옴
                    // const { data, error } = await supabase...
                    
                    // 샘플 데이터
                    const sampleSettlements = [
                        {
                            id: 1,
                            expert_id: 'expert1',
                            expert_name: '김전문가',
                            settlement_period: '2024-08',
                            total_bookings: 15,
                            total_revenue: 1500000,
                            platform_fee: 150000,
                            expert_payout: 1350000,
                            status: 'pending',
                            created_at: '2024-08-31T09:00:00Z'
                        },
                        {
                            id: 2,
                            expert_id: 'expert2',
                            expert_name: '이전문가',
                            settlement_period: '2024-08',
                            total_bookings: 8,
                            total_revenue: 800000,
                            platform_fee: 80000,
                            expert_payout: 720000,
                            status: 'completed',
                            created_at: '2024-08-25T14:30:00Z'
                        },
                        {
                            id: 3,
                            expert_id: 'expert3',
                            expert_name: '박전문가',
                            settlement_period: '2024-08',
                            total_bookings: 12,
                            total_revenue: 1200000,
                            platform_fee: 120000,
                            expert_payout: 1080000,
                            status: 'processing',
                            created_at: '2024-08-28T11:15:00Z'
                        }
                    ];
                    
                    setSettlements(sampleSettlements);
                } catch (error) {
                    console.error('정산 목록 로드 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            // 정산 승인
            const approveSettlement = async (settlementId) => {
                try {
                    // 실제로는 Supabase 업데이트
                    // await supabase.from('fee_settlements').update({ status: 'completed' }).eq('id', settlementId);
                    
                    alert('정산이 승인되었습니다.');
                    loadSettlements();
                } catch (error) {
                    console.error('정산 승인 오류:', error);
                    alert('정산 승인 중 오류가 발생했습니다.');
                }
            };

            // 정산 생성
            const createSettlement = async () => {
                try {
                    // 실제로는 정산 로직 실행
                    alert('정산이 생성되었습니다.');
                    setShowCreateSettlement(false);
                    loadSettlements();
                } catch (error) {
                    console.error('정산 생성 오류:', error);
                    alert('정산 생성 중 오류가 발생했습니다.');
                }
            };

            // 상태별 배지 색상
            const getStatusBadge = (status) => {
                switch (status) {
                    case 'pending':
                        return <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">승인 대기</span>;
                    case 'processing':
                        return <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">처리 중</span>;
                    case 'completed':
                        return <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">완료</span>;
                    case 'failed':
                        return <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">실패</span>;
                    default:
                        return <span className="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">{status}</span>;
                }
            };

            useEffect(() => {
                loadSettlements();
            }, []);

            if (loading) {
                return (
                    <div className="flex items-center justify-center py-12">
                        <div className="text-center">
                            <div className="text-4xl mb-4">💰</div>
                            <p className="text-gray-500">정산 데이터를 불러오는 중...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* 헤더 */}
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold">💰 수수료 관리</h2>
                        <div className="flex gap-3">
                            <select
                                value={selectedPeriod}
                                onChange={(e) => setSelectedPeriod(e.target.value)}
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="current">이번 달</option>
                                <option value="last">지난 달</option>
                                <option value="all">전체</option>
                            </select>
                            <button
                                onClick={() => setShowCreateSettlement(true)}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                ➕ 정산 생성
                            </button>
                        </div>
                    </div>

                    {/* 정산 요약 */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <div className="text-sm text-blue-600 font-medium">총 정산 건수</div>
                            <div className="text-2xl font-bold text-blue-700">{settlements.length}</div>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                            <div className="text-sm text-green-600 font-medium">완료된 정산</div>
                            <div className="text-2xl font-bold text-green-700">
                                {settlements.filter(s => s.status === 'completed').length}
                            </div>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <div className="text-sm text-yellow-600 font-medium">대기 중인 정산</div>
                            <div className="text-2xl font-bold text-yellow-700">
                                {settlements.filter(s => s.status === 'pending').length}
                            </div>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-lg">
                            <div className="text-sm text-purple-600 font-medium">총 플랫폼 수수료</div>
                            <div className="text-2xl font-bold text-purple-700">
                                {settlements.reduce((sum, s) => sum + s.platform_fee, 0).toLocaleString()}원
                            </div>
                        </div>
                    </div>

                    {/* 정산 목록 */}
                    <div className="bg-white rounded-lg border border-gray-200">
                        <div className="px-6 py-4 border-b border-gray-200">
                            <h3 className="font-medium text-gray-800">정산 내역</h3>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">전문가</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">정산 기간</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상담 건수</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">총 매출</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">플랫폼 수수료</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">전문가 수령액</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">액션</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {settlements.map((settlement) => (
                                        <tr key={settlement.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="font-medium text-gray-900">{settlement.expert_name}</div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {settlement.settlement_period}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {settlement.total_bookings}건
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {settlement.total_revenue.toLocaleString()}원
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {settlement.platform_fee.toLocaleString()}원
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                {settlement.expert_payout.toLocaleString()}원
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                {getStatusBadge(settlement.status)}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                                {settlement.status === 'pending' && (
                                                    <button
                                                        onClick={() => approveSettlement(settlement.id)}
                                                        className="text-green-600 hover:text-green-900 font-medium"
                                                    >
                                                        승인
                                                    </button>
                                                )}
                                                <button className="text-blue-600 hover:text-blue-900 font-medium">
                                                    상세
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* 정산 생성 모달 */}
                    {showCreateSettlement && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-gray-800">정산 생성</h3>
                                    <button
                                        onClick={() => setShowCreateSettlement(false)}
                                        className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    >
                                        ×
                                    </button>
                                </div>

                                <div className="space-y-4 mb-6">
                                    <p className="text-gray-600">
                                        이번 달 완료된 상담에 대한 정산을 생성하시겠습니까?
                                    </p>
                                    <div className="bg-blue-50 p-4 rounded-lg">
                                        <div className="text-sm space-y-1">
                                            <div>• 대상 기간: 2024년 8월</div>
                                            <div>• 처리 예상 시간: 5-10분</div>
                                            <div>• 정산 완료 후 전문가에게 자동 알림</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowCreateSettlement(false)}
                                        className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        취소
                                    </button>
                                    <button
                                        onClick={createSettlement}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        정산 생성
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 전문가 관리 섹션 - 완전 구현
        const ExpertManagementSection = ({ currentUser }) => {
            const [activeTab, setActiveTab] = useState('pending');
            const [experts, setExperts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [processingId, setProcessingId] = useState(null);
            const [selectedExpert, setSelectedExpert] = useState(null);
            const [showDetailModal, setShowDetailModal] = useState(false);
            const [actionReason, setActionReason] = useState('');

            // 전문가 목록 로드
            useEffect(() => {
                loadExperts();
            }, [activeTab]);

            const loadExperts = async () => {
                try {
                    setLoading(true);
                    if (supabase) {
                        const { data, error } = await supabase
                            .from('user_profiles')
                            .select('*')
                            .eq('role', 'expert')
                            .eq('expert_status', activeTab)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        setExperts(data || []);
                    } else {
                        // 데모 데이터
                        const demoExperts = [
                            {
                                id: 1,
                                user_id: 'expert1',
                                email: 'expert1@example.com',
                                nickname: '김재무전문가',
                                expert_type: 'legal',
                                expert_title: '공인회계사 • 세무사',
                                expert_specialties: ['세무상담', '자산관리', '절세전략'],
                                expert_credentials: ['공인회계사', '세무사', 'CFP'],
                                expert_experience_years: '15',
                                expert_bio: '15년 경력의 세무 전문가입니다. 개인 및 법인 세무 상담을 전문으로 합니다.',
                                expert_hourly_rate: '100000',
                                expert_phone: '010-1234-5678',
                                expert_business_license: 'BL-2024-001',
                                expert_qualification_number: 'CPA-12345',
                                expert_status: activeTab,
                                created_at: '2024-08-20T10:30:00Z',
                                expert_available_types: ['phone', 'video']
                            },
                            {
                                id: 2,
                                user_id: 'expert2',
                                email: 'expert2@example.com',
                                nickname: '박여행전문가',
                                expert_type: 'travel',
                                expert_title: '시니어 여행 플래너',
                                expert_specialties: ['시니어여행', '국내여행', '해외여행'],
                                expert_credentials: ['관광통역안내사', '여행상품기획사'],
                                expert_experience_years: '8',
                                expert_bio: '시니어 여행 전문 플래너로 안전하고 즐거운 여행을 기획합니다.',
                                expert_hourly_rate: '80000',
                                expert_phone: '010-9876-5432',
                                expert_business_license: '',
                                expert_qualification_number: 'TG-67890',
                                expert_status: activeTab,
                                created_at: '2024-08-19T14:20:00Z',
                                expert_available_types: ['phone', 'video', 'chat']
                            }
                        ];
                        setExperts(activeTab === 'pending' ? demoExperts : []);
                    }
                } catch (error) {
                    console.error('전문가 목록 로드 오류:', error);
                    setExperts([]);
                } finally {
                    setLoading(false);
                }
            };

            // 전문가 승인/거절 처리
            const handleExpertAction = async (expertId, action, reason = '') => {
                if (!confirm(`정말로 이 전문가를 ${action === 'approve' ? '승인' : '거절'}하시겠습니까?`)) {
                    return;
                }

                try {
                    setProcessingId(expertId);
                    const newStatus = action === 'approve' ? 'approved' : 'rejected';
                    
                    if (supabase) {
                        const { error } = await supabase
                            .from('user_profiles')
                            .update({ 
                                expert_status: newStatus,
                                expert_status_updated_at: new Date().toISOString(),
                                expert_status_reason: reason || (action === 'approve' ? '전문가 자격 요건을 충족합니다.' : '자격 요건 미달')
                            })
                            .eq('user_id', expertId);
                        
                        if (error) throw error;
                        
                        // 승인/거절 이메일 발송
                        const currentExpert = experts.find(e => e.user_id === expertId);
                        if (currentExpert) {
                            const emailResult = await sendExpertNotification(currentExpert, action, reason);
                            if (!emailResult.success) {
                                console.warn('이메일 발송 실패:', emailResult.message);
                            }
                        }
                    }
                    
                    alert(`전문가 ${action === 'approve' ? '승인' : '거절'} 처리가 완료되었습니다.`);
                    setActionReason('');
                    setShowDetailModal(false);
                    loadExperts(); // 목록 새로고침
                    
                } catch (error) {
                    console.error('전문가 상태 변경 오류:', error);
                    alert('처리 중 오류가 발생했습니다.');
                } finally {
                    setProcessingId(null);
                }
            };

            // 전문가 상세 정보 보기
            const showExpertDetail = (expert) => {
                setSelectedExpert(expert);
                setShowDetailModal(true);
            };

            const tabs = [
                { id: 'pending', name: '승인 대기', icon: '⏳', count: experts.filter(e => e.expert_status === 'pending').length },
                { id: 'approved', name: '승인됨', icon: '✅', count: experts.filter(e => e.expert_status === 'approved').length },
                { id: 'rejected', name: '거절됨', icon: '❌', count: experts.filter(e => e.expert_status === 'rejected').length },
                { id: 'all', name: '전체', icon: '📋', count: experts.length }
            ];

            return (
                <div className="space-y-6">
                    {/* 헤더 */}
                    <div className="flex items-center justify-between">
                        <h2 className="text-xl font-semibold">🎯 전문가 승인 관리</h2>
                        <div className="text-sm text-gray-500">
                            총 {experts.length}명의 전문가
                        </div>
                    </div>

                    {/* 탭 메뉴 */}
                    <div className="border-b border-gray-200">
                        <div className="flex space-x-8">
                            {tabs.map((tab) => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`py-2 px-1 border-b-2 font-medium text-sm transition-colors flex items-center space-x-2 ${
                                        activeTab === tab.id
                                            ? 'border-blue-500 text-blue-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    <span>{tab.icon}</span>
                                    <span>{tab.name}</span>
                                    {activeTab !== 'all' && (
                                        <span className={`px-2 py-0.5 text-xs rounded-full ${
                                            activeTab === tab.id ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-500'
                                        }`}>
                                            {experts.length}
                                        </span>
                                    )}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* 전문가 목록 */}
                    {loading ? (
                        <div className="text-center py-12">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p className="mt-2 text-gray-500">전문가 목록을 불러오는 중...</p>
                        </div>
                    ) : experts.length === 0 ? (
                        <div className="text-center py-12 text-gray-500">
                            <div className="text-4xl mb-4">📝</div>
                            <p>{activeTab === 'pending' ? '승인 대기 중인 전문가가 없습니다.' : '해당하는 전문가가 없습니다.'}</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {experts.map((expert) => (
                                <div key={expert.id || expert.user_id} className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            {/* 기본 정보 */}
                                            <div className="flex items-center space-x-3 mb-3">
                                                <div className="w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center">
                                                    <span className="text-white font-bold text-lg">🎯</span>
                                                </div>
                                                <div>
                                                    <h3 className="text-lg font-semibold text-gray-800">{expert.nickname}</h3>
                                                    <p className="text-orange-600 font-medium">{expert.expert_title}</p>
                                                    <p className="text-sm text-gray-500">{expert.email}</p>
                                                </div>
                                                <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                                                    expert.expert_status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                    expert.expert_status === 'approved' ? 'bg-green-100 text-green-800' :
                                                    'bg-red-100 text-red-800'
                                                }`}>
                                                    {expert.expert_status === 'pending' ? '⏳ 승인대기' :
                                                     expert.expert_status === 'approved' ? '✅ 승인완료' : '❌ 거절됨'}
                                                </div>
                                            </div>

                                            {/* 전문 정보 */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                                <div>
                                                    <label className="text-xs text-gray-500 uppercase tracking-wide">카테고리</label>
                                                    <p className="text-sm font-medium">
                                                        {expert.expert_type === 'legal' ? '📋 세무/법무/자산관리' :
                                                         expert.expert_type === 'travel' ? '✈️ 여행/취미' : '🏠 주거/생활'}
                                                    </p>
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-500 uppercase tracking-wide">경력</label>
                                                    <p className="text-sm font-medium">{expert.expert_experience_years}년</p>
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-500 uppercase tracking-wide">상담료</label>
                                                    <p className="text-sm font-medium">{Number(expert.expert_hourly_rate).toLocaleString()}원/시간</p>
                                                </div>
                                            </div>

                                            {/* 전문분야 */}
                                            <div className="mb-3">
                                                <label className="text-xs text-gray-500 uppercase tracking-wide">전문분야</label>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {expert.expert_specialties.map((specialty, index) => (
                                                        <span key={index} className="px-2 py-1 bg-blue-50 text-blue-600 text-xs rounded-full">
                                                            {specialty}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* 자격증 */}
                                            <div className="mb-4">
                                                <label className="text-xs text-gray-500 uppercase tracking-wide">자격증</label>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {expert.expert_credentials.map((credential, index) => (
                                                        <span key={index} className="px-2 py-1 bg-green-50 text-green-600 text-xs rounded-full">
                                                            {credential}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* 등록일 */}
                                            <p className="text-xs text-gray-500">
                                                등록일: {new Date(expert.created_at).toLocaleDateString('ko-KR')}
                                            </p>
                                        </div>

                                        {/* 액션 버튼 */}
                                        <div className="flex flex-col space-y-2 ml-4">
                                            <button
                                                onClick={() => showExpertDetail(expert)}
                                                className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-lg transition-colors"
                                            >
                                                📋 상세보기
                                            </button>
                                            
                                            {expert.expert_status === 'pending' && (
                                                <>
                                                    <button
                                                        onClick={() => handleExpertAction(expert.user_id, 'approve')}
                                                        disabled={processingId === expert.user_id}
                                                        className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition-colors disabled:bg-gray-400"
                                                    >
                                                        {processingId === expert.user_id ? '처리중...' : '✅ 승인'}
                                                    </button>
                                                    <button
                                                        onClick={() => handleExpertAction(expert.user_id, 'reject')}
                                                        disabled={processingId === expert.user_id}
                                                        className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors disabled:bg-gray-400"
                                                    >
                                                        {processingId === expert.user_id ? '처리중...' : '❌ 거절'}
                                                    </button>
                                                </>
                                            )}
                                            
                                            {expert.expert_status === 'approved' && (
                                                <button
                                                    onClick={() => handleExpertAction(expert.user_id, 'reject')}
                                                    disabled={processingId === expert.user_id}
                                                    className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded-lg transition-colors disabled:bg-gray-400"
                                                >
                                                    🔄 승인취소
                                                </button>
                                            )}
                                            
                                            {expert.expert_status === 'rejected' && (
                                                <button
                                                    onClick={() => handleExpertAction(expert.user_id, 'approve')}
                                                    disabled={processingId === expert.user_id}
                                                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition-colors disabled:bg-gray-400"
                                                >
                                                    🔄 재승인
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* 전문가 상세 모달 */}
                    {showDetailModal && selectedExpert && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl max-w-2xl w-full max-h-90vh overflow-y-auto">
                                <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                                    <h3 className="text-lg font-semibold">전문가 상세 정보</h3>
                                    <button
                                        onClick={() => setShowDetailModal(false)}
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="p-6 space-y-6">
                                    {/* 기본 정보 */}
                                    <div>
                                        <h4 className="font-medium text-gray-900 mb-3">👤 기본 정보</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-sm text-gray-500">이메일</label>
                                                <p className="font-medium">{selectedExpert.email}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">닉네임</label>
                                                <p className="font-medium">{selectedExpert.nickname}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">전화번호</label>
                                                <p className="font-medium">{selectedExpert.expert_phone}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">사업자등록번호</label>
                                                <p className="font-medium">{selectedExpert.expert_business_license || '개인 전문가'}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 전문가 정보 */}
                                    <div>
                                        <h4 className="font-medium text-gray-900 mb-3">🎯 전문가 정보</h4>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="text-sm text-gray-500">전문가 타이틀</label>
                                                <p className="font-medium text-orange-600">{selectedExpert.expert_title}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">경력</label>
                                                <p className="font-medium">{selectedExpert.expert_experience_years}년</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">자기소개</label>
                                                <p className="text-gray-700 whitespace-pre-wrap">{selectedExpert.expert_bio}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">시간당 상담료</label>
                                                <p className="font-medium text-green-600">{Number(selectedExpert.expert_hourly_rate).toLocaleString()}원</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">상담 가능 방식</label>
                                                <div className="flex gap-2 mt-1">
                                                    {selectedExpert.expert_available_types.map((type) => (
                                                        <span key={type} className="px-2 py-1 bg-blue-50 text-blue-600 text-sm rounded">
                                                            {type === 'phone' ? '📞 전화' : type === 'video' ? '📹 영상' : '💬 채팅'}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 자격 정보 */}
                                    <div>
                                        <h4 className="font-medium text-gray-900 mb-3">📜 자격 정보</h4>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="text-sm text-gray-500">자격증번호</label>
                                                <p className="font-medium">{selectedExpert.expert_qualification_number}</p>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">전문분야</label>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {selectedExpert.expert_specialties.map((specialty, index) => (
                                                        <span key={index} className="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
                                                            {specialty}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-500">보유 자격증</label>
                                                <div className="flex flex-wrap gap-2 mt-1">
                                                    {selectedExpert.expert_credentials.map((credential, index) => (
                                                        <span key={index} className="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">
                                                            {credential}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 승인/거절 처리 */}
                                    {selectedExpert.expert_status === 'pending' && (
                                        <div className="border-t pt-6">
                                            <h4 className="font-medium text-gray-900 mb-3">⚡ 승인 처리</h4>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm text-gray-500 mb-1">처리 사유</label>
                                                    <textarea
                                                        value={actionReason}
                                                        onChange={(e) => setActionReason(e.target.value)}
                                                        placeholder="승인 또는 거절 사유를 입력하세요..."
                                                        className="w-full p-3 border border-gray-200 rounded-lg resize-none"
                                                        rows="3"
                                                    />
                                                </div>
                                                <div className="flex space-x-3">
                                                    <button
                                                        onClick={() => handleExpertAction(selectedExpert.user_id, 'approve', actionReason)}
                                                        disabled={processingId === selectedExpert.user_id}
                                                        className="flex-1 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors disabled:bg-gray-400"
                                                    >
                                                        ✅ 승인하기
                                                    </button>
                                                    <button
                                                        onClick={() => handleExpertAction(selectedExpert.user_id, 'reject', actionReason)}
                                                        disabled={processingId === selectedExpert.user_id}
                                                        className="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:bg-gray-400"
                                                    >
                                                        ❌ 거절하기
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 회원 관리 섹션 (기본 구현)  
        const UserManagementSection = ({ currentUser }) => (
            <div className="space-y-6">
                <h2 className="text-xl font-semibold">👥 회원 관리</h2>
                <div className="text-center py-12 text-gray-500">
                    <div className="text-4xl mb-4">🔧</div>
                    <p>회원 관리 기능이 곧 추가될 예정입니다.</p>
                </div>
            </div>
        );

        // 회원가입/로그인 컴포넌트
        const AuthComponent = ({ onAuthSuccess, initialMode = 'login', generateGuestUser }) => {
            const [isLogin, setIsLogin] = useState(initialMode === 'login');
            const [authMode, setAuthMode] = useState(initialMode); // 'login', 'signup', 'expert'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [generatedNickname, setGeneratedNickname] = useState('');
            const [customNickname, setCustomNickname] = useState('');
            const [useCustomNickname, setUseCustomNickname] = useState(false);
            const [privacyConsent, setPrivacyConsent] = useState(false);
            const [expertPrivacyConsent, setExpertPrivacyConsent] = useState(false); // 전문가 등록 전용
            
            // 전문가 등록 관련 상태
            const [expertProfile, setExpertProfile] = useState({
                name: '',
                title: '',
                expertType: 'travel',
                experienceYears: '',
                bio: '',
                specialties: [],
                credentials: [],
                hourlyRate: '',
                consultationDuration: 60,
                phone: '',
                businessLicense: '',
                qualificationNumber: '',
                availableTypes: ['phone']
            });
            const [specialtyInput, setSpecialtyInput] = useState('');
            const [credentialInput, setCredentialInput] = useState('');
            const [currentStep, setCurrentStep] = useState(1); // 전문가 등록 단계

            useEffect(() => {
                if (!isLogin) {
                    // 회원가입 모드일 때 닉네임 미리보기 생성
                    const nickname = authManager.nicknameGen.generate();
                    setGeneratedNickname(nickname);
                }
            }, [isLogin]);

            // 전문가 카테고리 정의
            const expertCategories = {
                'travel': { name: '여행/취미', icon: '✈️', description: '시니어 여행 및 취미 활동 전문가' },
                'legal': { name: '세무/법무/자산관리', icon: '📋', description: '세무, 법무, 자산관리 전문가 (상담만)' },
                'living': { name: '주거/생활', icon: '🏠', description: '주거 및 생활환경 설계 전문가' }
            };

            // 전문가 프로필 업데이트 함수
            const updateExpertProfile = (field, value) => {
                setExpertProfile(prev => ({ ...prev, [field]: value }));
            };

            // 전문분야 추가
            const addSpecialty = () => {
                if (specialtyInput.trim() && !expertProfile.specialties.includes(specialtyInput.trim())) {
                    updateExpertProfile('specialties', [...expertProfile.specialties, specialtyInput.trim()]);
                    setSpecialtyInput('');
                }
            };

            // 자격증 추가
            const addCredential = () => {
                if (credentialInput.trim() && !expertProfile.credentials.includes(credentialInput.trim())) {
                    updateExpertProfile('credentials', [...expertProfile.credentials, credentialInput.trim()]);
                    setCredentialInput('');
                }
            };

            // 전문분야 제거
            const removeSpecialty = (index) => {
                const newSpecialties = expertProfile.specialties.filter((_, i) => i !== index);
                updateExpertProfile('specialties', newSpecialties);
            };

            // 자격증 제거
            const removeCredential = (index) => {
                const newCredentials = expertProfile.credentials.filter((_, i) => i !== index);
                updateExpertProfile('credentials', newCredentials);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                try {
                    if (authMode === 'login') {
                        // 로그인
                        const result = await authManager.signIn(email, password);
                        if (result.success) {
                            onAuthSuccess(result.user);
                        } else {
                            setError(result.error);
                        }
                    } else if (authMode === 'signup') {
                        // 일반 회원가입
                        if (password !== confirmPassword) {
                            setError('비밀번호가 일치하지 않습니다');
                            return;
                        }
                        // 비밀번호 보안 검증 (표준 준수)
                        const passwordValidation = validatePassword(password);
                        if (!passwordValidation.isValid) {
                            setError('비밀번호는 8자 이상이며, 영문/숫자/특수문자 중 2종류 이상 조합이어야 합니다');
                            return;
                        }
                        
                        // 닉네임 검증
                        const finalNickname = useCustomNickname ? customNickname.trim() : generatedNickname;
                        if (!finalNickname) {
                            setError('닉네임을 입력해주세요');
                            return;
                        }
                        if (useCustomNickname) {
                            if (finalNickname.length < 2 || finalNickname.length > 20) {
                                setError('닉네임은 2-20자로 입력해주세요');
                                return;
                            }
                            if (!/^[가-힣a-zA-Z0-9]+$/.test(finalNickname)) {
                                setError('닉네임은 한글, 영문, 숫자만 사용 가능합니다');
                                return;
                            }
                        }
                        if (!privacyConsent) {
                            setError('개인정보 수집·이용에 동의해주세요');
                            return;
                        }

                        const result = await authManager.signUp(email, password, finalNickname);
                        if (result.success) {
                            setError('');
                            showNotification('회원가입 완료!', `🎉 환영합니다, ${finalNickname}님!\n✨ 바로 서비스를 이용하실 수 있습니다.\n📊 은퇴생활비 계산과 커뮤니티 참여가 가능합니다.`, 'success');
                            setAuthMode('login');
                            setIsLogin(true);
                        } else {
                            setError(result.error);
                        }
                    } else if (authMode === 'expert') {
                        // 전문가 등록
                        await handleExpertRegistration();
                    }
                } catch (err) {
                    setError('처리 중 오류가 발생했습니다');
                }
            };

            const handleExpertRegistration = async () => {
                if (currentStep === 1) {
                    // 1단계: 기본 정보 검증만 수행 (회원가입은 하지 않음)
                    if (password !== confirmPassword) {
                        setError('비밀번호가 일치하지 않습니다');
                        return;
                    }
                    const passwordValidation = validatePassword(password);
                    if (!passwordValidation.isValid) {
                        setError('비밀번호는 8자 이상이며, 영문/숫자/특수문자 중 2종류 이상 조합이어야 합니다');
                        return;
                    }
                    if (!expertPrivacyConsent) {
                        setError('개인정보 수집·이용에 동의해주세요');
                        return;
                    }
                    if (!expertProfile.phone) {
                        setError('휴대폰 번호를 입력해주세요');
                        return;
                    }
                    if (!/^010-\d{4}-\d{4}$/.test(expertProfile.phone)) {
                        setError('휴대폰 번호는 010-1234-5678 형식으로 입력해주세요');
                        return;
                    }

                    // 이메일 중복 체크
                    const emailCheck = await authManager.checkEmail(email);
                    if (!emailCheck.success) {
                        setError(emailCheck.error);
                        return;
                    }

                    // 1단계 통과 - 2단계로 이동 (아직 회원가입은 하지 않음)
                    setCurrentStep(2);
                    setError('');
                    
                    // 2단계로 이동할 때 스크롤을 상단으로 이동
                    setTimeout(() => {
                        window.scrollTo({ 
                            top: 0, 
                            behavior: 'smooth' 
                        });
                    }, 100);
                    
                } else if (currentStep === 2) {
                    // 2단계: 전문가 프로필 완전 검증 및 등록
                    if (!expertProfile.name || !expertProfile.title || !expertProfile.experienceYears) {
                        setError('모든 필수 항목을 입력해주세요');
                        return;
                    }
                    if (!expertProfile.expertType) {
                        setError('전문분야를 선택해주세요');
                        return;
                    }
                    if (expertProfile.credentials.length === 0) {
                        setError('자격증/경력을 최소 1개 이상 입력해주세요');
                        return;
                    }
                    
                    
                    // 상담 방식 검증
                    if (expertProfile.availableTypes.length === 0) {
                        setError('제공 가능한 상담 방식을 최소 1개 이상 선택해주세요');
                        return;
                    }

                    // 엄격한 검증 추가
                    if (!expertProfile.businessLicense && !expertProfile.qualificationNumber) {
                        setError('사업자등록증 또는 자격증번호 중 하나는 필수로 입력해야 합니다');
                        return;
                    }
                    
                    // 사업자등록번호 입력 시 사업자등록증 파일 필수 검증
                    if (expertProfile.businessLicense && expertProfile.businessLicense.length >= 10 && !expertProfile.businessLicenseFile) {
                        setError('사업자등록번호를 입력하신 경우 사업자등록증 파일을 업로드해주세요');
                        return;
                    }
                    
                    if (parseInt(expertProfile.experienceYears) < 1) {
                        setError('최소 1년 이상의 경력이 필요합니다');
                        return;
                    }


                    // 사업자등록번호 형식 검증
                    if (expertProfile.businessLicense) {
                        const businessNumber = expertProfile.businessLicense.replace(/[^0-9]/g, '');
                        if (businessNumber.length !== 10) {
                            setError('사업자등록번호는 10자리 숫자로 입력해주세요');
                            return;
                        }
                        // 검증용으로 정규화된 형식으로 저장
                        const formatted = `${businessNumber.slice(0,3)}-${businessNumber.slice(3,5)}-${businessNumber.slice(5,10)}`;
                        updateExpertProfile('businessLicense', formatted);
                    }

                    // 휴대폰 번호 형식 검증
                    if (!/^010-\d{4}-\d{4}$/.test(expertProfile.phone)) {
                        setError('휴대폰 번호는 010-1234-5678 형식으로 입력해주세요');
                        return;
                    }

                    try {
                        // 이제 실제 회원가입 수행
                        const signUpResult = await authManager.signUp(email, password, expertProfile.name);
                        if (!signUpResult.success) {
                            setError(signUpResult.error);
                            return;
                        }

                        // 전문가 프로필 저장 (검토 대기 상태)
                        const { data: expertData, error: expertError } = await supabase
                            .from('financial_experts')
                            .insert({
                                email: email,
                                name: expertProfile.name,
                                phone: expertProfile.phone,
                                title: expertProfile.title,
                                category: expertProfile.category,
                                specialties: expertProfile.specialties,
                                bio: expertProfile.bio,
                                experience_years: parseInt(expertProfile.experienceYears),
                                credentials: expertProfile.credentials,
                                business_license: expertProfile.businessLicense || null,
                                qualification_number: expertProfile.qualificationNumber || null,
                                available_types: expertProfile.availableTypes,
                                verification_status: 'pending'
                            })
                            .select()
                            .single();

                        if (expertError) {
                            throw new Error('전문가 프로필 저장 실패: ' + expertError.message);
                        }

                        console.log('전문가 프로필 저장 완료:', expertData);
                        
                        showNotification('전문가 등록 신청 완료!', `📝 ${expertProfile.name}님의 전문가 등록 신청이 접수되었습니다.\n\n🔍 제출하신 서류를 검토 중입니다.\n📧 승인 결과를 이메일로 알려드릴게요.\n\n⏰ 검토 기간: 영업일 기준 3-5일`, 'success');
                        setAuthMode('login');
                        setCurrentStep(1);
                        resetExpertForm();
                    } catch (error) {
                        setError('전문가 등록 처리 중 오류가 발생했습니다');
                    }
                }
            };

            // 전문가 폼 초기화
            const resetExpertForm = () => {
                setExpertProfile({
                    name: '',
                    title: '',
                    expertType: 'travel',
                    experienceYears: '',
                    bio: '',
                    specialties: [],
                    credentials: [],
                    hourlyRate: '',
                    consultationDuration: 60,
                    phone: '',
                    businessLicense: '',
                    qualificationNumber: '',
                    availableTypes: ['phone']
                });
                setEmail('');
                setPassword('');
                setConfirmPassword('');
                setPrivacyConsent(false);
                setSpecialtyInput('');
                setCredentialInput('');
            };

            const regenerateNickname = () => {
                const newNickname = authManager.nicknameGen.generate();
                setGeneratedNickname(newNickname);
            };

            // 전문가 등록 UI 렌더링
            if (authMode === 'expert') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                        <div className="max-w-2xl w-full space-y-8">
                            <div className="text-center">
                                <div className="mb-6">
                                    <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-full mx-auto flex items-center justify-center">
                                        <span className="text-white font-bold text-xl">🎯</span>
                                    </div>
                                </div>
                                <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                    전문가 등록
                                </h1>
                                <p className="text-xl text-gray-600 mb-8">
                                    {currentStep === 1 ? '기본 정보 입력' : '전문가 프로필 등록'}
                                </p>
                                <div className="flex justify-center space-x-4 mb-8">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${currentStep >= 1 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>1</div>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${currentStep >= 2 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>2</div>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <form className="space-y-6" onSubmit={handleSubmit}>
                                    {currentStep === 1 ? (
                                        // 1단계: 기본 회원가입
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">실명 *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={expertProfile.name}
                                                    onChange={(e) => updateExpertProfile('name', e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="실명을 입력하세요"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">전문가 인증을 위해 실명이 필요합니다</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">이메일 *</label>
                                                <input
                                                    type="email"
                                                    required
                                                    value={email}
                                                    onChange={(e) => setEmail(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="이메일 주소"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">휴대폰 번호 *</label>
                                                <input
                                                    type="tel"
                                                    required
                                                    value={expertProfile.phone}
                                                    onChange={(e) => {
                                                        const formatted = formatPhoneNumber(e.target.value);
                                                        updateExpertProfile('phone', formatted);
                                                    }}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="010-1234-5678"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">본인 확인 및 상담 예약 연락용</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">비밀번호 *</label>
                                                <input
                                                    type="password"
                                                    required
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="비밀번호"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">비밀번호 확인 *</label>
                                                <input
                                                    type="password"
                                                    required
                                                    value={confirmPassword}
                                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="비밀번호 확인"
                                                />
                                            </div>

                                            
                                            <ExpertPrivacyConsentComponent 
                                                checked={expertPrivacyConsent}
                                                onChange={setExpertPrivacyConsent}
                                            />
                                        </div>
                                    ) : (
                                        // 2단계: 전문가 프로필
                                        <ExpertProfileForm 
                                            expertProfile={expertProfile}
                                            updateExpertProfile={updateExpertProfile}
                                            expertCategories={expertCategories}
                                            specialtyInput={specialtyInput}
                                            setSpecialtyInput={setSpecialtyInput}
                                            credentialInput={credentialInput}
                                            setCredentialInput={setCredentialInput}
                                            addSpecialty={addSpecialty}
                                            addCredential={addCredential}
                                            removeSpecialty={removeSpecialty}
                                            removeCredential={removeCredential}
                                        />
                                    )}
                                    
                                    {error && (
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                            <p className="text-red-800 text-sm">{error}</p>
                                        </div>
                                    )}
                                    
                                    <div className="flex space-x-4">
                                        {currentStep === 2 && (
                                            <button
                                                type="button"
                                                onClick={() => setCurrentStep(1)}
                                                className="w-full py-3 px-4 border border-gray-300 text-lg font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50"
                                            >
                                                이전 단계
                                            </button>
                                        )}
                                        <button
                                            type="submit"
                                            className="w-full py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-orange-600 hover:bg-orange-700"
                                        >
                                            {currentStep === 1 ? '다음 단계' : '전문가 등록 완료'}
                                        </button>
                                    </div>
                                    
                                    <div className="text-center">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setAuthMode('login');
                                                setCurrentStep(1);
                                                setError('');
                                            }}
                                            className="text-orange-600 hover:text-orange-500 text-sm font-medium"
                                        >
                                            일반 로그인으로 돌아가기
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-md w-full space-y-8">
                        <div className="text-center">
                            {/* 로고 자리 - PB 로고 */}
                            <div className="mb-6">
                                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mx-auto flex items-center justify-center">
                                    <span className="text-white font-bold text-xl">PB</span>
                                </div>
                            </div>
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                플랜비
                            </h1>
                            <p className="text-xl text-gray-600 mb-6">
                                행복한 은퇴생활의 시작
                            </p>
                            
                        </div>
                        
                        {/* 로그인/회원가입 폼 */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <form className="space-y-6" onSubmit={handleSubmit}>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                                        이메일
                                    </label>
                                    <input
                                        id="email"
                                        name="email"
                                        type="email"
                                        required
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                        placeholder="이메일 주소"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                                        비밀번호
                                    </label>
                                    <input
                                        id="password"
                                        name="password"
                                        type="password"
                                        required
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                        placeholder="비밀번호"
                                    />
                                    {authMode === 'signup' && (
                                        <div className="mt-2 text-xs text-gray-500">
                                            <p className="mb-1">비밀번호 요구사항:</p>
                                            <ul className="space-y-0.5">
                                                {(() => {
                                                    const validation = validatePassword(password);
                                                    return (
                                                        <>
                                                            <li className={`flex items-center ${validation.checks.length ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.length ? '✓' : '○'}</span>
                                                                8자 이상
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasLetter ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasLetter ? '✓' : '○'}</span>
                                                                영문 포함
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasNumber ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasNumber ? '✓' : '○'}</span>
                                                                숫자 포함
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasSpecial ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasSpecial ? '✓' : '○'}</span>
                                                                특수문자 포함
                                                            </li>
                                                            <li className={`flex items-center text-xs mt-1 ${validation.typeCount >= 2 ? 'text-green-600' : 'text-orange-500'}`}>
                                                                <span className="mr-2">{validation.typeCount >= 2 ? '✓' : '!'}</span>
                                                                영문, 숫자, 특수문자 중 2종류 이상 조합 필수
                                                            </li>
                                                        </>
                                                    );
                                                })()}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                                {authMode === 'signup' && (
                                    <>
                                        <div>
                                            <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">
                                                비밀번호 확인
                                            </label>
                                            <input
                                                id="confirmPassword"
                                                name="confirmPassword"
                                                type="password"
                                                required
                                                value={confirmPassword}
                                                onChange={(e) => setConfirmPassword(e.target.value)}
                                                className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                                placeholder="비밀번호 확인"
                                            />
                                        </div>
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <h4 className="text-sm font-medium text-blue-800 mb-3">닉네임 선택</h4>
                                            
                                            {/* 닉네임 선택 옵션 */}
                                            <div className="space-y-3">
                                                {/* 자동 생성 닉네임 옵션 */}
                                                <label className="flex items-center space-x-3 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="nicknameOption"
                                                        checked={!useCustomNickname}
                                                        onChange={() => setUseCustomNickname(false)}
                                                        onClick={() => setUseCustomNickname(false)}
                                                        className="h-4 w-4 text-blue-600 border-2 border-gray-300 focus:ring-blue-500"
                                                    />
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between">
                                                            <div>
                                                                <span className="text-sm font-medium text-blue-800">자동 생성</span>
                                                                <p className="text-lg font-bold text-blue-900">{generatedNickname}</p>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={regenerateNickname}
                                                                className="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm font-medium transition-colors"
                                                            >
                                                                🎲 다시생성
                                                            </button>
                                                        </div>
                                                    </div>
                                                </label>
                                                
                                                {/* 직접 입력 닉네임 옵션 */}
                                                <label className="flex items-start space-x-3 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="nicknameOption"
                                                        checked={useCustomNickname}
                                                        onChange={() => setUseCustomNickname(true)}
                                                        onClick={() => setUseCustomNickname(true)}
                                                        className="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 focus:ring-blue-500"
                                                    />
                                                    <div className="flex-1">
                                                        <span className="text-sm font-medium text-blue-800">직접 입력</span>
                                                        <input
                                                            type="text"
                                                            value={customNickname}
                                                            onChange={(e) => setCustomNickname(e.target.value)}
                                                            disabled={!useCustomNickname}
                                                            placeholder="원하는 닉네임을 입력하세요"
                                                            className={`mt-1 w-full px-3 py-2 border rounded-lg text-sm ${
                                                                useCustomNickname 
                                                                    ? 'border-blue-300 focus:border-blue-500 focus:ring-blue-500' 
                                                                    : 'border-gray-200 bg-gray-50 text-gray-400'
                                                            }`}
                                                        />
                                                        {useCustomNickname && (
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                2-20자, 한글/영문/숫자 사용 가능
                                                            </p>
                                                        )}
                                                    </div>
                                                </label>
                                            </div>
                                            
                                            <p className="text-xs text-blue-600 mt-3">💡 가입 후 언제든지 변경할 수 있어요</p>
                                        </div>
                                        
                                        {/* 개인정보 수집·이용 동의서 */}
                                        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <h4 className="text-sm font-medium text-gray-800 mb-3">개인정보 수집·이용 동의</h4>
                                            <div className="bg-white border border-gray-200 rounded p-3 text-xs text-gray-600 mb-3 max-h-32 overflow-y-auto">
                                                <div className="space-y-2">
                                                    <div>
                                                        <strong className="text-gray-800">■ 수집하는 개인정보 항목</strong>
                                                        <p>- 이메일 주소, 닉네임</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 개인정보 수집 및 이용목적</strong>
                                                        <p>- 회원 가입 및 관리</p>
                                                        <p>- 서비스 제공 및 본인확인</p>
                                                        <p>- 계산 결과 저장 및 커뮤니티 이용</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 개인정보 보유 및 이용기간</strong>
                                                        <p>- 회원탈퇴 시까지</p>
                                                        <p>- 단, 관계법령에 의해 보존할 필요가 있는 경우 해당 기간까지</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 동의 거부 권리</strong>
                                                        <p>- 개인정보 수집·이용에 대한 동의를 거부할 권리가 있습니다</p>
                                                        <p>- 다만, 동의 거부 시 서비스 이용이 제한될 수 있습니다</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <PrivacyConsentCheckbox 
                                                checked={privacyConsent}
                                                onChange={setPrivacyConsent}
                                            />
                                        </div>
                                    </>
                                )}
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}

                            <div>
                                <button
                                    type="submit"
                                    className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    {authMode === 'login' ? '로그인' : '회원가입'}
                                </button>
                            </div>

                            <div className="text-center">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setAuthMode(authMode === 'login' ? 'signup' : 'login');
                                        setIsLogin(authMode !== 'login');
                                        setError('');
                                        setEmail('');
                                        setPassword('');
                                        setConfirmPassword('');
                                        setPrivacyConsent(false);
                                        setCustomNickname('');
                                        setUseCustomNickname(false);
                                    }}
                                    className="text-blue-600 hover:text-blue-500 text-sm font-medium"
                                >
                                    {authMode === 'login' ? '계정이 없으신가요? 회원가입' : '이미 계정이 있으신가요? 로그인'}
                                </button>
                            </div>
                            </form>
                        </div>
                        
                        <div className="flex items-center text-sm text-gray-500 mb-6">
                            <div className="flex-grow border-t border-gray-300"></div>
                            <span className="mx-4">또는</span>
                            <div className="flex-grow border-t border-gray-300"></div>
                        </div>
                        
                        {/* 게스트로 이용해보기 */}
                        <div className="text-center space-y-3">
                            <button
                                onClick={() => onAuthSuccess(generateGuestUser())}
                                className="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-300"
                            >
                                🧮 게스트로 이용해보기
                            </button>
                            <p className="text-center text-sm text-gray-500">
                                회원가입 없이 계산기만 이용 (커뮤니티 이용 불가)
                            </p>
                        </div>
                        
                        {/* 전문가 등록 */}
                        <div className="flex items-center text-sm text-gray-500 mb-6">
                            <div className="flex-grow border-t border-gray-300"></div>
                            <span className="mx-4">전문가이신가요?</span>
                            <div className="flex-grow border-t border-gray-300"></div>
                        </div>
                        
                        <div className="text-center">
                            <button
                                onClick={() => setAuthMode('expert')}
                                className="group relative w-full flex justify-center py-3 px-4 border-2 border-orange-500 text-base font-medium rounded-lg text-orange-600 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-300"
                            >
                                🎯 전문가로 등록하기
                            </button>
                            <p className="text-center text-sm text-gray-500 mt-2">
                                여행/취미, 세무/법무, 주거/생활 전문가 모집
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // 블라인드식 커뮤니티 앱
        const CommunityApp = ({ setCurrentView, currentUser, checkCalculationForInteraction, handlePostClick, isAdminUser }) => {
            const [activeTopic, setActiveTopic] = useState('retirement');
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState({ title: '', content: '', topic: 'retirement', is_anonymous: true });
            const [showWriteForm, setShowWriteForm] = useState(false);
            const [showExpertWriteForm, setShowExpertWriteForm] = useState(false);
            const [expertPost, setExpertPost] = useState({
                title: '',
                content: '',
                category: 'travel',
                consultation_price: '20000',
                consultation_duration: '30',
                consultation_types: ['phone'],
                expert_title: '',
                expert_name: ''
            });
            const [newReply, setNewReply] = useState('');
            const [userProfile, setUserProfile] = useState(null);
            const [showExpertBookingModal, setShowExpertBookingModal] = useState(false);
            const [selectedExpertFromPost, setSelectedExpertFromPost] = useState(null);

            // 전문가 게시글에서 전문가 정보 추출
            const getExpertFromPost = (post) => {
                if (post.topic !== 'expert') return null;
                
                return {
                    id: post.user_hash,
                    name: post.expert_name,
                    title: post.expert_title,
                    profileImage: '🎯',
                    price: post.consultation_price,
                    hourlyRate: post.consultation_price?.replace(/[^0-9]/g, '') || '50000',
                    availableTypes: ['phone', 'video', 'chat']
                };
            };

            // 라이프스타일 그룹 정의 (중성적이고 포용적인 표현)
            const lifestyleGroups = {
                'prudent': { 
                    name: '알뜰 라이프', 
                    description: '실속있는 은퇴생활을 추구하는 분들',
                    color: 'bg-blue-500', 
                    emoji: '🌱',
                    tagline: '작은 것에서 찾는 큰 행복'
                },
                'balanced': { 
                    name: '밸런스 라이프', 
                    description: '균형잡힌 은퇴생활을 원하는 분들',
                    color: 'bg-green-500', 
                    emoji: '⚖️',
                    tagline: '안정과 여유의 조화'
                },
                'premium': { 
                    name: '프리미엄 라이프', 
                    description: '풍요로운 은퇴생활을 계획하는 분들',
                    color: 'bg-purple-500', 
                    emoji: '🌟',
                    tagline: '꿈꾸던 은퇴의 실현'
                }
            };

            // 토픽 보드 (블라인드의 토픽과 유사)
            const topics = {
                'retirement': { name: '은퇴계획', icon: '🏖️', description: '은퇴 준비와 은퇴설계' },
                'asset': { name: '재테크', icon: '💰', description: '투자와 자산 운용' },
                'pension': { name: '연금이야기', icon: '📋', description: '국민연금, 개인연금' },
                'health': { name: '건강관리', icon: '🏥', description: '의료비, 건강보험' },
                'life': { name: '시니어생활', icon: '🌻', description: '일상, 취미, 여행' },
                'housing': { name: '부동산', icon: '🏠', description: '주택, 임대, 이사' },
                'family': { name: '가족관계', icon: '👨‍👩‍👧‍👦', description: '부부, 형제자매, 자녀 이야기' },
                'work': { name: '재취업', icon: '💼', description: '시니어 일자리' },
                'expert': { name: '전문가 상담', icon: '🎯', description: '전문가 서비스 소개 및 상담 안내', isExpertOnly: true }
            };

            // 커뮤니티 목록 보기용 샘플 데이터 (상세보기는 계산 후 가능)
            const samplePosts = [
                {
                    id: '1',
                    title: '3억 자산으로 부부 은퇴 가능할까요?',
                    content: '아파트 2억 + 현금 1억입니다. 월 200만원 정도로 살 계획인데 괜찮을까요?',
                    topic: 'retirement',
                    asset_group: 'middle',
                    user_hash: 'user123',
                    age_badge: '60-64세',
                    asset_badge: '안정형',
                    is_hot: true,
                    replies_count: 12,
                    likes_count: 8,
                    created_at: '2025-01-20T10:30:00Z'
                },
                {
                    id: '2',
                    title: '연금 받는 시기 고민됩니다',
                    content: '국민연금 60세부터 받을지 65세부터 받을지... 건강한 편이라 고민이에요.',
                    topic: 'pension',
                    asset_group: 'middle', 
                    user_hash: 'user456',
                    age_badge: '55-59세',
                    asset_badge: '안정형',
                    is_hot: false,
                    replies_count: 7,
                    likes_count: 5,
                    created_at: '2025-01-20T09:15:00Z'
                },
                {
                    id: '3',
                    title: '10억 자산 어떻게 굴릴까요?',
                    content: '현금 5억, 부동산 5억 있는데 안전하게 수익 내는 방법 있을까요?',
                    topic: 'asset',
                    asset_group: 'high',
                    user_hash: 'user789',
                    age_badge: '65-69세',
                    asset_badge: '여유형',
                    is_hot: true,
                    replies_count: 15,
                    likes_count: 12,
                    created_at: '2025-01-20T08:45:00Z'
                },
                {
                    id: '4',
                    title: '기초연금으로만 사는 분 계신가요?',
                    content: '자산이 많지 않아서 기초연금에 의존하게 될 것 같은데... 경험담 듣고 싶어요.',
                    topic: 'life',
                    asset_group: 'low',
                    user_hash: 'user101', 
                    age_badge: '60-64세',
                    asset_badge: '생활형',
                    is_hot: false,
                    replies_count: 9,
                    likes_count: 6,
                    created_at: '2025-01-19T16:20:00Z'
                },
                {
                    id: '5',
                    title: '실버보험 가입 필요할까요?',
                    content: '60대 중반인데 실버보험 가입을 권유받았어요. 보험료가 만만치 않은데...',
                    topic: 'health',
                    asset_group: 'middle',
                    user_hash: 'user202',
                    age_badge: '60-64세', 
                    asset_badge: '안정형',
                    is_hot: false,
                    replies_count: 4,
                    likes_count: 3,
                    created_at: '2025-01-19T14:30:00Z'
                },
                // 전문가 게시글 샘플
                {
                    id: '6',
                    title: '시니어 여행 계획, 이것만은 꼭 확인하세요!',
                    content: '안녕하세요, 시니어 여행 전문 플래너 김여행입니다. 은퇴 후 첫 해외여행을 계획하시는 분들을 위한 체크리스트를 공유합니다...',
                    topic: 'expert',
                    expert_category: 'travel',
                    user_hash: 'expert_kim_travel',
                    expert_badge: '인증 전문가',
                    expert_name: '김여행플래너',
                    expert_title: '시니어 여행 전문 플래너',
                    consultation_price: '60,000원/60분',
                    is_hot: true,
                    replies_count: 23,
                    likes_count: 45,
                    created_at: '2025-01-21T09:00:00Z'
                },
                {
                    id: '7', 
                    title: '상속세 절세 전략 - 증여와 상속의 최적 타이밍',
                    content: '상속세 전문 세무사 최세무입니다. 많은 분들이 궁금해하시는 증여와 상속의 최적 타이밍에 대해 설명드리겠습니다...',
                    topic: 'expert',
                    expert_category: 'legal',
                    user_hash: 'expert_choi_tax',
                    expert_badge: '인증 전문가',
                    expert_name: '최세무사',
                    expert_title: '상속세 절세 전문 세무사',
                    consultation_price: '100,000원/60분',
                    is_hot: true,
                    replies_count: 18,
                    likes_count: 32,
                    created_at: '2025-01-20T15:30:00Z'
                },
                {
                    id: '8',
                    title: '은퇴 후 다운사이징, 성공적인 이사 가이드',
                    content: '시니어 주거 전문 컨설턴트 윤부동산입니다. 은퇴 후 집을 줄이는 다운사이징에 대한 실전 가이드를 공유합니다...',
                    topic: 'expert',
                    expert_category: 'living',
                    user_hash: 'expert_yoon_housing',
                    expert_badge: '인증 전문가',
                    expert_name: '윤부동산컨설턴트',
                    expert_title: '시니어 주거 전문 컨설턴트',
                    consultation_price: '80,000원/60분',
                    is_hot: false,
                    replies_count: 12,
                    likes_count: 28,
                    created_at: '2025-01-19T11:20:00Z'
                }
            ];

            // 컴포넌트 초기화시 세션 확인
            useEffect(() => {
                initializeCommunity();
            }, [currentUser]);

            // 토픽 변경시 게시글 다시 로드
            useEffect(() => {
                if (currentUser) {
                    loadPosts();
                }
            }, [activeTopic, currentUser]);

            const initializeCommunity = async () => {
                try {
                    if (currentUser) {
                        // Supabase 연결이 있을 때만 사용자 프로필 로드
                        if (supabase) {
                            try {
                                const { data: profile, error } = await supabase
                                    .from('user_profiles')
                                    .select('*')
                                    .eq('id', currentUser.id)
                                    .single();
                                
                                if (!error && profile) {
                                    setUserProfile(profile);
                                    console.log(`커뮤니티 접속: ${profile.nickname}`);
                                }
                            } catch (supabaseError) {
                                console.log('Supabase 연결 없음, 로컬 데이터 사용');
                            }
                        } else {
                            // Supabase가 없을 때 현재 사용자 정보로 임시 프로필 생성
                            setUserProfile({
                                id: currentUser.id,
                                nickname: currentUser.nickname || currentUser.email,
                                email: currentUser.email
                            });
                            console.log('커뮤니티 접속 (로컬 모드)');
                        }
                        
                        // 게시글 로드 (항상 실행)
                        await loadPosts();
                    }
                } catch (error) {
                    console.error('커뮤니티 초기화 오류:', error);
                    // 오류가 있어도 게시글 UI는 표시
                    await loadPosts();
                }
            };

            const loadPosts = async () => {
                if (!currentUser) return;
                try {
                    if (supabase) {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .select('*')
                            .eq('category', activeTopic)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        setPosts(data || []);
                    } else {
                        // Supabase 연결이 없을 때 샘플 데이터 표시
                        const filteredPosts = samplePosts.filter(post => 
                            post.topic === activeTopic
                        );
                        setPosts(filteredPosts);
                    }
                } catch (error) {
                    console.error('게시글 로딩 오류:', error);
                    // 오류 발생시 샘플 데이터로 폴백
                    const filteredPosts = samplePosts.filter(post => 
                        post.topic === activeTopic
                    );
                    setPosts(filteredPosts);
                }
            };

            // 내 자산 그룹 자동 감지 (계산기 결과 기반)
            const detectMyAssetGroup = () => {
                // 실제로는 계산기 결과를 기반으로 자산 그룹을 감지
                // 현재는 샘플로 'middle' 반환
                return 'middle';
            };

            // 게시글 필터링 (현재 선택된 자산그룹과 토픽)
            const getFilteredPosts = () => {
                return posts.filter(post => 
                    post.asset_group === selectedAssetGroup && 
                    post.topic === activeTopic
                );
            };

            // 시간 포맷팅 (블라인드식)
            const formatTime = (dateString) => {
                const now = new Date();
                const posted = new Date(dateString);
                const diffMs = now - posted;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffHours < 1) return '방금 전';
                if (diffHours < 24) return `${diffHours}시간 전`;
                if (diffDays < 7) return `${diffDays}일 전`;
                return posted.toLocaleDateString();
            };

            const createPost = async () => {
                if (!userSession) {
                    showNotification('로그인 필요', '게시글 작성을 위해 로그인이 필요합니다.', 'warning');
                    return;
                }

                if (!newPost.title.trim() || !newPost.content.trim()) {
                    showNotification('입력 오류', '제목과 내용을 모두 입력해주세요.', 'warning');
                    return;
                }

                try {
                    const postData = {
                        ...newPost,
                        topic: activeTopic,
                        author_nickname: userProfile?.nickname || '익명',
                        author_id: currentUser.id,
                        age_badge: '60-64세', // 향후 프로필에서 가져올 수 있음
                        is_hot: false,
                        replies_count: 0,
                        likes_count: 0,
                        created_at: new Date().toISOString()
                    };

                    if (supabase) {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .insert([postData])
                            .select();
                        
                        if (error) throw error;
                        setPosts([data[0], ...posts]);
                    } else {
                        // 로컬 상태에만 추가
                        const newId = String(Date.now());
                        setPosts([{ ...postData, id: newId }, ...posts]);
                    }

                    // 활동 기록 (필요시 추가)

                    setNewPost({ title: '', content: '', topic: activeTopic, is_anonymous: true });
                    setShowWriteForm(false);
                    showNotification('게시글 등록 완료', '게시글이 성공적으로 등록되었습니다! 🎉', 'success');
                } catch (error) {
                    console.error('게시글 작성 오류:', error);
                    showNotification('오류 발생', '게시글 작성 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                }
            };


            // 프로그레시브 접근: 먼저 커뮤니티를 보여주고, 상호작용 시에만 계산 체크

            // 정상 접근: 커뮤니티 화면
            // 기본 커뮤니티 그룹 (나중에 계산 결과 기반 그룹 배정 가능)
            const currentGroup = lifestyleGroups['balanced'];

            return (
                <div className="max-w-4xl mx-auto space-y-4">
                    {/* 뒤로가기 버튼 */}
                    <div className="flex justify-between items-center mb-4">
                        <button
                            onClick={() => setCurrentView('main')}
                            className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            메인으로 돌아가기
                        </button>
                        <div className="flex-1"></div>
                    </div>
                    
                    {/* 헤더 - 간소화 */}
                    <div className="bg-white rounded-lg shadow-md p-4">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-3">
                                <span className="text-2xl">{currentGroup.emoji}</span>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-800">커뮤니티</h1>
                                {isAdminUser(currentUser) && (
                                    <span className="px-2 py-1 bg-red-100 text-red-600 text-xs font-medium rounded-full">
                                        👑 관리자
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center">
                                <button
                                    onClick={() => {
                                        if (checkCalculationForInteraction()) {
                                            setShowWriteForm(true);
                                        }
                                    }}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg font-medium text-sm md:text-base whitespace-nowrap"
                                >
                                    ✍️ 글쓰기
                                </button>
                            </div>
                        </div>

                        {/* 토픽 보드 - 컴팩트 */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-600 mb-2">📂 토픽 보드</h3>
                            <div className="grid grid-cols-4 md:grid-cols-8 gap-1">
                                {Object.entries(topics)
                                    .filter(([key, topic]) => {
                                        // 전문가 전용 토픽은 관리자와 전문가만 표시
                                        if (topic.isExpertOnly) {
                                            return isAdminUser(currentUser) || 
                                                   (currentUser && currentUser.user_type === 'expert');
                                        }
                                        return true;
                                    })
                                    .map(([key, topic]) => (
                                    <button
                                        key={key}
                                        onClick={() => setActiveTopic(key)}
                                        className={`p-2 rounded-lg text-center transition-colors ${
                                            activeTopic === key
                                                ? 'bg-blue-50 border border-blue-300'
                                                : 'bg-gray-50 hover:bg-gray-100 border border-transparent'
                                        }`}
                                        title={topic.description}
                                    >
                                        <div className="text-base mb-1">{topic.icon}</div>
                                        <div className="font-medium text-gray-800 text-xs leading-tight">{topic.name}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* 글쓰기 모달 */}
                    {showWriteForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                                <div className="p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">✍️ 새 글 작성</h3>
                                        <button
                                            onClick={() => setShowWriteForm(false)}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            ✕
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                                        <p className="text-sm text-blue-800">
                                            <strong>{currentGroup.name}</strong> 커뮤니티의{' '}
                                            <strong>{topics[activeTopic].name}</strong> 토픽에 글을 작성합니다
                                        </p>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">제목</label>
                                            <input
                                                type="text"
                                                value={newPost.title}
                                                onChange={(e) => setNewPost({...newPost, title: e.target.value})}
                                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="제목을 입력하세요"
                                                maxLength={100}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">내용</label>
                                            <textarea
                                                value={newPost.content}
                                                onChange={(e) => setNewPost({...newPost, content: e.target.value})}
                                                className="w-full p-3 border rounded-lg h-40 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="궁금한 점이나 경험담을 자유롭게 작성해주세요"
                                                maxLength={1000}
                                            />
                                            <p className="text-xs text-gray-500 mt-1">{newPost.content.length}/1000</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                id="anonymous"
                                                checked={newPost.is_anonymous}
                                                onChange={(e) => setNewPost({...newPost, is_anonymous: e.target.checked})}
                                                className="rounded"
                                            />
                                            <label htmlFor="anonymous" className="text-sm text-gray-600">
                                                익명으로 게시 (추천)
                                            </label>
                                        </div>
                                        <div className="flex space-x-3 pt-4">
                                            <button
                                                onClick={createPost}
                                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium"
                                            >
                                                게시하기
                                            </button>
                                            <button
                                                onClick={() => setShowWriteForm(false)}
                                                className="px-6 py-3 border rounded-lg hover:bg-gray-50"
                                            >
                                                취소
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 현재 선택된 토픽 정보 */}
                    <div className="bg-white rounded-lg shadow-md p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <span className="text-lg">{topics[activeTopic].icon}</span>
                                <div>
                                    <h2 className="font-bold text-lg">{topics[activeTopic].name}</h2>
                                    <p className="text-sm text-gray-600">{currentGroup.name} 커뮤니티</p>
                                </div>
                            </div>
                            <div className="text-right text-sm text-gray-500">
                                <p>게시글 {posts.length}개</p>
                                <p>{topics[activeTopic].description}</p>
                            </div>
                        </div>
                    </div>


                    {/* 게시글 목록 - 블라인드식 */}
                    <div className="space-y-2">
                                {posts.map(post => (
                                    <div key={post.id} className={`rounded-lg shadow-md hover:shadow-lg transition-shadow ${
                                        post.topic === 'expert' ? 'bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500' : 'bg-white'
                                    }`}>
                                        <div className="p-4">
                                            <div className="flex items-start justify-between mb-3">
                                                <div className="flex-1">
                                                    {/* 뱃지들 */}
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        {post.topic === 'expert' ? (
                                                            <>
                                                                <span className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs font-bold">
                                                                    🎯 {post.expert_badge}
                                                                </span>
                                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                                    {post.expert_name}
                                                                </span>
                                                                {post.consultation_price && (
                                                                    <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                                                        💰 {post.consultation_price}
                                                                    </span>
                                                                )}
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                                                                    {post.asset_badge}
                                                                </span>
                                                                <span className="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
                                                                    {post.age_badge}
                                                                </span>
                                                            </>
                                                        )}
                                                        {post.is_hot && (
                                                            <span className="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-medium">
                                                                🔥 HOT
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    {/* 제목 */}
                                                    <h3 
                                                        className={`font-bold cursor-pointer hover:text-blue-600 transition-colors line-clamp-2 ${
                                                            post.topic === 'expert' ? 'text-orange-900' : 'text-gray-800'
                                                        }`}
                                                        onClick={() => handlePostClick(post)}
                                                    >
                                                        {post.title}
                                                    </h3>
                                                    
                                                    {/* 전문가 타이틀 */}
                                                    {post.topic === 'expert' && post.expert_title && (
                                                        <p className="text-orange-700 text-sm font-medium mt-1">
                                                            {post.expert_title}
                                                        </p>
                                                    )}
                                                    
                                                    {/* 내용 미리보기 */}
                                                    <p className="text-gray-600 text-sm mt-2 line-clamp-2">
                                                        {post.content.length > 120 ? `${post.content.substring(0, 120)}...` : post.content}
                                                    </p>
                                                    
                                                    {/* 전문가 게시글 액션 버튼 */}
                                                    {post.topic === 'expert' && (
                                                        <div className="mt-3 flex space-x-2">
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (currentUser?.isGuest) {
                                                                        setShowSignupModal(true);
                                                                        return;
                                                                    }
                                                                    const expert = getExpertFromPost(post);
                                                                    if (expert) {
                                                                        setSelectedExpertFromPost(expert);
                                                                        setShowExpertBookingModal(true);
                                                                    }
                                                                }}
                                                                className="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs font-medium"
                                                            >
                                                                📞 상담 예약
                                                            </button>
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handlePostClick(post);
                                                                }}
                                                                className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium"
                                                            >
                                                                📝 질문하기
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* 우측 메타 정보 */}
                                                <div className="text-right text-sm text-gray-500 ml-4">
                                                    <p>{formatTime(post.created_at)}</p>
                                                    <div className="flex items-center justify-end space-x-2 mt-1">
                                                        <span className="flex items-center">💬 {post.replies_count}</span>
                                                        <span className="flex items-center">👍 {post.likes_count}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                
                                {posts.length === 0 && (
                                    <div className="bg-white rounded-lg p-12 text-center">
                                        <div className="text-6xl mb-4">📝</div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">
                                            {currentGroup.name}의 {topics[activeTopic].name}
                                        </h3>
                                        <p className="text-gray-600 mb-4">아직 게시글이 없습니다.</p>
                                        <button
                                            onClick={() => {
                                                if (checkCalculationForInteraction()) {
                                                    setShowWriteForm(true);
                                                }
                                            }}
                                            className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
                                        >
                                            첫 번째 글 작성하기 ✍️
                                        </button>
                                    </div>
                                )}
                    </div>
                    
                    {/* 전문가 상담 예약 모달 */}
                    {showExpertBookingModal && selectedExpertFromPost && (
                        <ConsultationBookingComponent
                            expert={selectedExpertFromPost}
                            currentUser={currentUser}
                            onClose={() => {
                                setShowExpertBookingModal(false);
                                setSelectedExpertFromPost(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        // 상담 완료 확인 시스템 컴포넌트
        const ConsultationCompletionComponent = ({ consultation, onClose, userType }) => {
            const [isCompleting, setIsCompleting] = useState(false);
            const [showReviewForm, setShowReviewForm] = useState(false);
            const [review, setReview] = useState({
                rating: 5,
                reviewTitle: '',
                reviewContent: '',
                professionalismRating: 5,
                communicationRating: 5,
                satisfactionRating: 5,
                wouldRecommend: true
            });

            const handleComplete = async () => {
                setIsCompleting(true);
                try {
                    // TODO: Supabase에 완료 상태 업데이트
                    const completionData = {
                        consultationId: consultation.id,
                        userType, // 'expert' 또는 'client'
                        completedAt: new Date().toISOString()
                    };
                    
                    console.log('상담 완료 처리:', completionData);
                    
                    if (userType === 'client') {
                        setShowReviewForm(true);
                    } else {
                        alert('상담 완료 처리되었습니다');
                        onClose();
                    }
                } catch (error) {
                    console.error('완료 처리 오류:', error);
                    alert('완료 처리 중 오류가 발생했습니다');
                } finally {
                    setIsCompleting(false);
                }
            };

            const handleReviewSubmit = async () => {
                try {
                    // TODO: Supabase에 후기 저장
                    const reviewData = {
                        consultationId: consultation.id,
                        ...review,
                        createdAt: new Date().toISOString()
                    };
                    
                    console.log('후기 저장:', reviewData);
                    
                    alert('후기가 등록되었습니다. 감사합니다!');
                    onClose();
                } catch (error) {
                    console.error('후기 저장 오류:', error);
                    alert('후기 저장 중 오류가 발생했습니다');
                }
            };

            if (showReviewForm) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl max-h-90vh overflow-y-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-gray-900">상담 후기 작성</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                            </div>

                            <div className="space-y-6">
                                {/* 전체 평점 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">전체 만족도 *</label>
                                    <div className="flex space-x-1">
                                        {[1, 2, 3, 4, 5].map(star => (
                                            <button
                                                key={star}
                                                onClick={() => setReview(prev => ({ ...prev, rating: star }))}
                                                className={`text-2xl ${star <= review.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                            >
                                                ⭐
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 세부 평가 */}
                                <div className="space-y-4">
                                    <h4 className="font-medium">세부 평가</h4>
                                    
                                    {[
                                        { key: 'professionalismRating', label: '전문성' },
                                        { key: 'communicationRating', label: '소통' },
                                        { key: 'satisfactionRating', label: '만족도' }
                                    ].map(({ key, label }) => (
                                        <div key={key}>
                                            <label className="block text-sm text-gray-600 mb-1">{label}</label>
                                            <div className="flex space-x-1">
                                                {[1, 2, 3, 4, 5].map(star => (
                                                    <button
                                                        key={star}
                                                        onClick={() => setReview(prev => ({ ...prev, [key]: star }))}
                                                        className={`text-lg ${star <= review[key] ? 'text-yellow-400' : 'text-gray-300'}`}
                                                    >
                                                        ⭐
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* 후기 제목 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">후기 제목</label>
                                    <input
                                        type="text"
                                        value={review.reviewTitle}
                                        onChange={(e) => setReview(prev => ({ ...prev, reviewTitle: e.target.value }))}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        placeholder="후기 제목을 입력하세요"
                                    />
                                </div>

                                {/* 후기 내용 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상세 후기</label>
                                    <textarea
                                        value={review.reviewContent}
                                        onChange={(e) => setReview(prev => ({ ...prev, reviewContent: e.target.value }))}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        rows="4"
                                        placeholder="상담 경험을 다른 분들과 공유해주세요"
                                    />
                                </div>

                                {/* 추천 여부 */}
                                <div>
                                    <label className="flex items-center">
                                        <input
                                            type="checkbox"
                                            checked={review.wouldRecommend}
                                            onChange={(e) => setReview(prev => ({ ...prev, wouldRecommend: e.target.checked }))}
                                            className="h-4 w-4 text-blue-600"
                                        />
                                        <span className="ml-2 text-sm text-gray-700">이 전문가를 다른 분들께 추천하시겠어요?</span>
                                    </label>
                                </div>

                                <div className="flex space-x-4">
                                    <button
                                        onClick={() => setShowReviewForm(false)}
                                        className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        나중에 작성
                                    </button>
                                    <button
                                        onClick={handleReviewSubmit}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        후기 등록
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                        <div className="text-center">
                            <div className="text-6xl mb-4">✅</div>
                            <h3 className="text-xl font-bold text-gray-900 mb-4">상담이 완료되었나요?</h3>
                            
                            <div className="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                                <div className="space-y-2 text-sm">
                                    <div><strong>전문가:</strong> {consultation.expertName}</div>
                                    <div><strong>상담 일시:</strong> {consultation.scheduledTime}</div>
                                    <div><strong>상담 주제:</strong> {consultation.topic}</div>
                                </div>
                            </div>
                            
                            <p className="text-gray-600 mb-6">
                                {userType === 'expert' ? 
                                    '상담을 완료하셨으면 완료 버튼을 눌러주세요.' :
                                    '상담이 완료되었으면 완료 확인 후 후기를 작성해주세요.'
                                }
                            </p>
                            
                            <div className="flex space-x-4">
                                <button
                                    onClick={onClose}
                                    className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    나중에
                                </button>
                                <button
                                    onClick={handleComplete}
                                    disabled={isCompleting}
                                    className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                                >
                                    {isCompleting ? '처리중...' : '상담 완료'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 예약 시스템 컴포넌트
        const ConsultationBookingComponent = ({ expert, onClose, currentUser }) => {
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedTime, setSelectedTime] = useState('');
            const [consultationType, setConsultationType] = useState('phone');
            const [consultationTopic, setConsultationTopic] = useState('');
            const [clientQuestions, setClientQuestions] = useState('');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [currentStep, setCurrentStep] = useState(1);
            const [bookingResult, setBookingResult] = useState(null);

            // 예약 가능한 날짜 생성 (오늘부터 30일간)
            const getAvailableDates = () => {
                const dates = [];
                const today = new Date();
                for (let i = 1; i <= 30; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    // 주말 제외 (토: 6, 일: 0)
                    if (date.getDay() !== 0 && date.getDay() !== 6) {
                        dates.push(date);
                    }
                }
                return dates;
            };

            // 예약 가능한 시간 생성
            const getAvailableTimes = () => {
                const times = [];
                for (let hour = 9; hour <= 18; hour++) {
                    times.push(`${hour.toString().padStart(2, '0')}:00`);
                    if (hour < 18) {
                        times.push(`${hour.toString().padStart(2, '0')}:30`);
                    }
                }
                return times;
            };

            const handleBooking = async () => {
                if (!selectedDate || !selectedTime || !consultationTopic) {
                    alert('모든 필수 항목을 입력해주세요');
                    return;
                }

                // 결제 단계로 이동
                const bookingData = {
                    expertId: expert.id,
                    clientUserHash: currentUser?.id || 'guest_' + Date.now(),
                    scheduledTime: `${selectedDate} ${selectedTime}`,
                    consultationType,
                    consultationTopic,
                    clientQuestions,
                    phoneNumber: consultationType === 'phone' ? phoneNumber : '',
                    paymentAmount: parseInt(expert.hourlyRate),
                    platformFee: Math.round(parseInt(expert.hourlyRate) * 0.1),
                    expertPayout: Math.round(parseInt(expert.hourlyRate) * 0.9)
                };
                
                setBookingResult(bookingData);
                setCurrentStep(3); // 결제 단계
            };

            const handlePayment = async (paymentMethod) => {
                try {
                    // 결제 처리 시뮬레이션
                    console.log('결제 처리:', { 
                        method: paymentMethod, 
                        amount: bookingResult.paymentAmount 
                    });
                    
                    // TODO: 실제 결제 API 연동
                    // await processPayment(paymentMethod, bookingResult.paymentAmount);
                    
                    // Supabase에 예약 정보 저장
                    const { error } = await supabase
                        .from('consultation_sessions')
                        .insert({
                            expert_id: bookingResult.expertId,
                            client_id: currentUser.id,
                            scheduled_time: bookingResult.scheduledTime,
                            consultation_type: bookingResult.consultationType,
                            consultation_topic: bookingResult.consultationTopic,
                            client_questions: bookingResult.clientQuestions,
                            payment_amount: bookingResult.paymentAmount,
                            platform_fee: bookingResult.platformFee,
                            expert_payout: bookingResult.expertPayout,
                            payment_method: paymentMethod,
                            status: 'confirmed'
                        });

                    if (error) throw error;
                    
                    setCurrentStep(4); // 완료 단계
                } catch (error) {
                    console.error('결제 처리 오류:', error);
                    alert('결제 처리 중 오류가 발생했습니다');
                }
            };

            // 결제 단계 (3단계)
            if (currentStep === 3 && bookingResult) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                            <div className="text-center mb-6">
                                <div className="text-4xl mb-4">💳</div>
                                <h3 className="text-xl font-bold text-gray-900">결제하기</h3>
                                <p className="text-sm text-gray-600 mt-2">상담 예약을 완료하기 위해 결제해주세요</p>
                            </div>

                            {/* 결제 정보 요약 */}
                            <div className="bg-blue-50 p-4 rounded-lg mb-6">
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>전문가:</span>
                                        <span className="font-medium">{expert.name}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>상담 시간:</span>
                                        <span className="font-medium">{bookingResult.scheduledTime}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>상담 방식:</span>
                                        <span className="font-medium">
                                            {consultationType === 'phone' ? '📞 전화' :
                                             consultationType === 'video' ? '📹 화상' : '💬 채팅'}
                                        </span>
                                    </div>
                                    <hr className="my-2 border-blue-200" />
                                    <div className="flex justify-between font-bold text-lg">
                                        <span>총 결제금액:</span>
                                        <span className="text-blue-600">{bookingResult.paymentAmount.toLocaleString()}원</span>
                                    </div>
                                    <div className="text-xs text-gray-500 text-right">
                                        (플랫폼 수수료 {bookingResult.platformFee.toLocaleString()}원 포함)
                                    </div>
                                </div>
                            </div>

                            {/* 결제 방법 선택 */}
                            <div className="space-y-3 mb-6">
                                <h4 className="font-medium text-gray-800">결제 방법을 선택하세요</h4>
                                
                                <button
                                    onClick={() => handlePayment('card')}
                                    className="w-full p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors text-left"
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center">
                                            <span className="text-2xl mr-3">💳</span>
                                            <div>
                                                <div className="font-medium">신용카드</div>
                                                <div className="text-sm text-gray-500">일반적인 신용카드 결제</div>
                                            </div>
                                        </div>
                                        <div className="text-blue-600 font-medium">선택</div>
                                    </div>
                                </button>

                                <button
                                    onClick={() => handlePayment('kakaopay')}
                                    className="w-full p-4 border-2 border-yellow-200 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition-colors text-left"
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center">
                                            <span className="text-2xl mr-3">💰</span>
                                            <div>
                                                <div className="font-medium">카카오페이</div>
                                                <div className="text-sm text-gray-500">간편하고 안전한 결제</div>
                                            </div>
                                        </div>
                                        <div className="text-yellow-600 font-medium">선택</div>
                                    </div>
                                </button>

                                <button
                                    onClick={() => handlePayment('toss')}
                                    className="w-full p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors text-left"
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center">
                                            <span className="text-2xl mr-3">🏦</span>
                                            <div>
                                                <div className="font-medium">토스페이</div>
                                                <div className="text-sm text-gray-500">토스 간편결제</div>
                                            </div>
                                        </div>
                                        <div className="text-blue-600 font-medium">선택</div>
                                    </div>
                                </button>
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={() => setCurrentStep(2)}
                                    className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    이전
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    취소
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // 예약 완료 단계 (4단계)
            if (currentStep === 4 && bookingResult) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                            <div className="text-center">
                                <div className="text-6xl mb-4">🎉</div>
                                <h3 className="text-xl font-bold text-gray-900 mb-4">결제 완료!</h3>
                                <div className="bg-green-50 p-4 rounded-lg mb-4 text-left">
                                    <div className="space-y-2 text-sm">
                                        <div><strong>전문가:</strong> {expert.name}</div>
                                        <div><strong>일시:</strong> {bookingResult.scheduledTime}</div>
                                        <div><strong>상담 방식:</strong> {
                                            consultationType === 'phone' ? '📞 전화 상담' :
                                            consultationType === 'video' ? '📹 화상 상담' : '💬 채팅 상담'
                                        }</div>
                                        <div><strong>결제 금액:</strong> {bookingResult.paymentAmount.toLocaleString()}원</div>
                                    </div>
                                </div>
                                <div className="bg-blue-50 p-4 rounded-lg mb-6">
                                    <h4 className="font-medium text-blue-800 mb-2">📋 다음 단계</h4>
                                    <ul className="text-sm text-blue-700 text-left space-y-1">
                                        <li>• 전문가가 24시간 내 연락드립니다</li>
                                        <li>• 상담 전 준비사항을 안내해드립니다</li>
                                        <li>• 마이페이지에서 예약을 확인할 수 있습니다</li>
                                        <li>• 취소는 상담 24시간 전까지 가능합니다</li>
                                    </ul>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                >
                                    확인
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-2xl w-full shadow-xl max-h-90vh overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-900">상담 예약</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>

                        {/* 전문가 정보 */}
                        <div className="bg-orange-50 p-4 rounded-lg mb-6">
                            <div className="flex items-center gap-4">
                                <div className="text-3xl">{expert.profileImage}</div>
                                <div>
                                    <h4 className="font-bold text-gray-800">{expert.name}</h4>
                                    <p className="text-sm text-gray-600">{expert.title}</p>
                                    <p className="text-sm font-medium text-orange-600">{expert.price}</p>
                                </div>
                            </div>
                        </div>

                        {currentStep === 1 && (
                            <div className="space-y-6">
                                <h4 className="font-bold text-lg">1단계: 날짜 및 시간 선택</h4>
                                
                                {/* 날짜 선택 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 날짜 *</label>
                                    <select
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        required
                                    >
                                        <option value="">날짜 선택</option>
                                        {getAvailableDates().map(date => (
                                            <option key={date.toISOString()} value={date.toISOString().split('T')[0]}>
                                                {date.toLocaleDateString('ko-KR', { 
                                                    year: 'numeric', 
                                                    month: 'long', 
                                                    day: 'numeric',
                                                    weekday: 'short'
                                                })}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* 시간 선택 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 시간 *</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {getAvailableTimes().map(time => (
                                            <button
                                                key={time}
                                                onClick={() => setSelectedTime(time)}
                                                className={`p-2 text-sm rounded-lg border transition-colors ${
                                                    selectedTime === time
                                                        ? 'bg-orange-500 text-white border-orange-500'
                                                        : 'bg-white text-gray-700 border-gray-300 hover:bg-orange-50'
                                                }`}
                                            >
                                                {time}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 상담 방식 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 방식 *</label>
                                    <div className="space-y-2">
                                        {expert.availableTypes?.map(type => (
                                            <label key={type} className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                                <input
                                                    type="radio"
                                                    name="consultationType"
                                                    value={type}
                                                    checked={consultationType === type}
                                                    onChange={(e) => setConsultationType(e.target.value)}
                                                    className="h-4 w-4 text-orange-600"
                                                />
                                                <div className="ml-3">
                                                    <div className="font-medium">
                                                        {type === 'phone' ? '📞 전화 상담' :
                                                         type === 'video' ? '📹 화상 상담' : '💬 채팅 상담'}
                                                    </div>
                                                </div>
                                            </label>
                                        )) || (
                                            <label className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                                <input
                                                    type="radio"
                                                    name="consultationType"
                                                    value="phone"
                                                    checked={true}
                                                    onChange={() => setConsultationType('phone')}
                                                    className="h-4 w-4 text-orange-600"
                                                />
                                                <div className="ml-3">
                                                    <div className="font-medium">📞 전화 상담</div>
                                                </div>
                                            </label>
                                        )}
                                    </div>
                                </div>

                                <div className="flex justify-between">
                                    <button
                                        onClick={onClose}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        취소
                                    </button>
                                    <button
                                        onClick={() => setCurrentStep(2)}
                                        disabled={!selectedDate || !selectedTime}
                                        className="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-300"
                                    >
                                        다음 단계
                                    </button>
                                </div>
                            </div>
                        )}

                        {currentStep === 2 && (
                            <div className="space-y-6">
                                <h4 className="font-bold text-lg">2단계: 상담 내용</h4>
                                
                                {/* 상담 주제 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 주제 *</label>
                                    <input
                                        type="text"
                                        value={consultationTopic}
                                        onChange={(e) => setConsultationTopic(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        placeholder="상담받고 싶은 주제를 간단히 적어주세요"
                                        required
                                    />
                                </div>

                                {/* 구체적인 질문 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">구체적인 질문이나 상황</label>
                                    <textarea
                                        value={clientQuestions}
                                        onChange={(e) => setClientQuestions(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        rows="4"
                                        placeholder="상담을 위해 전문가가 미리 알아야 할 내용이나 질문을 적어주세요"
                                    />
                                </div>

                                {/* 전화번호 (전화 상담인 경우) */}
                                {consultationType === 'phone' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">연락처 *</label>
                                        <input
                                            type="tel"
                                            value={phoneNumber}
                                            onChange={(e) => setPhoneNumber(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg"
                                            placeholder="010-1234-5678"
                                            required
                                        />
                                    </div>
                                )}

                                {/* 예약 요약 */}
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h5 className="font-medium mb-2">예약 요약</h5>
                                    <div className="text-sm space-y-1">
                                        <div>📅 날짜: {selectedDate}</div>
                                        <div>⏰ 시간: {selectedTime}</div>
                                        <div>📞 방식: {consultationType === 'phone' ? '전화 상담' : consultationType === 'video' ? '화상 상담' : '채팅 상담'}</div>
                                        <div>💰 상담료: {expert.price}</div>
                                    </div>
                                </div>

                                <div className="flex justify-between">
                                    <button
                                        onClick={() => setCurrentStep(1)}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        이전
                                    </button>
                                    <button
                                        onClick={handleBooking}
                                        className="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                                    >
                                        예약 확정
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 전문가 글 작성 모달 컴포넌트
        const ExpertPostWriteModal = ({ isOpen, onClose, currentUser, onSuccess, isAdminUser }) => {
            const [formData, setFormData] = useState({
                title: '',
                content: '',
                category: 'travel',
                serviceType: 'phone',
                price: '',
                duration: '30',
                availableDays: [],
                availableTimeSlots: [],
                tags: []
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState('');
            const [tagInput, setTagInput] = useState('');

            // 카테고리 정의
            const categories = {
                'travel': { name: '여행/취미', icon: '✈️', color: 'orange' },
                'legal': { name: '세무/법무/자산관리', icon: '📋', color: 'blue' },
                'living': { name: '주거/생활', icon: '🏠', color: 'green' }
            };

            // 서비스 유형 (상담 방식)
            const serviceTypes = {
                'phone': '전화 상담',
                'chat': '채팅 상담',
                'video': '영상 통화'
            };

            // 요일 옵션
            const dayOptions = [
                { value: 'mon', label: '월' },
                { value: 'tue', label: '화' },
                { value: 'wed', label: '수' },
                { value: 'thu', label: '목' },
                { value: 'fri', label: '금' },
                { value: 'sat', label: '토' },
                { value: 'sun', label: '일' }
            ];

            // 시간 슬롯 옵션 (9시-18시, 1시간 단위)
            const timeSlotOptions = [
                { value: '09:00', label: '09:00' },
                { value: '10:00', label: '10:00' },
                { value: '11:00', label: '11:00' },
                { value: '12:00', label: '12:00' },
                { value: '13:00', label: '13:00' },
                { value: '14:00', label: '14:00' },
                { value: '15:00', label: '15:00' },
                { value: '16:00', label: '16:00' },
                { value: '17:00', label: '17:00' },
                { value: '18:00', label: '18:00' },
                { value: '19:00', label: '19:00' },
                { value: '20:00', label: '20:00' }
            ];

            // 폼 초기화
            useEffect(() => {
                if (isOpen) {
                    setFormData({
                        title: '',
                        content: '',
                        category: 'travel',
                        serviceType: 'phone',
                        price: '',
                        duration: '30',
                        availableDays: [],
                        availableTimeSlots: [],
                        tags: []
                    });
                    setError('');
                    setTagInput('');
                }
            }, [isOpen]);

            // 입력값 변경 핸들러
            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                setError('');
            };

            // 요일 선택 핸들러
            const handleDayToggle = (dayValue) => {
                setFormData(prev => ({
                    ...prev,
                    availableDays: prev.availableDays.includes(dayValue)
                        ? prev.availableDays.filter(day => day !== dayValue)
                        : [...prev.availableDays, dayValue]
                }));
            };

            // 시간 슬롯 선택 핸들러
            const handleTimeSlotToggle = (timeValue) => {
                setFormData(prev => ({
                    ...prev,
                    availableTimeSlots: prev.availableTimeSlots.includes(timeValue)
                        ? prev.availableTimeSlots.filter(time => time !== timeValue)
                        : [...prev.availableTimeSlots, timeValue]
                }));
            };

            // 태그 추가
            const handleAddTag = () => {
                const trimmedTag = tagInput.trim();
                if (trimmedTag && !formData.tags.includes(trimmedTag) && formData.tags.length < 5) {
                    setFormData(prev => ({
                        ...prev,
                        tags: [...prev.tags, trimmedTag]
                    }));
                    setTagInput('');
                }
            };

            // 태그 삭제
            const handleRemoveTag = (tagToRemove) => {
                setFormData(prev => ({
                    ...prev,
                    tags: prev.tags.filter(tag => tag !== tagToRemove)
                }));
            };

            // 폼 유효성 검사
            const validateForm = () => {
                if (!formData.title.trim()) return '제목을 입력해주세요.';
                if (!formData.content.trim()) return '내용을 입력해주세요.';
                if (!formData.price.trim()) return '상담료를 입력해주세요.';
                if (formData.availableDays.length === 0) return '상담 가능 요일을 선택해주세요.';
                if (formData.availableTimeSlots.length === 0) return '상담 가능 시간을 선택해주세요.';
                
                const price = parseInt(formData.price.replace(/,/g, ''));
                if (isNaN(price) || price < 30000) return '상담료는 최소 30,000원 이상이어야 합니다.';
                if (price > 500000) return '상담료는 최대 500,000원 이하여야 합니다.';

                return null;
            };

            // 글 작성 제출
            const handleSubmit = async () => {
                const validationError = validateForm();
                if (validationError) {
                    setError(validationError);
                    return;
                }

                setIsSubmitting(true);
                
                try {
                    let expertProfile = null;

                    // 관리자는 전문가 프로필 없이도 글 작성 가능
                    if (isAdminUser && isAdminUser(currentUser)) {
                        // 관리자용 임시 프로필 생성
                        expertProfile = {
                            id: 'admin-' + currentUser.id,
                            name: currentUser.email?.split('@')[0] || '관리자',
                            title: '시스템 관리자',
                            user_id: currentUser.id
                        };
                    } else {
                        // 일반 사용자는 전문가 프로필 확인
                        const { data: profile } = await supabase
                            .from('financial_experts')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .eq('is_verified', true)
                            .eq('is_active', true)
                            .single();

                        if (!profile) {
                            setError('승인된 전문가만 글을 작성할 수 있습니다.');
                            return;
                        }
                        expertProfile = profile;
                    }

                    // 일반 전문가의 경우 expert_posts 테이블에 저장
                    if (!isAdminUser || !isAdminUser(currentUser)) {
                        const postData = {
                            expert_id: expertProfile.id,
                            title: formData.title.trim(),
                            content: formData.content.trim(),
                            service_description: `서비스 유형: ${serviceTypes[formData.serviceType]}\n소요 시간: ${formData.duration}분\n상담료: ${formData.price}원\n가능 요일: ${formData.availableDays.map(d => dayOptions.find(opt => opt.value === d)?.label).join(', ')}\n가능 시간: ${formData.availableTimeSlots.join(', ')}\n💬 플랫폼 내 채팅으로 안전하게 상담받으세요`,
                            category: formData.category,
                            consultation_type: [formData.serviceType],
                            price_info: `${formData.price}원 / ${formData.duration}분`,
                            sample_questions: formData.tags
                        };

                        // expert_posts 테이블에 저장
                        const { data: expertPost, error: expertError } = await supabase
                            .from('expert_posts')
                            .insert([postData])
                            .select()
                            .single();

                        if (expertError) {
                            throw expertError;
                        }
                    }

                    // 커뮤니티 게시글로도 동시 등록 (전문가 카테고리)
                    const communityPostData = {
                        user_hash: currentUser.userHash,
                        topic: 'expert',
                        title: formData.title.trim(),
                        content: formData.content.trim(),
                        expert_category: formData.category,
                        expert_name: expertProfile.name,
                        expert_title: expertProfile.title,
                        expert_badge: isAdminUser && isAdminUser(currentUser) ? '👑 슈퍼관리자' : '인증 전문가',
                        created_at: new Date().toISOString()
                    };

                    const { error: communityError } = await supabase
                        .from('community_posts')
                        .insert([communityPostData]);

                    if (communityError) {
                        console.warn('커뮤니티 게시글 등록 실패:', communityError);
                    }

                    showNotification(
                        '서비스 게시 완료!',
                        '서비스가 성공적으로 등록되었습니다.\n전문가 찾기에서 고객들이 예약할 수 있습니다.',
                        'success'
                    );

                    onSuccess && onSuccess();
                    onClose();

                } catch (error) {
                    console.error('전문가 글 작성 오류:', error);
                    setError('글 작성 중 오류가 발생했습니다. 다시 시도해주세요.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        {/* 헤더 */}
                        <div className="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
                            <h2 className="text-lg font-bold">📝 서비스 게시하기</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 text-xl"
                            >
                                ✕
                            </button>
                        </div>

                        {/* 내용 */}
                        <div className="p-6 space-y-6">
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded p-3 text-red-700 text-sm">
                                    {error}
                                </div>
                            )}

                            {/* 카테고리 선택 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    전문 분야 *
                                </label>
                                <div className="grid grid-cols-3 gap-2">
                                    {Object.entries(categories).map(([key, category]) => (
                                        <button
                                            key={key}
                                            onClick={() => handleInputChange('category', key)}
                                            className={`p-3 rounded-lg text-center transition-all ${
                                                formData.category === key
                                                    ? `bg-${category.color}-500 text-white`
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                        >
                                            <div className="text-lg mb-1">{category.icon}</div>
                                            <div className="font-semibold text-xs">{category.name}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* 제목 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    제목 *
                                </label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => handleInputChange('title', e.target.value)}
                                    placeholder="예: 은퇴 후 해외 장기체류 완전 가이드"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    maxLength={100}
                                />
                                <div className="text-xs text-gray-500 mt-1">
                                    {formData.title.length}/100
                                </div>
                            </div>

                            {/* 내용 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    내용 *
                                </label>
                                <textarea
                                    value={formData.content}
                                    onChange={(e) => handleInputChange('content', e.target.value)}
                                    placeholder="전문가로서 제공하는 서비스를 상세히 설명해주세요.&#10;- 상담 내용&#10;- 경력 및 전문성&#10;- 고객에게 제공할 수 있는 가치"
                                    rows={8}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    maxLength={2000}
                                />
                                <div className="text-xs text-gray-500 mt-1">
                                    {formData.content.length}/2000
                                </div>
                            </div>

                            {/* 서비스 정보 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* 서비스 유형 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        서비스 유형
                                    </label>
                                    <select
                                        value={formData.serviceType}
                                        onChange={(e) => handleInputChange('serviceType', e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        {Object.entries(serviceTypes).map(([key, label]) => (
                                            <option key={key} value={key}>{label}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* 소요 시간 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        소요 시간 (분)
                                    </label>
                                    <select
                                        value={formData.duration}
                                        onChange={(e) => handleInputChange('duration', e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="15">15분</option>
                                        <option value="30">30분</option>
                                        <option value="45">45분</option>
                                        <option value="60">60분</option>
                                    </select>
                                </div>
                            </div>

                            {/* 상담료 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    상담료 (원) *
                                </label>
                                <input
                                    type="text"
                                    value={formData.price}
                                    onChange={(e) => {
                                        const value = e.target.value.replace(/[^0-9]/g, '');
                                        const formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                        handleInputChange('price', formatted);
                                    }}
                                    placeholder="30,000"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                                <div className="text-xs text-gray-500 mt-1">
                                    최소 30,000원 이상, 최대 500,000원 이하
                                </div>
                            </div>

                            {/* 상담 가능 요일 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    상담 가능 요일 *
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    {dayOptions.map(day => (
                                        <button
                                            key={day.value}
                                            onClick={() => handleDayToggle(day.value)}
                                            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.availableDays.includes(day.value)
                                                    ? 'bg-blue-500 text-white'
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                        >
                                            {day.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* 상담 가능 시간 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    상담 가능 시간 * (복수 선택 가능)
                                </label>
                                <div className="grid grid-cols-4 gap-2">
                                    {timeSlotOptions.map(time => (
                                        <button
                                            key={time.value}
                                            type="button"
                                            onClick={() => handleTimeSlotToggle(time.value)}
                                            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.availableTimeSlots.includes(time.value)
                                                    ? 'bg-green-500 text-white'
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                        >
                                            {time.label}
                                        </button>
                                    ))}
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    선택한 시간대에 상담이 가능합니다
                                </div>
                            </div>

                            {/* 태그 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    전문 태그 (최대 5개)
                                </label>
                                <div className="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        value={tagInput}
                                        onChange={(e) => setTagInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddTag())}
                                        placeholder="태그 입력 후 엔터"
                                        className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                    <button
                                        onClick={handleAddTag}
                                        disabled={!tagInput.trim() || formData.tags.length >= 5}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 disabled:bg-gray-300"
                                    >
                                        추가
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-1">
                                    {formData.tags.map((tag, index) => (
                                        <span
                                            key={index}
                                            className="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded"
                                        >
                                            {tag}
                                            <button
                                                onClick={() => handleRemoveTag(tag)}
                                                className="ml-1 text-blue-500 hover:text-blue-700"
                                            >
                                                ✕
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* 버튼 */}
                            <div className="flex gap-3 pt-4">
                                <button
                                    onClick={onClose}
                                    disabled={isSubmitting}
                                    className="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 disabled:opacity-50"
                                >
                                    취소
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    disabled={isSubmitting}
                                    className="flex-1 py-3 px-4 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSubmitting ? '등록 중...' : '글 등록'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 연락처 교환 컴포넌트
        const ContactExchangeComponent = ({ currentUser, isAdminUser }) => {
            const [exchangeRequests, setExchangeRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedRequest, setSelectedRequest] = useState(null);
            const [showDetailModal, setShowDetailModal] = useState(false);

            // 연락처 교환 요청 목록 로드
            const loadExchangeRequests = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('contact_exchange_requests')
                        .select(`
                            *,
                            expert:expert_id (nickname, email),
                            client:client_id (nickname, email),
                            booking:booking_id (
                                consultation_type,
                                scheduled_time,
                                payment_amount,
                                status
                            )
                        `)
                        .or(`expert_id.eq.${currentUser.id},client_id.eq.${currentUser.id}`)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setExchangeRequests(data || []);
                } catch (error) {
                    console.error('연락처 교환 요청 로드 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            // 연락처 공유 승인
            const approveContactShare = async (requestId, contactInfo) => {
                try {
                    const isExpert = exchangeRequests.find(r => r.id === requestId)?.expert_id === currentUser.id;
                    
                    const updateData = isExpert ? {
                        expert_phone: contactInfo.phone,
                        expert_email: contactInfo.email,
                        expert_preferred_contact: contactInfo.preferred_contact,
                        expert_available_hours: contactInfo.available_hours,
                        expert_consultation_notes: contactInfo.consultation_notes,
                        expert_approved_at: new Date().toISOString(),
                        status: 'approved_by_expert'
                    } : {
                        client_phone: contactInfo.phone,
                        client_email: contactInfo.email,
                        client_preferred_contact: contactInfo.preferred_contact,
                        client_consultation_notes: contactInfo.consultation_notes,
                        client_approved_at: new Date().toISOString(),
                        status: 'approved_by_client'
                    };

                    const { error } = await supabase
                        .from('contact_exchange_requests')
                        .update(updateData)
                        .eq('id', requestId);

                    if (error) throw error;
                    
                    alert('연락처가 공유되었습니다!');
                    loadExchangeRequests();
                    setShowDetailModal(false);
                } catch (error) {
                    console.error('연락처 승인 오류:', error);
                    alert('연락처 공유 중 오류가 발생했습니다.');
                }
            };

            // 상태 표시 함수
            const getStatusBadge = (status, isExpert, request) => {
                const userType = isExpert ? 'expert' : 'client';
                
                switch (status) {
                    case 'pending':
                        return <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">승인 대기중</span>;
                    case 'approved_by_expert':
                        return isExpert ? 
                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">내가 승인함</span> :
                            <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">전문가 승인됨</span>;
                    case 'approved_by_client':
                        return isExpert ? 
                            <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">고객 승인됨</span> :
                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">내가 승인함</span>;
                    case 'both_approved':
                        return <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">연락처 교환 완료</span>;
                    case 'declined':
                        return <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">거절됨</span>;
                    case 'expired':
                        return <span className="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">만료됨</span>;
                    default:
                        return <span className="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">{status}</span>;
                }
            };

            useEffect(() => {
                if (currentUser) {
                    loadExchangeRequests();
                }
            }, [currentUser]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center py-12">
                        <div className="text-center">
                            <div className="text-4xl mb-4">📞</div>
                            <p className="text-gray-500">연락처 교환 요청을 불러오는 중...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 rounded-xl">
                        <h2 className="text-xl font-bold mb-2">📞 연락처 교환</h2>
                        <p className="text-green-100">결제 완료된 상담의 연락처를 안전하게 교환하세요</p>
                    </div>

                    {exchangeRequests.length === 0 ? (
                        <div className="text-center py-12">
                            <div className="text-4xl mb-4">📭</div>
                            <h3 className="text-lg font-medium text-gray-800 mb-2">연락처 교환 요청이 없습니다</h3>
                            <p className="text-gray-600">전문가 상담을 예약하고 결제를 완료하면 연락처 교환이 가능합니다.</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {exchangeRequests.map((request) => {
                                const isExpert = request.expert_id === currentUser.id;
                                const otherUser = isExpert ? request.client : request.expert;
                                
                                return (
                                    <div key={request.id} className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <h3 className="font-semibold text-gray-800">
                                                        {isExpert ? '👤 ' + otherUser.nickname + ' (고객)' : '🎯 ' + otherUser.nickname + ' (전문가)'}
                                                    </h3>
                                                    {getStatusBadge(request.status, isExpert, request)}
                                                </div>
                                                
                                                <div className="text-sm text-gray-600 space-y-1">
                                                    <div>📅 상담 일시: {new Date(request.booking.scheduled_time).toLocaleString('ko-KR')}</div>
                                                    <div>💬 상담 방식: {
                                                        request.booking.consultation_type === 'phone' ? '📞 전화 상담' :
                                                        request.booking.consultation_type === 'video' ? '📹 화상 상담' : '💬 채팅 상담'
                                                    }</div>
                                                    <div>💰 결제 금액: {request.booking.payment_amount.toLocaleString()}원</div>
                                                    <div>⏰ 만료 시간: {new Date(request.expires_at).toLocaleString('ko-KR')}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-3 mt-4">
                                            <button
                                                onClick={() => {
                                                    setSelectedRequest(request);
                                                    setShowDetailModal(true);
                                                }}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                            >
                                                상세보기
                                            </button>
                                            
                                            {request.status === 'pending' || 
                                             (request.status === 'approved_by_client' && isExpert) ||
                                             (request.status === 'approved_by_expert' && !isExpert) ? (
                                                <button
                                                    onClick={() => {
                                                        setSelectedRequest(request);
                                                        setShowDetailModal(true);
                                                    }}
                                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                                                >
                                                    연락처 공유
                                                </button>
                                            ) : null}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* 연락처 교환 상세 모달 */}
                    {showDetailModal && selectedRequest && (
                        <ContactExchangeDetailModal
                            request={selectedRequest}
                            currentUser={currentUser}
                            onClose={() => {
                                setShowDetailModal(false);
                                setSelectedRequest(null);
                            }}
                            onApprove={approveContactShare}
                        />
                    )}
                </div>
            );
        };

        // 연락처 교환 상세 모달
        const ContactExchangeDetailModal = ({ request, currentUser, onClose, onApprove }) => {
            const [contactInfo, setContactInfo] = useState({
                phone: currentUser.phone || '',
                email: currentUser.email || '',
                preferred_contact: 'phone',
                available_hours: '',
                consultation_notes: ''
            });

            const isExpert = request.expert_id === currentUser.id;
            const otherUser = isExpert ? request.client : request.expert;
            const canShare = request.status === 'pending' || 
                           (request.status === 'approved_by_client' && isExpert) ||
                           (request.status === 'approved_by_expert' && !isExpert);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!contactInfo.phone && !contactInfo.email) {
                    alert('전화번호 또는 이메일 중 하나는 입력해야 합니다.');
                    return;
                }
                onApprove(request.id, contactInfo);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">연락처 교환 상세</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                            >
                                ×
                            </button>
                        </div>

                        {/* 상담 정보 */}
                        <div className="bg-blue-50 p-4 rounded-lg mb-6">
                            <h3 className="font-medium text-blue-800 mb-3">📋 상담 정보</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div><strong>상대방:</strong> {otherUser.nickname}</div>
                                <div><strong>상담 일시:</strong> {new Date(request.booking.scheduled_time).toLocaleString('ko-KR')}</div>
                                <div><strong>상담 방식:</strong> {
                                    request.booking.consultation_type === 'phone' ? '📞 전화' :
                                    request.booking.consultation_type === 'video' ? '📹 화상' : '💬 채팅'
                                }</div>
                                <div><strong>결제 금액:</strong> {request.booking.payment_amount.toLocaleString()}원</div>
                            </div>
                        </div>

                        {/* 교환된 연락처 표시 */}
                        {request.status === 'both_approved' && (
                            <div className="bg-green-50 p-4 rounded-lg mb-6">
                                <h3 className="font-medium text-green-800 mb-3">✅ 교환된 연락처</h3>
                                <div className="space-y-3">
                                    {isExpert ? (
                                        <div>
                                            <div className="text-sm font-medium text-gray-700">고객 연락처:</div>
                                            <div className="text-sm">전화: {request.client_phone || '미제공'}</div>
                                            <div className="text-sm">이메일: {request.client_email || '미제공'}</div>
                                            <div className="text-sm">선호 연락방식: {request.client_preferred_contact || '미지정'}</div>
                                            {request.client_consultation_notes && (
                                                <div className="text-sm mt-2">
                                                    <strong>고객 메시지:</strong> {request.client_consultation_notes}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="text-sm font-medium text-gray-700">전문가 연락처:</div>
                                            <div className="text-sm">전화: {request.expert_phone || '미제공'}</div>
                                            <div className="text-sm">이메일: {request.expert_email || '미제공'}</div>
                                            <div className="text-sm">선호 연락방식: {request.expert_preferred_contact || '미지정'}</div>
                                            <div className="text-sm">상담 가능 시간: {request.expert_available_hours || '미지정'}</div>
                                            {request.expert_consultation_notes && (
                                                <div className="text-sm mt-2">
                                                    <strong>전문가 안내사항:</strong> {request.expert_consultation_notes}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 연락처 공유 폼 */}
                        {canShare && (
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <h3 className="font-medium text-gray-800 mb-4">📞 내 연락처 공유</h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            전화번호
                                        </label>
                                        <input
                                            type="tel"
                                            value={contactInfo.phone}
                                            onChange={(e) => setContactInfo(prev => ({ ...prev, phone: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="010-1234-5678"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            이메일
                                        </label>
                                        <input
                                            type="email"
                                            value={contactInfo.email}
                                            onChange={(e) => setContactInfo(prev => ({ ...prev, email: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="email@example.com"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        선호하는 연락 방식
                                    </label>
                                    <select
                                        value={contactInfo.preferred_contact}
                                        onChange={(e) => setContactInfo(prev => ({ ...prev, preferred_contact: e.target.value }))}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="phone">전화 우선</option>
                                        <option value="email">이메일 우선</option>
                                        <option value="both">둘 다 가능</option>
                                    </select>
                                </div>

                                {isExpert && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            상담 가능 시간
                                        </label>
                                        <input
                                            type="text"
                                            value={contactInfo.available_hours}
                                            onChange={(e) => setContactInfo(prev => ({ ...prev, available_hours: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="예: 평일 9-18시, 주말 상담 가능"
                                        />
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        {isExpert ? '상담 전 안내사항' : '전문가에게 전달할 메시지'}
                                    </label>
                                    <textarea
                                        value={contactInfo.consultation_notes}
                                        onChange={(e) => setContactInfo(prev => ({ ...prev, consultation_notes: e.target.value }))}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                        placeholder={isExpert ? "상담 전 준비사항이나 주의사항을 알려주세요" : "전문가에게 궁금한 점이나 요청사항을 적어주세요"}
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        취소
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        연락처 공유하기
                                    </button>
                                </div>
                            </form>
                        )}

                        {!canShare && request.status !== 'both_approved' && (
                            <div className="text-center py-8">
                                <div className="text-4xl mb-2">⏳</div>
                                <p className="text-gray-600">상대방의 연락처 공유를 기다리고 있습니다.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 실시간 채팅 컴포넌트 - 전문가-고객 상담용 개선 + WebRTC
        const ChatComponent = ({ currentUser, isAdminUser }) => {
            const [chatRooms, setChatRooms] = useState([]);
            const [selectedRoom, setSelectedRoom] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [participants, setParticipants] = useState([]);
            const [loading, setLoading] = useState(true);
            const [sending, setSending] = useState(false);
            const [showCreateRoom, setShowCreateRoom] = useState(false);
            const [isExpertConsultation, setIsExpertConsultation] = useState(false);
            
            // WebRTC 통화 관련 상태
            const [isCallActive, setIsCallActive] = useState(false);
            const [callType, setCallType] = useState(null); // 'audio' | 'video'
            const [localStream, setLocalStream] = useState(null);
            const [remoteStream, setRemoteStream] = useState(null);
            const [peerConnection, setPeerConnection] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [isVideoOff, setIsVideoOff] = useState(false);
            const [callStatus, setCallStatus] = useState('idle'); // 'idle' | 'calling' | 'ringing' | 'connected' | 'ended'
            const [showFileUpload, setShowFileUpload] = useState(false);
            const [uploadingFile, setUploadingFile] = useState(false);
            
            const messagesEndRef = useRef(null);
            const messageSubscription = useRef(null);
            const localVideoRef = useRef(null);
            const remoteVideoRef = useRef(null);
            const fileInputRef = useRef(null);
            const callSubscription = useRef(null);

            // 채팅방 목록 로드
            const loadChatRooms = async () => {
                try {
                    const { data, error } = await supabase
                        .from('chat_rooms')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setChatRooms(data || []);
                    
                    // 첫 번째 채팅방을 기본 선택
                    if (data && data.length > 0) {
                        setSelectedRoom(data[0]);
                    }
                } catch (error) {
                    console.error('채팅방 로드 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            // 채팅방 참여
            const joinRoom = async (room) => {
                try {
                    // 참여자로 추가 (이미 있으면 업데이트)
                    await supabase
                        .from('chat_participants')
                        .upsert({
                            room_id: room.id,
                            user_id: currentUser.id,
                            is_active: true
                        }, {
                            onConflict: 'room_id,user_id'
                        });
                        
                    setSelectedRoom(room);
                    loadMessages(room.id);
                    loadParticipants(room.id);
                } catch (error) {
                    console.error('채팅방 참여 오류:', error);
                }
            };

            // 메시지 로드
            const loadMessages = async (roomId) => {
                try {
                    const { data, error } = await supabase
                        .from('chat_messages')
                        .select('*')
                        .eq('room_id', roomId)
                        .order('created_at', { ascending: true })
                        .limit(100); // 최근 100개 메시지만

                    if (error) throw error;
                    setMessages(data || []);
                    
                    // 스크롤을 맨 아래로
                    setTimeout(() => scrollToBottom(), 100);
                } catch (error) {
                    console.error('메시지 로드 오류:', error);
                }
            };

            // 참여자 로드
            const loadParticipants = async (roomId) => {
                try {
                    const { data, error } = await supabase
                        .from('chat_participants')
                        .select(`
                            *,
                            user_profiles:user_id (
                                nickname,
                                role
                            )
                        `)
                        .eq('room_id', roomId)
                        .eq('is_active', true);

                    if (error) throw error;
                    setParticipants(data || []);
                } catch (error) {
                    console.error('참여자 로드 오류:', error);
                }
            };

            // 메시지 전송
            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !selectedRoom || sending) return;

                try {
                    setSending(true);
                    const { error } = await supabase
                        .from('chat_messages')
                        .insert({
                            room_id: selectedRoom.id,
                            user_id: currentUser.id,
                            user_nickname: currentUser.nickname || currentUser.email,
                            message_text: newMessage.trim(),
                            message_type: 'text'
                        });

                    if (error) throw error;
                    setNewMessage('');
                } catch (error) {
                    console.error('메시지 전송 오류:', error);
                    alert('메시지 전송 중 오류가 발생했습니다.');
                } finally {
                    setSending(false);
                }
            };

            // 스크롤을 맨 아래로
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            // 실시간 구독 설정
            const setupRealtimeSubscription = (roomId) => {
                // 기존 구독 해제
                if (messageSubscription.current) {
                    messageSubscription.current.unsubscribe();
                }

                // 새 메시지 구독
                messageSubscription.current = supabase
                    .channel(`chat-${roomId}`)
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: `room_id=eq.${roomId}`
                    }, (payload) => {
                        const message = payload.new;
                        
                        // WebRTC 시그널링 메시지 처리
                        if (message.message_type === 'webrtc-signal') {
                            try {
                                const signalData = JSON.parse(message.message_text);
                                handleSignalingMessage(signalData);
                            } catch (error) {
                                console.error('시그널링 메시지 파싱 오류:', error);
                            }
                        } else {
                            // 일반 채팅 메시지만 화면에 표시
                            setMessages(prev => [...prev, message]);
                            setTimeout(() => scrollToBottom(), 100);
                        }
                    })
                    .subscribe();
            };

            useEffect(() => {
                if (currentUser) {
                    loadChatRooms();
                }

                return () => {
                    if (messageSubscription.current) {
                        messageSubscription.current.unsubscribe();
                    }
                    
                    // WebRTC 리소스 정리
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    if (peerConnection) {
                        peerConnection.close();
                    }
                };
            }, [currentUser]);

            useEffect(() => {
                if (selectedRoom) {
                    setupRealtimeSubscription(selectedRoom.id);
                }
            }, [selectedRoom]);

            // 메시지 시간 포맷
            const formatMessageTime = (timestamp) => {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            // WebRTC 구성
            const rtcConfiguration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            // WebRTC 통화 시작
            const startCall = async (type) => {
                if (!selectedRoom || selectedRoom.room_type !== 'private') {
                    alert('프라이빗 상담방에서만 통화가 가능합니다.');
                    return;
                }

                try {
                    setCallStatus('calling');
                    setCallType(type);
                    
                    // 사용자 미디어 권한 요청
                    const constraints = {
                        audio: true,
                        video: type === 'video'
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    setLocalStream(stream);
                    
                    if (localVideoRef.current && type === 'video') {
                        localVideoRef.current.srcObject = stream;
                    }

                    // PeerConnection 생성
                    const pc = new RTCPeerConnection(rtcConfiguration);
                    setPeerConnection(pc);

                    // 로컬 스트림을 PeerConnection에 추가
                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });

                    // 원격 스트림 수신 처리
                    pc.ontrack = (event) => {
                        const [remoteStream] = event.streams;
                        setRemoteStream(remoteStream);
                        if (remoteVideoRef.current) {
                            remoteVideoRef.current.srcObject = remoteStream;
                        }
                    };

                    // ICE candidate 처리
                    pc.onicecandidate = async (event) => {
                        if (event.candidate) {
                            await sendSignalingMessage({
                                type: 'ice-candidate',
                                candidate: event.candidate,
                                roomId: selectedRoom.id,
                                from: currentUser.id
                            });
                        }
                    };

                    // 연결 상태 모니터링
                    pc.onconnectionstatechange = () => {
                        console.log('Connection state:', pc.connectionState);
                        if (pc.connectionState === 'connected') {
                            setCallStatus('connected');
                            setIsCallActive(true);
                        } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                            endCall();
                        }
                    };

                    // offer 생성 및 전송
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    await sendSignalingMessage({
                        type: 'offer',
                        offer: offer,
                        callType: type,
                        roomId: selectedRoom.id,
                        from: currentUser.id
                    });

                } catch (error) {
                    console.error('통화 시작 오류:', error);
                    alert('통화를 시작할 수 없습니다. 마이크/카메라 권한을 확인해주세요.');
                    setCallStatus('idle');
                }
            };

            // 통화 종료
            const endCall = () => {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    setLocalStream(null);
                }
                
                if (peerConnection) {
                    peerConnection.close();
                    setPeerConnection(null);
                }
                
                setRemoteStream(null);
                setIsCallActive(false);
                setCallStatus('idle');
                setCallType(null);
                setIsMuted(false);
                setIsVideoOff(false);

                // 통화 종료 신호 전송
                if (selectedRoom) {
                    sendSignalingMessage({
                        type: 'end-call',
                        roomId: selectedRoom.id,
                        from: currentUser.id
                    });
                }
            };

            // 음소거 토글
            const toggleMute = () => {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        setIsMuted(!audioTrack.enabled);
                    }
                }
            };

            // 비디오 토글
            const toggleVideo = () => {
                if (localStream && callType === 'video') {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        setIsVideoOff(!videoTrack.enabled);
                    }
                }
            };

            // 시그널링 메시지 전송 (Supabase 채팅 메시지 이용)
            const sendSignalingMessage = async (signalData) => {
                try {
                    await supabase
                        .from('chat_messages')
                        .insert({
                            room_id: signalData.roomId,
                            user_id: currentUser.id,
                            user_nickname: currentUser.nickname || currentUser.email,
                            message_text: JSON.stringify(signalData),
                            message_type: 'webrtc-signal'
                        });
                } catch (error) {
                    console.error('시그널링 메시지 전송 오류:', error);
                }
            };

            // WebRTC 시그널링 처리
            const handleSignalingMessage = async (signalData) => {
                try {
                    switch (signalData.type) {
                        case 'offer':
                            await handleOffer(signalData);
                            break;
                        case 'answer':
                            await handleAnswer(signalData);
                            break;
                        case 'ice-candidate':
                            await handleIceCandidate(signalData);
                            break;
                        case 'end-call':
                            endCall();
                            break;
                    }
                } catch (error) {
                    console.error('시그널링 처리 오류:', error);
                }
            };

            // Offer 처리
            const handleOffer = async (signalData) => {
                if (!peerConnection && signalData.from !== currentUser.id) {
                    const shouldAccept = confirm('음성/영상 통화 요청이 왔습니다. 수락하시겠습니까?');
                    if (!shouldAccept) return;

                    setCallStatus('ringing');
                    setCallType(signalData.callType);

                    // 사용자 미디어 가져오기
                    const constraints = {
                        audio: true,
                        video: signalData.callType === 'video'
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    setLocalStream(stream);

                    if (localVideoRef.current && signalData.callType === 'video') {
                        localVideoRef.current.srcObject = stream;
                    }

                    // PeerConnection 생성
                    const pc = new RTCPeerConnection(rtcConfiguration);
                    setPeerConnection(pc);

                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });

                    pc.ontrack = (event) => {
                        const [remoteStream] = event.streams;
                        setRemoteStream(remoteStream);
                        if (remoteVideoRef.current) {
                            remoteVideoRef.current.srcObject = remoteStream;
                        }
                    };

                    pc.onicecandidate = async (event) => {
                        if (event.candidate) {
                            await sendSignalingMessage({
                                type: 'ice-candidate',
                                candidate: event.candidate,
                                roomId: selectedRoom.id,
                                from: currentUser.id
                            });
                        }
                    };

                    pc.onconnectionstatechange = () => {
                        if (pc.connectionState === 'connected') {
                            setCallStatus('connected');
                            setIsCallActive(true);
                        } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                            endCall();
                        }
                    };

                    // remote description 설정 및 answer 생성
                    await pc.setRemoteDescription(signalData.offer);
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    await sendSignalingMessage({
                        type: 'answer',
                        answer: answer,
                        roomId: selectedRoom.id,
                        from: currentUser.id
                    });
                }
            };

            // Answer 처리
            const handleAnswer = async (signalData) => {
                if (peerConnection && signalData.from !== currentUser.id) {
                    await peerConnection.setRemoteDescription(signalData.answer);
                }
            };

            // ICE Candidate 처리
            const handleIceCandidate = async (signalData) => {
                if (peerConnection && signalData.from !== currentUser.id) {
                    await peerConnection.addIceCandidate(signalData.candidate);
                }
            };

            // 파일 업로드 처리
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file || !selectedRoom) return;

                // 파일 크기 체크 (10MB 제한)
                if (file.size > 10 * 1024 * 1024) {
                    alert('파일 크기가 10MB를 초과합니다.');
                    return;
                }

                setUploadingFile(true);
                try {
                    // 현재는 Supabase Storage 없이 파일 이름만 메시지로 전송
                    // 실제 환경에서는 아래 주석을 해제하고 Supabase Storage 설정 필요
                    /*
                    const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
                    const { data, error } = await supabase.storage
                        .from('chat-files')
                        .upload(fileName, file);

                    if (error) throw error;
                    */

                    // 임시로 파일 정보만 메시지로 전송
                    const fileInfo = {
                        name: file.name,
                        size: Math.round(file.size / 1024), // KB 단위
                        type: file.type,
                        uploadTime: new Date().toISOString()
                    };

                    // 파일 공유 메시지 전송
                    await supabase
                        .from('chat_messages')
                        .insert({
                            room_id: selectedRoom.id,
                            user_id: currentUser.id,
                            user_nickname: currentUser.nickname || currentUser.email,
                            message_text: `📎 ${file.name} (${fileInfo.size}KB)`,
                            message_type: 'file',
                            file_url: null // 실제 Storage 설정 후에는 data.path 사용
                        });

                    setShowFileUpload(false);
                    
                    // 성공 메시지
                    setTimeout(() => {
                        alert('파일이 공유되었습니다. (데모 모드: 실제 파일은 업로드되지 않음)');
                    }, 500);

                } catch (error) {
                    console.error('파일 업로드 오류:', error);
                    alert('파일 공유 중 오류가 발생했습니다.');
                } finally {
                    setUploadingFile(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-96">
                        <div className="text-center">
                            <div className="text-4xl mb-4">💬</div>
                            <p className="text-gray-500">채팅방을 불러오는 중...</p>
                        </div>
                    </div>
                );
            }

            // 전문가 상담 요청 함수
            const requestExpertConsultation = async () => {
                try {
                    const roomName = `${currentUser.nickname || currentUser.email}님의 상담실`;
                    const { data, error } = await supabase
                        .from('chat_rooms')
                        .insert({
                            name: roomName,
                            description: '전문가와의 1:1 상담을 위한 프라이빗 채팅방입니다.',
                            room_type: 'private',
                            created_by: currentUser.id,
                            max_participants: 2
                        })
                        .select()
                        .single();

                    if (error) throw error;
                    
                    // 생성된 방에 자동 참여
                    await joinRoom(data);
                    loadChatRooms();
                    setShowCreateRoom(false);
                } catch (error) {
                    console.error('상담방 생성 오류:', error);
                    alert('상담방 생성 중 오류가 발생했습니다.');
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[700px] flex flex-col lg:flex-row">
                    {/* 채팅방 목록 (왼쪽/상단) */}
                    <div className="w-full lg:w-1/3 border-b lg:border-b-0 lg:border-r border-gray-200 flex flex-col h-48 lg:h-auto">
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-4 text-white">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-lg font-bold">💬 실시간 상담</h2>
                                    <p className="text-blue-100 text-sm">전문가와 소통하세요</p>
                                </div>
                                <button
                                    onClick={() => setShowCreateRoom(true)}
                                    className="px-3 py-1 bg-white bg-opacity-20 rounded-lg text-sm hover:bg-opacity-30 transition-colors"
                                >
                                    + 상담 요청
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto">
                            {chatRooms.length === 0 ? (
                                <div className="text-center py-8 px-4">
                                    <div className="text-4xl mb-2">🔍</div>
                                    <p className="text-gray-500 text-sm mb-4">아직 참여중인 채팅방이 없습니다</p>
                                    <button
                                        onClick={() => setShowCreateRoom(true)}
                                        className="text-blue-600 text-sm underline hover:text-blue-700"
                                    >
                                        전문가 상담 요청하기
                                    </button>
                                </div>
                            ) : (
                                chatRooms.map((room) => (
                                    <div
                                        key={room.id}
                                        onClick={() => joinRoom(room)}
                                        className={`p-3 cursor-pointer border-b border-gray-100 hover:bg-gray-50 transition-all duration-200 ${
                                            selectedRoom?.id === room.id ? 'bg-blue-50 border-l-4 border-l-blue-500 shadow-sm' : ''
                                        }`}
                                    >
                                        <div className="flex items-start justify-between mb-2">
                                            <h3 className="font-medium text-gray-800 text-sm truncate pr-2">{room.name}</h3>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-medium flex-shrink-0 ${
                                                room.room_type === 'expert' ? 'bg-orange-100 text-orange-700' :
                                                room.room_type === 'private' ? 'bg-purple-100 text-purple-700' :
                                                'bg-green-100 text-green-700'
                                            }`}>
                                                {room.room_type === 'expert' ? '👨‍💼' :
                                                 room.room_type === 'private' ? '🔒' : '👥'}
                                            </span>
                                        </div>
                                        <p className="text-xs text-gray-600 line-clamp-2 mb-2">{room.description}</p>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center text-xs text-gray-500">
                                                <span className="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                                활성 상태
                                            </div>
                                            <div className="text-xs text-gray-400">
                                                {new Date(room.created_at).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* 채팅 영역 (오른쪽) */}
                    <div className="flex-1 flex flex-col">
                        {selectedRoom ? (
                            <>
                                {/* 채팅방 헤더 - 전문가 상담용 개선 */}
                                <div className="bg-gradient-to-r from-gray-50 to-blue-50 px-4 py-3 border-b border-gray-200">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center space-x-3">
                                            <div className={`w-3 h-3 rounded-full ${
                                                selectedRoom.room_type === 'expert' ? 'bg-orange-400' :
                                                selectedRoom.room_type === 'private' ? 'bg-purple-400' :
                                                'bg-green-400'
                                            } animate-pulse`}></div>
                                            <div>
                                                <h3 className="font-bold text-gray-800 flex items-center">
                                                    {selectedRoom.name}
                                                    {selectedRoom.room_type === 'private' && (
                                                        <span className="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                                            🔒 프라이빗 상담
                                                        </span>
                                                    )}
                                                </h3>
                                                <p className="text-xs text-gray-600">{selectedRoom.description}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            <div className="text-right">
                                                <div className="text-sm text-gray-600">
                                                    👥 {participants.length}명
                                                </div>
                                                {selectedRoom.room_type === 'private' && (
                                                    <div className="text-xs text-green-600 font-medium">
                                                        ✅ 상담 진행중
                                                    </div>
                                                )}
                                            </div>
                                            {/* 상담 도구 버튼들 */}
                                            {selectedRoom.room_type === 'private' && (
                                                <div className="flex space-x-1">
                                                    {!isCallActive ? (
                                                        <>
                                                            <button
                                                                onClick={() => startCall('audio')}
                                                                disabled={callStatus !== 'idle'}
                                                                className="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors disabled:opacity-50"
                                                                title="음성 통화"
                                                            >
                                                                📞
                                                            </button>
                                                            <button
                                                                onClick={() => startCall('video')}
                                                                disabled={callStatus !== 'idle'}
                                                                className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors disabled:opacity-50"
                                                                title="영상 통화"
                                                            >
                                                                📹
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <div className="flex space-x-1">
                                                            <button
                                                                onClick={toggleMute}
                                                                className={`p-2 rounded-lg transition-colors ${
                                                                    isMuted 
                                                                        ? 'text-red-600 bg-red-50' 
                                                                        : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                                                }`}
                                                                title={isMuted ? '음소거 해제' : '음소거'}
                                                            >
                                                                {isMuted ? '🔇' : '🎤'}
                                                            </button>
                                                            {callType === 'video' && (
                                                                <button
                                                                    onClick={toggleVideo}
                                                                    className={`p-2 rounded-lg transition-colors ${
                                                                        isVideoOff 
                                                                            ? 'text-red-600 bg-red-50' 
                                                                            : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                                                    }`}
                                                                    title={isVideoOff ? '비디오 켜기' : '비디오 끄기'}
                                                                >
                                                                    {isVideoOff ? '📵' : '📹'}
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={endCall}
                                                                className="p-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors"
                                                                title="통화 종료"
                                                            >
                                                                📴
                                                            </button>
                                                        </div>
                                                    )}
                                                    <button
                                                        onClick={() => setShowFileUpload(true)}
                                                        className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                        title="파일 공유"
                                                    >
                                                        📎
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 비디오 통화 영역 */}
                                {isCallActive && callType === 'video' && (
                                    <div className="bg-black p-4 flex-shrink-0">
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 h-64">
                                            {/* 원격 비디오 (상대방) */}
                                            <div className="relative bg-gray-800 rounded-lg overflow-hidden">
                                                <video
                                                    ref={remoteVideoRef}
                                                    autoPlay
                                                    playsInline
                                                    className="w-full h-full object-cover"
                                                />
                                                <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                                    상대방
                                                </div>
                                            </div>
                                            
                                            {/* 로컬 비디오 (본인) */}
                                            <div className="relative bg-gray-700 rounded-lg overflow-hidden">
                                                <video
                                                    ref={localVideoRef}
                                                    autoPlay
                                                    playsInline
                                                    muted
                                                    className="w-full h-full object-cover"
                                                />
                                                <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                                    나
                                                </div>
                                                {isVideoOff && (
                                                    <div className="absolute inset-0 bg-gray-600 flex items-center justify-center">
                                                        <div className="text-white text-center">
                                                            <div className="text-4xl mb-2">📵</div>
                                                            <div>비디오 꺼짐</div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* 통화 상태 표시 */}
                                        <div className="text-center text-white mt-2">
                                            {callStatus === 'calling' && '📞 통화 연결 중...'}
                                            {callStatus === 'ringing' && '📞 상대방이 응답을 기다리고 있습니다...'}
                                            {callStatus === 'connected' && (
                                                <span className="text-green-400">✅ 통화 연결됨</span>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* 음성 통화 상태 표시 */}
                                {isCallActive && callType === 'audio' && (
                                    <div className="bg-gradient-to-r from-green-500 to-blue-500 p-4 text-white text-center flex-shrink-0">
                                        <div className="flex items-center justify-center space-x-4">
                                            <div className="text-2xl animate-pulse">📞</div>
                                            <div>
                                                <div className="font-medium">음성 통화 진행중</div>
                                                <div className="text-sm opacity-90">
                                                    {callStatus === 'calling' && '통화 연결 중...'}
                                                    {callStatus === 'ringing' && '상대방 응답 대기중...'}
                                                    {callStatus === 'connected' && '✅ 연결됨'}
                                                </div>
                                            </div>
                                            <div className="text-2xl">
                                                {isMuted ? '🔇' : '🎤'}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* 메시지 영역 - 전문가 상담용 개선 */}
                                <div className={`flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 ${
                                    isCallActive ? 'max-h-64' : ''
                                }`}>
                                    {messages.length === 0 ? (
                                        <div className="text-center text-gray-500 mt-16">
                                            <div className="text-6xl mb-4">
                                                {selectedRoom.room_type === 'private' ? '🏥' : '💭'}
                                            </div>
                                            <h3 className="text-lg font-medium mb-2">
                                                {selectedRoom.room_type === 'private' ? '상담을 시작하세요' : '대화를 시작하세요'}
                                            </h3>
                                            <p className="text-sm">
                                                {selectedRoom.room_type === 'private' 
                                                    ? '전문가와 안전한 1:1 상담을 진행할 수 있습니다'
                                                    : '첫 번째 메시지를 보내보세요!'
                                                }
                                            </p>
                                        </div>
                                    ) : (
                                        messages.map((message, index) => {
                                            const isMyMessage = message.user_id === currentUser.id;
                                            const isExpertMessage = message.user_nickname && message.user_nickname.includes('전문가');
                                            const showAvatar = index === 0 || messages[index - 1].user_id !== message.user_id;
                                            
                                            return (
                                                <div
                                                    key={message.id}
                                                    className={`flex items-end space-x-2 ${
                                                        isMyMessage ? 'justify-end flex-row-reverse space-x-reverse' : 'justify-start'
                                                    }`}
                                                >
                                                    {/* 프로필 아이콘 */}
                                                    {showAvatar && !isMyMessage && (
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                                                            isExpertMessage 
                                                                ? 'bg-orange-100 text-orange-700' 
                                                                : 'bg-blue-100 text-blue-700'
                                                        }`}>
                                                            {isExpertMessage ? '👨‍💼' : '👤'}
                                                        </div>
                                                    )}
                                                    {showAvatar && isMyMessage && (
                                                        <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                                            나
                                                        </div>
                                                    )}
                                                    
                                                    {/* 메시지 버블 */}
                                                    <div className={`max-w-xs lg:max-w-md ${!showAvatar ? 'ml-10' : ''}`}>
                                                        {/* 발신자 이름 (전문가 강조) */}
                                                        {!isMyMessage && showAvatar && (
                                                            <div className={`text-xs font-medium mb-1 ml-1 ${
                                                                isExpertMessage ? 'text-orange-700' : 'text-gray-600'
                                                            }`}>
                                                                {isExpertMessage && '⭐ '}
                                                                {message.user_nickname}
                                                                {isExpertMessage && ' (전문가)'}
                                                            </div>
                                                        )}
                                                        
                                                        {/* 메시지 내용 */}
                                                        <div className={`px-4 py-3 rounded-2xl shadow-sm ${
                                                            isMyMessage
                                                                ? 'bg-blue-500 text-white rounded-br-md'
                                                                : isExpertMessage
                                                                    ? 'bg-orange-50 text-orange-900 border border-orange-200 rounded-bl-md'
                                                                    : 'bg-white text-gray-800 border border-gray-200 rounded-bl-md'
                                                        }`}>
                                                            {message.message_type === 'file' ? (
                                                                <div className="flex items-center space-x-2">
                                                                    <div className="text-2xl">📎</div>
                                                                    <div className="flex-1">
                                                                        <div className="font-medium">{message.message_text}</div>
                                                                        <button
                                                                            onClick={() => {
                                                                                // 데모 모드: 실제 파일 다운로드 대신 알림 표시
                                                                                if (message.file_url) {
                                                                                    // 실제 환경에서는 아래 코드 사용
                                                                                    // const { data } = supabase.storage
                                                                                    //     .from('chat-files')
                                                                                    //     .getPublicUrl(message.file_url);
                                                                                    // window.open(data.publicUrl, '_blank');
                                                                                    alert('파일 다운로드 기능 (실제 배포 시 활성화됩니다)');
                                                                                } else {
                                                                                    alert('파일 다운로드: 데모 모드에서는 실제 파일이 저장되지 않습니다.');
                                                                                }
                                                                            }}
                                                                            className={`text-xs underline hover:no-underline ${
                                                                                isMyMessage ? 'text-blue-200' : 'text-blue-600'
                                                                            }`}
                                                                        >
                                                                            다운로드 (데모)
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className="whitespace-pre-wrap break-words leading-relaxed">
                                                                    {message.message_text}
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* 시간 */}
                                                        <div className={`text-xs mt-1 px-1 ${
                                                            isMyMessage ? 'text-right text-gray-400' : 'text-left text-gray-500'
                                                        }`}>
                                                            {formatMessageTime(message.created_at)}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* 메시지 입력 - 전문가 상담용 개선 */}
                                <div className="border-t border-gray-200 bg-white p-4">
                                    {selectedRoom.room_type === 'private' && (
                                        <div className="flex items-center justify-between bg-blue-50 rounded-lg px-3 py-2 mb-3 text-sm">
                                            <div className="flex items-center space-x-2">
                                                <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                                                <span className="text-blue-700 font-medium">안전한 1:1 상담 진행중</span>
                                            </div>
                                            <div className="text-xs text-blue-600">
                                                🔒 암호화된 대화
                                            </div>
                                        </div>
                                    )}
                                    
                                    <form onSubmit={sendMessage} className="space-y-3">
                                        <div className="flex gap-2">
                                            <div className="flex-1 relative">
                                                <input
                                                    type="text"
                                                    value={newMessage}
                                                    onChange={(e) => setNewMessage(e.target.value)}
                                                    placeholder={
                                                        selectedRoom.room_type === 'private' 
                                                            ? "궁금한 점을 자세히 말씀해 주세요..."
                                                            : "메시지를 입력하세요..."
                                                    }
                                                    className="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                                    disabled={sending}
                                                    maxLength="1000"
                                                />
                                                <div className="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">
                                                    {newMessage.length}/1000
                                                </div>
                                            </div>
                                            <button
                                                type="submit"
                                                disabled={!newMessage.trim() || sending}
                                                className={`px-6 py-3 rounded-xl font-medium transition-all duration-200 ${
                                                    !newMessage.trim() || sending
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : selectedRoom.room_type === 'private'
                                                            ? 'bg-orange-500 hover:bg-orange-600 text-white shadow-lg hover:shadow-xl'
                                                            : 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl'
                                                }`}
                                            >
                                                {sending ? (
                                                    <div className="flex items-center space-x-2">
                                                        <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                                                        <span>전송중</span>
                                                    </div>
                                                ) : (
                                                    '전송 📤'
                                                )}
                                            </button>
                                        </div>
                                        
                                        {/* 빠른 응답 버튼들 (상담용) */}
                                        {selectedRoom.room_type === 'private' && newMessage === '' && (
                                            <div className="flex flex-wrap gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => setNewMessage('안녕하세요! 상담 요청드립니다.')}
                                                    className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                                >
                                                    👋 인사
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setNewMessage('은퇴 계획에 대해 상담받고 싶습니다.')}
                                                    className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                                >
                                                    💰 은퇴 계획
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setNewMessage('투자 포트폴리오 검토를 부탁드립니다.')}
                                                    className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                                >
                                                    📈 투자 상담
                                                </button>
                                            </div>
                                        )}
                                    </form>
                                </div>
                            </>
                        ) : (
                            <div className="flex items-center justify-center h-full text-gray-500">
                                <div className="text-center max-w-md">
                                    <div className="text-6xl mb-6">🏥</div>
                                    <h3 className="text-xl font-semibold text-gray-700 mb-4">전문가 상담 시작하기</h3>
                                    <p className="text-gray-600 mb-6 leading-relaxed">
                                        은퇴 계획, 투자, 재무 설계에 대해<br/>
                                        전문가와 안전하게 상담하세요
                                    </p>
                                    <button
                                        onClick={() => setShowCreateRoom(true)}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-medium hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 shadow-lg hover:shadow-xl"
                                    >
                                        🚀 새 상담 시작하기
                                    </button>
                                    <div className="mt-4 text-sm text-gray-500">
                                        💡 1:1 프라이빗 상담 | 🔒 안전한 암호화 대화
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* 파일 업로드 모달 */}
                    {showFileUpload && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
                                <div className="text-center mb-6">
                                    <div className="text-4xl mb-3">📎</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">파일 공유</h3>
                                    <p className="text-gray-600 text-sm">
                                        상담 자료나 문서를 공유할 수 있습니다
                                    </p>
                                </div>
                                
                                <div className="space-y-4 mb-6">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            onChange={handleFileUpload}
                                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip"
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            disabled={uploadingFile}
                                            className="text-gray-500 hover:text-blue-600 transition-colors disabled:opacity-50"
                                        >
                                            {uploadingFile ? (
                                                <div className="flex items-center justify-center space-x-2">
                                                    <div className="animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                                                    <span>업로드 중...</span>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="text-4xl mb-2">📁</div>
                                                    <div className="text-sm">파일을 선택하거나 드래그하세요</div>
                                                    <div className="text-xs text-gray-400 mt-1">
                                                        PDF, DOC, 이미지, ZIP 파일 지원
                                                    </div>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                    
                                    <div className="bg-yellow-50 rounded-lg p-3">
                                        <h4 className="font-medium text-yellow-800 mb-2">📋 유의사항</h4>
                                        <div className="text-xs text-yellow-700 space-y-1">
                                            <div>• 최대 파일 크기: 10MB</div>
                                            <div>• 개인정보 포함 파일은 주의하세요</div>
                                            <div>• 업로드된 파일은 암호화 저장됩니다</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => setShowFileUpload(false)}
                                        disabled={uploadingFile}
                                        className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors disabled:opacity-50"
                                    >
                                        취소
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 상담방 생성 모달 */}
                    {showCreateRoom && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
                                <div className="text-center mb-6">
                                    <div className="text-4xl mb-3">🏥</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">전문가 상담 요청</h3>
                                    <p className="text-gray-600 text-sm">
                                        전문가와의 1:1 상담방을 생성합니다
                                    </p>
                                </div>
                                
                                <div className="space-y-4 mb-6">
                                    <div className="bg-blue-50 rounded-lg p-4">
                                        <div className="flex items-center space-x-3">
                                            <div className="text-2xl">👤</div>
                                            <div>
                                                <div className="font-medium text-gray-800">
                                                    {currentUser?.nickname || currentUser?.email}
                                                </div>
                                                <div className="text-sm text-gray-600">상담 신청자</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-orange-50 rounded-lg p-4">
                                        <h4 className="font-medium text-gray-800 mb-2">🎯 상담 가능 분야</h4>
                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                            <div className="text-gray-700">• 은퇴 계획 설계</div>
                                            <div className="text-gray-700">• 투자 포트폴리오</div>
                                            <div className="text-gray-700">• 세금 최적화</div>
                                            <div className="text-gray-700">• 보험 상담</div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-green-50 rounded-lg p-4">
                                        <h4 className="font-medium text-gray-800 mb-2">✅ 상담 혜택</h4>
                                        <div className="text-sm space-y-1">
                                            <div className="text-gray-700">• 전문가 1:1 맞춤 상담</div>
                                            <div className="text-gray-700">• 안전한 프라이빗 대화</div>
                                            <div className="text-gray-700">• 자료 공유 가능</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => setShowCreateRoom(false)}
                                        className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors"
                                    >
                                        취소
                                    </button>
                                    <button
                                        onClick={requestExpertConsultation}
                                        className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-lg"
                                    >
                                        상담 시작하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 공지사항 컴포넌트
        const AnnouncementComponent = ({ currentUser, isAdminUser }) => {
            const [announcements, setAnnouncements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [selectedAnnouncement, setSelectedAnnouncement] = useState(null);
            const [showDetailModal, setShowDetailModal] = useState(false);

            // 공지사항 목록 로드
            const loadAnnouncements = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('announcements')
                        .select('*')
                        .eq('is_active', true)
                        .order('is_important', { ascending: false })
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setAnnouncements(data || []);
                } catch (error) {
                    console.error('공지사항 로드 오류:', error);
                } finally {
                    setLoading(false);
                }
            };

            // 조회수 증가
            const incrementViewCount = async (announcementId) => {
                if (!currentUser || currentUser.isGuest) return;
                
                try {
                    await supabase
                        .from('announcement_views')
                        .upsert({ 
                            announcement_id: announcementId, 
                            user_id: currentUser.id 
                        }, { 
                            onConflict: 'announcement_id,user_id' 
                        });
                } catch (error) {
                    console.error('조회수 증가 오류:', error);
                }
            };

            useEffect(() => {
                loadAnnouncements();
            }, []);

            // 공지사항 상세보기
            const handleAnnouncementClick = (announcement) => {
                setSelectedAnnouncement(announcement);
                setShowDetailModal(true);
                incrementViewCount(announcement.id);
            };

            // 공지사항 삭제 (관리자만)
            const handleDeleteAnnouncement = async (id) => {
                if (!isAdminUser(currentUser)) return;
                
                if (confirm('정말 이 공지사항을 삭제하시겠습니까?')) {
                    try {
                        const { error } = await supabase
                            .from('announcements')
                            .update({ is_active: false })
                            .eq('id', id);

                        if (error) throw error;
                        
                        alert('공지사항이 삭제되었습니다.');
                        loadAnnouncements();
                    } catch (error) {
                        console.error('삭제 오류:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        {/* 헤더 */}
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-8 text-white">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl font-bold mb-2">📢 공지사항</h1>
                                    <p className="text-blue-100">
                                        플랜비의 새로운 소식과 중요한 안내사항을 확인하세요
                                    </p>
                                </div>
                                {isAdminUser(currentUser) && (
                                    <button
                                        onClick={() => setShowWriteModal(true)}
                                        className="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-colors"
                                    >
                                        ✏️ 공지 작성
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* 공지사항 목록 */}
                        <div className="p-6">
                            {loading ? (
                                <div className="text-center py-12">
                                    <div className="text-4xl mb-4">📡</div>
                                    <p className="text-gray-500">공지사항을 불러오는 중...</p>
                                </div>
                            ) : announcements.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-4xl mb-4">📭</div>
                                    <p className="text-gray-500">등록된 공지사항이 없습니다.</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {announcements.map((announcement) => (
                                        <div
                                            key={announcement.id}
                                            className={`border rounded-lg p-5 cursor-pointer transition-all hover:shadow-md ${
                                                announcement.is_important
                                                    ? 'border-red-300 bg-red-50 hover:bg-red-100'
                                                    : 'border-gray-200 bg-white hover:bg-gray-50'
                                            }`}
                                            onClick={() => handleAnnouncementClick(announcement)}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        {announcement.is_important && (
                                                            <span className="bg-red-500 text-white px-2 py-1 rounded text-xs font-medium">
                                                                중요
                                                            </span>
                                                        )}
                                                        <h3 className="text-lg font-semibold text-gray-800 line-clamp-1">
                                                            {announcement.title}
                                                        </h3>
                                                    </div>
                                                    <p className="text-gray-600 text-sm line-clamp-2 mb-3">
                                                        {announcement.content}
                                                    </p>
                                                    <div className="text-xs text-gray-400">
                                                        {new Date(announcement.created_at).toLocaleDateString('ko-KR', {
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </div>
                                                </div>
                                                {isAdminUser(currentUser) && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleDeleteAnnouncement(announcement.id);
                                                        }}
                                                        className="text-red-400 hover:text-red-600 p-1"
                                                        title="삭제"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 공지사항 상세보기 모달 */}
                    {showDetailModal && selectedAnnouncement && (
                        <AnnouncementDetailModal
                            announcement={selectedAnnouncement}
                            onClose={() => {
                                setShowDetailModal(false);
                                setSelectedAnnouncement(null);
                            }}
                        />
                    )}

                    {/* 공지사항 작성 모달 */}
                    {showWriteModal && (
                        <AnnouncementWriteModal
                            currentUser={currentUser}
                            onClose={() => setShowWriteModal(false)}
                            onSuccess={() => {
                                setShowWriteModal(false);
                                loadAnnouncements();
                            }}
                        />
                    )}
                </div>
            );
        };

        // 공지사항 상세보기 모달
        const AnnouncementDetailModal = ({ announcement, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-xl">
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                    {announcement.is_important && (
                                        <span className="bg-red-500 text-white px-2 py-1 rounded text-xs font-medium">
                                            중요
                                        </span>
                                    )}
                                    <h2 className="text-xl font-bold text-gray-800">
                                        {announcement.title}
                                    </h2>
                                </div>
                                <p className="text-sm text-gray-500">
                                    {new Date(announcement.created_at).toLocaleDateString('ko-KR', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </p>
                            </div>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                            >
                                ×
                            </button>
                        </div>

                        <div className="prose prose-sm max-w-none">
                            <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">
                                {announcement.content}
                            </div>
                        </div>

                        <div className="mt-6 pt-4 border-t border-gray-200">
                            <button
                                onClick={onClose}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                확인
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 공지사항 작성 모달
        const AnnouncementWriteModal = ({ currentUser, onClose, onSuccess }) => {
            const [formData, setFormData] = useState({
                title: '',
                content: '',
                is_important: false
            });
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.title.trim() || !formData.content.trim()) {
                    alert('제목과 내용을 모두 입력해주세요.');
                    return;
                }

                try {
                    setSubmitting(true);
                    const { error } = await supabase
                        .from('announcements')
                        .insert({
                            title: formData.title.trim(),
                            content: formData.content.trim(),
                            is_important: formData.is_important,
                            created_by: currentUser.id
                        });

                    if (error) throw error;

                    alert('공지사항이 등록되었습니다.');
                    onSuccess();
                } catch (error) {
                    console.error('공지사항 등록 오류:', error);
                    alert('등록 중 오류가 발생했습니다.');
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">📢 공지사항 작성</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                            >
                                ×
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    제목 *
                                </label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="공지사항 제목을 입력하세요"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    내용 *
                                </label>
                                <textarea
                                    value={formData.content}
                                    onChange={(e) => setFormData(prev => ({ ...prev, content: e.target.value }))}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="10"
                                    placeholder="공지사항 내용을 입력하세요"
                                    required
                                />
                            </div>

                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="is_important"
                                    checked={formData.is_important}
                                    onChange={(e) => setFormData(prev => ({ ...prev, is_important: e.target.checked }))}
                                    className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                                />
                                <label htmlFor="is_important" className="ml-2 text-sm text-gray-700">
                                    중요 공지사항으로 설정 (상단에 고정됩니다)
                                </label>
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                >
                                    취소
                                </button>
                                <button
                                    type="submit"
                                    disabled={submitting}
                                    className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400"
                                >
                                    {submitting ? '등록 중...' : '등록하기'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 전문가 찾기 컴포넌트
        const ExpertFinderComponent = ({ currentUser, isAdminUser, setShowSignupModal }) => {
            const [activeCategory, setActiveCategory] = useState('travel');
            const [showBookingModal, setShowBookingModal] = useState(false);
            const [selectedExpert, setSelectedExpert] = useState(null);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [isExpert, setIsExpert] = useState(false);

            // 전문가 여부 확인 (관리자는 모든 권한 보유)
            useEffect(() => {
                const checkExpertStatus = async () => {
                    if (!currentUser) {
                        setIsExpert(false);
                        return;
                    }

                    // 관리자는 모든 전문가 권한 보유
                    if (isAdminUser && isAdminUser(currentUser)) {
                        setIsExpert(true);
                        return;
                    }

                    try {
                        const { data: expertProfile } = await supabase
                            .from('financial_experts')
                            .select('is_verified, is_active')
                            .eq('user_id', currentUser.id)
                            .single();

                        setIsExpert(expertProfile?.is_verified === true && expertProfile?.is_active === true);
                    } catch (error) {
                        setIsExpert(false);
                    }
                };

                checkExpertStatus();
            }, [currentUser]);

            // 글쓰기 완료 후 새로고침
            const handleWriteSuccess = () => {
                // 필요시 전문가 목록 새로고침 로직 추가
                console.log('전문가 글 작성 완료');
            };
            
            // 3대 전문가 카테고리 정의
            const expertCategories = {
                'travel': {
                    name: '여행/취미',
                    icon: '✈️',
                    color: 'from-orange-500 to-red-500',
                    bgColor: 'from-orange-50 to-red-50',
                    description: '은퇴 후 여행과 취미생활 전문가'
                },
                'legal': {
                    name: '세무/법무/자산관리',
                    icon: '📋',
                    color: 'from-blue-500 to-indigo-500',
                    bgColor: 'from-blue-50 to-indigo-50',
                    description: '상속, 세금, 자산관리 전문가 (상담만, 판매 금지)'
                },
                'living': {
                    name: '주거/생활',
                    icon: '🏠',
                    color: 'from-green-500 to-emerald-500',
                    bgColor: 'from-green-50 to-emerald-50',
                    description: '은퇴 후 주거와 생활환경 설계 전문가'
                }
            };

            // 더미 전문가 데이터
            const expertData = {
                'travel': [
                    {
                        id: 1,
                        name: '김여행플래너',
                        title: '시니어 여행 전문 플래너',
                        experience: '12년 경력',
                        rating: 4.8,
                        reviews: 156,
                        specialties: ['안전여행', '의료동행여행', '장기체류', '해외거주'],
                        price: '60,000원/60분',
                        responseRate: 95,
                        profileImage: '✈️'
                    },
                    {
                        id: 2,
                        name: '박취미코치',
                        title: '시니어 라이프 취미 코치',
                        experience: '15년 경력',
                        rating: 4.9,
                        reviews: 203,
                        specialties: ['원예', '사진', '요리', '독서모임'],
                        price: '45,000원/60분',
                        responseRate: 92,
                        profileImage: '🎨'
                    },
                    {
                        id: 3,
                        name: '이평생교육사',
                        title: '시니어 교육 전문가',
                        experience: '10년 경력',
                        rating: 4.7,
                        reviews: 134,
                        specialties: ['디지털교육', '온라인학습', '자격증취득'],
                        price: '40,000원/45분',
                        responseRate: 88,
                        profileImage: '📚'
                    }
                ],
                'legal': [
                    {
                        id: 4,
                        name: '최세무사',
                        title: '상속세 절세 전문 세무사',
                        experience: '20년 경력',
                        rating: 4.9,
                        reviews: 156,
                        specialties: ['상속세 절세', '증여세 최적화', '연금소득세'],
                        price: '100,000원/60분',
                        responseRate: 97,
                        profileImage: '📊'
                    },
                    {
                        id: 5,
                        name: '정변호사',
                        title: '상속전문 변호사',
                        experience: '18년 경력',
                        rating: 4.8,
                        reviews: 134,
                        specialties: ['상속법률', '유언작성', '가족신탁'],
                        price: '150,000원/60분',
                        responseRate: 94,
                        profileImage: '⚖️'
                    },
                    {
                        id: 6,
                        name: '한자산관리사',
                        title: 'CFP 자산관리 상담사',
                        experience: '25년 경력',
                        rating: 4.9,
                        reviews: 298,
                        specialties: ['자산배분상담', '연금전략설계', '리스크관리'],
                        price: '120,000원/90분',
                        responseRate: 96,
                        profileImage: '💼'
                    }
                ],
                'living': [
                    {
                        id: 7,
                        name: '윤부동산컨설턴트',
                        title: '시니어 주거 전문 컨설턴트',
                        experience: '15년 경력',
                        rating: 4.8,
                        reviews: 142,
                        specialties: ['다운사이징', '시설선택', '주거비절약', '지역비교'],
                        price: '80,000원/60분',
                        responseRate: 91,
                        profileImage: '🏡'
                    },
                    {
                        id: 8,
                        name: '조귀농멘토',
                        title: '귀농귀촌 전문 멘토',
                        experience: '12년 경력',
                        rating: 4.7,
                        reviews: 98,
                        specialties: ['지역선택', '정착지원', '농업시작', '시골생활'],
                        price: '70,000원/90분',
                        responseRate: 89,
                        profileImage: '🌾'
                    },
                    {
                        id: 9,
                        name: '문생활설계사',
                        title: '시니어 라이프 플래너',
                        experience: '18년 경력',
                        rating: 4.6,
                        reviews: 165,
                        specialties: ['생활비관리', '건강관리', '인간관계', '일상설계'],
                        price: '60,000원/60분',
                        responseRate: 93,
                        profileImage: '🏠'
                    }
                ]
            };

            const currentExperts = expertData[activeCategory] || [];
            const currentCategory = expertCategories[activeCategory];

            return (
                <div className={`bg-gradient-to-r ${currentCategory.bgColor} p-6 rounded-lg`}>
                    {/* 헤더 */}
                    <div className="mb-6">
                        <div className="text-center mb-4">
                            <h3 className="text-lg md:text-xl font-bold text-gray-800 no-break-korean">
                                🎯 관심있는 분야의 전문가에게 정보를 얻으세요!
                            </h3>
                        </div>
                        
                        {/* 전문가 전용 서비스 게시 섹션 */}
                        {isExpert && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <div className="flex flex-col md:flex-row items-center justify-between gap-3">
                                    <div className="text-center md:text-left">
                                        <p className="text-sm font-medium text-blue-800 no-break-korean">
                                            💡 전문가는 서비스를 업로드할 수 있어요!
                                        </p>
                                        <p className="text-xs text-blue-600 mt-1">
                                            고객들이 예약하고 상담받을 수 있는 서비스를 등록해보세요
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setShowWriteModal(true)}
                                        className="px-4 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors shadow-md no-break-korean whitespace-nowrap"
                                        title="서비스 게시하기"
                                    >
                                        📝 내 서비스 게시하기
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 카테고리 탭 */}
                    <div className="grid grid-cols-3 gap-2 mb-6">
                        {Object.entries(expertCategories).map(([key, category]) => (
                            <button
                                key={key}
                                onClick={() => setActiveCategory(key)}
                                className={`p-3 rounded-lg text-center transition-all duration-300 ${
                                    activeCategory === key
                                        ? `bg-gradient-to-r ${category.color} text-white shadow-lg`
                                        : 'bg-white text-gray-600 hover:bg-gray-50'
                                }`}
                            >
                                <div className="text-base md:text-lg mb-1">{category.icon}</div>
                                <div className="font-semibold text-xs leading-tight no-break-korean responsive-text-sm">{category.name}</div>
                            </button>
                        ))}
                    </div>

                    {/* 전문가 목록 */}
                    <div className="space-y-4 mb-6">
                        {currentExperts.map(expert => (
                            <div key={expert.id} className="bg-white rounded-lg p-4 shadow-md">
                                <div className="flex items-start gap-4">
                                    {/* 프로필 */}
                                    <div className="text-3xl">{expert.profileImage}</div>
                                    
                                    {/* 정보 */}
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <h4 className="font-bold text-gray-800 break-keep">{expert.name}</h4>
                                            <div className="flex items-center gap-1">
                                                <span className="text-yellow-500">⭐</span>
                                                <span className="text-sm font-medium">{expert.rating}</span>
                                                <span className="text-xs text-gray-500">({expert.reviews})</span>
                                            </div>
                                        </div>
                                        
                                        <p className="text-sm text-gray-600 mb-2 break-keep">{expert.title}</p>
                                        <p className="text-xs text-gray-500 mb-2 break-keep">{expert.experience}</p>
                                        
                                        {/* 전문분야 태그 */}
                                        <div className="flex flex-wrap gap-1 mb-3">
                                            {expert.specialties.map((specialty, index) => (
                                                <span key={index} className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded no-break-korean">
                                                    {specialty}
                                                </span>
                                            ))}
                                        </div>
                                        
                                        {/* 하단 정보 */}
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm">
                                                <span className="font-semibold text-blue-600">{expert.price}</span>
                                                <span className="text-xs text-gray-500 ml-2">응답률 {expert.responseRate}%</span>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    if (currentUser?.isGuest) {
                                                        setShowSignupModal(true);
                                                        return;
                                                    }
                                                    setSelectedExpert(expert);
                                                    setShowBookingModal(true);
                                                }}
                                                className="px-3 md:px-4 py-2 bg-blue-500 text-white rounded-lg text-xs md:text-sm font-medium hover:bg-blue-600 transition-colors no-break-korean"
                                            >
                                                상담 예약
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* 안내 메시지 */}
                    <div className="bg-white p-4 rounded-lg">
                        <h4 className="font-bold text-gray-800 mb-2">🛡️ 안전한 전문가 플랫폼</h4>
                        <div className="text-sm text-gray-600 space-y-1">
                            <p>✅ 모든 전문가 자격증 검증 완료</p>
                            <p>✅ 금융상품 판매 완전 금지 (순수 상담만)</p>
                            <p>✅ 투명한 후기 시스템</p>
                            <p>✅ 비대면 상담으로 안전하고 편리하게</p>
                            <p>🚧 현재 시범 운영 중 - 2025년 3월 정식 오픈 예정</p>
                        </div>
                    </div>
                    
                    {/* 예약 모달 */}
                    {showBookingModal && selectedExpert && (
                        <ConsultationBookingComponent
                            expert={selectedExpert}
                            currentUser={currentUser}
                            onClose={() => {
                                setShowBookingModal(false);
                                setSelectedExpert(null);
                            }}
                        />
                    )}

                    {/* 전문가 글쓰기 모달 */}
                    {showWriteModal && (
                        <ExpertPostWriteModal
                            isOpen={showWriteModal}
                            onClose={() => setShowWriteModal(false)}
                            currentUser={currentUser}
                            onSuccess={handleWriteSuccess}
                            isAdminUser={isAdminUser}
                        />
                    )}
                </div>
            );
        };

        // 게시글 상세 페이지 컴포넌트
        const PostDetailPage = ({ post, setCurrentView, currentUser, checkCalculationForInteraction, isAdminUser }) => {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState('');
            const [likes, setLikes] = useState(post.likes || 0);
            const [isLiked, setIsLiked] = useState(false);

            // 댓글 로드
            useEffect(() => {
                const loadReplies = async () => {
                    try {
                        if (supabase) {
                            const { data, error } = await supabase
                                .from('community_replies')
                                .select('*')
                                .eq('post_id', post.id)
                                .order('created_at', { ascending: true });
                            
                            if (error) throw error;
                            setReplies(data || []);
                        }
                    } catch (error) {
                        console.error('댓글 로딩 오류:', error);
                        setReplies([]);
                    }
                };

                loadReplies();
            }, [post.id]);

            return (
                <div className="max-w-4xl mx-auto">
                    {/* 뒤로가기 헤더 */}
                    <div className="flex items-center mb-6">
                        <button 
                            onClick={() => setCurrentView('community')}
                            className="flex items-center text-gray-600 hover:text-gray-800 transition-colors"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            커뮤니티로 돌아가기
                        </button>
                    </div>

                    {/* 게시글 상세 */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden">
                        <div className="p-6">
                            {/* 제목 */}
                            <h1 className="text-2xl font-bold text-gray-800 mb-4">{post.title}</h1>
                            
                            {/* 작성자 정보 */}
                            <div className="flex items-center text-sm text-gray-500 mb-6">
                                <span className="bg-gray-100 px-2 py-1 rounded mr-2">익명</span>
                                <span>{new Date(post.created_at).toLocaleDateString()}</span>
                                <span className="mx-2">•</span>
                                <span>조회 {post.views || 0}</span>
                            </div>
                            
                            {/* 본문 */}
                            <div className="prose max-w-none mb-8">
                                <p className="text-gray-800 whitespace-pre-wrap leading-relaxed">{post.content}</p>
                            </div>
                            
                            {/* 액션 버튼들 */}
                            <div className="flex items-center space-x-6 py-4 border-t border-gray-200">
                                <button 
                                    onClick={async () => {
                                        if (!checkCalculationForInteraction('like_post')) return;
                                        
                                        try {
                                            const newLikesCount = isLiked ? likes - 1 : likes + 1;
                                            
                                            if (supabase) {
                                                const { error } = await supabase
                                                    .from('community_posts')
                                                    .update({ likes: newLikesCount })
                                                    .eq('id', post.id);
                                                
                                                if (error) throw error;
                                            }
                                            
                                            setLikes(newLikesCount);
                                            setIsLiked(!isLiked);
                                        } catch (error) {
                                            console.error('좋아요 오류:', error);
                                        }
                                    }}
                                    className={`flex items-center transition-colors ${
                                        isLiked 
                                            ? 'text-blue-600 hover:text-blue-800' 
                                            : 'text-gray-600 hover:text-blue-600'
                                    }`}
                                >
                                    <span className="mr-1">{isLiked ? '👍' : '👍'}</span>
                                    <span>공감 {likes}</span>
                                </button>
                                <button className="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                                    <span className="mr-1">💬</span>
                                    <span>댓글 {replies.length}</span>
                                </button>
                                <button 
                                    onClick={() => {
                                        if (navigator.share) {
                                            navigator.share({
                                                title: post.title,
                                                text: post.content.substring(0, 100) + '...',
                                                url: window.location.href
                                            });
                                        } else {
                                            // 클립보드에 복사
                                            navigator.clipboard.writeText(window.location.href)
                                                .then(() => alert('링크가 클립보드에 복사되었습니다!'))
                                                .catch(() => {
                                                    // 폴백: 텍스트 선택
                                                    const textArea = document.createElement('textarea');
                                                    textArea.value = window.location.href;
                                                    document.body.appendChild(textArea);
                                                    textArea.select();
                                                    document.execCommand('copy');
                                                    document.body.removeChild(textArea);
                                                    alert('링크가 클립보드에 복사되었습니다!');
                                                });
                                        }
                                    }}
                                    className="flex items-center text-gray-600 hover:text-gray-800 transition-colors"
                                >
                                    <span className="mr-1">📤</span>
                                    <span>공유</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 댓글 섹션 */}
                    <div className="bg-white rounded-lg shadow-md mt-6 p-6">
                        <h3 className="text-lg font-semibold mb-4">댓글 {replies.length}개</h3>
                        
                        {/* 댓글 작성 */}
                        <div className="mb-6">
                            <textarea
                                value={newReply}
                                onChange={(e) => setNewReply(e.target.value)}
                                placeholder="댓글을 작성해주세요..."
                                className="w-full p-3 border border-gray-200 rounded-lg resize-none"
                                rows="3"
                            />
                            <div className="flex justify-end mt-2">
                                <button
                                    onClick={async () => {
                                        if (!checkCalculationForInteraction('write_reply')) return;
                                        
                                        if (newReply.trim()) {
                                            try {
                                                const replyData = {
                                                    post_id: post.id,
                                                    content: newReply.trim(),
                                                    author_nickname: currentUser?.nickname || currentUser?.email || '익명',
                                                    user_hash: currentUser?.user_hash || null,
                                                    is_anonymous: true,
                                                    created_at: new Date().toISOString()
                                                };

                                                if (supabase) {
                                                    const { data, error } = await supabase
                                                        .from('community_replies')
                                                        .insert([replyData])
                                                        .select();
                                                    
                                                    if (error) throw error;
                                                    setReplies([...replies, data[0]]);
                                                } else {
                                                    // 로컬 상태에만 추가
                                                    setReplies([...replies, { ...replyData, id: Date.now() }]);
                                                }
                                                
                                                setNewReply('');
                                            } catch (error) {
                                                console.error('댓글 저장 오류:', error);
                                                alert('댓글 저장에 실패했습니다.');
                                            }
                                        }
                                    }}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                                >
                                    댓글 작성
                                </button>
                            </div>
                        </div>

                        {/* 댓글 목록 */}
                        <div className="space-y-4">
                            {replies.length === 0 ? (
                                <div className="text-center py-8 text-gray-500">
                                    <div className="text-4xl mb-2">💬</div>
                                    <p>첫 번째 댓글을 작성해보세요!</p>
                                </div>
                            ) : (
                                replies.map((reply, index) => (
                                    <div key={reply.id || index} className="border-b border-gray-100 pb-4">
                                        <div className="flex items-center justify-between text-sm text-gray-500 mb-2">
                                            <div className="flex items-center">
                                                <span className="bg-blue-100 text-blue-600 px-2 py-1 rounded mr-2">
                                                    {reply.author_nickname || '익명'}
                                                </span>
                                                <span>{new Date(reply.created_at).toLocaleDateString('ko-KR')} {new Date(reply.created_at).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</span>
                                            </div>
                                        </div>
                                        <p className="text-gray-800 leading-relaxed">{reply.content}</p>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        // 재산세 계산 함수 (2025년 한국 기준)
        const calculatePropertyTax = (homeValue) => {
            if (!homeValue || homeValue === 0) return 0;
            
            // 주택 공시가격 (만원 → 원)
            const publicValue = homeValue * 10000;
            
            // 과세표준 = 공시가격 × 공정시장가액비율(60%)
            const taxBase = publicValue * 0.6;
            
            // 재산세 = 과세표준 × 세율(0.4%) - 누진공제(63만원)
            const annualPropertyTax = Math.max(0, (taxBase * 0.004) - 630000);
            
            // 월 재산세
            return Math.round(annualPropertyTax / 12);
        };

        // 원본 계산기 완전 통합 (planb-calculator.html에서 추출)
        const OriginalCalculator = ({ savedCalculations = [], onCalculationComplete, setCurrentView, currentUser, showNotification, setAuthMode, setShowSaveResultSignupModal }) => {
            const [calculatorStep, setCalculatorStep] = useState(1);
            const [formData, setFormData] = useState({
                age: '', health: '보통', mode: '균형',
                housingType: '', // 주거형태: 'owned_living', 'owned_renting', 'jeonse', 'monthly', 'none'
                financialAssets: '', severancePay: '', 
                // 주거 관련 (주거형태별로 다름)
                homeValue: '', homeMortgage: '', homeMortgageInterest: '',
                ownedHouseDeposit: '', currentDeposit: '', currentRentType: '', currentRent: '',
                jeonseDeposit: '', monthlyDeposit: '', monthlyRent: '',
                investmentRealEstate: '', investmentLoan: '', investmentLoanInterest: '',
                debt: '', debtInterest: '', depositLoan: '', depositLoanInterest: '', inheritance: '',
                nationalPension: '', privatePension: '', housingPension: '', 
                // 은퇴 월 수입
                rentalIncome: '', workIncome: '', financialIncome: '', otherIncome: ''
            });
            const [calculatorResult, setCalculatorResult] = useState(null);
            const [averageData, setAverageData] = useState(null);
            const [showAssetDetail, setShowAssetDetail] = useState(false);
            const [showInheritanceGuide, setShowInheritanceGuide] = useState(false);
            const [lifeExpectancy, setLifeExpectancy] = useState(100);
            const [enableDownsizing, setEnableDownsizing] = useState(false);
            const [isResultSaved, setIsResultSaved] = useState(false);
            const [expenseData, setExpenseData] = useState({
                food: '', communication: '', utilities: '', medical: '', hobby: '', vehicle: '', etc: ''
            });
            const [showExpenseModal, setShowExpenseModal] = useState(false);

            const handleInputChange = (field, value) => {
                const cleanValue = value === '' ? '' : value;
                setFormData({ ...formData, [field]: cleanValue });
            };

            // 다음 단계로 이동하면서 페이지 상단으로 스크롤
            const goToNextStep = (step) => {
                setCalculatorStep(step);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // 나이 입력 시 평균 데이터 업데이트
            useEffect(() => {
                if (formData.age) {
                    setAverageData(getAverageDataByAge(parseInt(formData.age)));
                }
            }, [formData.age]);

            // 기대수명 변경 시 계산 결과 업데이트 (입력 중이 아닐 때만)
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    calculateResults();
                    setIsResultSaved(false);
                }
            }, [lifeExpectancy, enableDownsizing]);

            const getAverageDataByAge = (age) => {
                if (age >= 60) return { financialAssets: 8000, severancePay: 3000, homeValue: 25000, nationalPension: 120, privatePension: 50, debt: 500 };
                if (age >= 55) return { financialAssets: 6500, severancePay: 4000, homeValue: 28000, nationalPension: 100, privatePension: 40, debt: 800 };
                if (age >= 50) return { financialAssets: 5000, severancePay: 5000, homeValue: 30000, nationalPension: 80, privatePension: 30, debt: 1200 };
                if (age >= 45) return { financialAssets: 3500, severancePay: 3500, homeValue: 32000, nationalPension: 60, privatePension: 20, debt: 1500 };
                return { financialAssets: 2000, severancePay: 2000, homeValue: 25000, nationalPension: 40, privatePension: 10, debt: 1000 };
            };

            const formatResultAmount = (amount) => {
                if (amount >= 100000000) {
                    const 억 = Math.floor(amount / 100000000);
                    const 만 = Math.round((amount % 100000000) / 10000);
                    if (만 === 0) return `${억}억원`;
                    return `${억}억 ${만}만원`;
                }
                if (amount >= 10000) {
                    return `${Math.round(amount / 10000)}만원`;
                }
                return `${Math.round(amount).toLocaleString()}원`;
            };
            
            // 컴포넌트 마운트시 저장된 데이터 확인만 (자동 불러오기 안함)
            useEffect(() => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    // 저장된 데이터가 있다는 것만 확인, 자동 불러오기는 하지 않음
                    console.log('저장된 계산결과가 있습니다.');
                }
            }, []);

            const formatAmount = (value) => {
                if (!value || value === '' || value === '0') return '💰 0원';
                const num = parseInt(value);
                if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                return `💰 ${num.toLocaleString()}만원`;
            };

            // AmountInput 컴포넌트

            // 원본 calculateResults 함수 (planb-calculator.html에서 추출)
            const calculateResults = () => {
                const age = parseInt(formData.age);
                
                // 자산 계산 (만원 → 원)
                let housingAsset = 0;
                let housingDebt = 0;
                let monthlyHousingCost = 0;
                
                // 월 대출 이자 (개별 합산)
                const monthlyLoanInterest = 
                    ((parseInt(formData.homeMortgageInterest) || 0) + 
                     (parseInt(formData.investmentLoanInterest) || 0) + 
                     (parseInt(formData.debtInterest) || 0) + 
                     (parseInt(formData.depositLoanInterest) || 0)) * 10000;
                
                if (formData.housingType === 'owned_living') {
                    housingAsset = (parseInt(formData.homeValue) || 0) * 10000;
                    housingDebt = (parseInt(formData.homeMortgage) || 0) * 10000;
                } else if (formData.housingType === 'owned_renting') {
                    housingAsset = (parseInt(formData.homeValue) || 0) * 10000;
                    housingDebt = (parseInt(formData.homeMortgage) || 0) * 10000;
                    if (formData.currentRentType === 'monthly') {
                        monthlyHousingCost = (parseInt(formData.currentRent) || 0) * 10000;
                    }
                } else if (formData.housingType === 'jeonse') {
                    housingAsset = (parseInt(formData.jeonseDeposit) || 0) * 10000;
                } else if (formData.housingType === 'monthly') {
                    housingAsset = (parseInt(formData.monthlyDeposit) || 0) * 10000;
                    monthlyHousingCost = (parseInt(formData.monthlyRent) || 0) * 10000;
                }

                const assets = {
                    financial: (parseInt(formData.financialAssets) || 0) * 10000,
                    severance: (parseInt(formData.severancePay) || 0) * 10000,
                    housing: housingAsset,
                    currentDeposit: (parseInt(formData.currentDeposit) || 0) * 10000,
                    housingDebt: housingDebt,
                    monthlyHousingCost: monthlyHousingCost,
                    investment: (parseInt(formData.investmentRealEstate) || 0) * 10000,
                    investmentLoan: (parseInt(formData.investmentLoan) || 0) * 10000,
                    debt: (parseInt(formData.debt) || 0) * 10000,
                    depositLoan: (parseInt(formData.depositLoan) || 0) * 10000,
                    inheritance: (parseInt(formData.inheritance) || 0) * 10000
                };
                
                // 주거형태별 자산 반영 비율
                const housingPensionAmount = (parseInt(formData.housingPension) || 0);
                let housingValueRatio = 0;
                
                if (formData.housingType === 'owned_living') {
                    if (housingPensionAmount > 0) {
                        housingValueRatio = 1.0;
                    } else if (enableDownsizing) {
                        housingValueRatio = 0.75;
                    } else {
                        housingValueRatio = 0;
                    }
                } else if (formData.housingType === 'owned_renting') {
                    if (enableDownsizing) {
                        housingValueRatio = 0.75;
                    } else {
                        housingValueRatio = 0;
                    }
                } else if (formData.housingType === 'jeonse' || formData.housingType === 'monthly') {
                    housingValueRatio = 1.0;
                }
                
                const ownedHouseDepositDebt = (parseInt(formData.ownedHouseDeposit) || 0) * 10000;
                
                // 주택 매각 시 실제 매각 가능 금액 계산
                let realizedHousingAsset = 0;
                if (formData.housingType === 'owned_living' && enableDownsizing) {
                    realizedHousingAsset = Math.max(0, (assets.housing * housingValueRatio) - assets.housingDebt);
                } else if (formData.housingType === 'owned_renting' && enableDownsizing) {
                    realizedHousingAsset = Math.max(0, (assets.housing * housingValueRatio) - ownedHouseDepositDebt - assets.housingDebt);
                } else {
                    realizedHousingAsset = assets.housing * housingValueRatio;
                }
                
                // 주택연금 선택 시 주택 자산 처리
                let housingAssetForUsable = realizedHousingAsset;
                if (parseInt(formData.housingPension) > 0) {
                    housingAssetForUsable = 0;
                }
                
                const usableAssetsGross = assets.financial + assets.severance + housingAssetForUsable;
                const usableAssets = usableAssetsGross;
                
                const totalDebts = (enableDownsizing ? 0 : assets.housingDebt) + assets.investmentLoan + assets.debt + assets.depositLoan +
                    (enableDownsizing && formData.housingType === 'owned_renting' ? 0 : ownedHouseDepositDebt);
                
                const unusableAssets = assets.investment + assets.inheritance +
                    (!enableDownsizing && !parseInt(formData.housingPension) && parseInt(formData.homeValue) > 0 ? (parseInt(formData.homeValue) || 0) * 10000 : 0);
                
                const allAssets = assets.financial + assets.severance + assets.housing + assets.currentDeposit + assets.investment + assets.inheritance;
                const totalAssets = Math.max(0, allAssets - totalDebts);
                
                const emergencyFund = assets.financial * 0.1;
                const availableAssets = Math.max(0, usableAssets - emergencyFund);
                
                const yearsToLive = lifeExpectancy - age;
                const annualWithdrawal = availableAssets / yearsToLive;
                const dailyAmount = annualWithdrawal / 365;
                const monthlyAmount = annualWithdrawal / 12;
                
                const monthlyPension = (parseInt(formData.nationalPension) || 0) + (parseInt(formData.privatePension) || 0) + (parseInt(formData.housingPension) || 0);
                const monthlyOtherIncome = (parseInt(formData.rentalIncome) || 0) + (parseInt(formData.workIncome) || 0) + (parseInt(formData.financialIncome) || 0) + (parseInt(formData.otherIncome) || 0);
                
                // 재산세 계산 (주택 소유시에만)
                const monthlyPropertyTax = (formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') ? 
                    calculatePropertyTax(parseInt(formData.homeValue) || 0) : 0;
                
                const totalMonthlyAvailable = Math.round(monthlyAmount) + (monthlyPension * 10000) + (monthlyOtherIncome * 10000) - monthlyHousingCost - monthlyLoanInterest - monthlyPropertyTax;
                const totalDailyAvailable = Math.round(totalMonthlyAvailable / 30.4);
                
                const result = {
                    dailyAmount: Math.round(dailyAmount),
                    monthlyAmount: Math.round(monthlyAmount),
                    annualAmount: Math.round(annualWithdrawal),
                    totalDailyAvailable: totalDailyAvailable,
                    totalMonthlyAvailable: Math.round(totalMonthlyAvailable),
                    monthlyLivingCost: Math.round(totalMonthlyAvailable),
                    totalAssets: Math.round(totalAssets / 10000), // 만원 단위로 변환
                    assetSufficiencyYears: yearsToLive,
                    housingType: formData.housingType,
                    yearsToLive: yearsToLive,
                    assetBreakdown: {
                        totalAssets, usableAssets, usableAssetsGross, unusableAssets, availableAssets, emergencyFund, totalDebts,
                        financial: assets.financial, severance: assets.severance,
                        housing: assets.housing, realizedHousingAsset: realizedHousingAsset, currentDeposit: assets.currentDeposit, housingDebt: assets.housingDebt, housingValueRatio: housingValueRatio,
                        monthlyHousingCost: assets.monthlyHousingCost,
                        investment: assets.investment, investmentLoan: assets.investmentLoan,
                        debt: assets.debt, inheritance: assets.inheritance, 
                        housingPensionAmount: housingPensionAmount,
                        housingType: formData.housingType,
                        enableDownsizing: enableDownsizing,
                        ownedHouseDepositDebt: ownedHouseDepositDebt
                    },
                    monthlyPension: monthlyPension * 10000,
                    monthlyOtherIncome: monthlyOtherIncome * 10000,
                    monthlyHousingCost: monthlyHousingCost,
                    monthlyLoanInterest: monthlyLoanInterest,
                    monthlyPropertyTax: monthlyPropertyTax,
                    safetyLevel: totalMonthlyAvailable >= 2500000 ? '안전' : totalMonthlyAvailable >= 1800000 ? '보통' : '주의' // KB금융 최소 251만원(안전), 정부 적정 177만원(보통), 정부 최소 124만원(주의)
                };

                setCalculatorResult(result);
                
                // 세션 생성을 위한 콜백 호출
                if (onCalculationComplete) {
                    onCalculationComplete(result);
                }
                
                setCalculatorStep(4);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };


            const openExpenseModal = () => {
                setShowExpenseModal(true);
            };

            const closeExpenseModal = () => {
                setShowExpenseModal(false);
            };

            const handleExpenseChange = (field, value) => {
                setExpenseData({ ...expenseData, [field]: value });
            };
            
            // 지출 입력 컴포넌트 (AmountInput과 동일한 스타일)
            const ExpenseInput = ({ label, field, value, placeholder }) => {
                const formatAmount = (value) => {
                    if (!value || value === '' || value === '0') return '💰 0원';
                    const num = parseInt(value);
                    if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                    if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                    return `💰 ${num.toLocaleString()}만원`;
                };

                const handleInputChange = (e) => {
                    const inputValue = e.target.value;
                    const numValue = inputValue.replace(/[^0-9]/g, '');
                    
                    // 입력값이 변경된 경우에만 상태 업데이트 (포커스 유지)
                    if (numValue !== value) {
                        handleExpenseChange(field, numValue);
                    }
                };

                return (
                    <div>
                        <label className="block text-xl font-semibold text-gray-800 mb-3">{label}</label>
                        <input
                            type="text"
                            inputMode="numeric"
                            pattern="[0-9]*"
                            value={value}
                            onChange={handleInputChange}
                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg focus:border-blue-500 focus:outline-none"
                            placeholder={placeholder}
                            autoComplete="off"
                        />
                        <div className="text-green-600 font-semibold text-lg mt-1">
                            {formatAmount(value)}
                        </div>
                    </div>
                );
            };

            // 2024년 통계청 가계동향조사 데이터 (만원 단위)
            const getStatKoreaData = () => ({
                food: 41, // 식료품·비주류음료 41.2만원
                communication: 14, // 통신비 (정보통신 포함) 14만원 추정
                utilities: 35, // 주거·수도·광열 35만원
                medical: 24, // 보건 23.9만원
                hobby: 31, // 오락·문화 31만원 추정
                vehicle: 33, // 교통비 33.5만원
                etc: 20 // 기타 (의류·신발, 가정용품 등) 20만원 추정
            });
            
            const submitExpenseData = async () => {
                // 통계청 데이터와 비교
                const statData = getStatKoreaData();
                const userTotal = Object.values(expenseData).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                const statTotal = Object.values(statData).reduce((sum, val) => sum + val, 0);
                
                setExpenseComparison({
                    user: expenseData,
                    stat: statData,
                    userTotal: userTotal,
                    statTotal: statTotal
                });
                
                // 지출내역을 DB에 저장 (회원인 경우)
                if (currentUser && !currentUser.isGuest && supabase) {
                    try {
                        // 먼저 현재 사용자의 최신 계산 결과 ID를 찾기
                        const { data: calculationData, error: calcError } = await supabase
                            .from('user_calculations')
                            .select('id')
                            .eq('user_id', currentUser.id)
                            .order('created_at', { ascending: false })
                            .limit(1);
                        
                        if (calcError) {
                            console.error('계산 데이터 조회 실패:', calcError);
                        } else if (calculationData && calculationData.length > 0) {
                            // 지출내역을 user_expenses 테이블에 저장
                            const expensePayload = {
                                calculation_id: calculationData[0].id,
                                food_expenses: parseInt(expenseData.food) || 0,
                                communication_expenses: parseInt(expenseData.communication) || 0,
                                utilities_expenses: parseInt(expenseData.utilities) || 0,
                                living_expenses: parseInt(expenseData.etc) || 0, // 기타를 생활비로 매핑
                                medical_expenses: parseInt(expenseData.medical) || 0,
                                leisure_expenses: parseInt(expenseData.hobby) || 0, // 취미·여가를 여가비로 매핑
                                transportation_expenses: parseInt(expenseData.vehicle) || 0,
                                miscellaneous_expenses: 0,
                                created_at: new Date().toISOString()
                            };
                            
                            const { error: expenseError } = await supabase
                                .from('user_expenses')
                                .upsert(expensePayload);
                            
                            if (expenseError) {
                                console.error('지출내역 저장 실패:', expenseError);
                            } else {
                                console.log('지출내역 DB 저장 성공');
                            }
                        }
                    } catch (error) {
                        console.error('지출내역 저장 처리 실패:', error);
                    }
                }
                
                setShowExpenseModal(false);
                setShowComparisonModal(true);
            };
            
            const [expenseComparison, setExpenseComparison] = useState(null);
            const [showComparisonModal, setShowComparisonModal] = useState(false);
            
            // 계산결과 저장 함수 
            const saveCalculationResult = () => {
                if (!calculatorResult) return;
                
                // 게스트 사용자인 경우 저장용 회원가입 모달 표시
                if (currentUser?.isGuest) {
                    setShowSaveResultSignupModal(true);
                    return;
                }
                
                // 회원 사용자인 경우 직접 저장
                const savedResult = {
                    ...calculatorResult,
                    formData: formData,
                    lifeExpectancy: lifeExpectancy,
                    enableDownsizing: enableDownsizing,
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('planb_calculation_result', JSON.stringify(savedResult));
                setIsResultSaved(true);
                
                showNotification('저장 완료', '계산결과가 저장되었습니다! 💾\n언제든 다시 확인할 수 있습니다.', 'success');
            };
            
            // 저장된 계산결과 불러오기 (localStorage)
            const loadCalculationResult = () => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    try {
                        const savedData = JSON.parse(saved);
                        setFormData(savedData.formData);
                        setCalculatorResult(savedData);
                        setLifeExpectancy(savedData.lifeExpectancy);
                        setEnableDownsizing(savedData.enableDownsizing);
                        setCalculatorStep(4);
                        setIsResultSaved(true);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        showNotification('불러오기 완료', '저장된 계산결과를 불러왔습니다! 📊', 'success');
                    } catch (error) {
                        console.error('저장된 데이터 불러오기 실패:', error);
                        showNotification('불러오기 실패', '저장된 데이터를 불러오는데 실패했습니다.', 'error');
                    }
                } else {
                    showNotification('저장된 데이터 없음', '아직 저장된 계산결과가 없습니다.', 'info');
                }
            };
            

            // 추가 필수 함수들
            const [activeTab, setActiveTab] = useState('expense');

            const joinCommunity = () => {
                showNotification('커뮤니티 출시 예정', '커뮤니티 기능이 곧 출시됩니다! 🎉\n비슷한 고민을 가진 분들과 소통할 수 있어요.', 'info');
            };

            // 기대수명 변경 시 결과 재계산
            const recalculateWithLifeExpectancy = () => {
                if (calculatorResult && lifeExpectancy) {
                    const yearsToLive = lifeExpectancy - parseInt(formData.age);
                    const monthlyAmount = calculatorResult.assetBreakdown?.availableAssets ? 
                        Math.floor(calculatorResult.assetBreakdown.availableAssets / yearsToLive / 12) : 0;
                    
                    const totalMonthlyAvailable = monthlyAmount + (calculatorResult.monthlyPension || 0) + 
                        (calculatorResult.monthlyOtherIncome || 0) - (calculatorResult.monthlyHousingCost || 0) - 
                        (calculatorResult.monthlyLoanInterest || 0) - (calculatorResult.monthlyPropertyTax || 0);
                    
                    const updatedResult = {
                        ...calculatorResult,
                        yearsToLive: yearsToLive,
                        monthlyAmount: monthlyAmount,
                        totalMonthlyAvailable: totalMonthlyAvailable,
                        totalDailyAvailable: Math.floor(totalMonthlyAvailable / 30),
                        safetyLevel: totalMonthlyAvailable >= 2500000 ? '안전' : totalMonthlyAvailable >= 1800000 ? '보통' : '주의'
                    };
                    
                    setCalculatorResult(updatedResult);
                }
            };

            // 기대수명이 변경될 때마다 재계산
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    recalculateWithLifeExpectancy();
                }
            }, [lifeExpectancy]);

            // 다운사이징 옵션 변경 시 재계산
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    // 다운사이징 옵션 변경시 재계산 수행
                    calculateResults();
                }
            }, [enableDownsizing]);

            // 1단계 렌더링
            if (calculatorStep === 1) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => setCurrentView('main')}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    메인으로 돌아가기
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🧮 은퇴생활비 계산기</h1>
                                <p className="text-xl text-gray-600">나이와 건강상태를 입력해주세요</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '33%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">1단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="space-y-6">
                                    <div className="mb-6">
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🎂 나이</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            pattern="[0-9]*"
                                            value={formData.age}
                                            onChange={(e) => {
                                                const numValue = e.target.value.replace(/[^0-9]/g, '');
                                                handleInputChange('age', numValue);
                                            }}
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            placeholder=""
                                            autoComplete="off"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">💪 건강 상태</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.health}
                                            onChange={(e) => handleInputChange('health', e.target.value)}
                                        >
                                            <option value="양호">양호 (운동 규칙적, 큰 질병 없음)</option>
                                            <option value="보통">보통 (일반적인 건강 상태)</option>
                                            <option value="주의필요">주의필요 (만성질환 있거나 관리 필요)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🎯 생활 모드</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.mode}
                                            onChange={(e) => handleInputChange('mode', e.target.value)}
                                        >
                                            <option value="보수적">보수적 (안전 우선, 여유자금 확보)</option>
                                            <option value="균형">균형 (평균적인 생활 수준 유지)</option>
                                            <option value="적극적">적극적 (여유있는 생활, 취미활동)</option>
                                        </select>
                                    </div>

                                    <button
                                        onClick={() => goToNextStep(2)}
                                        className="btn-primary w-full text-xl py-4"
                                        disabled={!formData.age || !formData.health || !formData.mode}
                                    >
                                        다음 단계 →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 2단계 렌더링 (자산 정보)
            if (calculatorStep === 2) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(1)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    이전 단계
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🏠 자산 정보</h1>
                                <p className="text-xl text-gray-600">현재 보유하고 계신 자산을 입력해주세요</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '66%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">2단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="bg-green-50 border-l-4 border-green-400 p-6 mb-8 rounded-r-lg">
                                    <p className="text-lg text-green-800">
                                        😊 <strong>정확한 수치를 모르시는 경우에는</strong><br/>
                                        알고 계신 대략적인 금액을 입력하시면 됩니다.
                                    </p>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🏠 주거 형태</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.housingType}
                                            onChange={(e) => handleInputChange('housingType', e.target.value)}
                                        >
                                            <option value="">선택하세요</option>
                                            <option value="owned_living">자가 소유 + 거주</option>
                                            <option value="owned_renting">자가 소유 + 전세/월세 거주</option>
                                            <option value="jeonse">전세</option>
                                            <option value="monthly">월세</option>
                                            <option value="none">무주택</option>
                                        </select>
                                    </div>

                                    <AmountInput
                                        label="🏦 현금 및 현금성 자산 (예금·적금·주식·펀드 등, 단위: 만원)"
                                        value={formData.financialAssets}
                                        onChange={(v) => handleInputChange('financialAssets', v)}
                                        placeholder=""
                                    />

                                    <AmountInput
                                        label="💼 퇴직금 (은퇴시 받을 퇴직금 또는 현재 남아있는 퇴직금, 단위: 만원)"
                                        value={formData.severancePay}
                                        onChange={(v) => handleInputChange('severancePay', v)}
                                        placeholder=""
                                    />

                                    {/* 주거형태별 조건부 필드 */}
                                    {(formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') && (
                                        <>
                                            <AmountInput
                                                label="🏠 자가 소유 주택 시세 (단위: 만원)"
                                                value={formData.homeValue}
                                                onChange={(v) => handleInputChange('homeValue', v)}
                                                placeholder=""
                                            />
                                            <AmountInput
                                                label="🏠 주택담보대출 잔액 (단위: 만원)"
                                                value={formData.homeMortgage}
                                                onChange={(v) => handleInputChange('homeMortgage', v)}
                                                placeholder=""
                                            />
                                            {formData.homeMortgage && parseInt(formData.homeMortgage) > 0 && (
                                                <div className="space-y-4">
                                                    <AmountInput
                                                        label="💳 월 대출상환액 (매달 나가는 돈, 단위: 만원)"
                                                        value={formData.homeMortgagePayment}
                                                        onChange={(v) => handleInputChange('homeMortgagePayment', v)}
                                                        placeholder="예: 50만원"
                                                    />
                                                    
                                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                                        <div className="flex items-center mb-3">
                                                            <input
                                                                type="checkbox"
                                                                id="knowLoanEndYear"
                                                                checked={formData.knowLoanEndYear || false}
                                                                onChange={(e) => handleInputChange('knowLoanEndYear', e.target.checked)}
                                                                onClick={(e) => {
                                                                    const newValue = !formData.knowLoanEndYear;
                                                                    handleInputChange('knowLoanEndYear', newValue);
                                                                }}
                                                                className="mr-2 scale-125"
                                                            />
                                                            <label htmlFor="knowLoanEndYear" className="text-blue-800 font-semibold">
                                                                📅 대출 완료 예정년도를 알고 있어요
                                                            </label>
                                                        </div>
                                                        
                                                        {!formData.knowLoanEndYear && (
                                                            <p className="text-blue-700 text-sm">
                                                                ℹ️ 체크하지 않으면 <strong>보수적으로 계산</strong>합니다.<br/>
                                                                (은퇴 후에도 계속 상환한다고 가정)
                                                            </p>
                                                        )}
                                                    </div>

                                                    {formData.knowLoanEndYear && (
                                                        <div>
                                                            <label className="block text-xl font-semibold text-gray-800 mb-3">📅 대출 완료 예정년도</label>
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                pattern="[0-9]*"
                                                                value={formData.loanEndYear || ''}
                                                                onChange={(e) => {
                                                                    const year = e.target.value.replace(/[^0-9]/g, '');
                                                                    if (year.length <= 4) {
                                                                        handleInputChange('loanEndYear', year);
                                                                    }
                                                                }}
                                                                className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                                placeholder="예: 2030"
                                                            />
                                                            {formData.loanEndYear && (
                                                                <div className="text-green-600 font-semibold text-lg mt-1">
                                                                    ✅ {formData.loanEndYear}년 이후 월 {formData.homeMortgagePayment ? parseInt(formData.homeMortgagePayment).toLocaleString() : 0}만원 절약!
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {formData.housingType === 'owned_renting' && (
                                        <>
                                            <AmountInput
                                                label="🏠 내 소유 집 임차인 보증금 (내가 받은 보증금, 단위: 만원)"
                                                value={formData.ownedHouseDeposit}
                                                onChange={(v) => handleInputChange('ownedHouseDeposit', v)}
                                                placeholder=""
                                            />

                                            <AmountInput
                                                label="🏠 현재 거주지 보증금 (내가 낸 보증금, 단위: 만원)"
                                                value={formData.currentDeposit}
                                                onChange={(v) => handleInputChange('currentDeposit', v)}
                                                placeholder=""
                                            />
                                            
                                            <AmountInput
                                                label="💳 보증금 대출 잔액 (단위: 만원)"
                                                value={formData.depositLoan}
                                                onChange={(v) => handleInputChange('depositLoan', v)}
                                                placeholder=""
                                            />
                                            {formData.depositLoan && parseInt(formData.depositLoan) > 0 && (
                                                <div className="space-y-4">
                                                    <AmountInput
                                                        label="💳 보증금 대출 월 상환액 (매달 나가는 돈, 단위: 만원)"
                                                        value={formData.depositLoanPayment}
                                                        onChange={(v) => handleInputChange('depositLoanPayment', v)}
                                                        placeholder="예: 30만원"
                                                    />
                                                    
                                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                                        <div className="flex items-center mb-3">
                                                            <input
                                                                type="checkbox"
                                                                id="knowDepositLoanEndYear"
                                                                checked={formData.knowDepositLoanEndYear || false}
                                                                onChange={(e) => handleInputChange('knowDepositLoanEndYear', e.target.checked)}
                                                                className="mr-2 scale-125"
                                                            />
                                                            <label htmlFor="knowDepositLoanEndYear" className="text-blue-800 font-semibold">
                                                                📅 대출 완료 예정년도를 알고 있어요
                                                            </label>
                                                        </div>
                                                    </div>

                                                    {formData.knowDepositLoanEndYear && (
                                                        <div>
                                                            <label className="block text-xl font-semibold text-gray-800 mb-3">📅 대출 완료 예정년도</label>
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                pattern="[0-9]*"
                                                                value={formData.depositLoanEndYear || ''}
                                                                onChange={(e) => {
                                                                    const year = e.target.value.replace(/[^0-9]/g, '');
                                                                    if (year.length <= 4) {
                                                                        handleInputChange('depositLoanEndYear', year);
                                                                    }
                                                                }}
                                                                className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                                placeholder="예: 2028"
                                                            />
                                                            {formData.depositLoanEndYear && (
                                                                <div className="text-green-600 font-semibold text-lg mt-1">
                                                                    ✅ {formData.depositLoanEndYear}년 이후 월 {formData.depositLoanPayment ? parseInt(formData.depositLoanPayment).toLocaleString() : 0}만원 절약!
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            <div className="mb-6">
                                                <label className="block text-xl font-semibold text-gray-800 mb-3">🏠 현재 거주 형태</label>
                                                <select
                                                    className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                    value={formData.currentRentType}
                                                    onChange={(e) => handleInputChange('currentRentType', e.target.value)}
                                                >
                                                    <option value="">선택하세요</option>
                                                    <option value="jeonse">전세</option>
                                                    <option value="monthly">월세</option>
                                                </select>
                                            </div>

                                            {formData.currentRentType === 'monthly' && (
                                                <AmountInput
                                                    label="🏠 현재 거주지 월세 (내가 내는 월세, 단위: 만원)"
                                                    value={formData.currentRent}
                                                    onChange={(v) => handleInputChange('currentRent', v)}
                                                    placeholder=""
                                                    />
                                            )}
                                        </>
                                    )}

                                    {formData.housingType === 'jeonse' && (
                                        <AmountInput
                                            label="🏠 전세보증금 (단위: 만원)"
                                            value={formData.jeonseDeposit}
                                            onChange={(v) => handleInputChange('jeonseDeposit', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    {formData.housingType === 'monthly' && (
                                        <>
                                            <AmountInput
                                                label="🏠 월세보증금 (단위: 만원)"
                                                value={formData.monthlyDeposit}
                                                onChange={(v) => handleInputChange('monthlyDeposit', v)}
                                                placeholder=""
                                            />
                                            <AmountInput
                                                label="🏠 월세 (단위: 만원)"
                                                value={formData.monthlyRent}
                                                onChange={(v) => handleInputChange('monthlyRent', v)}
                                                placeholder=""
                                            />
                                        </>
                                    )}

                                    <AmountInput
                                        label="🏢 수익형 부동산 (오피스텔·상가 등, 단위: 만원)"
                                        value={formData.investmentRealEstate}
                                        onChange={(v) => handleInputChange('investmentRealEstate', v)}
                                        placeholder=""
                                        averageAmount={0}
                                    />

                                    <AmountInput
                                        label="🏢 수익형 부동산 대출 잔액 (단위: 만원)"
                                        value={formData.investmentLoan}
                                        onChange={(v) => handleInputChange('investmentLoan', v)}
                                        placeholder=""
                                        averageAmount={0}
                                    />
                                    {formData.investmentLoan && parseInt(formData.investmentLoan) > 0 && (
                                        <AmountInput
                                            label="💳 수익형 부동산 대출 월 이자 (단위: 만원)"
                                            value={formData.investmentLoanInterest}
                                            onChange={(v) => handleInputChange('investmentLoanInterest', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    <AmountInput
                                        label="💳 기타 대출 잔액 (단위: 만원)"
                                        value={formData.debt}
                                        onChange={(v) => handleInputChange('debt', v)}
                                        placeholder=""
                                    />
                                    {formData.debt && parseInt(formData.debt) > 0 && (
                                        <AmountInput
                                            label="💳 기타 대출 월 이자 (단위: 만원)"
                                            value={formData.debtInterest}
                                            onChange={(v) => handleInputChange('debtInterest', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    <div className="mb-6">
                                        <div className="flex items-center gap-2 mb-3">
                                            <label className="block text-xl font-semibold text-gray-800">👨‍👩‍👧‍👦 가족 증여 또는 상속 예정액 (단위: 만원)</label>
                                            <button
                                                onClick={() => setShowInheritanceGuide(!showInheritanceGuide)}
                                                className="text-blue-500 bg-blue-50 rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-blue-100"
                                            >
                                                ?
                                            </button>
                                        </div>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            pattern="[0-9]*"
                                            value={formData.inheritance}
                                            onChange={(e) => {
                                                const numValue = e.target.value.replace(/[^0-9]/g, '');
                                                handleInputChange('inheritance', numValue === '' ? '' : numValue);
                                            }}
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            placeholder=""
                                            autoComplete="off"
                                        />
                                        <div className="text-green-600 font-semibold text-lg mt-1">{formatAmount(formData.inheritance)}</div>
                                        
                                        {showInheritanceGuide && (
                                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-3 rounded-r-lg">
                                                <div className="text-yellow-800">
                                                    <p className="font-semibold mb-2">📊 참고 가이드라인</p>
                                                    <ul className="text-sm space-y-1">
                                                        <li>• <strong>생애 평균:</strong> 약 2,000만원 (한국조세재정연구원 2022)</li>
                                                        <li>• <strong>부모 1인당:</strong> 평균 1,000만원 내외</li>
                                                        <li>• <strong>시기:</strong> 대부분 50-70대에 받음</li>
                                                        <li>• <strong>형태:</strong> 현금, 부동산, 주식 등 다양</li>
                                                    </ul>
                                                    <p className="text-xs mt-2 text-yellow-700">
                                                        * 가족 상황에 따라 큰 차이가 있으니 예상 가능한 금액만 입력하세요
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-4 mt-8">
                                        <button
                                            onClick={() => goToNextStep(1)}
                                            className="flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200"
                                        >
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                            </svg>
                                            이전 단계
                                        </button>
                                        <button
                                            onClick={() => goToNextStep(3)}
                                            className="btn-primary flex-1"
                                            disabled={!formData.housingType}
                                        >
                                            다음 단계 →
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 3단계 렌더링 (추가 수입·지출)
            if (calculatorStep === 3) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(2)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    이전 단계
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">📋 추가 수입·지출</h1>
                                <p className="text-xl text-gray-600">매달 들어오는 연금이나 나가는 고정비용 (선택사항)</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '100%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">3단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="bg-green-50 border-l-4 border-green-400 p-6 mb-8 rounded-r-lg">
                                    <p className="text-lg text-green-800">
                                        😊 <strong>정확한 수치를 모르시는 경우에는</strong><br/>
                                        알고 계신 대략적인 금액을 입력하시면 됩니다.
                                    </p>
                                </div>

                                <h2 className="text-2xl font-bold mb-6 text-gray-800">📈 매달 받는 연금 (단위: 만원)</h2>
                                
                                <AmountInput
                                    label="🏛️ 국민연금 (월 수령액)"
                                    value={formData.nationalPension}
                                    onChange={(v) => handleInputChange('nationalPension', v)}
                                    placeholder=""
                                />
                                
                                <AmountInput
                                    label="💰 개인연금 (월 수령액)"
                                    value={formData.privatePension}
                                    onChange={(v) => handleInputChange('privatePension', v)}
                                    placeholder=""
                                />
                                
                                <AmountInput
                                    label="🏠 주택연금 (월 수령액)"
                                    value={formData.housingPension}
                                    onChange={(v) => handleInputChange('housingPension', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />

                                <h2 className="text-2xl font-bold mb-6 mt-8 text-gray-800">💼 기타 월 수입 (단위: 만원)</h2>
                                
                                <AmountInput
                                    label="🏠 임대소득 (월 수령액)"
                                    value={formData.rentalIncome}
                                    onChange={(v) => handleInputChange('rentalIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="💼 근로소득 (파트타임, 자문료 등)"
                                    value={formData.workIncome}
                                    onChange={(v) => handleInputChange('workIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="💰 금융소득 (배당금, 이자 등)"
                                    value={formData.financialIncome}
                                    onChange={(v) => handleInputChange('financialIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="📚 기타소득 (강의, 로열티 등)"
                                    value={formData.otherIncome}
                                    onChange={(v) => handleInputChange('otherIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />

                                <div className="flex gap-4 mt-8">
                                    <button
                                        onClick={() => goToNextStep(2)}
                                        className="flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200"
                                    >
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                        </svg>
                                        이전 단계
                                    </button>
                                    <button
                                        onClick={calculateResults}
                                        className="btn-primary flex-1"
                                    >
                                        🚀 은퇴생활비 계산하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 결과 화면 (원본에서 추출한 완전한 버전)
            if (calculatorStep === 4 && calculatorResult) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(3)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    다시 계산하기
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🎉 은퇴생활비 계산 완료!</h1>
                            </div>

                            <div className="card mb-6">
                                <div className="text-center">
                                    <div className="text-5xl font-bold text-blue-600 mb-4">
                                        하루 {formatResultAmount(calculatorResult.totalDailyAvailable)}
                                    </div>
                                    <div className="text-3xl text-gray-600 mb-4">
                                        월 {formatResultAmount(calculatorResult.totalMonthlyAvailable)}
                                    </div>
                                    
                                    {/* 안전 수준 표시 */}
                                    <div className={`inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4 ${
                                        calculatorResult.safetyLevel === '안전' ? 'bg-green-500' :
                                        calculatorResult.safetyLevel === '보통' ? 'bg-yellow-500' : 'bg-red-500'
                                    }`}>
                                        {calculatorResult.safetyLevel} 수준
                                    </div>
                                    
                                    {/* 기대수명 조정 */}
                                    <div className="bg-blue-50 p-4 rounded-lg mb-4 max-w-md mx-auto">
                                        <div className="flex items-center justify-center gap-3 mb-2">
                                            <span className="text-sm font-medium text-blue-800">기대수명:</span>
                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={() => setLifeExpectancy(Math.max(70, lifeExpectancy - 5))}
                                                    className="w-8 h-8 bg-blue-200 hover:bg-blue-300 rounded-full flex items-center justify-center text-blue-700 font-bold"
                                                >
                                                    -
                                                </button>
                                                <span className="font-bold text-lg text-blue-600 min-w-[50px] text-center">{lifeExpectancy}세</span>
                                                <button 
                                                    onClick={() => setLifeExpectancy(Math.min(110, lifeExpectancy + 5))}
                                                    className="w-8 h-8 bg-blue-200 hover:bg-blue-300 rounded-full flex items-center justify-center text-blue-700 font-bold"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                        <div className="text-xs text-blue-600 text-center">
                                            {formData.age}세부터 {lifeExpectancy}세까지 ({lifeExpectancy - parseInt(formData.age)}년간) 자산 보존
                                        </div>
                                    </div>

                                    
                                    {/* 계산 결과 저장 */}
                                    {!isResultSaved ? (
                                        <div className="text-center mb-6">
                                            <button
                                                onClick={saveCalculationResult}
                                                className="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300"
                                            >
                                                💾 내 계산결과 저장하기
                                            </button>
                                            <div className="text-sm text-blue-600 mt-2 font-medium">
                                                계산 결과를 저장하면 나와 비슷한 사람들과 이야기할 수 있어요!
                                            </div>
                                            <div className="text-sm text-gray-500 mt-1">
                                                언제든지 다시 계산하고 업데이트 할 수 있습니다
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center mb-6">
                                            <div className="inline-block px-6 py-3 bg-green-100 text-green-800 rounded-lg font-semibold">
                                                ✅ 계산결과가 저장되었습니다!
                                            </div>
                                            <div className="text-sm text-gray-500 mt-2">
                                                언제든지 다시 계산하고 업데이트 할 수 있습니다
                                            </div>
                                            <div className="text-sm text-blue-600 mt-1 font-medium">
                                                👇 아래에서 비슷한 분들과 소통해보세요
                                            </div>
                                        </div>
                                    )}
                                    
                                </div>
                            </div>
                            
                            {/* 커뮤니티 섹션 - 저장 후에만 표시 */}
                            {isResultSaved && (
                                <div className="card mb-6">
                                    <h3 className="text-xl font-bold mb-4">👥 나와 비슷한 사람들과 소통해보세요</h3>
                                
                                    {/* 탭 네비게이션 */}
                                    <div className="grid grid-cols-3 gap-2 mb-6">
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'expense' 
                                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            onClick={() => setActiveTab('expense')}
                                        >
                                            📊 지출내역 공유
                                        </button>
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'community' 
                                                    ? 'bg-gradient-to-r from-green-500 to-blue-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200 animate-pulse'
                                            }`}
                                            onClick={() => setActiveTab('community')}
                                        >
                                            💬 커뮤니티 참여
                                        </button>
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'expert' 
                                                    ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            onClick={() => setActiveTab('expert')}
                                        >
                                            🔍 전문가 찾기
                                        </button>
                                    </div>

                                    {/* 지출내역 공유 탭 */}
                                    {activeTab === 'expense' && (
                                        <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg">
                                            <div className="bg-white p-4 rounded-lg mb-4">
                                                <p className="text-gray-800 font-semibold">
                                                    💰 <strong>지출내역 입력</strong> 후<br/>
                                                    비슷한 사람들이 어떻게 돈을 쓰고 있는지 확인할 수 있습니다.
                                                </p>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2 mb-4 text-xs">
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"식비는 얼마가 적당할까요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"다른사람은 의료비를 얼마나 쓸까요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"취미·여가비 현실적인 기준은?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"차량유지비는 얼마나 나올까요?"</div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-purple-100 p-3 rounded-lg mb-4 text-center">
                                                <p className="text-purple-800 font-semibold">
                                                    📈 <strong>더 나은 서비스 제공을 위해서만 익명으로 활용됩니다</strong>
                                                </p>
                                                <p className="text-purple-700 text-sm">내 또래의 실제 지출 패턴을 확인하세요</p>
                                            </div>
                                            
                                            <button
                                                onClick={openExpenseModal}
                                                className="w-full text-lg py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold transform hover:scale-105 transition-all duration-300"
                                            >
                                                📝 지출내역 입력하기
                                            </button>
                                        </div>
                                    )}

                                    {/* 커뮤니티 참여 탭 */}
                                    {activeTab === 'community' && (
                                        <div className="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg">
                                            <div className="bg-white p-4 rounded-lg mb-4">
                                                <p className="text-gray-800 font-semibold">
                                                    🤝 <strong>익명 라이프스타일 커뮤니티</strong>에서<br/>
                                                    비슷한 자산과 나이대({formData.age}세)의 사람들과 솔직한 경험을 나누어보세요.
                                                </p>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2 mb-4 text-xs">
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"실제로 이 돈으로 살 수 있나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"예상치 못한 비용들은 뭐가 있나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"어떤 서비스들을 실제로 이용하시나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"은퇴 생활의 현실적인 팁들"</div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-green-100 p-3 rounded-lg mb-4 text-center">
                                                <p className="text-green-800 font-semibold">
                                                    ✨ <strong>금융상품 판매는 일체 없습니다</strong> ✨
                                                </p>
                                                <p className="text-green-700 text-sm">순수 라이프스타일 커뮤니티입니다</p>
                                            </div>
                                            
                                            <button
                                                onClick={joinCommunity}
                                                className="w-full text-lg py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg font-semibold transform hover:scale-105 transition-all duration-300"
                                            >
                                                🤝 익명 커뮤니티 참여하기
                                            </button>
                                        </div>
                                    )}

                                    {/* 전문가 찾기 탭 */}
                                    {activeTab === 'expert' && (
                                        <div className="space-y-6">
                                            {/* 전문가 찾기 서비스 소개 */}
                                            <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-6 border border-orange-200">
                                                <div className="flex items-center space-x-3 mb-4">
                                                    <div className="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                                                        <span className="text-white text-xl">🧑‍💼</span>
                                                    </div>
                                                    <div>
                                                        <h3 className="text-xl font-bold text-gray-900">전문가 상담</h3>
                                                        <p className="text-sm text-gray-600">인증된 재무설계 전문가와 1:1 상담</p>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                    <div className="flex items-start space-x-3">
                                                        <span className="text-orange-500 text-lg">💡</span>
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">맞춤형 조언</h4>
                                                            <p className="text-sm text-gray-600">계산 결과를 바탕으로 개인별 최적화 전략 제시</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-start space-x-3">
                                                        <span className="text-orange-500 text-lg">🏆</span>
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">검증된 전문가</h4>
                                                            <p className="text-sm text-gray-600">CFP, AFP 등 공인자격증 보유 전문가</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-start space-x-3">
                                                        <span className="text-orange-500 text-lg">📞</span>
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">다양한 상담방식</h4>
                                                            <p className="text-sm text-gray-600">전화, 영상통화, 대면 상담 선택</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-start space-x-3">
                                                        <span className="text-orange-500 text-lg">⏰</span>
                                                        <div>
                                                            <h4 className="font-medium text-gray-900">유연한 일정</h4>
                                                            <p className="text-sm text-gray-600">원하는 시간에 예약 가능</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="bg-white rounded-lg p-4 mb-4">
                                                    <h4 className="font-medium text-gray-900 mb-2">📋 이런 분들께 추천해요</h4>
                                                    <ul className="text-sm text-gray-600 space-y-1">
                                                        <li>• 계산 결과를 전문가와 함께 검토하고 싶으신 분</li>
                                                        <li>• 세부적인 투자 포트폴리오 조언이 필요한 분</li>
                                                        <li>• 세금 최적화 방법을 알고 싶으신 분</li>
                                                        <li>• 리스크 관리 전략을 세우고 싶으신 분</li>
                                                    </ul>
                                                </div>
                                                
                                                {isGuest ? (
                                                    <div className="text-center space-y-3">
                                                        <p className="text-sm text-gray-600">전문가 상담은 회원만 이용할 수 있습니다</p>
                                                        <button
                                                            onClick={() => setShowSignupModal(true)}
                                                            className="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-600 transition-colors"
                                                        >
                                                            회원가입하고 전문가 찾기 🚀
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="text-center">
                                                        <button
                                                            onClick={() => setCurrentView('experts')}
                                                            className="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-600 transition-colors"
                                                        >
                                                            전문가 찾기 시작하기 🚀
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="card mb-6">
                                <h3 className="text-xl font-bold mb-4">📊 세부 계산결과</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span>자산을 활용한 생활비:</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold">{formatResultAmount(calculatorResult.monthlyAmount)}/월</span>
                                            <button
                                                onClick={() => setShowAssetDetail(!showAssetDetail)}
                                                className="text-white text-sm px-3 py-2 bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors font-semibold shadow-md animate-pulse"
                                            >
                                                {showAssetDetail ? '📊 계산과정 숨기기' : '📊 계산과정 보기'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {!showAssetDetail && (
                                        <div className="text-center mt-2">
                                            <p className="text-xs text-blue-600">💡 계산과정을 보시면 자산 분류와 주택 매각 옵션을 확인할 수 있습니다</p>
                                        </div>
                                    )}

                                    {/* 자산 계산 상세 설명 */}
                                    {showAssetDetail && (
                                        <div className="bg-blue-50 p-4 rounded-lg mt-3 space-y-3 text-sm">
                                            <div className="font-semibold text-blue-800 mb-2">📊 계산 과정</div>
                                            
                                            <div className="space-y-3">
                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="font-medium">• 순 자산:</span>
                                                        <span className="font-bold">{formatResultAmount(calculatorResult.assetBreakdown?.totalAssets || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600 mb-3">입력하신 모든 자산을 생활비로 쓸 수 있는 자산과 쓸 수 없는 자산으로 구분했습니다</p>
                                                    
                                                    {/* 자산 구분 테이블 */}
                                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                                        {/* 돈이 나오는 자산 */}
                                                        <div className="bg-green-50 p-2 rounded border border-green-200">
                                                            <div className="font-semibold text-green-800 mb-2">💰 생활비로 쓸 수 있는 자산</div>
                                                            <div className="space-y-1 text-green-700">
                                                                {parseInt(formData.financialAssets) > 0 && <div>• 현금성 자산: {formatResultAmount(parseInt(formData.financialAssets) * 10000)}</div>}
                                                                {parseInt(formData.severancePay) > 0 && <div>• 퇴직금: {formatResultAmount(parseInt(formData.severancePay) * 10000)}</div>}
                                                                {formData.homeValue && parseInt(formData.homeValue) > 0 && enableDownsizing && (
                                                                    <div>• 주택 (매각): {formatResultAmount(calculatorResult.assetBreakdown?.realizedHousingAsset || 0)}</div>
                                                                )}
                                                                {parseInt(formData.housingPension) > 0 && (
                                                                    <div>• 주택 (주택연금): {formatResultAmount(parseInt(formData.homeValue) * 10000)}</div>
                                                                )}
                                                                {formData.jeonseDeposit && parseInt(formData.jeonseDeposit) > 0 && <div>• 전세보증금: {formatResultAmount(parseInt(formData.jeonseDeposit) * 10000)}</div>}
                                                                {formData.monthlyDeposit && parseInt(formData.monthlyDeposit) > 0 && <div>• 월세보증금: {formatResultAmount(parseInt(formData.monthlyDeposit) * 10000)}</div>}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* 돈이 나오지 않는 자산 */}
                                                        <div className="bg-gray-50 p-2 rounded border border-gray-200">
                                                            <div className="font-semibold text-gray-800 mb-2">🏠 생활비로 쓸 수 없는 자산</div>
                                                            <div className="space-y-1 text-gray-600">
                                                                {formData.homeValue && parseInt(formData.homeValue) > 0 && !enableDownsizing && !parseInt(formData.housingPension) && (
                                                                    <div>• {formData.housingType === 'owned_living' ? '거주용' : '임대용'} 주택: {formatResultAmount(parseInt(formData.homeValue) * 10000)}</div>
                                                                )}
                                                                {formData.investmentRealEstate && parseInt(formData.investmentRealEstate) > 0 && (
                                                                    <div>• 수익형 부동산: {formatResultAmount(parseInt(formData.investmentRealEstate) * 10000)}</div>
                                                                )}
                                                                {formData.currentDeposit && parseInt(formData.currentDeposit) > 0 && <div>• 거주지 보증금: {formatResultAmount(parseInt(formData.currentDeposit) * 10000)}</div>}
                                                                {formData.inheritance && parseInt(formData.inheritance) > 0 && <div>• 증여/상속 예정: {formatResultAmount(parseInt(formData.inheritance) * 10000)}</div>}
                                                                {(!formData.homeValue || parseInt(formData.homeValue) === 0 || 
                                                                  (formData.housingType === 'owned_living' && (enableDownsizing || parseInt(formData.housingPension))) ||
                                                                  (formData.housingType === 'owned_renting' && enableDownsizing)) && 
                                                                 (!formData.inheritance || parseInt(formData.inheritance) === 0) &&
                                                                 (!formData.currentDeposit || parseInt(formData.currentDeposit) === 0) && (
                                                                    <div className="text-gray-400 italic">해당 없음</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* 부채 차감 */}
                                                    {((formData.debt && parseInt(formData.debt) > 0) || (formData.homeMortgage && parseInt(formData.homeMortgage) > 0) || (formData.investmentLoan && parseInt(formData.investmentLoan) > 0) || (formData.depositLoan && parseInt(formData.depositLoan) > 0) || (formData.ownedHouseDeposit && parseInt(formData.ownedHouseDeposit) > 0)) && (
                                                        <div className="mt-3 p-2 bg-red-50 rounded border border-red-200">
                                                            <div className="font-semibold text-red-800 mb-1 text-xs">💳 부채 차감</div>
                                                            <div className="space-y-1 text-xs text-red-700">
                                                                {formData.debt && parseInt(formData.debt) > 0 && <div>• 기타 대출: -{formatResultAmount(parseInt(formData.debt) * 10000)}</div>}
                                                                {formData.homeMortgage && parseInt(formData.homeMortgage) > 0 && <div>• 주택대출: -{formatResultAmount(parseInt(formData.homeMortgage) * 10000)}</div>}
                                                                {formData.investmentLoan && parseInt(formData.investmentLoan) > 0 && <div>• 투자대출: -{formatResultAmount(parseInt(formData.investmentLoan) * 10000)}</div>}
                                                                {formData.depositLoan && parseInt(formData.depositLoan) > 0 && <div>• 보증금 대출: -{formatResultAmount(parseInt(formData.depositLoan) * 10000)}</div>}
                                                                {formData.ownedHouseDeposit && parseInt(formData.ownedHouseDeposit) > 0 && <div>• 임차인 보증금: -{formatResultAmount(parseInt(formData.ownedHouseDeposit) * 10000)}</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* 주택 매각 옵션 */}
                                                {(formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') && !parseInt(formData.housingPension) && (
                                                    <div className="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-300 mt-3">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <span className="text-sm font-medium text-orange-800">🏠 주택 매각 옵션</span>
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={enableDownsizing}
                                                                    onChange={(e) => setEnableDownsizing(e.target.checked)}
                                                                    className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500"
                                                                />
                                                                <span className="text-sm font-medium text-orange-800">매각했을 때 생활비 계산하기</span>
                                                            </label>
                                                        </div>
                                                        <div className="text-xs text-orange-600">
                                                            주택을 매각하면 더 많은 은퇴생활비를 확보할 수 있어요.
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 비상자금 제외:</span>
                                                        <span className="font-bold text-red-600">-{formatResultAmount(calculatorResult.assetBreakdown?.emergencyFund || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">예상치 못한 의료비 등을 위해 현금성 자산의 10%를 비상자금으로 보존합니다</p>
                                                </div>

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 생활비로 쓸 수 있는 자산:</span>
                                                        <span className="font-bold text-green-600">{formatResultAmount(calculatorResult.assetBreakdown?.availableAssets || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">비상자금까지 차감하고 기대수명까지 소비할 수 있는 자산입니다</p>
                                                </div>

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 소비 예상 기간:</span>
                                                        <span className="font-bold text-blue-600">{calculatorResult.yearsToLive || 0}년</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">현재 나이부터 기대수명까지 자산을 소비하는 기간입니다</p>
                                                </div>

                                                <div className="bg-blue-100 p-3 rounded-lg border-t-2 border-blue-300">
                                                    <div className="text-center font-bold text-green-600 text-lg">
                                                        소비 가능한 자산은 연간 {formatResultAmount(calculatorResult.monthlyAmount * 12)}, 월간 {formatResultAmount(calculatorResult.monthlyAmount)} 입니다.
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="text-xs text-blue-700 mt-3 p-3 bg-blue-100 rounded border-l-4 border-blue-400">
                                                💡 <strong>계산 공식:</strong> 생활비로 쓸 수 있는 자산 ÷ 소비예상기간 ÷ 12개월 = 월 사용 가능 금액<br/>
                                                <div className="mt-2 p-2 bg-yellow-50 rounded border border-yellow-200">
                                                    <strong>⚠️ 중요:</strong> 이 계산은 <strong>{lifeExpectancy}세까지</strong> 자산을 소비한다고 가정하고 계산되었습니다.(투자수익률을 배제)
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {calculatorResult.monthlyPension > 0 && (
                                        <div className="flex justify-between text-green-700">
                                            <span>+ 연금 수입:</span>
                                            <span className="font-bold">+{formatResultAmount(calculatorResult.monthlyPension)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyOtherIncome > 0 && (
                                        <div className="flex justify-between text-green-700">
                                            <span>+ 기타 월 수입:</span>
                                            <span className="font-bold">+{formatResultAmount(calculatorResult.monthlyOtherIncome)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyHousingCost > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월세 지출:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyHousingCost)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyLoanInterest > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월 대출 이자:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyLoanInterest)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyPropertyTax > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월 재산세:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyPropertyTax)}/월</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between font-bold pt-2 border-t border-blue-200 text-lg">
                                        <span>월간 총 은퇴생활비:</span>
                                        <span className="text-blue-600">{formatResultAmount(calculatorResult.totalMonthlyAvailable)}/월</span>
                                    </div>
                                </div>
                            </div>


                            <div className="text-center space-y-3">
                                <button
                                    onClick={() => goToNextStep(1)}
                                    className="text-gray-500 underline hover:text-gray-700"
                                >
                                    다시 계산하기
                                </button>
                            </div>

                            {/* 지출내역 입력 모달 */}
                            {showExpenseModal && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-8">
                                    <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto relative">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-center flex-1">📊 월 지출내역 입력</h3>
                                            <button
                                                onClick={closeExpenseModal}
                                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold ml-4"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        <div className="space-y-6">
                                            <ExpenseInput
                                                label="🍽️ 식비"
                                                field="food"
                                                value={expenseData.food}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="📱 통신비"
                                                field="communication"
                                                value={expenseData.communication}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="💡 공과금"
                                                field="utilities"
                                                value={expenseData.utilities}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🏥 의료비"
                                                field="medical"
                                                value={expenseData.medical}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🎯 취미·여가비"
                                                field="hobby"
                                                value={expenseData.hobby}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🚗 차량유지비 (기름값 등)"
                                                field="vehicle"
                                                value={expenseData.vehicle}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="📦 기타"
                                                field="etc"
                                                value={expenseData.etc}
                                                placeholder=""
                                            />
                                        </div>
                                        <div className="flex gap-3 mt-6">
                                            <button
                                                onClick={closeExpenseModal}
                                                className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400"
                                            >
                                                취소
                                            </button>
                                            <button
                                                onClick={submitExpenseData}
                                                className="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                            >
                                                저장
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* 지출내역 비교 결과 모달 */}
                            {showComparisonModal && expenseComparison && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto relative">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-center flex-1">📊 지출 패턴 비교 결과</h3>
                                            <button
                                                onClick={() => setShowComparisonModal(false)}
                                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold ml-4"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        
                                        {/* 전체 비교 */}
                                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-6">
                                            <div className="grid grid-cols-2 gap-4 text-center">
                                                <div>
                                                    <p className="text-sm text-gray-600 mb-1">내 지출 총액</p>
                                                    <p className="text-2xl font-bold text-blue-600">{expenseComparison.userTotal.toLocaleString()}만원</p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-gray-600 mb-1">통계청 평균 (2024년)</p>
                                                    <p className="text-2xl font-bold text-purple-600">{expenseComparison.statTotal.toLocaleString()}만원</p>
                                                </div>
                                            </div>
                                            
                                            <div className="text-center mt-4">
                                                {expenseComparison.userTotal > expenseComparison.statTotal ? (
                                                    <p className="text-red-600 font-semibold">
                                                        📈 평균보다 {(expenseComparison.userTotal - expenseComparison.statTotal).toLocaleString()}만원 더 지출
                                                    </p>
                                                ) : expenseComparison.userTotal < expenseComparison.statTotal ? (
                                                    <p className="text-green-600 font-semibold">
                                                        📉 평균보다 {(expenseComparison.statTotal - expenseComparison.userTotal).toLocaleString()}만원 절약
                                                    </p>
                                                ) : (
                                                    <p className="text-gray-600 font-semibold">
                                                        ✅ 평균과 동일한 수준
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* 항목별 비교 */}
                                        <div className="space-y-3">
                                            <h4 className="text-lg font-bold mb-3">항목별 상세 비교</h4>
                                            
                                            {Object.entries({
                                                food: '🍽️ 식비',
                                                communication: '📱 통신비', 
                                                utilities: '💡 공과금',
                                                medical: '🏥 의료비',
                                                hobby: '🎯 취미·여가비',
                                                vehicle: '🚗 차량유지비',
                                                etc: '📦 기타'
                                            }).map(([key, label]) => {
                                                const userAmount = parseInt(expenseComparison.user[key]) || 0;
                                                const statAmount = expenseComparison.stat[key];
                                                const difference = userAmount - statAmount;
                                                const percentage = statAmount > 0 ? Math.round((difference / statAmount) * 100) : 0;
                                                
                                                return (
                                                    <div key={key} className="border rounded-lg p-4">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="font-semibold">{label}</span>
                                                            <span className={`text-sm font-bold ${
                                                                difference > 0 ? 'text-red-600' : 
                                                                difference < 0 ? 'text-green-600' : 'text-gray-600'
                                                            }`}>
                                                                {difference > 0 ? `+${difference}만원` : 
                                                                 difference < 0 ? `${difference}만원` : '±0만원'}
                                                                {percentage !== 0 && ` (${percentage > 0 ? '+' : ''}${percentage}%)`}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between text-sm">
                                                            <span>내 지출: <strong>{userAmount.toLocaleString()}만원</strong></span>
                                                            <span>평균: <strong>{statAmount.toLocaleString()}만원</strong></span>
                                                        </div>
                                                        
                                                        {/* 비교 바 */}
                                                        <div className="mt-2 bg-gray-200 rounded-full h-2 relative">
                                                            <div 
                                                                className="bg-purple-400 h-2 rounded-full" 
                                                                style={{width: `${Math.min(100, (statAmount / Math.max(userAmount, statAmount)) * 100)}%`}}
                                                            ></div>
                                                            <div 
                                                                className="bg-blue-500 h-2 rounded-full absolute top-0" 
                                                                style={{width: `${Math.min(100, (userAmount / Math.max(userAmount, statAmount)) * 100)}%`}}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        <div className="text-xs text-gray-500 mt-4 p-3 bg-gray-50 rounded">
                                            📊 기준: 통계청 2024년 가계동향조사 (전국 평균)
                                        </div>
                                        
                                        <div className="flex gap-3 mt-6">
                                            <button
                                                onClick={() => setShowComparisonModal(false)}
                                                className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600"
                                            >
                                                확인
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                        </div>
                    </div>
                );
            }

            return <div>잘못된 단계입니다.</div>;
        };

        // 게스트 사용자 관리
        const createGuestUser = () => {
            const guestId = crypto.randomUUID();
            const guestNickname = authManager.nicknameGen.generate();
            const guestUser = {
                id: guestId,
                email: null,
                nickname: guestNickname,
                isGuest: true,
                createdAt: new Date().toISOString()
            };
            localStorage.setItem('planb_guest_user', JSON.stringify(guestUser));
            return guestUser;
        };

        // 메인 App 컴포넌트
        const PlanBApp = () => {
            const [currentView, setCurrentView] = useState('login'); // 로그인 화면으로 바로 시작
            const [selectedPost, setSelectedPost] = useState(null); // 선택된 게시글 상태
            const [savedCalculations, setSavedCalculations] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isGuest, setIsGuest] = useState(false);
            const [authMode, setAuthMode] = useState('login'); // 'login' 또는 'signup'
            const [showAuthForm, setShowAuthForm] = useState(false); // 웰컴 페이지에서 폼 표시 여부
            const [showGuestConfirmModal, setShowGuestConfirmModal] = useState(false);
            const [showCommunityAccessModal, setShowCommunityAccessModal] = useState(false);
            const [showCalculationRequiredModal, setShowCalculationRequiredModal] = useState(false);
            const [showNotificationModal, setShowNotificationModal] = useState(false);
            const [notificationContent, setNotificationContent] = useState({ title: '', message: '', type: 'info' });
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [showSignupModal, setShowSignupModal] = useState(false);
            const [showSaveResultSignupModal, setShowSaveResultSignupModal] = useState(false);
            const [lastActivity, setLastActivity] = useState(Date.now());

            // 외부 클릭시 메뉴 닫기
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showMobileMenu && !event.target.closest('nav')) {
                        setShowMobileMenu(false);
                    }
                };
                
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [showMobileMenu]);

            // 세션 타임아웃 관리
            useEffect(() => {
                const SESSION_TIMEOUT = 30 * 60 * 1000; // 30분

                const updateActivity = () => {
                    setLastActivity(Date.now());
                };

                const checkInactivity = () => {
                    if (currentUser && !isGuest && (Date.now() - lastActivity > SESSION_TIMEOUT)) {
                        handleLogout();
                        showNotification('세션 만료', '보안을 위해 30분 후 자동 로그아웃되었습니다.\n다시 로그인해주세요.', 'warning');
                    }
                };

                // 사용자 활동 감지 이벤트
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                events.forEach(event => {
                    document.addEventListener(event, updateActivity, true);
                });

                // 5분마다 비활성 시간 체크
                const inactivityTimer = setInterval(checkInactivity, 5 * 60 * 1000);

                return () => {
                    events.forEach(event => {
                        document.removeEventListener(event, updateActivity, true);
                    });
                    clearInterval(inactivityTimer);
                };
            }, [currentUser, isGuest, lastActivity]);
            
            // 통합 알림 모달 함수
            const showNotification = (title, message, type = 'info') => {
                setNotificationContent({ title, message, type });
                setShowNotificationModal(true);
            };

            // 입력값 검증 함수들
            const validateUserInput = {
                email: (input) => {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(input) && input.length <= 100;
                },
                phone: (input) => {
                    const phoneRegex = /^010-\d{4}-\d{4}$/;
                    return phoneRegex.test(input);
                },
                businessNumber: (input) => {
                    const businessRegex = /^\d{3}-\d{2}-\d{5}$/;
                    return businessRegex.test(input);
                },
                name: (input) => {
                    return input && input.length >= 2 && input.length <= 20 && 
                           /^[가-힣a-zA-Z\s]+$/.test(input);
                },
                password: (input) => {
                    return input && input.length >= 8 && input.length <= 100 &&
                           /^(?=.*[a-zA-Z])(?=.*[0-9])|(?=.*[a-zA-Z])(?=.*[!@#$%^&*])|(?=.*[0-9])(?=.*[!@#$%^&*])/.test(input);
                },
                text: (input, maxLength = 1000) => {
                    return input && input.length > 0 && input.length <= maxLength &&
                           !/[<>'"&]/.test(input); // XSS 방지
                }
            };
            
            // 컴포넌트 마운트시 인증 상태 확인
            useEffect(() => {
                initializeApp();
            }, []);

            const initializeApp = async () => {
                try {
                    // 게스트 데이터 초기화 (일회성 사용)
                    localStorage.removeItem('planb_guest_user');
                    localStorage.removeItem('planb_calculation_result');
                    
                    // 자동 로그인 기능 비활성화
                    // 항상 로그인 화면으로 시작
                    console.log('자동 로그인 기능이 비활성화되어 있습니다');
                    // 게스트는 항상 welcome 화면부터 시작
                } catch (error) {
                    console.error('앱 초기화 오류:', error);
                }
            };
            
            // 인증 성공 핸들러
            const handleAuthSuccess = async (user) => {
                // 로그인 성공시 로그아웃 플래그 제거
                localStorage.removeItem('planb_user_logged_out');
                
                // 기존 게스트 데이터가 있다면 회원 계정으로 이관
                const guestCalculation = localStorage.getItem('planb_calculation_result');
                
                setCurrentUser(user);
                setIsAuthenticated(true);
                setIsGuest(false);
                setCurrentView('main');
                
                const isAdmin = isAdminUser(user);
                console.log(`로그인 성공${isAdmin ? ' (관리자)' : ' (일반 사용자)'}`);
                loadSavedCalculations();
                
                // 게스트 데이터 정리
                localStorage.removeItem('planb_guest_user');
                
                // 게스트 계산 결과가 있었다면 실제로 DB에 저장
                if (guestCalculation) {
                    try {
                        const calculationData = JSON.parse(guestCalculation);
                        
                        // Supabase에 실제 저장
                        if (supabase) {
                            const { error } = await supabase
                                .from('user_calculations')
                                .upsert({
                                    user_id: user.id,
                                    user_hash: null, // 회원은 user_hash 불필요
                                    age: calculationData.formData?.age,
                                    age_group: calculationData.formData?.ageGroup,
                                    health_status: calculationData.formData?.health,
                                    life_mode: calculationData.formData?.lifeMode,
                                    housing_type: calculationData.formData?.housingType,
                                    housing_value: calculationData.formData?.homeValue ? parseInt(calculationData.formData.homeValue) * 10000 : 0,
                                    financial_assets: calculationData.formData?.financialAssets ? parseInt(calculationData.formData.financialAssets) * 10000 : 0,
                                    severance_pay: calculationData.formData?.severancePay ? parseInt(calculationData.formData.severancePay) * 10000 : 0,
                                    debt: calculationData.formData?.debt ? parseInt(calculationData.formData.debt) * 10000 : 0,
                                    national_pension: calculationData.formData?.nationalPension ? parseInt(calculationData.formData.nationalPension) * 10000 : 0,
                                    private_pension: calculationData.formData?.privatePension ? parseInt(calculationData.formData.privatePension) * 10000 : 0,
                                    calculation_result: calculationData,
                                    updated_at: new Date().toISOString()
                                });
                            
                            if (error) {
                                console.error('계산 결과 DB 저장 실패:', error);
                            } else {
                                console.log('게스트 계산 결과 DB 저장 성공');
                            }
                        }
                        
                        setTimeout(() => {
                            showNotification(
                                '회원가입 완료!', 
                                '계산 결과가 회원 계정에 안전하게 저장되었습니다!\n언제든 다시 확인하실 수 있어요 💾', 
                                'success'
                            );
                        }, 1000);
                        
                    } catch (error) {
                        console.error('게스트 계산 결과 처리 실패:', error);
                        setTimeout(() => {
                            showNotification(
                                '회원가입 완료!', 
                                '회원가입이 완료되었습니다. 계산 결과 저장 중 오류가 발생했지만 언제든 다시 계산하실 수 있어요.', 
                                'success'
                            );
                        }, 1000);
                    }
                }
            };
            
            // 게스트 모드 시작 핸들러
            const handleGuestStart = () => {
                setShowGuestConfirmModal(true);
            };
            
            // 게스트 모드 확인 후 시작
            const confirmGuestStart = () => {
                const guestUser = createGuestUser();
                setCurrentUser(guestUser);
                setIsGuest(true);
                setCurrentView('main');
                setShowGuestConfirmModal(false);
                console.log(`게스트 모드 시작: ${guestUser.nickname}`);
            };
            
            
            // 로그아웃 핸들러
            const handleLogout = async () => {
                if (isGuest) {
                    // 게스트 모드 종료
                    localStorage.removeItem('planb_guest_user');
                    localStorage.removeItem('planb_calculation_result');
                    setCurrentUser(null);
                    setIsGuest(false);
                    setCurrentView('login');
                    setSavedCalculations([]);
                } else {
                    // 회원 로그아웃
                    const result = await authManager.signOut();
                    if (result.success) {
                        // 로그아웃 상태를 localStorage에 저장
                        localStorage.setItem('planb_user_logged_out', 'true');
                        
                        setCurrentUser(null);
                        setIsAuthenticated(false);
                        setCurrentView('login');
                        setSavedCalculations([]);
                        localStorage.removeItem('planb_calculation_result');
                        console.log('로그아웃 완료 - 자동 로그인 비활성화');
                    }
                }
            };
            
            // 저장된 계산결과 불러오기
            const loadSavedCalculations = () => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    // 저장된 계산 결과가 있으면 계산기 화면으로 이동하여 결과 표시
                    setSavedCalculations([JSON.parse(saved)]);
                }
                // 저장된 결과가 없어도 정상적인 상황이므로 alert 제거
            };

            // 계산 완료시 결과 저장 및 커뮤니티 안내
            const handleCalculationComplete = async (calculationResult) => {
                try {
                    // 계산 결과를 localStorage와 Supabase에 저장
                    localStorage.setItem('planb_calculation_result', JSON.stringify(calculationResult));
                    
                    if (currentUser) {
                        // 회원인 경우 Supabase에도 저장
                        const { error } = await supabase
                            .from('user_calculations')
                            .upsert({
                                user_id: currentUser.id,
                                age: calculationResult.formData?.age,
                                age_group: calculationResult.formData?.age >= 60 ? '60대' : '50대',
                                health_status: calculationResult.formData?.health,
                                life_mode: calculationResult.formData?.lifeMode,
                                housing_type: calculationResult.formData?.housingType,
                                housing_value: (calculationResult.formData?.housingValue || 0) * 10000,
                                financial_assets: (calculationResult.formData?.financialAssets || 0) * 10000,
                                severance_pay: (calculationResult.formData?.severancePay || 0) * 10000,
                                debt: (calculationResult.formData?.debt || 0) * 10000,
                                national_pension: (calculationResult.formData?.nationalPension || 0) * 10000,
                                private_pension: (calculationResult.formData?.privatePension || 0) * 10000,
                                calculation_result: calculationResult,
                                updated_at: new Date().toISOString()
                            });
                        
                        if (error) {
                            console.error('계산 결과 저장 오류:', error);
                        }
                    }
                    
                    // 계산 완료 - 별도 안내 없이 조용히 완료
                    
                } catch (error) {
                    console.error('계산 완료 처리 실패:', error);
                }
            };

            // 커뮤니티 접근 체크 (모든 사용자가 목록 보기 가능, 상호작용만 제한)
            const handleCommunityAccess = () => {
                console.log('커뮤니티 접근 시도:', { isAuthenticated, isGuest, currentUser });
                
                // 게스트, 회원 모두 커뮤니티 목록 보기 허용
                // 인증되지 않은 사용자만 로그인 유도
                if (!isAuthenticated && !isGuest) {
                    console.log('로그인 폼 표시');
                    setAuthMode('login');
                    setCurrentView('login');
                    setShowAuthForm(true);
                    return;
                }
                
                console.log('커뮤니티 페이지로 이동');
                setCurrentView('community');
            };
            
            // 관리자 계정 목록 (개발자/테스트 계정)
            const isAdminUser = (user) => {
                if (!user || !user.email) return false;
                const adminEmails = [
                    'jwpaparoy@gmail.com',  // 개발자 계정
                    'knwwhr@gmail.com'      // 관리자 계정
                ];
                return adminEmails.includes(user.email.toLowerCase());
            };

            // 사용자 타입 확인 함수 (async) - 관리자는 모든 권한 보유
            const getUserType = async (user) => {
                if (!user) return 'guest';
                
                // 게스트 사용자 확인
                if (user.isGuest) return 'guest';
                
                // 관리자는 모든 권한을 가지므로 'admin' 반환하지만 UI에서 모든 기능 접근 가능
                if (isAdminUser(user)) return 'admin';
                
                // Supabase에서 expert_profiles 테이블 조회하여 전문가 여부 확인
                try {
                    const { data: expertProfile, error } = await supabase
                        .from('financial_experts')
                        .select('id, verification_status')
                        .eq('email', user.email)
                        .single();
                    
                    if (expertProfile && expertProfile.verification_status === 'approved') {
                        return 'expert';
                    }
                } catch (error) {
                    // expert_profiles에 없으면 일반회원
                    console.log('Expert profile not found, user is regular member');
                }
                
                return 'member';
            };

            // 관리자 권한 확인 함수들
            const hasAdminAccess = (user) => isAdminUser(user);
            const hasMemberAccess = (user) => user && (isAdminUser(user) || !isGuest);
            const hasExpertAccess = async (user) => {
                if (!user) return false;
                if (isAdminUser(user)) return true; // 관리자는 전문가 권한 포함
                
                try {
                    const { data: expertProfile } = await supabase
                        .from('financial_experts')
                        .select('verification_status')
                        .eq('email', user.email)
                        .single();
                    return expertProfile?.verification_status === 'approved';
                } catch {
                    return false;
                }
            };

            // 사용자 타입별 표시 이름
            const getUserTypeName = (userType) => {
                switch(userType) {
                    case 'admin': return '관리자';
                    case 'expert': return '전문가';
                    case 'member': return '일반회원';
                    default: return '게스트';
                }
            };

            // 커뮤니티 상호작용 체크 (상세보기/글쓰기)
            const checkCalculationForInteraction = (action) => {
                // 게스트인 경우 회원가입 유도
                if (isGuest) {
                    setShowCommunityAccessModal(true);
                    return false;
                }
                
                // 관리자 계정인 경우 모든 기능 접근 허용
                if (isAdminUser(currentUser)) {
                    console.log('관리자 계정으로 모든 기능 접근 허용:', currentUser.email);
                    return true;
                }
                
                // 일반 회원인 경우 계산 완료 체크
                const hasCalculation = localStorage.getItem('planb_calculation_result');
                if (!hasCalculation) {
                    setShowCalculationRequiredModal(true);
                    return false;
                }
                return true;
            };

            // 게시글 상세보기 핸들러 (프로그레시브 접근)
            const handlePostClick = (post) => {
                // 계산 완료 여부 체크
                if (!checkCalculationForInteraction('view_post')) {
                    return; // 모달이 표시됨
                }
                
                // 계산 완료된 사용자만 상세보기 가능
                setSelectedPost(post);
                setCurrentView('post-detail');
            };


            // 로그인 화면 (기본 화면)
            if (currentView === 'login') {
                return (
                    <AuthComponent 
                        onAuthSuccess={handleAuthSuccess} 
                        initialMode={authMode}
                        generateGuestUser={createGuestUser}
                    />
                );
            }


            // 마이페이지
            if (currentView === 'mypage') {
                return (
                    <MyPageComponent 
                        currentUser={currentUser}
                        onClose={() => setCurrentView('main')}
                        getUserType={getUserType}
                        getUserTypeName={getUserTypeName}
                        isAdminUser={isAdminUser}
                        isGuest={isGuest}
                    />
                );
            }
            

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* 상단 네비게이션 */}
                    <nav className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                {/* 로고 */}
                                <div 
                                    className="text-xl font-bold text-blue-600 cursor-pointer"
                                    onClick={() => setCurrentView('main')}
                                >
                                    플랜비
                                </div>

                                {/* 햄버거 버튼 */}
                                <button
                                    onClick={() => setShowMobileMenu(!showMobileMenu)}
                                    className="p-2 rounded-md text-gray-600 hover:text-blue-600 hover:bg-gray-100 transition-colors"
                                >
                                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        {showMobileMenu ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                        )}
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        {/* 사이드바 메뉴 */}
                        {showMobileMenu && (
                            <>
                                {/* 사이드바 배경 오버레이 */}
                                <div 
                                    className="fixed inset-0 bg-black bg-opacity-50 z-40"
                                    onClick={() => setShowMobileMenu(false)}
                                />
                                
                                {/* 사이드바 */}
                                <div className="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out">
                                    {/* 사이드바 헤더 */}
                                    <div className="flex items-center justify-between p-4 border-b border-gray-200 bg-blue-50">
                                        <div className="flex items-center space-x-2">
                                            <div className="text-xl font-bold text-blue-600">플랜비</div>
                                            <span className="text-xs text-gray-500">메뉴</span>
                                        </div>
                                        <button
                                            onClick={() => setShowMobileMenu(false)}
                                            className="p-2 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    {/* 사이드바 컨텐츠 */}
                                    <div className="flex flex-col h-full">
                                        {/* 사용자 정보 영역을 상단으로 이동 */}
                                        <div className="border-b border-gray-200 p-4 bg-gray-50">
                                            {isGuest ? (
                                                <>
                                                    <div className="px-3 py-2 text-amber-600 font-medium flex items-center text-sm">
                                                        <span className="mr-2 text-base">🌟</span>
                                                        <div className="flex-1 min-w-0">
                                                            <span className="truncate">{currentUser?.nickname}</span>
                                                            <div className="text-xs text-amber-500">(게스트 모드 - 계산기 전용)</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 mt-2">
                                                        <button
                                                            onClick={() => {
                                                                setAuthMode('signup');
                                                                setCurrentView('login');
                                                                setShowAuthForm(true);
                                                                setShowMobileMenu(false);
                                                            }}
                                                            className="flex-1 px-3 py-2 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center justify-center text-sm"
                                                        >
                                                            <span className="mr-2 text-base">✨</span>
                                                            회원가입
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                handleLogout();
                                                                setShowMobileMenu(false);
                                                            }}
                                                            className="flex-1 px-3 py-2 rounded-md text-gray-700 hover:bg-gray-200 hover:text-red-600 transition-colors flex items-center justify-center text-sm"
                                                        >
                                                            <span className="mr-2 text-base">🚪</span>
                                                            나가기
                                                        </button>
                                                    </div>
                                                </>
                                            ) : currentUser ? (
                                                <>
                                                    <div className="px-3 py-2 text-gray-700 font-medium flex items-center text-sm">
                                                        <span className="mr-2 text-base">
                                                            {isAdminUser(currentUser) ? '👑' : '👤'}
                                                        </span>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="truncate">{currentUser?.nickname || currentUser?.email}</div>
                                                            {isAdminUser(currentUser) && (
                                                                <span className="text-red-500 text-xs bg-red-100 px-1 py-0.5 rounded mt-1 inline-block">슈퍼관리자</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 mt-2">
                                                        <button
                                                            onClick={() => {
                                                                setCurrentView('mypage');
                                                                setShowMobileMenu(false);
                                                            }}
                                                            className="flex-1 px-3 py-2 rounded-md text-gray-700 hover:bg-gray-200 hover:text-blue-600 transition-colors flex items-center justify-center text-sm"
                                                        >
                                                            <span className="mr-2 text-base">⚙️</span>
                                                            마이페이지
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                handleLogout();
                                                                setShowMobileMenu(false);
                                                            }}
                                                            className="flex-1 px-3 py-2 rounded-md text-gray-700 hover:bg-gray-200 hover:text-red-600 transition-colors flex items-center justify-center text-sm"
                                                        >
                                                            <span className="mr-2 text-base">🚪</span>
                                                            로그아웃
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                <button
                                                    onClick={() => {
                                                        setAuthMode('login');
                                                        setCurrentView('login');
                                                        setShowAuthForm(true);
                                                        setShowMobileMenu(false);
                                                    }}
                                                    className="w-full px-3 py-2 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center justify-center text-sm"
                                                >
                                                    <span className="mr-2 text-base">🔑</span>
                                                    로그인
                                                </button>
                                            )}
                                        </div>

                                        {/* 메인 메뉴들 */}
                                        <div className="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                                            {/* 계산기는 모든 사용자에게 공개 */}
                                            <button
                                                className={`w-full text-left px-3 py-2 rounded-md transition-colors flex items-center text-sm ${
                                                    currentView === 'calculator' 
                                                        ? 'bg-blue-100 text-blue-700 font-medium shadow-sm' 
                                                        : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                                }`}
                                                onClick={() => {
                                                    setCurrentView('calculator');
                                                    setShowMobileMenu(false);
                                                }}
                                            >
                                                <span className="mr-3 text-base">🧮</span>
                                                은퇴생활비 계산기
                                            </button>
                                            
                                            {/* 게스트가 아닌 경우에만 표시 */}
                                            {!isGuest && (
                                                <>
                                                    <button
                                                        className={`w-full text-left px-3 py-2 rounded-md transition-colors flex items-center text-sm ${
                                                            currentView === 'community' 
                                                                ? 'bg-blue-100 text-blue-700 font-medium shadow-sm' 
                                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                                        }`}
                                                        onClick={() => {
                                                            handleCommunityAccess();
                                                            setShowMobileMenu(false);
                                                        }}
                                                    >
                                                        <span className="mr-3 text-base">💬</span>
                                                        커뮤니티
                                                    </button>
                                                    
                                                    <button
                                                        className={`w-full text-left px-3 py-2 rounded-md transition-colors flex items-center text-sm ${
                                                            currentView === 'experts' 
                                                                ? 'bg-blue-100 text-blue-700 font-medium shadow-sm' 
                                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                                        }`}
                                                        onClick={() => {
                                                            setCurrentView('experts');
                                                            setShowMobileMenu(false);
                                                        }}
                                                    >
                                                        <span className="mr-3 text-base">🔍</span>
                                                        전문가 찾기
                                                    </button>
                                                    
                                                    <button
                                                        className={`w-full text-left px-3 py-2 rounded-md transition-colors flex items-center text-sm ${
                                                            currentView === 'announcements' 
                                                                ? 'bg-blue-100 text-blue-700 font-medium shadow-sm' 
                                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                                        }`}
                                                        onClick={() => {
                                                            setCurrentView('announcements');
                                                            setShowMobileMenu(false);
                                                        }}
                                                    >
                                                        <span className="mr-3 text-base">📢</span>
                                                        공지사항
                                                    </button>
                                                    
                                                    <button
                                                        className={`w-full text-left px-3 py-2 rounded-md transition-colors flex items-center text-sm ${
                                                            currentView === 'chat' 
                                                                ? 'bg-blue-100 text-blue-700 font-medium shadow-sm' 
                                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                                        }`}
                                                        onClick={() => {
                                                            // 채팅은 회원만 가능 
                                                            if (!checkCalculationForInteraction('chat_access')) {
                                                                return;
                                                            }
                                                            setCurrentView('chat');
                                                            setShowMobileMenu(false);
                                                        }}
                                                    >
                                                        <span className="mr-3 text-base">💬</span>
                                                        실시간 채팅
                                                    </button>
                                                </>
                                            )}
                                            
                                            {/* 게스트에게만 표시되는 안내 */}
                                            {isGuest && (
                                                <div className="px-3 py-4 border border-blue-200 rounded-lg bg-blue-50">
                                                    <div className="text-sm text-blue-600 mb-2 font-medium">🌟 게스트 모드</div>
                                                    <p className="text-xs text-blue-500 mb-3">현재 계산기만 사용 가능합니다. 더 많은 기능을 이용하려면 회원가입하세요!</p>
                                                    <div className="text-xs text-blue-400">
                                                        <div>• 커뮤니티 참여</div>
                                                        <div>• 전문가 상담</div>
                                                        <div>• 개인 데이터 저장</div>
                                                        <div>• 계산 기록 관리</div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </nav>
                    
                    {/* 메인 컨텐츠 영역 */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {currentView === 'main' && (
                            <div className="text-center">
                                <div className="mb-8">
                                    <h1 className="text-4xl font-bold text-gray-800 mb-4">
                                        플랜비
                                    </h1>
                                    <p className="text-xl text-gray-600 mb-2">
                                        행복한 은퇴생활의 시작
                                    </p>
                                    
                                    {/* 사용자 환영 메시지 */}
                                    {currentUser && (
                                        <div className="text-lg text-blue-700 font-medium mb-6">
                                            안녕하세요, {currentUser.nickname || currentUser.email.split('@')[0]}님! 👋
                                            {isAdminUser(currentUser) && (
                                                <span className="ml-2 text-red-600 text-sm">
                                                    👑 슈퍼관리자
                                                </span>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* 메인 화면 공지사항 배너 */}
                                    <div 
                                        className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-8 cursor-pointer hover:bg-blue-100 transition-colors max-w-2xl mx-auto"
                                        onClick={() => setCurrentView('announcements')}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3">
                                                <div className="text-blue-600">
                                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                                                    </svg>
                                                </div>
                                                <div className="flex-1">
                                                    <span className="text-sm font-medium text-blue-900">
                                                        📢 새로운 전문가 매칭 서비스 오픈! WebRTC 영상통화까지 지원 
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="text-blue-400">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* 기능 카드들 - 핵심 서비스만 표시 */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 max-w-4xl mx-auto">
                                    {/* 1. 은퇴생활비 계산기 */}
                                    <div className="card hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2" 
                                         onClick={() => setCurrentView('calculator')}>
                                        <div className="text-5xl mb-4">🧮</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-3">
                                            은퇴생활비 계산기
                                        </h3>
                                        <p className="text-gray-600 mb-4 leading-relaxed">
                                            내 자산으로 평생 얼마나 쓸 수 있는지<br/>
                                            정확히 계산해보세요
                                        </p>
                                        <div className="text-blue-600 font-semibold text-sm">
                                            💡 무료 계산기
                                        </div>
                                    </div>
                                    
                                    {/* 2. 커뮤니티 */}
                                    <div className="card hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
                                         onClick={handleCommunityAccess}>
                                        <div className="text-5xl mb-4">👥</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-3">
                                            커뮤니티
                                        </h3>
                                        <p className="text-gray-600 mb-4 leading-relaxed">
                                            같은 고민을 가진 분들과<br/>
                                            경험과 정보를 공유하세요
                                        </p>
                                        <div className="text-purple-600 font-semibold text-sm">
                                            👨‍👩‍👧‍👦 회원 전용
                                        </div>
                                    </div>
                                    
                                    {/* 3. 전문가 상담 */}
                                    <div className="card hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-2"
                                         onClick={() => setCurrentView('experts')}>
                                        <div className="text-5xl mb-4">🎯</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-3">
                                            전문가 상담
                                        </h3>
                                        <p className="text-gray-600 mb-4 leading-relaxed">
                                            📞 음성통화 📹 영상통화<br/>
                                            전문가와 실시간 1:1 상담
                                        </p>
                                        <div className="text-orange-600 font-semibold text-sm">
                                            🚀 WebRTC 지원
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        )}
                        
                        {currentView === 'calculator' && <OriginalCalculator savedCalculations={savedCalculations} onCalculationComplete={handleCalculationComplete} setCurrentView={setCurrentView} currentUser={currentUser} showNotification={showNotification} setAuthMode={setAuthMode} setShowSaveResultSignupModal={setShowSaveResultSignupModal} />}
                        
                        
                        {currentView === 'community' && <CommunityApp setCurrentView={setCurrentView} currentUser={currentUser} checkCalculationForInteraction={checkCalculationForInteraction} handlePostClick={handlePostClick} isAdminUser={isAdminUser} />}
                        {currentView === 'post-detail' && selectedPost && <PostDetailPage post={selectedPost} setCurrentView={setCurrentView} currentUser={currentUser} checkCalculationForInteraction={checkCalculationForInteraction} isAdminUser={isAdminUser} />}
                        
                        {/* 전문가 찾기 페이지 - 게스트 접근제한 추가 */}
                        {currentView === 'experts' && (
                            isGuest ? (
                                <div className="min-h-screen bg-gray-50 py-8">
                                    <div className="max-w-md mx-auto">
                                        <div className="bg-white rounded-2xl shadow-lg p-8">
                                            <div className="text-center">
                                                <div className="text-4xl mb-4">🔍</div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-3">
                                                    궁금하시죠? <br/> 은퇴생활비를 먼저 계산해보세요 😊
                                                </h3>
                                                <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                                    <strong>자신의 상황을 알아야 전문가에게 더 나은 상담을 받을 수 있어요!</strong><br/><br/>
                                                    3분만 계산해보시면 전문가들을<br/>
                                                    만나고 상담받을 수 있어요!
                                                </p>
                                                <div className="space-y-3">
                                                    <button
                                                        onClick={() => {
                                                            setCurrentView('calculator');
                                                        }}
                                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                                    >
                                                        🧮 바로 계산하러 가기
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            setAuthMode('signup');
                                                            setCurrentView('login');
                                                            setShowAuthForm(true);
                                                        }}
                                                        className="w-full px-4 py-3 border border-blue-600 text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition-colors text-sm"
                                                    >
                                                        ✨ 회원가입하기
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-6xl mx-auto">
                                    <div className="card">
                                        <ExpertFinderComponent currentUser={currentUser} isAdminUser={isAdminUser} setShowSignupModal={setShowSignupModal} />
                                    </div>
                                </div>
                            )
                        )}

                        {/* 공지사항 페이지 - 모든 사용자 접근 가능 */}
                        {currentView === 'announcements' && (
                            <div className="max-w-6xl mx-auto">
                                <div className="card">
                                    <AnnouncementComponent currentUser={currentUser} isAdminUser={isAdminUser} />
                                </div>
                            </div>
                        )}

                        {/* 실시간 채팅 페이지 - 회원만 접근 가능 */}
                        {currentView === 'chat' && (
                            <div className="max-w-6xl mx-auto">
                                <ChatComponent currentUser={currentUser} isAdminUser={isAdminUser} />
                            </div>
                        )}
                    </main>
                    
                    {/* 커뮤니티 접근 제한 모달 */}
                    {showCommunityAccessModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowCommunityAccessModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">🔒</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        커뮤니티 참여는 회원만 가능해요 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        게시글은 보셨는데 어떠세요?<br/>
                                        <strong>더 자세한 내용이 궁금하시죠?</strong><br/><br/>
                                        회원가입하시면 다른 분들과<br/>
                                        소통하고 정보를 나눌 수 있어요!
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowCommunityAccessModal(false);
                                                setAuthMode('signup');
                                                setCurrentView('login');
                                                setShowAuthForm(true);
                                            }}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                        >
                                            📝 회원가입하고<br/>
                                            상세내용 보기
                                        </button>
                                        <button
                                            onClick={() => setShowCommunityAccessModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            나중에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 계산 필요 안내 모달 */}
                    {showCalculationRequiredModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowCalculationRequiredModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">🧮</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        궁금하시죠? <br/> 은퇴생활비를 먼저 계산해보세요 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        <strong>은퇴 후 생활비로 얼마씩 써야할까요?</strong><br/><br/>
                                        3분만 계산해보시면 더 재미있게<br/>
                                        커뮤니티를 이용하실 수 있어요!
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowCalculationRequiredModal(false);
                                                setCurrentView('calculator');
                                            }}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                        >
                                            🧮 바로 계산하러 가기
                                        </button>
                                        <button
                                            onClick={() => setShowCalculationRequiredModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            나중에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 회원가입 유도 모달 (전문가 상담용) */}
                    {showSignupModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowSignupModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">👤</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        전문가 상담을 이용하시려면<br/>회원가입이 필요해요 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        <strong>1:1 개인 맞춤 전문가 상담</strong><br/><br/>
                                        검증된 금융 전문가와 직접 상담하고<br/>
                                        개인화된 은퇴설계를 받아보세요!
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowSignupModal(false);
                                                setCurrentView('login');
                                                setAuthMode('signup');
                                            }}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                        >
                                            ✨ 지금 회원가입하기
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowSignupModal(false);
                                                setCurrentView('calculator');
                                            }}
                                            className="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm"
                                        >
                                            🧮 고민해보고 계산부터 하기
                                        </button>
                                        <button
                                            onClick={() => setShowSignupModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            다음에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 계산 결과 저장용 회원가입 모달 */}
                    {showSaveResultSignupModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowSaveResultSignupModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">💾</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        계산 결과를 안전하게<br/>저장하시겠어요? 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        <strong>회원가입하면 계산 결과가 안전하게 보관됩니다!</strong><br/><br/>
                                        • 언제든 다시 확인 가능<br/>
                                        • 커뮤니티에서 비슷한 분들과 소통<br/>
                                        • 전문가 상담 예약 가능<br/>
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowSaveResultSignupModal(false);
                                                setCurrentView('login');
                                                setAuthMode('signup');
                                            }}
                                            className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition-colors text-sm"
                                        >
                                            💾 회원가입하고 저장하기
                                        </button>
                                        <button
                                            onClick={() => setShowSaveResultSignupModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            나중에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 통합 알림 모달 */}
                    {showNotificationModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowNotificationModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">
                                        {notificationContent.type === 'success' ? '✅' : 
                                         notificationContent.type === 'error' ? '❌' : 
                                         notificationContent.type === 'warning' ? '⚠️' : 'ℹ️'}
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        {notificationContent.title}
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed whitespace-pre-line">
                                        {notificationContent.message}
                                    </p>
                                    <button
                                        onClick={() => setShowNotificationModal(false)}
                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                    >
                                        확인
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 푸터 */}
                    <footer className="bg-gray-800 text-white mt-16">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <div className="text-center">
                                <h3 className="text-xl font-bold mb-4">플랜비</h3>
                                <p className="text-gray-300 mb-4">
                                    든든한 은퇴를 위한 커뮤니티 플랫폼
                                </p>
                                <div className="text-gray-400 text-sm">
                                    © 2025 플랜비. All rights reserved.
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // AuthManager는 이미 위에서 초기화되었음
        
        // React 앱 렌더링
        console.log('React 및 ReactDOM 로드됨:', { React, ReactDOM });
        console.log('Root element 찾기:', document.getElementById('root'));
        
        // React 앱 바로 렌더링
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<PlanBApp />);
            console.log('React 앱 렌더링 성공');
        } catch (error) {
            console.error('React 앱 렌더링 에러:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h1>플랜비</h1>
                    <p style="color: red;">오류가 발생했습니다.</p>
                    <p style="color: red; font-size: 12px;">${error.message}</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">새로고침</button>
                </div>
            `;
        }
    </script>
</body>
</html>