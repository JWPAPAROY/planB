<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플랜비 - 은퇴설계 커뮤니티</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Meta Tags for SEO -->
    <meta name="description" content="은퇴생활비 계산기와 커뮤니티 플랫폼. 같은 고민을 가진 사람들과 소통하세요.">
    <meta name="keywords" content="은퇴생활비, 재무설계, 커뮤니티, 은퇴계획, 플랜비">
    <meta name="author" content="플랜비">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">
    
    <!-- 플랜비 전용 스타일 -->
    <style>
        /* 기본 폰트 및 배경 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            font-size: 18px;
            line-height: 1.6;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        /* 카드 스타일 (원본 그대로) */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 16px;
        }

        /* 버튼 스타일들 (원본 그대로) */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 인풋 스타일 개선 */
        input[type="text"], 
        input[type="number"], 
        select, 
        textarea {
            transition: all 0.2s;
        }

        input[type="text"]:focus, 
        input[type="number"]:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 체크박스 스타일 개선 */
        input[type="checkbox"] {
            accent-color: #3b82f6;
            transform: scale(1.2);
        }

        /* 호버 효과 */
        .hover-lift {
            transition: transform 0.2s;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
        }

        /* 반응형 조정 */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            
            .card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .btn-primary {
                padding: 14px 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
                border-radius: 12px;
            }
            
            .btn-primary {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // AmountInput 컴포넌트 (외부에서 정의하여 재생성 방지)
        const AmountInput = ({ label, value, onChange, placeholder }) => {
            const formatAmount = (value) => {
                if (!value || value === '' || value === '0') return '💰 0원';
                const num = parseInt(value);
                if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                return `💰 ${num.toLocaleString()}만원`;
            };

            return (
                <div className="mb-6">
                    <label className="block text-xl font-semibold text-gray-800 mb-3">{label}</label>
                    <input
                        type="text"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        value={value}
                        onChange={(e) => {
                            const numValue = e.target.value.replace(/[^0-9]/g, '');
                            onChange(numValue);
                        }}
                        className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                        placeholder={placeholder}
                        autoComplete="off"
                    />
                    <div className="text-green-600 font-semibold text-lg mt-1">
                        {formatAmount(value)}
                    </div>
                </div>
            );
        };

        // Supabase 설정 (플랜비 전용)
        const supabaseUrl = 'https://iopidkmpoxcctixchkmv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvcGlka21wb3hjY3RpeGNoa212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTY0MDIsImV4cCI6MjA3MTIzMjQwMn0.M_bvNzXqPFxmyj4n5xGi3L_eV5yP_8ex-5z8rhjltrQ';
        const supabase = window.supabase?.createClient ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;

        // 익명 세션 관리 시스템
        class AnonymousSessionManager {
            constructor() {
                this.currentSession = null;
                this.tokenKey = 'planb_session_token';
            }

            // 보안 토큰 생성
            generateSecureToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // 계산 결과 해시 생성 (조작 방지)
            async hashCalculationResult(result) {
                const dataString = JSON.stringify({
                    monthlyLivingCost: result.monthlyLivingCost,
                    totalAssets: result.totalAssets,
                    assetSufficiencyYears: result.assetSufficiencyYears,
                    housingType: result.housingType
                });
                
                const encoder = new TextEncoder();
                const data = encoder.encode(dataString);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // 그룹 자동 배정
            assignGroup(calculationResult) {
                const monthlyBudget = calculationResult.monthlyLivingCost;
                const assetYears = calculationResult.assetSufficiencyYears;
                
                // 복합 지표로 은밀하게 분류
                if (monthlyBudget < 200 || assetYears < 15) return 'prudent';
                if (monthlyBudget < 400 || assetYears < 25) return 'balanced';
                return 'premium';
            }

            // 익명 닉네임 생성
            generateNickname(group) {
                const groupNames = {
                    'prudent': '알뜰라이프',
                    'balanced': '밸런스라이프', 
                    'premium': '프리미엄라이프'
                };
                const randomNum = Math.floor(Math.random() * 999) + 1;
                return `${groupNames[group]}${randomNum.toString().padStart(3, '0')}`;
            }

            // 계산 완료시 익명 세션 생성
            async createSession(calculationResult) {
                try {
                    const sessionToken = this.generateSecureToken();
                    const calculationHash = await this.hashCalculationResult(calculationResult);
                    const assignedGroup = this.assignGroup(calculationResult);
                    const nickname = this.generateNickname(assignedGroup);

                    const sessionData = {
                        session_token: sessionToken,
                        calculation_hash: calculationHash,
                        assigned_group: assignedGroup,
                        nickname: nickname,
                        monthly_budget: calculationResult.monthlyLivingCost,
                        asset_years: calculationResult.assetSufficiencyYears,
                        housing_type: calculationResult.housingType,
                        created_at: new Date().toISOString(),
                        expires_at: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString(),
                        last_active: new Date().toISOString(),
                        community_posts_count: 0
                    };

                    if (supabase) {
                        // 서버에 익명 세션 저장
                        const { data, error } = await supabase
                            .from('anonymous_sessions')
                            .insert([sessionData])
                            .select();

                        if (error) throw error;
                        
                        // 로컬에는 토큰만 저장
                        localStorage.setItem(this.tokenKey, sessionToken);
                        this.currentSession = data[0];
                        
                        console.log(`익명 세션 생성: ${nickname} (${assignedGroup} 그룹)`);
                        return this.currentSession;
                    } else {
                        // 오프라인 모드: localStorage에 전체 데이터 저장
                        const fallbackSession = { ...sessionData, id: Date.now() };
                        localStorage.setItem(this.tokenKey, sessionToken);
                        localStorage.setItem(`planb_session_${sessionToken}`, JSON.stringify(fallbackSession));
                        this.currentSession = fallbackSession;
                        return this.currentSession;
                    }
                } catch (error) {
                    console.error('세션 생성 실패:', error);
                    // 로컬 폴백
                    return this.createLocalFallbackSession(calculationResult);
                }
            }

            // 세션 복구
            async restoreSession() {
                try {
                    const token = localStorage.getItem(this.tokenKey);
                    if (!token) return null;

                    if (supabase) {
                        // 서버에서 세션 조회
                        const { data, error } = await supabase
                            .from('anonymous_sessions')
                            .select('*')
                            .eq('session_token', token)
                            .single();

                        if (error) {
                            if (error.code === 'PGRST116') { // 세션 없음
                                localStorage.removeItem(this.tokenKey);
                                return null;
                            }
                            throw error;
                        }

                        // 만료 확인
                        if (new Date(data.expires_at) < new Date()) {
                            await this.deleteSession(token);
                            return null;
                        }

                        // 마지막 활동 시간 업데이트
                        await supabase
                            .from('anonymous_sessions')
                            .update({ last_active: new Date().toISOString() })
                            .eq('session_token', token);

                        this.currentSession = data;
                        console.log(`세션 복구: ${data.nickname} (${data.assigned_group} 그룹)`);
                        return this.currentSession;
                    } else {
                        // 오프라인 모드: localStorage에서 복구
                        const sessionData = localStorage.getItem(`planb_session_${token}`);
                        if (sessionData) {
                            this.currentSession = JSON.parse(sessionData);
                            return this.currentSession;
                        }
                        return null;
                    }
                } catch (error) {
                    console.error('세션 복구 실패:', error);
                    return this.getLocalFallbackSession();
                }
            }

            // 세션 연장
            async extendSession() {
                if (!this.currentSession) return;

                try {
                    const newExpiryDate = new Date(Date.now() + (30 * 24 * 60 * 60 * 1000));
                    
                    if (supabase) {
                        await supabase
                            .from('anonymous_sessions')
                            .update({ 
                                expires_at: newExpiryDate.toISOString(),
                                last_active: new Date().toISOString()
                            })
                            .eq('session_token', this.currentSession.session_token);
                    }
                    
                    this.currentSession.expires_at = newExpiryDate.toISOString();
                    console.log('세션 30일 연장됨');
                } catch (error) {
                    console.error('세션 연장 실패:', error);
                }
            }

            // 커뮤니티 활동 기록
            async recordCommunityActivity(activityType = 'general') {
                if (!this.currentSession) return;

                try {
                    if (supabase) {
                        const updates = { 
                            last_active: new Date().toISOString()
                        };

                        if (activityType === 'post') {
                            updates.community_posts_count = (this.currentSession.community_posts_count || 0) + 1;
                        }

                        await supabase
                            .from('anonymous_sessions')
                            .update(updates)
                            .eq('session_token', this.currentSession.session_token);

                        this.currentSession = { ...this.currentSession, ...updates };
                    }
                } catch (error) {
                    console.error('활동 기록 실패:', error);
                }
            }

            // 세션 삭제
            async deleteSession(token = null) {
                const targetToken = token || this.currentSession?.session_token;
                if (!targetToken) return;

                try {
                    if (supabase) {
                        await supabase
                            .from('anonymous_sessions')
                            .delete()
                            .eq('session_token', targetToken);
                    }
                    
                    localStorage.removeItem(this.tokenKey);
                    localStorage.removeItem(`planb_session_${targetToken}`);
                    this.currentSession = null;
                } catch (error) {
                    console.error('세션 삭제 실패:', error);
                }
            }

            // 커뮤니티 접근 권한 확인
            checkCommunityAccess() {
                if (!this.currentSession) {
                    return {
                        hasAccess: false,
                        message: "은퇴생활비 계산을 완료하시면 커뮤니티를 이용하실 수 있습니다",
                        action: "redirect_to_calculator"
                    };
                }

                // 세션 만료 확인
                if (new Date(this.currentSession.expires_at) < new Date()) {
                    return {
                        hasAccess: false,
                        message: "커뮤니티 이용권이 만료되었습니다. 간단히 재계산해주세요",
                        action: "redirect_to_calculator"
                    };
                }

                return {
                    hasAccess: true,
                    userGroup: this.currentSession.assigned_group,
                    nickname: this.currentSession.nickname,
                    session: this.currentSession
                };
            }

            // QR 코드용 링크 생성 (다중 기기 연동)
            generateDeviceLink() {
                if (!this.currentSession) return null;
                
                const baseUrl = window.location.origin;
                return `${baseUrl}/?link_token=${this.currentSession.session_token}`;
            }

            // 로컬 폴백 세션 생성
            createLocalFallbackSession(calculationResult) {
                const assignedGroup = this.assignGroup(calculationResult);
                const nickname = this.generateNickname(assignedGroup);
                const token = this.generateSecureToken();

                const fallbackSession = {
                    session_token: token,
                    assigned_group: assignedGroup,
                    nickname: nickname,
                    monthly_budget: calculationResult.monthlyLivingCost,
                    asset_years: calculationResult.assetSufficiencyYears,
                    created_at: new Date().toISOString(),
                    expires_at: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString(),
                    is_local_fallback: true
                };

                localStorage.setItem(this.tokenKey, token);
                localStorage.setItem(`planb_session_${token}`, JSON.stringify(fallbackSession));
                this.currentSession = fallbackSession;
                
                console.log(`로컬 폴백 세션 생성: ${nickname} (${assignedGroup} 그룹)`);
                return this.currentSession;
            }
        }

        // sessionManager 인스턴스 생성
        const sessionManager = new AnonymousSessionManager();

        // Supabase는 이미 위에서 초기화되었음

        // 랜덤 닉네임 생성기 
        class NicknameGenerator {
            constructor() {
                this.adjectives = [
                    '행복한', '여유로운', '지혜로운', '활기찬', '당당한', '멋진', 
                    '우아한', '든든한', '빛나는', '평온한', '건강한', '따뜻한',
                    '자유로운', '늠름한', '친근한', '성실한', '단아한', '차분한'
                ];
                
                this.nouns = [
                    '나무', '바다', '산', '꽃', '새', '구름', '별', '달', 
                    '여행자', '정원사', '독서가', '요리사', '화가', '음악가',
                    '산책자', '사색가', '탐험가', '수집가', '관찰자', '이야기꾼'
                ];
            }
            
            generate() {
                const adj = this.adjectives[Math.floor(Math.random() * this.adjectives.length)];
                const noun = this.nouns[Math.floor(Math.random() * this.nouns.length)];
                const number = Math.floor(Math.random() * 9000) + 1000; // 1000-9999
                return `${adj}${noun}${number}`;
            }
        }

        // 회원 인증 매니저
        class AuthManager {
            constructor() {
                this.nicknameGen = new NicknameGenerator();
                this.currentUser = null;
            }
            
            // 회원가입
            async signUp(email, password, nickname = null) {
                try {
                    const finalNickname = nickname || this.nicknameGen.generate();
                    
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                nickname: finalNickname
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    // 사용자 프로필 생성
                    if (data.user) {
                        const { error: profileError } = await supabase
                            .from('user_profiles')
                            .insert({
                                id: data.user.id,
                                email: email,
                                nickname: finalNickname,
                                privacy_consent: true,
                                privacy_consent_date: new Date().toISOString(),
                                created_at: new Date().toISOString()
                            });
                        
                        if (profileError) throw profileError;
                    }
                    
                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 로그인
            async signIn(email, password) {
                try {
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    this.currentUser = data.user;
                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 이메일 중복 체크 (단순 중복 확인)
            async checkEmail(email) {
                try {
                    // 기존 user_profiles 테이블에서 이메일 확인
                    const { data: existingUser, error } = await supabase
                        .from('user_profiles')
                        .select('id, email')
                        .eq('email', email)
                        .single();
                    
                    if (existingUser) {
                        // 이미 존재하는 이메일
                        return { 
                            success: false, 
                            error: '이미 등록된 이메일입니다. 다른 이메일을 사용해주세요.'
                        };
                    }
                    
                    return { success: true };
                } catch (error) {
                    // 사용자가 없는 경우 (정상적인 상황)
                    return { success: true };
                }
            }

            // 로그아웃
            async signOut() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    
                    this.currentUser = null;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            // 현재 사용자 정보 가져오기
            async getCurrentUser() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    this.currentUser = user;
                    return user;
                } catch (error) {
                    console.error('Error getting current user:', error);
                    return null;
                }
            }
            
            // 닉네임 업데이트
            async updateNickname(newNickname) {
                try {
                    if (!this.currentUser) throw new Error('로그인이 필요합니다');
                    
                    const { error } = await supabase
                        .from('user_profiles')
                        .update({ nickname: newNickname })
                        .eq('id', this.currentUser.id);
                    
                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        // 전역 인증 매니저 인스턴스
        const authManager = new AuthManager();

        // 개인정보동의 체크박스 컴포넌트
        const PrivacyConsentCheckbox = ({ checked, onChange }) => {
            return (
                <label className="flex items-start space-x-3 cursor-pointer">
                    <input
                        type="checkbox"
                        checked={checked}
                        onChange={(e) => onChange(e.target.checked)}
                        className="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                    />
                    <div className="flex-1">
                        <span className="text-sm text-gray-800 font-medium">
                            개인정보 수집·이용에 동의합니다 
                            <span className="text-red-500 ml-1">(필수)</span>
                        </span>
                        <p className="text-xs text-gray-500 mt-1">
                            위 개인정보 수집·이용에 대한 내용을 읽고 동의합니다
                        </p>
                    </div>
                </label>
            );
        };

        // 전문가용 개인정보수집이용동의서 컴포넌트
        const ExpertPrivacyConsentComponent = ({ checked, onChange }) => {
            const [showFullText, setShowFullText] = useState(false);

            return (
                <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div className="mb-4">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">개인정보 수집·이용 동의서</h3>
                        <div className="text-sm text-gray-700 space-y-2">
                            <div className="bg-white p-3 rounded border">
                                <p><strong>• 수집항목:</strong> 성명, 이메일, 연락처, 전문분야, 자격증·경력정보, 사업자등록증</p>
                                <p><strong>• 수집목적:</strong> 전문가 신원확인, 자격검증, 상담서비스 제공, 수수료 정산</p>
                                <p><strong>• 보유기간:</strong> 서비스 탈퇴 후 3년 (전자상거래법)</p>
                                <p><strong>• 제3자 제공:</strong> 상담 매칭을 위한 최소정보만 고객에게 제공</p>
                                <p className="text-red-600"><strong>• 동의거부권:</strong> 동의를 거부할 수 있으나, 서비스 이용이 제한됩니다</p>
                            </div>
                            
                            <button
                                type="button"
                                onClick={() => setShowFullText(!showFullText)}
                                className="text-blue-600 hover:text-blue-800 text-sm underline"
                            >
                                {showFullText ? '간략히 보기' : '전문 보기'}
                            </button>
                            
                            {showFullText && (
                                <div className="bg-white border border-gray-200 rounded p-4 text-xs text-gray-600 max-h-60 overflow-y-auto">
                                    <h4 className="font-semibold mb-2">개인정보 수집·이용 동의서 (전문)</h4>
                                    
                                    <div className="space-y-3">
                                        <div>
                                            <h5 className="font-medium">1. 개인정보의 수집 및 이용목적</h5>
                                            <p>- 전문가 신원 확인 및 자격 검증</p>
                                            <p>- 상담 서비스 제공 및 매칭</p>
                                            <p>- 수수료 정산 및 세금계산서 발행</p>
                                            <p>- 서비스 품질 향상을 위한 통계 분석</p>
                                            <p>- 법령상 의무이행 (전자상거래법, 소득세법 등)</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">2. 수집하는 개인정보의 항목</h5>
                                            <p><strong>필수항목:</strong> 성명, 이메일, 연락처(휴대폰), 전문분야, 경력년수, 자격증 정보</p>
                                            <p><strong>선택항목:</strong> 프로필 사진, 상세 이력, 사업자등록번호</p>
                                            <p><strong>자동수집:</strong> IP주소, 쿠키, 접속 로그, 서비스 이용기록</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">3. 개인정보의 보유 및 이용기간</h5>
                                            <p>- 서비스 이용기간 중</p>
                                            <p>- 서비스 탈퇴 후 3년 (전자상거래 등에서의 소비자보호에 관한 법률)</p>
                                            <p>- 세법에 따른 장부보관의무: 5년</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">4. 개인정보의 제3자 제공</h5>
                                            <p>- 상담 신청 고객에게 전문가 프로필 정보 제공 (성명, 전문분야, 경력, 후기)</p>
                                            <p>- 세무 신고를 위한 국세청 제공 (법정의무사항)</p>
                                            <p>- 기타 법령에 의한 제공</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">5. 개인정보처리의 위탁</h5>
                                            <p>- 결제대행사: 수수료 정산 (PG사)</p>
                                            <p>- 클라우드 서비스: 데이터 저장 (Supabase)</p>
                                            <p>- 알림톡 발송: 예약 확인 알림 (문자서비스)</p>
                                        </div>
                                        
                                        <div>
                                            <h5 className="font-medium">6. 정보주체의 권리·의무</h5>
                                            <p>- 개인정보 열람·정정·삭제·처리정지 요구권</p>
                                            <p>- 손해배상청구권</p>
                                            <p>- 개인정보보호위원회 신고권 (privacy.go.kr, 국번없이 182)</p>
                                        </div>
                                        
                                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2">
                                            <p className="text-red-700 font-medium">※ 위 사항에 대한 동의를 거부할 수 있으나, 동의 거부 시 전문가 등록 및 서비스 이용이 제한됩니다.</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <label className="flex items-start space-x-3 cursor-pointer">
                        <input
                            type="checkbox"
                            checked={checked}
                            onChange={(e) => onChange(e.target.checked)}
                            className="mt-1 h-5 w-5 text-orange-600 border-2 border-gray-300 rounded focus:ring-orange-500 focus:ring-2"
                        />
                        <div className="flex-1">
                            <span className="text-sm text-gray-800 font-medium">
                                위 개인정보 수집·이용에 동의합니다 
                                <span className="text-red-500 ml-1">(필수)</span>
                            </span>
                            <p className="text-xs text-gray-500 mt-1">
                                전문가 등록을 위해 위 개인정보 수집·이용 동의서의 내용을 읽고 동의합니다
                            </p>
                        </div>
                    </label>
                </div>
            );
        };

        // 휴대폰 번호 자동 포맷팅 함수
        const formatPhoneNumber = (value) => {
            // 숫자만 추출
            const numbers = value.replace(/[^\d]/g, '');
            
            // 11자리 초과시 자르기
            if (numbers.length > 11) {
                return numbers.slice(0, 11);
            }
            
            // 포맷팅
            if (numbers.length <= 3) {
                return numbers;
            } else if (numbers.length <= 7) {
                return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
            } else {
                return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7)}`;
            }
        };

        // 비밀번호 유효성 검사 함수
        const validatePassword = (password) => {
            const checks = {
                length: password.length >= 8,
                hasLetter: /[A-Za-z]/.test(password),
                hasNumber: /[0-9]/.test(password),
                hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };
            
            const typeCount = [checks.hasLetter, checks.hasNumber, checks.hasSpecial].filter(Boolean).length;
            
            return {
                isValid: checks.length && typeCount >= 2,
                checks: checks,
                typeCount: typeCount
            };
        };

        // 전문가 프로필 폼 컴포넌트
        const ExpertProfileForm = ({ 
            expertProfile, updateExpertProfile, expertCategories,
            specialtyInput, setSpecialtyInput, credentialInput, setCredentialInput,
            addSpecialty, addCredential, removeSpecialty, removeCredential 
        }) => {
            return (
                <div className="space-y-6">
                    {/* 전문가 카테고리 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-3">전문 분야 *</label>
                        <div className="grid grid-cols-1 gap-3">
                            {Object.entries(expertCategories).map(([key, category]) => (
                                <label key={key} className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input
                                        type="radio"
                                        name="expertType"
                                        value={key}
                                        checked={expertProfile.expertType === key}
                                        onChange={(e) => updateExpertProfile('expertType', e.target.value)}
                                        className="h-4 w-4 text-orange-600"
                                    />
                                    <div className="ml-3">
                                        <div className="text-lg">{category.icon} {category.name}</div>
                                        <div className="text-sm text-gray-500">{category.description}</div>
                                    </div>
                                </label>
                            ))}
                        </div>
                    </div>

                    {/* 직책/타이틀 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">직책/타이틀 *</label>
                        <input
                            type="text"
                            required
                            value={expertProfile.title}
                            onChange={(e) => updateExpertProfile('title', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="예: 시니어 여행 전문 플래너"
                        />
                    </div>

                    {/* 경력 년수 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">경력 (년) *</label>
                        <input
                            type="number"
                            required
                            min="1"
                            max="50"
                            value={expertProfile.experienceYears}
                            onChange={(e) => updateExpertProfile('experienceYears', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="경력 년수"
                        />
                    </div>

                    {/* 소개 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">자기소개</label>
                        <textarea
                            rows="3"
                            value={expertProfile.bio}
                            onChange={(e) => updateExpertProfile('bio', e.target.value)}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="간단한 자기소개를 작성해주세요"
                        />
                    </div>

                    {/* 전문분야 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">전문분야 *</label>
                        <div className="flex gap-2 mt-1">
                            <input
                                type="text"
                                value={specialtyInput}
                                onChange={(e) => setSpecialtyInput(e.target.value)}
                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                placeholder="전문분야 입력 후 추가 버튼"
                                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addSpecialty())}
                            />
                            <button
                                type="button"
                                onClick={addSpecialty}
                                className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                            >
                                추가
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {expertProfile.specialties.map((specialty, index) => (
                                <span key={index} className="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
                                    {specialty}
                                    <button
                                        type="button"
                                        onClick={() => removeSpecialty(index)}
                                        className="ml-2 text-orange-600 hover:text-orange-800"
                                    >
                                        ×
                                    </button>
                                </span>
                            ))}
                        </div>
                    </div>

                    {/* 자격증/경력 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">자격증/경력증명 *</label>
                        <div className="flex gap-2 mt-1">
                            <input
                                type="text"
                                value={credentialInput}
                                onChange={(e) => setCredentialInput(e.target.value)}
                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                placeholder="자격증/경력 입력 후 추가 버튼"
                                onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addCredential())}
                            />
                            <button
                                type="button"
                                onClick={addCredential}
                                className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                            >
                                추가
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-2">
                            {expertProfile.credentials.map((credential, index) => (
                                <span key={index} className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                    {credential}
                                    <button
                                        type="button"
                                        onClick={() => removeCredential(index)}
                                        className="ml-2 text-blue-600 hover:text-blue-800"
                                    >
                                        ×
                                    </button>
                                </span>
                            ))}
                        </div>
                    </div>


                    {/* 상담 방식 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-3">제공 가능한 상담 방식 *</label>
                        <div className="space-y-2">
                            {[
                                { value: 'phone', label: '📞 전화 상담', desc: '음성 통화로 상담' },
                                { value: 'video', label: '📹 화상 상담', desc: 'Zoom, Meet 등 화상 통화' },
                                { value: 'chat', label: '💬 채팅 상담', desc: '텍스트 기반 상담' }
                            ].map(({ value, label, desc }) => (
                                <label key={value} className="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50">
                                    <input
                                        type="checkbox"
                                        checked={expertProfile.availableTypes.includes(value)}
                                        onChange={(e) => {
                                            const types = e.target.checked
                                                ? [...expertProfile.availableTypes, value]
                                                : expertProfile.availableTypes.filter(t => t !== value);
                                            updateExpertProfile('availableTypes', types);
                                        }}
                                        className="h-4 w-4 text-orange-600"
                                    />
                                    <div className="ml-3">
                                        <div className="font-medium">{label}</div>
                                        <div className="text-sm text-gray-500">{desc}</div>
                                    </div>
                                </label>
                            ))}
                        </div>
                    </div>

                    {/* 연락처 */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">휴대폰 번호 *</label>
                        <input
                            type="tel"
                            required
                            value={expertProfile.phone}
                            onChange={(e) => {
                                const formatted = formatPhoneNumber(e.target.value);
                                updateExpertProfile('phone', formatted);
                            }}
                            className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                            placeholder="010-1234-5678"
                        />
                        <p className="text-xs text-gray-500 mt-1">상담 예약 확인 및 본인 인증용</p>
                    </div>


                    {/* 자격 검증 섹션 */}
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            🔒 자격 검증 (필수 - 둘 중 하나 이상)
                        </h4>
                        
                        <div className="space-y-4">
                            {/* 사업자등록증 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">사업자등록번호</label>
                                <input
                                    type="text"
                                    value={expertProfile.businessLicense}
                                    onChange={(e) => {
                                        const value = e.target.value.replace(/[^0-9]/g, '');
                                        const formatted = value.length >= 10 ? 
                                            `${value.slice(0,3)}-${value.slice(3,5)}-${value.slice(5,10)}` : 
                                            value;
                                        updateExpertProfile('businessLicense', formatted);
                                    }}
                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                    placeholder="1234567890 또는 123-45-67890"
                                    maxLength="12"
                                />
                                <p className="text-xs text-gray-500 mt-1">개인사업자 또는 법인사업자 등록번호</p>
                            </div>

                            {/* 자격증번호 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">국가자격증 번호</label>
                                <input
                                    type="text"
                                    value={expertProfile.qualificationNumber}
                                    onChange={(e) => updateExpertProfile('qualificationNumber', e.target.value)}
                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500"
                                    placeholder="예: 관광통역안내사 제12345호"
                                />
                                <p className="text-xs text-gray-500 mt-1">국가자격증, 민간자격증 또는 전문 라이선스 번호</p>
                            </div>

                            <div className="bg-white border border-orange-200 rounded p-3">
                                <p className="text-sm text-orange-800">
                                    <strong>⚠️ 검증 안내:</strong> 
                                </p>
                                <ul className="text-xs text-orange-700 mt-1 space-y-1">
                                    <li>• 사업자등록번호는 국세청 사업자등록상태 조회로 검증</li>
                                    <li>• 자격증은 발급기관 확인 또는 자격증 사본 요청</li>
                                    <li>• 허위 정보 제출시 등록 거부 및 서비스 이용 제한</li>
                                    <li>• 검토 기간: 영업일 기준 3-5일</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // 마이페이지 컴포넌트
        const MyPageComponent = ({ currentUser, onClose, getUserType, getUserTypeName }) => {
            const [userType, setUserType] = useState('member');
            const [userTypeName, setUserTypeName] = useState('일반회원');
            const [activeTab, setActiveTab] = useState('profile');
            
            // 사용자 타입 확인 (async)
            useEffect(() => {
                const checkUserType = async () => {
                    const type = await getUserType(currentUser);
                    const typeName = getUserTypeName(type);
                    setUserType(type);
                    setUserTypeName(typeName);
                };
                
                if (currentUser) {
                    checkUserType();
                }
            }, [currentUser]);

            const tabs = [
                { id: 'profile', name: '내 정보', icon: '👤' },
                { id: 'activity', name: '활동 내역', icon: '📊' },
                ...(userType === 'expert' ? [{ id: 'expert', name: '전문가 관리', icon: '🎯' }] : []),
                ...(userType === 'admin' ? [{ id: 'admin', name: '관리자', icon: '👑' }] : [])
            ];

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* 헤더 */}
                    <div className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-4xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                                        <span className="text-white font-bold text-lg">
                                            {userType === 'admin' ? '👑' : userType === 'expert' ? '🎯' : '👤'}
                                        </span>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-800">마이페이지</h1>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-gray-600">{currentUser?.nickname || currentUser?.email}</span>
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                userType === 'admin' ? 'bg-red-100 text-red-800' :
                                                userType === 'expert' ? 'bg-orange-100 text-orange-800' :
                                                'bg-blue-100 text-blue-800'
                                            }`}>
                                                {userTypeName}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 탭 메뉴 */}
                    <div className="bg-white border-b border-gray-200">
                        <div className="max-w-4xl mx-auto px-4">
                            <div className="flex space-x-8">
                                {tabs.map((tab) => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-4 px-2 border-b-2 font-medium text-sm transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        {tab.icon} {tab.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* 탭 컨텐츠 */}
                    <div className="max-w-4xl mx-auto px-4 py-8">
                        {activeTab === 'profile' && (
                            <ProfileTab currentUser={currentUser} userType={userType} userTypeName={userTypeName} />
                        )}
                        {activeTab === 'activity' && (
                            <ActivityTab currentUser={currentUser} userType={userType} />
                        )}
                        {activeTab === 'expert' && userType === 'expert' && (
                            <ExpertTab currentUser={currentUser} />
                        )}
                        {activeTab === 'admin' && userType === 'admin' && (
                            <AdminTab currentUser={currentUser} />
                        )}
                    </div>
                </div>
            );
        };

        // 내 정보 탭
        const ProfileTab = ({ currentUser, userType, userTypeName }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">기본 정보</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">{currentUser?.email}</div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">닉네임</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">{currentUser?.nickname || '설정되지 않음'}</div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">회원 유형</label>
                            <div className="p-3 bg-gray-50 rounded-lg">
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                    userType === 'admin' ? 'bg-red-100 text-red-800' :
                                    userType === 'expert' ? 'bg-orange-100 text-orange-800' :
                                    'bg-blue-100 text-blue-800'
                                }`}>
                                    {userTypeName}
                                </span>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">가입일</label>
                            <div className="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {currentUser?.created_at ? new Date(currentUser.created_at).toLocaleDateString() : '정보 없음'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        // 활동 내역 탭
        const ActivityTab = ({ currentUser, userType }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">활동 통계</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                            <div className="text-2xl font-bold text-blue-600">5</div>
                            <div className="text-sm text-gray-600">작성한 게시글</div>
                        </div>
                        <div className="text-center p-4 bg-green-50 rounded-lg">
                            <div className="text-2xl font-bold text-green-600">12</div>
                            <div className="text-sm text-gray-600">작성한 댓글</div>
                        </div>
                        <div className="text-center p-4 bg-purple-50 rounded-lg">
                            <div className="text-2xl font-bold text-purple-600">3</div>
                            <div className="text-sm text-gray-600">계산 결과</div>
                        </div>
                    </div>
                </div>
                
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">최근 활동</h2>
                    <div className="space-y-3">
                        <div className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <div className="flex-1">
                                <div className="text-sm font-medium">게시글 작성</div>
                                <div className="text-xs text-gray-500">2025년 8월 22일</div>
                            </div>
                        </div>
                        <div className="text-center text-gray-500 py-4">
                            더 많은 활동 기록은 준비 중입니다
                        </div>
                    </div>
                </div>
            </div>
        );

        // 전문가 관리 탭
        const ExpertTab = ({ currentUser }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">전문가 대시보드</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="text-center p-4 bg-orange-50 rounded-lg">
                            <div className="text-2xl font-bold text-orange-600">8</div>
                            <div className="text-sm text-gray-600">총 상담 건수</div>
                        </div>
                        <div className="text-center p-4 bg-green-50 rounded-lg">
                            <div className="text-2xl font-bold text-green-600">4.8</div>
                            <div className="text-sm text-gray-600">평균 평점</div>
                        </div>
                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                            <div className="text-2xl font-bold text-blue-600">95%</div>
                            <div className="text-sm text-gray-600">응답률</div>
                        </div>
                    </div>
                </div>
                
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">예약 관리</h2>
                    <div className="text-center text-gray-500 py-8">
                        예약 관리 기능은 준비 중입니다
                    </div>
                </div>
            </div>
        );

        // 관리자 탭
        const AdminTab = ({ currentUser }) => (
            <div className="space-y-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">관리자 대시보드</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div className="text-center p-4 bg-red-50 rounded-lg">
                            <div className="text-2xl font-bold text-red-600">156</div>
                            <div className="text-sm text-gray-600">전체 회원수</div>
                        </div>
                        <div className="text-center p-4 bg-orange-50 rounded-lg">
                            <div className="text-2xl font-bold text-orange-600">12</div>
                            <div className="text-sm text-gray-600">등록된 전문가</div>
                        </div>
                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                            <div className="text-2xl font-bold text-blue-600">234</div>
                            <div className="text-sm text-gray-600">총 게시글</div>
                        </div>
                        <div className="text-center p-4 bg-green-50 rounded-lg">
                            <div className="text-2xl font-bold text-green-600">89</div>
                            <div className="text-sm text-gray-600">계산 완료</div>
                        </div>
                    </div>
                </div>
                
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">관리 메뉴</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
                            <div className="font-medium">👥 회원 관리</div>
                            <div className="text-sm text-gray-500">회원 목록 및 권한 관리</div>
                        </button>
                        <button className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
                            <div className="font-medium">🎯 전문가 승인</div>
                            <div className="text-sm text-gray-500">전문가 등록 검토 및 승인</div>
                        </button>
                        <button className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
                            <div className="font-medium">📝 게시글 관리</div>
                            <div className="text-sm text-gray-500">커뮤니티 게시글 모니터링</div>
                        </button>
                        <button className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-left">
                            <div className="font-medium">📊 통계 보기</div>
                            <div className="text-sm text-gray-500">플랫폼 이용 현황</div>
                        </button>
                    </div>
                </div>
            </div>
        );

        // 회원가입/로그인 컴포넌트
        const AuthComponent = ({ onAuthSuccess, initialMode = 'login', generateGuestUser }) => {
            const [isLogin, setIsLogin] = useState(initialMode === 'login');
            const [authMode, setAuthMode] = useState(initialMode); // 'login', 'signup', 'expert'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [generatedNickname, setGeneratedNickname] = useState('');
            const [customNickname, setCustomNickname] = useState('');
            const [useCustomNickname, setUseCustomNickname] = useState(false);
            const [privacyConsent, setPrivacyConsent] = useState(false);
            
            // 전문가 등록 관련 상태
            const [expertProfile, setExpertProfile] = useState({
                name: '',
                title: '',
                expertType: 'travel',
                experienceYears: '',
                bio: '',
                specialties: [],
                credentials: [],
                hourlyRate: '',
                consultationDuration: 60,
                phone: '',
                businessLicense: '',
                qualificationNumber: '',
                availableTypes: ['phone']
            });
            const [specialtyInput, setSpecialtyInput] = useState('');
            const [credentialInput, setCredentialInput] = useState('');
            const [currentStep, setCurrentStep] = useState(1); // 전문가 등록 단계

            useEffect(() => {
                if (!isLogin) {
                    // 회원가입 모드일 때 닉네임 미리보기 생성
                    const nickname = authManager.nicknameGen.generate();
                    setGeneratedNickname(nickname);
                }
            }, [isLogin]);

            // 전문가 카테고리 정의
            const expertCategories = {
                'travel': { name: '여행/취미', icon: '✈️', description: '시니어 여행 및 취미 활동 전문가' },
                'legal': { name: '세무/법무/자산관리', icon: '📋', description: '세무, 법무, 자산관리 전문가 (상담만)' },
                'living': { name: '주거/생활', icon: '🏠', description: '주거 및 생활환경 설계 전문가' }
            };

            // 전문가 프로필 업데이트 함수
            const updateExpertProfile = (field, value) => {
                setExpertProfile(prev => ({ ...prev, [field]: value }));
            };

            // 전문분야 추가
            const addSpecialty = () => {
                if (specialtyInput.trim() && !expertProfile.specialties.includes(specialtyInput.trim())) {
                    updateExpertProfile('specialties', [...expertProfile.specialties, specialtyInput.trim()]);
                    setSpecialtyInput('');
                }
            };

            // 자격증 추가
            const addCredential = () => {
                if (credentialInput.trim() && !expertProfile.credentials.includes(credentialInput.trim())) {
                    updateExpertProfile('credentials', [...expertProfile.credentials, credentialInput.trim()]);
                    setCredentialInput('');
                }
            };

            // 전문분야 제거
            const removeSpecialty = (index) => {
                const newSpecialties = expertProfile.specialties.filter((_, i) => i !== index);
                updateExpertProfile('specialties', newSpecialties);
            };

            // 자격증 제거
            const removeCredential = (index) => {
                const newCredentials = expertProfile.credentials.filter((_, i) => i !== index);
                updateExpertProfile('credentials', newCredentials);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                try {
                    if (authMode === 'login') {
                        // 로그인
                        const result = await authManager.signIn(email, password);
                        if (result.success) {
                            onAuthSuccess(result.user);
                        } else {
                            setError(result.error);
                        }
                    } else if (authMode === 'signup') {
                        // 일반 회원가입
                        if (password !== confirmPassword) {
                            setError('비밀번호가 일치하지 않습니다');
                            return;
                        }
                        // 비밀번호 보안 검증 (표준 준수)
                        const passwordValidation = validatePassword(password);
                        if (!passwordValidation.isValid) {
                            setError('비밀번호는 8자 이상이며, 영문/숫자/특수문자 중 2종류 이상 조합이어야 합니다');
                            return;
                        }
                        
                        // 닉네임 검증
                        const finalNickname = useCustomNickname ? customNickname.trim() : generatedNickname;
                        if (!finalNickname) {
                            setError('닉네임을 입력해주세요');
                            return;
                        }
                        if (useCustomNickname) {
                            if (finalNickname.length < 2 || finalNickname.length > 20) {
                                setError('닉네임은 2-20자로 입력해주세요');
                                return;
                            }
                            if (!/^[가-힣a-zA-Z0-9]+$/.test(finalNickname)) {
                                setError('닉네임은 한글, 영문, 숫자만 사용 가능합니다');
                                return;
                            }
                        }
                        if (!privacyConsent) {
                            setError('개인정보 수집·이용에 동의해주세요');
                            return;
                        }

                        const result = await authManager.signUp(email, password, finalNickname);
                        if (result.success) {
                            setError('');
                            showNotification('회원가입 완료!', `🎉 환영합니다, ${finalNickname}님!\n✨ 바로 서비스를 이용하실 수 있습니다.\n📊 은퇴생활비 계산과 커뮤니티 참여가 가능합니다.`, 'success');
                            setAuthMode('login');
                            setIsLogin(true);
                        } else {
                            setError(result.error);
                        }
                    } else if (authMode === 'expert') {
                        // 전문가 등록
                        await handleExpertRegistration();
                    }
                } catch (err) {
                    setError('처리 중 오류가 발생했습니다');
                }
            };

            const handleExpertRegistration = async () => {
                if (currentStep === 1) {
                    // 1단계: 기본 정보 검증만 수행 (회원가입은 하지 않음)
                    if (password !== confirmPassword) {
                        setError('비밀번호가 일치하지 않습니다');
                        return;
                    }
                    const passwordValidation = validatePassword(password);
                    if (!passwordValidation.isValid) {
                        setError('비밀번호는 8자 이상이며, 영문/숫자/특수문자 중 2종류 이상 조합이어야 합니다');
                        return;
                    }
                    if (!privacyConsent) {
                        setError('개인정보 수집·이용에 동의해주세요');
                        return;
                    }
                    if (!expertProfile.phone) {
                        setError('휴대폰 번호를 입력해주세요');
                        return;
                    }
                    if (!/^010-\d{4}-\d{4}$/.test(expertProfile.phone)) {
                        setError('휴대폰 번호는 010-1234-5678 형식으로 입력해주세요');
                        return;
                    }

                    // 이메일 중복 체크
                    const emailCheck = await authManager.checkEmail(email);
                    if (!emailCheck.success) {
                        setError(emailCheck.error);
                        return;
                    }

                    // 1단계 통과 - 2단계로 이동 (아직 회원가입은 하지 않음)
                    setCurrentStep(2);
                    setError('');
                    
                } else if (currentStep === 2) {
                    // 2단계: 전문가 프로필 완전 검증 및 등록
                    if (!expertProfile.name || !expertProfile.title || !expertProfile.experienceYears) {
                        setError('모든 필수 항목을 입력해주세요');
                        return;
                    }
                    if (expertProfile.specialties.length === 0) {
                        setError('전문분야를 최소 1개 이상 입력해주세요');
                        return;
                    }
                    if (expertProfile.credentials.length === 0) {
                        setError('자격증/경력을 최소 1개 이상 입력해주세요');
                        return;
                    }
                    
                    
                    // 상담 방식 검증
                    if (expertProfile.availableTypes.length === 0) {
                        setError('제공 가능한 상담 방식을 최소 1개 이상 선택해주세요');
                        return;
                    }

                    // 엄격한 검증 추가
                    if (!expertProfile.businessLicense && !expertProfile.qualificationNumber) {
                        setError('사업자등록증 또는 자격증번호 중 하나는 필수로 입력해야 합니다');
                        return;
                    }
                    
                    if (parseInt(expertProfile.experienceYears) < 1) {
                        setError('최소 1년 이상의 경력이 필요합니다');
                        return;
                    }


                    // 사업자등록번호 형식 검증
                    if (expertProfile.businessLicense) {
                        const businessNumber = expertProfile.businessLicense.replace(/[^0-9]/g, '');
                        if (businessNumber.length !== 10) {
                            setError('사업자등록번호는 10자리 숫자로 입력해주세요');
                            return;
                        }
                        // 검증용으로 정규화된 형식으로 저장
                        const formatted = `${businessNumber.slice(0,3)}-${businessNumber.slice(3,5)}-${businessNumber.slice(5,10)}`;
                        updateExpertProfile('businessLicense', formatted);
                    }

                    // 휴대폰 번호 형식 검증
                    if (!/^010-\d{4}-\d{4}$/.test(expertProfile.phone)) {
                        setError('휴대폰 번호는 010-1234-5678 형식으로 입력해주세요');
                        return;
                    }

                    try {
                        // 이제 실제 회원가입 수행
                        const signUpResult = await authManager.signUp(email, password, expertProfile.name);
                        if (!signUpResult.success) {
                            setError(signUpResult.error);
                            return;
                        }

                        // 전문가 프로필 저장 (검토 대기 상태)
                        const { data: expertData, error: expertError } = await supabase
                            .from('expert_profiles')
                            .insert({
                                email: email,
                                name: expertProfile.name,
                                phone: expertProfile.phone,
                                title: expertProfile.title,
                                category: expertProfile.category,
                                specialties: expertProfile.specialties,
                                bio: expertProfile.bio,
                                experience_years: parseInt(expertProfile.experienceYears),
                                credentials: expertProfile.credentials,
                                business_license: expertProfile.businessLicense || null,
                                qualification_number: expertProfile.qualificationNumber || null,
                                available_types: expertProfile.availableTypes,
                                verification_status: 'pending'
                            })
                            .select()
                            .single();

                        if (expertError) {
                            throw new Error('전문가 프로필 저장 실패: ' + expertError.message);
                        }

                        console.log('전문가 프로필 저장 완료:', expertData);
                        
                        showNotification('전문가 등록 신청 완료!', `📝 ${expertProfile.name}님의 전문가 등록 신청이 접수되었습니다.\n\n🔍 제출하신 서류를 검토 중입니다.\n📧 승인 결과를 이메일로 알려드릴게요.\n\n⏰ 검토 기간: 영업일 기준 3-5일`, 'success');
                        setAuthMode('login');
                        setCurrentStep(1);
                        resetExpertForm();
                    } catch (error) {
                        setError('전문가 등록 처리 중 오류가 발생했습니다');
                    }
                }
            };

            // 전문가 폼 초기화
            const resetExpertForm = () => {
                setExpertProfile({
                    name: '',
                    title: '',
                    expertType: 'travel',
                    experienceYears: '',
                    bio: '',
                    specialties: [],
                    credentials: [],
                    hourlyRate: '',
                    consultationDuration: 60,
                    phone: '',
                    businessLicense: '',
                    qualificationNumber: '',
                    availableTypes: ['phone']
                });
                setEmail('');
                setPassword('');
                setConfirmPassword('');
                setPrivacyConsent(false);
                setSpecialtyInput('');
                setCredentialInput('');
            };

            const regenerateNickname = () => {
                const newNickname = authManager.nicknameGen.generate();
                setGeneratedNickname(newNickname);
            };

            // 전문가 등록 UI 렌더링
            if (authMode === 'expert') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                        <div className="max-w-2xl w-full space-y-8">
                            <div className="text-center">
                                <div className="mb-6">
                                    <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-full mx-auto flex items-center justify-center">
                                        <span className="text-white font-bold text-xl">🎯</span>
                                    </div>
                                </div>
                                <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                    전문가 등록
                                </h1>
                                <p className="text-xl text-gray-600 mb-8">
                                    {currentStep === 1 ? '기본 정보 입력' : '전문가 프로필 등록'}
                                </p>
                                <div className="flex justify-center space-x-4 mb-8">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${currentStep >= 1 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>1</div>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${currentStep >= 2 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>2</div>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <form className="space-y-6" onSubmit={handleSubmit}>
                                    {currentStep === 1 ? (
                                        // 1단계: 기본 회원가입
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">실명 *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={expertProfile.name}
                                                    onChange={(e) => updateExpertProfile('name', e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="실명을 입력하세요"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">전문가 인증을 위해 실명이 필요합니다</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">이메일 *</label>
                                                <input
                                                    type="email"
                                                    required
                                                    value={email}
                                                    onChange={(e) => setEmail(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="이메일 주소"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">휴대폰 번호 *</label>
                                                <input
                                                    type="tel"
                                                    required
                                                    value={expertProfile.phone}
                                                    onChange={(e) => {
                                                        const formatted = formatPhoneNumber(e.target.value);
                                                        updateExpertProfile('phone', formatted);
                                                    }}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="010-1234-5678"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">본인 확인 및 상담 예약 연락용</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">비밀번호 *</label>
                                                <input
                                                    type="password"
                                                    required
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="비밀번호"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">비밀번호 확인 *</label>
                                                <input
                                                    type="password"
                                                    required
                                                    value={confirmPassword}
                                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                                    className="mt-1 w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-lg"
                                                    placeholder="비밀번호 확인"
                                                />
                                            </div>

                                            
                                            <ExpertPrivacyConsentComponent 
                                                checked={privacyConsent}
                                                onChange={setPrivacyConsent}
                                            />
                                        </div>
                                    ) : (
                                        // 2단계: 전문가 프로필
                                        <ExpertProfileForm 
                                            expertProfile={expertProfile}
                                            updateExpertProfile={updateExpertProfile}
                                            expertCategories={expertCategories}
                                            specialtyInput={specialtyInput}
                                            setSpecialtyInput={setSpecialtyInput}
                                            credentialInput={credentialInput}
                                            setCredentialInput={setCredentialInput}
                                            addSpecialty={addSpecialty}
                                            addCredential={addCredential}
                                            removeSpecialty={removeSpecialty}
                                            removeCredential={removeCredential}
                                        />
                                    )}
                                    
                                    {error && (
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                            <p className="text-red-800 text-sm">{error}</p>
                                        </div>
                                    )}
                                    
                                    <div className="flex space-x-4">
                                        {currentStep === 2 && (
                                            <button
                                                type="button"
                                                onClick={() => setCurrentStep(1)}
                                                className="w-full py-3 px-4 border border-gray-300 text-lg font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50"
                                            >
                                                이전 단계
                                            </button>
                                        )}
                                        <button
                                            type="submit"
                                            className="w-full py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-orange-600 hover:bg-orange-700"
                                        >
                                            {currentStep === 1 ? '다음 단계' : '전문가 등록 완료'}
                                        </button>
                                    </div>
                                    
                                    <div className="text-center">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setAuthMode('login');
                                                setCurrentStep(1);
                                                setError('');
                                            }}
                                            className="text-orange-600 hover:text-orange-500 text-sm font-medium"
                                        >
                                            일반 로그인으로 돌아가기
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-md w-full space-y-8">
                        <div className="text-center">
                            {/* 로고 자리 - PB 로고 */}
                            <div className="mb-6">
                                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mx-auto flex items-center justify-center">
                                    <span className="text-white font-bold text-xl">PB</span>
                                </div>
                            </div>
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                플랜비
                            </h1>
                            <p className="text-xl text-gray-600 mb-8">
                                행복한 은퇴생활의 시작
                            </p>
                        </div>
                        
                        {/* 로그인/회원가입 폼 */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <form className="space-y-6" onSubmit={handleSubmit}>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                                        이메일
                                    </label>
                                    <input
                                        id="email"
                                        name="email"
                                        type="email"
                                        required
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                        placeholder="이메일 주소"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                                        비밀번호
                                    </label>
                                    <input
                                        id="password"
                                        name="password"
                                        type="password"
                                        required
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                        placeholder="비밀번호"
                                    />
                                    {authMode === 'signup' && (
                                        <div className="mt-2 text-xs text-gray-500">
                                            <p className="mb-1">비밀번호 요구사항:</p>
                                            <ul className="space-y-0.5">
                                                {(() => {
                                                    const validation = validatePassword(password);
                                                    return (
                                                        <>
                                                            <li className={`flex items-center ${validation.checks.length ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.length ? '✓' : '○'}</span>
                                                                8자 이상
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasLetter ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasLetter ? '✓' : '○'}</span>
                                                                영문 포함
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasNumber ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasNumber ? '✓' : '○'}</span>
                                                                숫자 포함
                                                            </li>
                                                            <li className={`flex items-center ${validation.checks.hasSpecial ? 'text-green-600' : 'text-gray-400'}`}>
                                                                <span className="mr-2">{validation.checks.hasSpecial ? '✓' : '○'}</span>
                                                                특수문자 포함
                                                            </li>
                                                            <li className={`flex items-center text-xs mt-1 ${validation.typeCount >= 2 ? 'text-green-600' : 'text-orange-500'}`}>
                                                                <span className="mr-2">{validation.typeCount >= 2 ? '✓' : '!'}</span>
                                                                영문, 숫자, 특수문자 중 2종류 이상 조합 필수
                                                            </li>
                                                        </>
                                                    );
                                                })()}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                                {authMode === 'signup' && (
                                    <>
                                        <div>
                                            <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">
                                                비밀번호 확인
                                            </label>
                                            <input
                                                id="confirmPassword"
                                                name="confirmPassword"
                                                type="password"
                                                required
                                                value={confirmPassword}
                                                onChange={(e) => setConfirmPassword(e.target.value)}
                                                className="mt-1 appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg"
                                                placeholder="비밀번호 확인"
                                            />
                                        </div>
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <h4 className="text-sm font-medium text-blue-800 mb-3">닉네임 선택</h4>
                                            
                                            {/* 닉네임 선택 옵션 */}
                                            <div className="space-y-3">
                                                {/* 자동 생성 닉네임 옵션 */}
                                                <label className="flex items-center space-x-3 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="nicknameOption"
                                                        checked={!useCustomNickname}
                                                        onChange={() => setUseCustomNickname(false)}
                                                        className="h-4 w-4 text-blue-600 border-2 border-gray-300 focus:ring-blue-500"
                                                    />
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between">
                                                            <div>
                                                                <span className="text-sm font-medium text-blue-800">자동 생성</span>
                                                                <p className="text-lg font-bold text-blue-900">{generatedNickname}</p>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={regenerateNickname}
                                                                className="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm font-medium transition-colors"
                                                            >
                                                                🎲 다시생성
                                                            </button>
                                                        </div>
                                                    </div>
                                                </label>
                                                
                                                {/* 직접 입력 닉네임 옵션 */}
                                                <label className="flex items-start space-x-3 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="nicknameOption"
                                                        checked={useCustomNickname}
                                                        onChange={() => setUseCustomNickname(true)}
                                                        className="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 focus:ring-blue-500"
                                                    />
                                                    <div className="flex-1">
                                                        <span className="text-sm font-medium text-blue-800">직접 입력</span>
                                                        <input
                                                            type="text"
                                                            value={customNickname}
                                                            onChange={(e) => setCustomNickname(e.target.value)}
                                                            disabled={!useCustomNickname}
                                                            placeholder="원하는 닉네임을 입력하세요"
                                                            className={`mt-1 w-full px-3 py-2 border rounded-lg text-sm ${
                                                                useCustomNickname 
                                                                    ? 'border-blue-300 focus:border-blue-500 focus:ring-blue-500' 
                                                                    : 'border-gray-200 bg-gray-50 text-gray-400'
                                                            }`}
                                                        />
                                                        {useCustomNickname && (
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                2-20자, 한글/영문/숫자 사용 가능
                                                            </p>
                                                        )}
                                                    </div>
                                                </label>
                                            </div>
                                            
                                            <p className="text-xs text-blue-600 mt-3">💡 가입 후 언제든지 변경할 수 있어요</p>
                                        </div>
                                        
                                        {/* 개인정보 수집·이용 동의서 */}
                                        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <h4 className="text-sm font-medium text-gray-800 mb-3">개인정보 수집·이용 동의</h4>
                                            <div className="bg-white border border-gray-200 rounded p-3 text-xs text-gray-600 mb-3 max-h-32 overflow-y-auto">
                                                <div className="space-y-2">
                                                    <div>
                                                        <strong className="text-gray-800">■ 수집하는 개인정보 항목</strong>
                                                        <p>- 이메일 주소, 닉네임</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 개인정보 수집 및 이용목적</strong>
                                                        <p>- 회원 가입 및 관리</p>
                                                        <p>- 서비스 제공 및 본인확인</p>
                                                        <p>- 계산 결과 저장 및 커뮤니티 이용</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 개인정보 보유 및 이용기간</strong>
                                                        <p>- 회원탈퇴 시까지</p>
                                                        <p>- 단, 관계법령에 의해 보존할 필요가 있는 경우 해당 기간까지</p>
                                                    </div>
                                                    <div>
                                                        <strong className="text-gray-800">■ 동의 거부 권리</strong>
                                                        <p>- 개인정보 수집·이용에 대한 동의를 거부할 권리가 있습니다</p>
                                                        <p>- 다만, 동의 거부 시 서비스 이용이 제한될 수 있습니다</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <PrivacyConsentCheckbox 
                                                checked={privacyConsent}
                                                onChange={setPrivacyConsent}
                                            />
                                        </div>
                                    </>
                                )}
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}

                            <div>
                                <button
                                    type="submit"
                                    className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    {authMode === 'login' ? '로그인' : '회원가입'}
                                </button>
                            </div>

                            <div className="text-center">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setAuthMode(authMode === 'login' ? 'signup' : 'login');
                                        setIsLogin(authMode !== 'login');
                                        setError('');
                                        setEmail('');
                                        setPassword('');
                                        setConfirmPassword('');
                                        setPrivacyConsent(false);
                                        setCustomNickname('');
                                        setUseCustomNickname(false);
                                    }}
                                    className="text-blue-600 hover:text-blue-500 text-sm font-medium"
                                >
                                    {authMode === 'login' ? '계정이 없으신가요? 회원가입' : '이미 계정이 있으신가요? 로그인'}
                                </button>
                            </div>
                            </form>
                        </div>
                        
                        <div className="flex items-center text-sm text-gray-500 mb-6">
                            <div className="flex-grow border-t border-gray-300"></div>
                            <span className="mx-4">또는</span>
                            <div className="flex-grow border-t border-gray-300"></div>
                        </div>
                        
                        {/* 게스트로 이용해보기 */}
                        <div className="text-center space-y-3">
                            <button
                                onClick={() => onAuthSuccess(generateGuestUser())}
                                className="group relative w-full flex justify-center py-3 px-4 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-300"
                            >
                                🧮 게스트로 이용해보기
                            </button>
                            <p className="text-center text-sm text-gray-500">
                                회원가입 없이 계산기만 이용 (커뮤니티 이용 불가)
                            </p>
                        </div>
                        
                        {/* 전문가 등록 */}
                        <div className="flex items-center text-sm text-gray-500 mb-6">
                            <div className="flex-grow border-t border-gray-300"></div>
                            <span className="mx-4">전문가이신가요?</span>
                            <div className="flex-grow border-t border-gray-300"></div>
                        </div>
                        
                        <div className="text-center">
                            <button
                                onClick={() => setAuthMode('expert')}
                                className="group relative w-full flex justify-center py-3 px-4 border-2 border-orange-500 text-base font-medium rounded-lg text-orange-600 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-300"
                            >
                                🎯 전문가로 등록하기
                            </button>
                            <p className="text-center text-sm text-gray-500 mt-2">
                                여행/취미, 세무/법무, 주거/생활 전문가 모집
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // 블라인드식 커뮤니티 앱
        const CommunityApp = ({ setCurrentView, currentUser, checkCalculationForInteraction, handlePostClick, isAdminUser }) => {
            const [activeTopic, setActiveTopic] = useState('retirement');
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState({ title: '', content: '', topic: 'retirement', is_anonymous: true });
            const [showWriteForm, setShowWriteForm] = useState(false);
            const [newReply, setNewReply] = useState('');
            const [userProfile, setUserProfile] = useState(null);
            const [showExpertBookingModal, setShowExpertBookingModal] = useState(false);
            const [selectedExpertFromPost, setSelectedExpertFromPost] = useState(null);

            // 전문가 게시글에서 전문가 정보 추출
            const getExpertFromPost = (post) => {
                if (post.topic !== 'expert') return null;
                
                return {
                    id: post.user_hash,
                    name: post.expert_name,
                    title: post.expert_title,
                    profileImage: '🎯',
                    price: post.consultation_price,
                    hourlyRate: post.consultation_price?.replace(/[^0-9]/g, '') || '50000',
                    availableTypes: ['phone', 'video', 'chat']
                };
            };

            // 라이프스타일 그룹 정의 (중성적이고 포용적인 표현)
            const lifestyleGroups = {
                'prudent': { 
                    name: '알뜰 라이프', 
                    description: '실속있는 은퇴생활을 추구하는 분들',
                    color: 'bg-blue-500', 
                    emoji: '🌱',
                    tagline: '작은 것에서 찾는 큰 행복'
                },
                'balanced': { 
                    name: '밸런스 라이프', 
                    description: '균형잡힌 은퇴생활을 원하는 분들',
                    color: 'bg-green-500', 
                    emoji: '⚖️',
                    tagline: '안정과 여유의 조화'
                },
                'premium': { 
                    name: '프리미엄 라이프', 
                    description: '풍요로운 은퇴생활을 계획하는 분들',
                    color: 'bg-purple-500', 
                    emoji: '🌟',
                    tagline: '꿈꾸던 은퇴의 실현'
                }
            };

            // 토픽 보드 (블라인드의 토픽과 유사)
            const topics = {
                'retirement': { name: '은퇴계획', icon: '🏖️', description: '은퇴 준비와 은퇴설계' },
                'asset': { name: '재테크', icon: '💰', description: '투자와 자산 운용' },
                'pension': { name: '연금이야기', icon: '📋', description: '국민연금, 개인연금' },
                'health': { name: '건강관리', icon: '🏥', description: '의료비, 건강보험' },
                'life': { name: '시니어생활', icon: '🌻', description: '일상, 취미, 여행' },
                'housing': { name: '부동산', icon: '🏠', description: '주택, 임대, 이사' },
                'family': { name: '가족관계', icon: '👨‍👩‍👧‍👦', description: '부부, 형제자매, 자녀 이야기' },
                'work': { name: '재취업', icon: '💼', description: '시니어 일자리' },
                'expert': { name: '전문가 상담', icon: '🎯', description: '전문가 서비스 소개 및 상담 안내', isExpertOnly: true }
            };

            // 커뮤니티 목록 보기용 샘플 데이터 (상세보기는 계산 후 가능)
            const samplePosts = [
                {
                    id: '1',
                    title: '3억 자산으로 부부 은퇴 가능할까요?',
                    content: '아파트 2억 + 현금 1억입니다. 월 200만원 정도로 살 계획인데 괜찮을까요?',
                    topic: 'retirement',
                    asset_group: 'middle',
                    user_hash: 'user123',
                    age_badge: '60-64세',
                    asset_badge: '안정형',
                    is_hot: true,
                    replies_count: 12,
                    likes_count: 8,
                    created_at: '2025-01-20T10:30:00Z'
                },
                {
                    id: '2',
                    title: '연금 받는 시기 고민됩니다',
                    content: '국민연금 60세부터 받을지 65세부터 받을지... 건강한 편이라 고민이에요.',
                    topic: 'pension',
                    asset_group: 'middle', 
                    user_hash: 'user456',
                    age_badge: '55-59세',
                    asset_badge: '안정형',
                    is_hot: false,
                    replies_count: 7,
                    likes_count: 5,
                    created_at: '2025-01-20T09:15:00Z'
                },
                {
                    id: '3',
                    title: '10억 자산 어떻게 굴릴까요?',
                    content: '현금 5억, 부동산 5억 있는데 안전하게 수익 내는 방법 있을까요?',
                    topic: 'asset',
                    asset_group: 'high',
                    user_hash: 'user789',
                    age_badge: '65-69세',
                    asset_badge: '여유형',
                    is_hot: true,
                    replies_count: 15,
                    likes_count: 12,
                    created_at: '2025-01-20T08:45:00Z'
                },
                {
                    id: '4',
                    title: '기초연금으로만 사는 분 계신가요?',
                    content: '자산이 많지 않아서 기초연금에 의존하게 될 것 같은데... 경험담 듣고 싶어요.',
                    topic: 'life',
                    asset_group: 'low',
                    user_hash: 'user101', 
                    age_badge: '60-64세',
                    asset_badge: '생활형',
                    is_hot: false,
                    replies_count: 9,
                    likes_count: 6,
                    created_at: '2025-01-19T16:20:00Z'
                },
                {
                    id: '5',
                    title: '실버보험 가입 필요할까요?',
                    content: '60대 중반인데 실버보험 가입을 권유받았어요. 보험료가 만만치 않은데...',
                    topic: 'health',
                    asset_group: 'middle',
                    user_hash: 'user202',
                    age_badge: '60-64세', 
                    asset_badge: '안정형',
                    is_hot: false,
                    replies_count: 4,
                    likes_count: 3,
                    created_at: '2025-01-19T14:30:00Z'
                },
                // 전문가 게시글 샘플
                {
                    id: '6',
                    title: '시니어 여행 계획, 이것만은 꼭 확인하세요!',
                    content: '안녕하세요, 시니어 여행 전문 플래너 김여행입니다. 은퇴 후 첫 해외여행을 계획하시는 분들을 위한 체크리스트를 공유합니다...',
                    topic: 'expert',
                    expert_category: 'travel',
                    user_hash: 'expert_kim_travel',
                    expert_badge: '인증 전문가',
                    expert_name: '김여행플래너',
                    expert_title: '시니어 여행 전문 플래너',
                    consultation_price: '60,000원/60분',
                    is_hot: true,
                    replies_count: 23,
                    likes_count: 45,
                    created_at: '2025-01-21T09:00:00Z'
                },
                {
                    id: '7', 
                    title: '상속세 절세 전략 - 증여와 상속의 최적 타이밍',
                    content: '상속세 전문 세무사 최세무입니다. 많은 분들이 궁금해하시는 증여와 상속의 최적 타이밍에 대해 설명드리겠습니다...',
                    topic: 'expert',
                    expert_category: 'legal',
                    user_hash: 'expert_choi_tax',
                    expert_badge: '인증 전문가',
                    expert_name: '최세무사',
                    expert_title: '상속세 절세 전문 세무사',
                    consultation_price: '100,000원/60분',
                    is_hot: true,
                    replies_count: 18,
                    likes_count: 32,
                    created_at: '2025-01-20T15:30:00Z'
                },
                {
                    id: '8',
                    title: '은퇴 후 다운사이징, 성공적인 이사 가이드',
                    content: '시니어 주거 전문 컨설턴트 윤부동산입니다. 은퇴 후 집을 줄이는 다운사이징에 대한 실전 가이드를 공유합니다...',
                    topic: 'expert',
                    expert_category: 'living',
                    user_hash: 'expert_yoon_housing',
                    expert_badge: '인증 전문가',
                    expert_name: '윤부동산컨설턴트',
                    expert_title: '시니어 주거 전문 컨설턴트',
                    consultation_price: '80,000원/60분',
                    is_hot: false,
                    replies_count: 12,
                    likes_count: 28,
                    created_at: '2025-01-19T11:20:00Z'
                }
            ];

            // 컴포넌트 초기화시 세션 확인
            useEffect(() => {
                initializeCommunity();
            }, [currentUser]);

            // 토픽 변경시 게시글 다시 로드
            useEffect(() => {
                if (currentUser) {
                    loadPosts();
                }
            }, [activeTopic, currentUser]);

            const initializeCommunity = async () => {
                try {
                    if (currentUser) {
                        // Supabase 연결이 있을 때만 사용자 프로필 로드
                        if (supabase) {
                            try {
                                const { data: profile, error } = await supabase
                                    .from('user_profiles')
                                    .select('*')
                                    .eq('id', currentUser.id)
                                    .single();
                                
                                if (!error && profile) {
                                    setUserProfile(profile);
                                    console.log(`커뮤니티 접속: ${profile.nickname}`);
                                }
                            } catch (supabaseError) {
                                console.log('Supabase 연결 없음, 로컬 데이터 사용');
                            }
                        } else {
                            // Supabase가 없을 때 현재 사용자 정보로 임시 프로필 생성
                            setUserProfile({
                                id: currentUser.id,
                                nickname: currentUser.nickname || currentUser.email,
                                email: currentUser.email
                            });
                            console.log(`커뮤니티 접속: ${currentUser.nickname || currentUser.email} (로컬 모드)`);
                        }
                        
                        // 게시글 로드 (항상 실행)
                        await loadPosts();
                    }
                } catch (error) {
                    console.error('커뮤니티 초기화 오류:', error);
                    // 오류가 있어도 게시글 UI는 표시
                    await loadPosts();
                }
            };

            const loadPosts = async () => {
                if (!currentUser) return;
                try {
                    if (supabase) {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .select('*')
                            .eq('category', activeTopic)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        setPosts(data || []);
                    } else {
                        // Supabase 연결이 없을 때 샘플 데이터 표시
                        const filteredPosts = samplePosts.filter(post => 
                            post.topic === activeTopic
                        );
                        setPosts(filteredPosts);
                    }
                } catch (error) {
                    console.error('게시글 로딩 오류:', error);
                    // 오류 발생시 샘플 데이터로 폴백
                    const filteredPosts = samplePosts.filter(post => 
                        post.topic === activeTopic
                    );
                    setPosts(filteredPosts);
                }
            };

            // 내 자산 그룹 자동 감지 (계산기 결과 기반)
            const detectMyAssetGroup = () => {
                // 실제로는 계산기 결과를 기반으로 자산 그룹을 감지
                // 현재는 샘플로 'middle' 반환
                return 'middle';
            };

            // 게시글 필터링 (현재 선택된 자산그룹과 토픽)
            const getFilteredPosts = () => {
                return posts.filter(post => 
                    post.asset_group === selectedAssetGroup && 
                    post.topic === activeTopic
                );
            };

            // 시간 포맷팅 (블라인드식)
            const formatTime = (dateString) => {
                const now = new Date();
                const posted = new Date(dateString);
                const diffMs = now - posted;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffHours < 1) return '방금 전';
                if (diffHours < 24) return `${diffHours}시간 전`;
                if (diffDays < 7) return `${diffDays}일 전`;
                return posted.toLocaleDateString();
            };

            const createPost = async () => {
                if (!userSession) {
                    showNotification('로그인 필요', '게시글 작성을 위해 로그인이 필요합니다.', 'warning');
                    return;
                }

                if (!newPost.title.trim() || !newPost.content.trim()) {
                    showNotification('입력 오류', '제목과 내용을 모두 입력해주세요.', 'warning');
                    return;
                }

                try {
                    const postData = {
                        ...newPost,
                        topic: activeTopic,
                        author_nickname: userProfile?.nickname || '익명',
                        author_id: currentUser.id,
                        age_badge: '60-64세', // 향후 프로필에서 가져올 수 있음
                        is_hot: false,
                        replies_count: 0,
                        likes_count: 0,
                        created_at: new Date().toISOString()
                    };

                    if (supabase) {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .insert([postData])
                            .select();
                        
                        if (error) throw error;
                        setPosts([data[0], ...posts]);
                    } else {
                        // 로컬 상태에만 추가
                        const newId = String(Date.now());
                        setPosts([{ ...postData, id: newId }, ...posts]);
                    }

                    // 활동 기록 (필요시 추가)

                    setNewPost({ title: '', content: '', topic: activeTopic, is_anonymous: true });
                    setShowWriteForm(false);
                    showNotification('게시글 등록 완료', '게시글이 성공적으로 등록되었습니다! 🎉', 'success');
                } catch (error) {
                    console.error('게시글 작성 오류:', error);
                    showNotification('오류 발생', '게시글 작성 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                }
            };


            // 프로그레시브 접근: 먼저 커뮤니티를 보여주고, 상호작용 시에만 계산 체크

            // 정상 접근: 커뮤니티 화면
            // 기본 커뮤니티 그룹 (나중에 계산 결과 기반 그룹 배정 가능)
            const currentGroup = lifestyleGroups['balanced'];

            return (
                <div className="max-w-4xl mx-auto space-y-4">
                    {/* 뒤로가기 버튼 */}
                    <div className="flex justify-between items-center mb-4">
                        <button
                            onClick={() => setCurrentView('main')}
                            className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            메인으로 돌아가기
                        </button>
                        <div className="flex-1"></div>
                    </div>
                    
                    {/* 헤더 - 간소화 */}
                    <div className="bg-white rounded-lg shadow-md p-4">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-3">
                                <span className="text-2xl">{currentGroup.emoji}</span>
                                <h1 className="text-xl md:text-2xl font-bold text-gray-800">커뮤니티</h1>
                                {isAdminUser(currentUser) && (
                                    <span className="px-2 py-1 bg-red-100 text-red-600 text-xs font-medium rounded-full">
                                        👑 관리자
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center">
                                <button
                                    onClick={() => {
                                        if (checkCalculationForInteraction()) {
                                            setShowWriteForm(true);
                                        }
                                    }}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg font-medium text-sm md:text-base whitespace-nowrap"
                                >
                                    ✍️ 글쓰기
                                </button>
                            </div>
                        </div>

                        {/* 토픽 보드 - 컴팩트 */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-600 mb-2">📂 토픽 보드</h3>
                            <div className="grid grid-cols-4 md:grid-cols-8 gap-1">
                                {Object.entries(topics).map(([key, topic]) => (
                                    <button
                                        key={key}
                                        onClick={() => setActiveTopic(key)}
                                        className={`p-2 rounded-lg text-center transition-colors ${
                                            activeTopic === key
                                                ? 'bg-blue-50 border border-blue-300'
                                                : 'bg-gray-50 hover:bg-gray-100 border border-transparent'
                                        }`}
                                        title={topic.description}
                                    >
                                        <div className="text-base mb-1">{topic.icon}</div>
                                        <div className="font-medium text-gray-800 text-xs leading-tight">{topic.name}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* 글쓰기 모달 */}
                    {showWriteForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                                <div className="p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-xl font-bold">✍️ 새 글 작성</h3>
                                        <button
                                            onClick={() => setShowWriteForm(false)}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            ✕
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                                        <p className="text-sm text-blue-800">
                                            <strong>{currentGroup.name}</strong> 커뮤니티의{' '}
                                            <strong>{topics[activeTopic].name}</strong> 토픽에 글을 작성합니다
                                        </p>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">제목</label>
                                            <input
                                                type="text"
                                                value={newPost.title}
                                                onChange={(e) => setNewPost({...newPost, title: e.target.value})}
                                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="제목을 입력하세요"
                                                maxLength={100}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">내용</label>
                                            <textarea
                                                value={newPost.content}
                                                onChange={(e) => setNewPost({...newPost, content: e.target.value})}
                                                className="w-full p-3 border rounded-lg h-40 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="궁금한 점이나 경험담을 자유롭게 작성해주세요"
                                                maxLength={1000}
                                            />
                                            <p className="text-xs text-gray-500 mt-1">{newPost.content.length}/1000</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                id="anonymous"
                                                checked={newPost.is_anonymous}
                                                onChange={(e) => setNewPost({...newPost, is_anonymous: e.target.checked})}
                                                className="rounded"
                                            />
                                            <label htmlFor="anonymous" className="text-sm text-gray-600">
                                                익명으로 게시 (추천)
                                            </label>
                                        </div>
                                        <div className="flex space-x-3 pt-4">
                                            <button
                                                onClick={createPost}
                                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium"
                                            >
                                                게시하기
                                            </button>
                                            <button
                                                onClick={() => setShowWriteForm(false)}
                                                className="px-6 py-3 border rounded-lg hover:bg-gray-50"
                                            >
                                                취소
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 현재 선택된 토픽 정보 */}
                    <div className="bg-white rounded-lg shadow-md p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <span className="text-lg">{topics[activeTopic].icon}</span>
                                <div>
                                    <h2 className="font-bold text-lg">{topics[activeTopic].name}</h2>
                                    <p className="text-sm text-gray-600">{currentGroup.name} 커뮤니티</p>
                                </div>
                            </div>
                            <div className="text-right text-sm text-gray-500">
                                <p>게시글 {posts.length}개</p>
                                <p>{topics[activeTopic].description}</p>
                            </div>
                        </div>
                    </div>


                    {/* 게시글 목록 - 블라인드식 */}
                    <div className="space-y-2">
                                {posts.map(post => (
                                    <div key={post.id} className={`rounded-lg shadow-md hover:shadow-lg transition-shadow ${
                                        post.topic === 'expert' ? 'bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500' : 'bg-white'
                                    }`}>
                                        <div className="p-4">
                                            <div className="flex items-start justify-between mb-3">
                                                <div className="flex-1">
                                                    {/* 뱃지들 */}
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        {post.topic === 'expert' ? (
                                                            <>
                                                                <span className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs font-bold">
                                                                    🎯 {post.expert_badge}
                                                                </span>
                                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                                    {post.expert_name}
                                                                </span>
                                                                {post.consultation_price && (
                                                                    <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                                                        💰 {post.consultation_price}
                                                                    </span>
                                                                )}
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                                                                    {post.asset_badge}
                                                                </span>
                                                                <span className="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
                                                                    {post.age_badge}
                                                                </span>
                                                            </>
                                                        )}
                                                        {post.is_hot && (
                                                            <span className="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-medium">
                                                                🔥 HOT
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    {/* 제목 */}
                                                    <h3 
                                                        className={`font-bold cursor-pointer hover:text-blue-600 transition-colors line-clamp-2 ${
                                                            post.topic === 'expert' ? 'text-orange-900' : 'text-gray-800'
                                                        }`}
                                                        onClick={() => handlePostClick(post)}
                                                    >
                                                        {post.title}
                                                    </h3>
                                                    
                                                    {/* 전문가 타이틀 */}
                                                    {post.topic === 'expert' && post.expert_title && (
                                                        <p className="text-orange-700 text-sm font-medium mt-1">
                                                            {post.expert_title}
                                                        </p>
                                                    )}
                                                    
                                                    {/* 내용 미리보기 */}
                                                    <p className="text-gray-600 text-sm mt-2 line-clamp-2">
                                                        {post.content.length > 120 ? `${post.content.substring(0, 120)}...` : post.content}
                                                    </p>
                                                    
                                                    {/* 전문가 게시글 액션 버튼 */}
                                                    {post.topic === 'expert' && (
                                                        <div className="mt-3 flex space-x-2">
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    const expert = getExpertFromPost(post);
                                                                    if (expert) {
                                                                        setSelectedExpertFromPost(expert);
                                                                        setShowExpertBookingModal(true);
                                                                    }
                                                                }}
                                                                className="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs font-medium"
                                                            >
                                                                📞 상담 예약
                                                            </button>
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handlePostClick(post);
                                                                }}
                                                                className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium"
                                                            >
                                                                📝 질문하기
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* 우측 메타 정보 */}
                                                <div className="text-right text-sm text-gray-500 ml-4">
                                                    <p>{formatTime(post.created_at)}</p>
                                                    <div className="flex items-center justify-end space-x-2 mt-1">
                                                        <span className="flex items-center">💬 {post.replies_count}</span>
                                                        <span className="flex items-center">👍 {post.likes_count}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                
                                {posts.length === 0 && (
                                    <div className="bg-white rounded-lg p-12 text-center">
                                        <div className="text-6xl mb-4">📝</div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">
                                            {currentGroup.name}의 {topics[activeTopic].name}
                                        </h3>
                                        <p className="text-gray-600 mb-4">아직 게시글이 없습니다.</p>
                                        <button
                                            onClick={() => {
                                                if (checkCalculationForInteraction()) {
                                                    setShowWriteForm(true);
                                                }
                                            }}
                                            className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
                                        >
                                            첫 번째 글 작성하기 ✍️
                                        </button>
                                    </div>
                                )}
                    </div>
                    
                    {/* 전문가 상담 예약 모달 */}
                    {showExpertBookingModal && selectedExpertFromPost && (
                        <ConsultationBookingComponent
                            expert={selectedExpertFromPost}
                            currentUser={currentUser}
                            onClose={() => {
                                setShowExpertBookingModal(false);
                                setSelectedExpertFromPost(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        // 상담 완료 확인 시스템 컴포넌트
        const ConsultationCompletionComponent = ({ consultation, onClose, userType }) => {
            const [isCompleting, setIsCompleting] = useState(false);
            const [showReviewForm, setShowReviewForm] = useState(false);
            const [review, setReview] = useState({
                rating: 5,
                reviewTitle: '',
                reviewContent: '',
                professionalismRating: 5,
                communicationRating: 5,
                satisfactionRating: 5,
                wouldRecommend: true
            });

            const handleComplete = async () => {
                setIsCompleting(true);
                try {
                    // TODO: Supabase에 완료 상태 업데이트
                    const completionData = {
                        consultationId: consultation.id,
                        userType, // 'expert' 또는 'client'
                        completedAt: new Date().toISOString()
                    };
                    
                    console.log('상담 완료 처리:', completionData);
                    
                    if (userType === 'client') {
                        setShowReviewForm(true);
                    } else {
                        alert('상담 완료 처리되었습니다');
                        onClose();
                    }
                } catch (error) {
                    console.error('완료 처리 오류:', error);
                    alert('완료 처리 중 오류가 발생했습니다');
                } finally {
                    setIsCompleting(false);
                }
            };

            const handleReviewSubmit = async () => {
                try {
                    // TODO: Supabase에 후기 저장
                    const reviewData = {
                        consultationId: consultation.id,
                        ...review,
                        createdAt: new Date().toISOString()
                    };
                    
                    console.log('후기 저장:', reviewData);
                    
                    alert('후기가 등록되었습니다. 감사합니다!');
                    onClose();
                } catch (error) {
                    console.error('후기 저장 오류:', error);
                    alert('후기 저장 중 오류가 발생했습니다');
                }
            };

            if (showReviewForm) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl max-h-90vh overflow-y-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-gray-900">상담 후기 작성</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                            </div>

                            <div className="space-y-6">
                                {/* 전체 평점 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">전체 만족도 *</label>
                                    <div className="flex space-x-1">
                                        {[1, 2, 3, 4, 5].map(star => (
                                            <button
                                                key={star}
                                                onClick={() => setReview(prev => ({ ...prev, rating: star }))}
                                                className={`text-2xl ${star <= review.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                            >
                                                ⭐
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 세부 평가 */}
                                <div className="space-y-4">
                                    <h4 className="font-medium">세부 평가</h4>
                                    
                                    {[
                                        { key: 'professionalismRating', label: '전문성' },
                                        { key: 'communicationRating', label: '소통' },
                                        { key: 'satisfactionRating', label: '만족도' }
                                    ].map(({ key, label }) => (
                                        <div key={key}>
                                            <label className="block text-sm text-gray-600 mb-1">{label}</label>
                                            <div className="flex space-x-1">
                                                {[1, 2, 3, 4, 5].map(star => (
                                                    <button
                                                        key={star}
                                                        onClick={() => setReview(prev => ({ ...prev, [key]: star }))}
                                                        className={`text-lg ${star <= review[key] ? 'text-yellow-400' : 'text-gray-300'}`}
                                                    >
                                                        ⭐
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* 후기 제목 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">후기 제목</label>
                                    <input
                                        type="text"
                                        value={review.reviewTitle}
                                        onChange={(e) => setReview(prev => ({ ...prev, reviewTitle: e.target.value }))}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        placeholder="후기 제목을 입력하세요"
                                    />
                                </div>

                                {/* 후기 내용 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상세 후기</label>
                                    <textarea
                                        value={review.reviewContent}
                                        onChange={(e) => setReview(prev => ({ ...prev, reviewContent: e.target.value }))}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        rows="4"
                                        placeholder="상담 경험을 다른 분들과 공유해주세요"
                                    />
                                </div>

                                {/* 추천 여부 */}
                                <div>
                                    <label className="flex items-center">
                                        <input
                                            type="checkbox"
                                            checked={review.wouldRecommend}
                                            onChange={(e) => setReview(prev => ({ ...prev, wouldRecommend: e.target.checked }))}
                                            className="h-4 w-4 text-blue-600"
                                        />
                                        <span className="ml-2 text-sm text-gray-700">이 전문가를 다른 분들께 추천하시겠어요?</span>
                                    </label>
                                </div>

                                <div className="flex space-x-4">
                                    <button
                                        onClick={() => setShowReviewForm(false)}
                                        className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        나중에 작성
                                    </button>
                                    <button
                                        onClick={handleReviewSubmit}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        후기 등록
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                        <div className="text-center">
                            <div className="text-6xl mb-4">✅</div>
                            <h3 className="text-xl font-bold text-gray-900 mb-4">상담이 완료되었나요?</h3>
                            
                            <div className="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                                <div className="space-y-2 text-sm">
                                    <div><strong>전문가:</strong> {consultation.expertName}</div>
                                    <div><strong>상담 일시:</strong> {consultation.scheduledTime}</div>
                                    <div><strong>상담 주제:</strong> {consultation.topic}</div>
                                </div>
                            </div>
                            
                            <p className="text-gray-600 mb-6">
                                {userType === 'expert' ? 
                                    '상담을 완료하셨으면 완료 버튼을 눌러주세요.' :
                                    '상담이 완료되었으면 완료 확인 후 후기를 작성해주세요.'
                                }
                            </p>
                            
                            <div className="flex space-x-4">
                                <button
                                    onClick={onClose}
                                    className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                >
                                    나중에
                                </button>
                                <button
                                    onClick={handleComplete}
                                    disabled={isCompleting}
                                    className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                                >
                                    {isCompleting ? '처리중...' : '상담 완료'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 예약 시스템 컴포넌트
        const ConsultationBookingComponent = ({ expert, onClose, currentUser }) => {
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedTime, setSelectedTime] = useState('');
            const [consultationType, setConsultationType] = useState('phone');
            const [consultationTopic, setConsultationTopic] = useState('');
            const [clientQuestions, setClientQuestions] = useState('');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [currentStep, setCurrentStep] = useState(1);
            const [bookingResult, setBookingResult] = useState(null);

            // 예약 가능한 날짜 생성 (오늘부터 30일간)
            const getAvailableDates = () => {
                const dates = [];
                const today = new Date();
                for (let i = 1; i <= 30; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    // 주말 제외 (토: 6, 일: 0)
                    if (date.getDay() !== 0 && date.getDay() !== 6) {
                        dates.push(date);
                    }
                }
                return dates;
            };

            // 예약 가능한 시간 생성
            const getAvailableTimes = () => {
                const times = [];
                for (let hour = 9; hour <= 18; hour++) {
                    times.push(`${hour.toString().padStart(2, '0')}:00`);
                    if (hour < 18) {
                        times.push(`${hour.toString().padStart(2, '0')}:30`);
                    }
                }
                return times;
            };

            const handleBooking = async () => {
                if (!selectedDate || !selectedTime || !consultationTopic) {
                    alert('모든 필수 항목을 입력해주세요');
                    return;
                }

                try {
                    const bookingData = {
                        expertId: expert.id,
                        clientUserHash: currentUser?.id || 'guest_' + Date.now(),
                        scheduledTime: `${selectedDate} ${selectedTime}`,
                        consultationType,
                        consultationTopic,
                        clientQuestions,
                        phoneNumber: consultationType === 'phone' ? phoneNumber : '',
                        paymentAmount: parseInt(expert.hourlyRate),
                        platformFee: Math.round(parseInt(expert.hourlyRate) * 0.1),
                        expertPayout: Math.round(parseInt(expert.hourlyRate) * 0.9)
                    };

                    // TODO: Supabase에 예약 정보 저장
                    console.log('예약 정보 저장:', bookingData);
                    
                    setBookingResult(bookingData);
                    setCurrentStep(3);
                } catch (error) {
                    console.error('예약 처리 오류:', error);
                    alert('예약 처리 중 오류가 발생했습니다');
                }
            };

            if (currentStep === 3 && bookingResult) {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                        <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                            <div className="text-center">
                                <div className="text-6xl mb-4">✅</div>
                                <h3 className="text-xl font-bold text-gray-900 mb-4">예약 완료!</h3>
                                <div className="bg-green-50 p-4 rounded-lg mb-4 text-left">
                                    <div className="space-y-2 text-sm">
                                        <div><strong>전문가:</strong> {expert.name}</div>
                                        <div><strong>일시:</strong> {bookingResult.scheduledTime}</div>
                                        <div><strong>상담 방식:</strong> {
                                            consultationType === 'phone' ? '📞 전화 상담' :
                                            consultationType === 'video' ? '📹 화상 상담' : '💬 채팅 상담'
                                        }</div>
                                        <div><strong>상담료:</strong> {expert.hourlyRate.toLocaleString()}원</div>
                                        <div><strong>플랫폼 수수료:</strong> {bookingResult.platformFee.toLocaleString()}원</div>
                                    </div>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    예약 확정 메일을 발송했습니다.<br/>
                                    상담 전에 전문가가 연락드릴 예정입니다.
                                </p>
                                <button
                                    onClick={onClose}
                                    className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                >
                                    확인
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                    <div className="bg-white rounded-xl p-6 max-w-2xl w-full shadow-xl max-h-90vh overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-900">상담 예약</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>

                        {/* 전문가 정보 */}
                        <div className="bg-orange-50 p-4 rounded-lg mb-6">
                            <div className="flex items-center gap-4">
                                <div className="text-3xl">{expert.profileImage}</div>
                                <div>
                                    <h4 className="font-bold text-gray-800">{expert.name}</h4>
                                    <p className="text-sm text-gray-600">{expert.title}</p>
                                    <p className="text-sm font-medium text-orange-600">{expert.price}</p>
                                </div>
                            </div>
                        </div>

                        {currentStep === 1 && (
                            <div className="space-y-6">
                                <h4 className="font-bold text-lg">1단계: 날짜 및 시간 선택</h4>
                                
                                {/* 날짜 선택 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 날짜 *</label>
                                    <select
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        required
                                    >
                                        <option value="">날짜 선택</option>
                                        {getAvailableDates().map(date => (
                                            <option key={date.toISOString()} value={date.toISOString().split('T')[0]}>
                                                {date.toLocaleDateString('ko-KR', { 
                                                    year: 'numeric', 
                                                    month: 'long', 
                                                    day: 'numeric',
                                                    weekday: 'short'
                                                })}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* 시간 선택 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 시간 *</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {getAvailableTimes().map(time => (
                                            <button
                                                key={time}
                                                onClick={() => setSelectedTime(time)}
                                                className={`p-2 text-sm rounded-lg border transition-colors ${
                                                    selectedTime === time
                                                        ? 'bg-orange-500 text-white border-orange-500'
                                                        : 'bg-white text-gray-700 border-gray-300 hover:bg-orange-50'
                                                }`}
                                            >
                                                {time}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 상담 방식 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 방식 *</label>
                                    <div className="space-y-2">
                                        {expert.availableTypes?.map(type => (
                                            <label key={type} className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                                <input
                                                    type="radio"
                                                    name="consultationType"
                                                    value={type}
                                                    checked={consultationType === type}
                                                    onChange={(e) => setConsultationType(e.target.value)}
                                                    className="h-4 w-4 text-orange-600"
                                                />
                                                <div className="ml-3">
                                                    <div className="font-medium">
                                                        {type === 'phone' ? '📞 전화 상담' :
                                                         type === 'video' ? '📹 화상 상담' : '💬 채팅 상담'}
                                                    </div>
                                                </div>
                                            </label>
                                        )) || (
                                            <label className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                                <input
                                                    type="radio"
                                                    name="consultationType"
                                                    value="phone"
                                                    checked={true}
                                                    onChange={() => setConsultationType('phone')}
                                                    className="h-4 w-4 text-orange-600"
                                                />
                                                <div className="ml-3">
                                                    <div className="font-medium">📞 전화 상담</div>
                                                </div>
                                            </label>
                                        )}
                                    </div>
                                </div>

                                <div className="flex justify-between">
                                    <button
                                        onClick={onClose}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        취소
                                    </button>
                                    <button
                                        onClick={() => setCurrentStep(2)}
                                        disabled={!selectedDate || !selectedTime}
                                        className="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-300"
                                    >
                                        다음 단계
                                    </button>
                                </div>
                            </div>
                        )}

                        {currentStep === 2 && (
                            <div className="space-y-6">
                                <h4 className="font-bold text-lg">2단계: 상담 내용</h4>
                                
                                {/* 상담 주제 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">상담 주제 *</label>
                                    <input
                                        type="text"
                                        value={consultationTopic}
                                        onChange={(e) => setConsultationTopic(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        placeholder="상담받고 싶은 주제를 간단히 적어주세요"
                                        required
                                    />
                                </div>

                                {/* 구체적인 질문 */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">구체적인 질문이나 상황</label>
                                    <textarea
                                        value={clientQuestions}
                                        onChange={(e) => setClientQuestions(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                        rows="4"
                                        placeholder="상담을 위해 전문가가 미리 알아야 할 내용이나 질문을 적어주세요"
                                    />
                                </div>

                                {/* 전화번호 (전화 상담인 경우) */}
                                {consultationType === 'phone' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">연락처 *</label>
                                        <input
                                            type="tel"
                                            value={phoneNumber}
                                            onChange={(e) => setPhoneNumber(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg"
                                            placeholder="010-1234-5678"
                                            required
                                        />
                                    </div>
                                )}

                                {/* 예약 요약 */}
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <h5 className="font-medium mb-2">예약 요약</h5>
                                    <div className="text-sm space-y-1">
                                        <div>📅 날짜: {selectedDate}</div>
                                        <div>⏰ 시간: {selectedTime}</div>
                                        <div>📞 방식: {consultationType === 'phone' ? '전화 상담' : consultationType === 'video' ? '화상 상담' : '채팅 상담'}</div>
                                        <div>💰 상담료: {expert.price}</div>
                                    </div>
                                </div>

                                <div className="flex justify-between">
                                    <button
                                        onClick={() => setCurrentStep(1)}
                                        className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                                    >
                                        이전
                                    </button>
                                    <button
                                        onClick={handleBooking}
                                        className="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600"
                                    >
                                        예약 확정
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 전문가 찾기 컴포넌트
        const ExpertFinderComponent = ({ currentUser }) => {
            const [activeCategory, setActiveCategory] = useState('travel');
            const [showBookingModal, setShowBookingModal] = useState(false);
            const [selectedExpert, setSelectedExpert] = useState(null);
            
            // 3대 전문가 카테고리 정의
            const expertCategories = {
                'travel': {
                    name: '여행/취미',
                    icon: '✈️',
                    color: 'from-orange-500 to-red-500',
                    bgColor: 'from-orange-50 to-red-50',
                    description: '은퇴 후 여행과 취미생활 전문가'
                },
                'legal': {
                    name: '세무/법무/자산관리',
                    icon: '📋',
                    color: 'from-blue-500 to-indigo-500',
                    bgColor: 'from-blue-50 to-indigo-50',
                    description: '상속, 세금, 자산관리 전문가 (상담만, 판매 금지)'
                },
                'living': {
                    name: '주거/생활',
                    icon: '🏠',
                    color: 'from-green-500 to-emerald-500',
                    bgColor: 'from-green-50 to-emerald-50',
                    description: '은퇴 후 주거와 생활환경 설계 전문가'
                }
            };

            // 더미 전문가 데이터
            const expertData = {
                'travel': [
                    {
                        id: 1,
                        name: '김여행플래너',
                        title: '시니어 여행 전문 플래너',
                        experience: '12년 경력',
                        rating: 4.8,
                        reviews: 156,
                        specialties: ['안전여행', '의료동행여행', '장기체류', '해외거주'],
                        price: '60,000원/60분',
                        responseRate: 95,
                        profileImage: '✈️'
                    },
                    {
                        id: 2,
                        name: '박취미코치',
                        title: '시니어 라이프 취미 코치',
                        experience: '15년 경력',
                        rating: 4.9,
                        reviews: 203,
                        specialties: ['원예', '사진', '요리', '독서모임'],
                        price: '45,000원/60분',
                        responseRate: 92,
                        profileImage: '🎨'
                    },
                    {
                        id: 3,
                        name: '이평생교육사',
                        title: '시니어 교육 전문가',
                        experience: '10년 경력',
                        rating: 4.7,
                        reviews: 134,
                        specialties: ['디지털교육', '온라인학습', '자격증취득'],
                        price: '40,000원/45분',
                        responseRate: 88,
                        profileImage: '📚'
                    }
                ],
                'legal': [
                    {
                        id: 4,
                        name: '최세무사',
                        title: '상속세 절세 전문 세무사',
                        experience: '20년 경력',
                        rating: 4.9,
                        reviews: 156,
                        specialties: ['상속세 절세', '증여세 최적화', '연금소득세'],
                        price: '100,000원/60분',
                        responseRate: 97,
                        profileImage: '📊'
                    },
                    {
                        id: 5,
                        name: '정변호사',
                        title: '상속전문 변호사',
                        experience: '18년 경력',
                        rating: 4.8,
                        reviews: 134,
                        specialties: ['상속법률', '유언작성', '가족신탁'],
                        price: '150,000원/60분',
                        responseRate: 94,
                        profileImage: '⚖️'
                    },
                    {
                        id: 6,
                        name: '한자산관리사',
                        title: 'CFP 자산관리 상담사',
                        experience: '25년 경력',
                        rating: 4.9,
                        reviews: 298,
                        specialties: ['자산배분상담', '연금전략설계', '리스크관리'],
                        price: '120,000원/90분',
                        responseRate: 96,
                        profileImage: '💼'
                    }
                ],
                'living': [
                    {
                        id: 7,
                        name: '윤부동산컨설턴트',
                        title: '시니어 주거 전문 컨설턴트',
                        experience: '15년 경력',
                        rating: 4.8,
                        reviews: 142,
                        specialties: ['다운사이징', '시설선택', '주거비절약', '지역비교'],
                        price: '80,000원/60분',
                        responseRate: 91,
                        profileImage: '🏡'
                    },
                    {
                        id: 8,
                        name: '조귀농멘토',
                        title: '귀농귀촌 전문 멘토',
                        experience: '12년 경력',
                        rating: 4.7,
                        reviews: 98,
                        specialties: ['지역선택', '정착지원', '농업시작', '시골생활'],
                        price: '70,000원/90분',
                        responseRate: 89,
                        profileImage: '🌾'
                    },
                    {
                        id: 9,
                        name: '문생활설계사',
                        title: '시니어 라이프 플래너',
                        experience: '18년 경력',
                        rating: 4.6,
                        reviews: 165,
                        specialties: ['생활비관리', '건강관리', '인간관계', '일상설계'],
                        price: '60,000원/60분',
                        responseRate: 93,
                        profileImage: '🏠'
                    }
                ]
            };

            const currentExperts = expertData[activeCategory] || [];
            const currentCategory = expertCategories[activeCategory];

            return (
                <div className={`bg-gradient-to-r ${currentCategory.bgColor} p-6 rounded-lg`}>
                    {/* 헤더 */}
                    <div className="text-center mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                            🔍 신뢰할 수 있는 전문가를 찾아보세요
                        </h3>
                        <p className="text-gray-600 text-sm">
                            검증된 자격증 보유 전문가들과 안전한 상담
                        </p>
                    </div>

                    {/* 카테고리 탭 */}
                    <div className="grid grid-cols-3 gap-2 mb-6">
                        {Object.entries(expertCategories).map(([key, category]) => (
                            <button
                                key={key}
                                onClick={() => setActiveCategory(key)}
                                className={`p-3 rounded-lg text-center transition-all duration-300 ${
                                    activeCategory === key
                                        ? `bg-gradient-to-r ${category.color} text-white shadow-lg`
                                        : 'bg-white text-gray-600 hover:bg-gray-50'
                                }`}
                            >
                                <div className="text-lg mb-1">{category.icon}</div>
                                <div className="font-semibold text-xs">{category.name}</div>
                            </button>
                        ))}
                    </div>

                    {/* 전문가 목록 */}
                    <div className="space-y-4 mb-6">
                        {currentExperts.map(expert => (
                            <div key={expert.id} className="bg-white rounded-lg p-4 shadow-md">
                                <div className="flex items-start gap-4">
                                    {/* 프로필 */}
                                    <div className="text-3xl">{expert.profileImage}</div>
                                    
                                    {/* 정보 */}
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <h4 className="font-bold text-gray-800">{expert.name}</h4>
                                            <div className="flex items-center gap-1">
                                                <span className="text-yellow-500">⭐</span>
                                                <span className="text-sm font-medium">{expert.rating}</span>
                                                <span className="text-xs text-gray-500">({expert.reviews})</span>
                                            </div>
                                        </div>
                                        
                                        <p className="text-sm text-gray-600 mb-2">{expert.title}</p>
                                        <p className="text-xs text-gray-500 mb-2">{expert.experience}</p>
                                        
                                        {/* 전문분야 태그 */}
                                        <div className="flex flex-wrap gap-1 mb-3">
                                            {expert.specialties.map((specialty, index) => (
                                                <span key={index} className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">
                                                    {specialty}
                                                </span>
                                            ))}
                                        </div>
                                        
                                        {/* 하단 정보 */}
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm">
                                                <span className="font-semibold text-blue-600">{expert.price}</span>
                                                <span className="text-xs text-gray-500 ml-2">응답률 {expert.responseRate}%</span>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    setSelectedExpert(expert);
                                                    setShowBookingModal(true);
                                                }}
                                                className="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors"
                                            >
                                                상담 예약
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* 안내 메시지 */}
                    <div className="bg-white p-4 rounded-lg">
                        <h4 className="font-bold text-gray-800 mb-2">🛡️ 안전한 전문가 플랫폼</h4>
                        <div className="text-sm text-gray-600 space-y-1">
                            <p>✅ 모든 전문가 자격증 검증 완료</p>
                            <p>✅ 금융상품 판매 완전 금지 (순수 상담만)</p>
                            <p>✅ 투명한 후기 시스템</p>
                            <p>✅ 비대면 상담으로 안전하고 편리하게</p>
                            <p>🚧 현재 시범 운영 중 - 2025년 3월 정식 오픈 예정</p>
                        </div>
                    </div>
                    
                    {/* 예약 모달 */}
                    {showBookingModal && selectedExpert && (
                        <ConsultationBookingComponent
                            expert={selectedExpert}
                            currentUser={currentUser}
                            onClose={() => {
                                setShowBookingModal(false);
                                setSelectedExpert(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        // 게시글 상세 페이지 컴포넌트
        const PostDetailPage = ({ post, setCurrentView, currentUser, checkCalculationForInteraction, isAdminUser }) => {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState('');
            const [likes, setLikes] = useState(post.likes || 0);
            const [isLiked, setIsLiked] = useState(false);

            // 댓글 로드
            useEffect(() => {
                const loadReplies = async () => {
                    try {
                        if (supabase) {
                            const { data, error } = await supabase
                                .from('community_replies')
                                .select('*')
                                .eq('post_id', post.id)
                                .order('created_at', { ascending: true });
                            
                            if (error) throw error;
                            setReplies(data || []);
                        }
                    } catch (error) {
                        console.error('댓글 로딩 오류:', error);
                        setReplies([]);
                    }
                };

                loadReplies();
            }, [post.id]);

            return (
                <div className="max-w-4xl mx-auto">
                    {/* 뒤로가기 헤더 */}
                    <div className="flex items-center mb-6">
                        <button 
                            onClick={() => setCurrentView('community')}
                            className="flex items-center text-gray-600 hover:text-gray-800 transition-colors"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            커뮤니티로 돌아가기
                        </button>
                    </div>

                    {/* 게시글 상세 */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden">
                        <div className="p-6">
                            {/* 제목 */}
                            <h1 className="text-2xl font-bold text-gray-800 mb-4">{post.title}</h1>
                            
                            {/* 작성자 정보 */}
                            <div className="flex items-center text-sm text-gray-500 mb-6">
                                <span className="bg-gray-100 px-2 py-1 rounded mr-2">익명</span>
                                <span>{new Date(post.created_at).toLocaleDateString()}</span>
                                <span className="mx-2">•</span>
                                <span>조회 {post.views || 0}</span>
                            </div>
                            
                            {/* 본문 */}
                            <div className="prose max-w-none mb-8">
                                <p className="text-gray-800 whitespace-pre-wrap leading-relaxed">{post.content}</p>
                            </div>
                            
                            {/* 액션 버튼들 */}
                            <div className="flex items-center space-x-6 py-4 border-t border-gray-200">
                                <button 
                                    onClick={async () => {
                                        if (!checkCalculationForInteraction('like_post')) return;
                                        
                                        try {
                                            const newLikesCount = isLiked ? likes - 1 : likes + 1;
                                            
                                            if (supabase) {
                                                const { error } = await supabase
                                                    .from('community_posts')
                                                    .update({ likes: newLikesCount })
                                                    .eq('id', post.id);
                                                
                                                if (error) throw error;
                                            }
                                            
                                            setLikes(newLikesCount);
                                            setIsLiked(!isLiked);
                                        } catch (error) {
                                            console.error('좋아요 오류:', error);
                                        }
                                    }}
                                    className={`flex items-center transition-colors ${
                                        isLiked 
                                            ? 'text-blue-600 hover:text-blue-800' 
                                            : 'text-gray-600 hover:text-blue-600'
                                    }`}
                                >
                                    <span className="mr-1">{isLiked ? '👍' : '👍'}</span>
                                    <span>공감 {likes}</span>
                                </button>
                                <button className="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                                    <span className="mr-1">💬</span>
                                    <span>댓글 {replies.length}</span>
                                </button>
                                <button 
                                    onClick={() => {
                                        if (navigator.share) {
                                            navigator.share({
                                                title: post.title,
                                                text: post.content.substring(0, 100) + '...',
                                                url: window.location.href
                                            });
                                        } else {
                                            // 클립보드에 복사
                                            navigator.clipboard.writeText(window.location.href)
                                                .then(() => alert('링크가 클립보드에 복사되었습니다!'))
                                                .catch(() => {
                                                    // 폴백: 텍스트 선택
                                                    const textArea = document.createElement('textarea');
                                                    textArea.value = window.location.href;
                                                    document.body.appendChild(textArea);
                                                    textArea.select();
                                                    document.execCommand('copy');
                                                    document.body.removeChild(textArea);
                                                    alert('링크가 클립보드에 복사되었습니다!');
                                                });
                                        }
                                    }}
                                    className="flex items-center text-gray-600 hover:text-gray-800 transition-colors"
                                >
                                    <span className="mr-1">📤</span>
                                    <span>공유</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* 댓글 섹션 */}
                    <div className="bg-white rounded-lg shadow-md mt-6 p-6">
                        <h3 className="text-lg font-semibold mb-4">댓글 {replies.length}개</h3>
                        
                        {/* 댓글 작성 */}
                        <div className="mb-6">
                            <textarea
                                value={newReply}
                                onChange={(e) => setNewReply(e.target.value)}
                                placeholder="댓글을 작성해주세요..."
                                className="w-full p-3 border border-gray-200 rounded-lg resize-none"
                                rows="3"
                            />
                            <div className="flex justify-end mt-2">
                                <button
                                    onClick={async () => {
                                        if (!checkCalculationForInteraction('write_reply')) return;
                                        
                                        if (newReply.trim()) {
                                            try {
                                                const replyData = {
                                                    post_id: post.id,
                                                    content: newReply.trim(),
                                                    author_nickname: currentUser?.nickname || currentUser?.email || '익명',
                                                    user_hash: currentUser?.user_hash || null,
                                                    is_anonymous: true,
                                                    created_at: new Date().toISOString()
                                                };

                                                if (supabase) {
                                                    const { data, error } = await supabase
                                                        .from('community_replies')
                                                        .insert([replyData])
                                                        .select();
                                                    
                                                    if (error) throw error;
                                                    setReplies([...replies, data[0]]);
                                                } else {
                                                    // 로컬 상태에만 추가
                                                    setReplies([...replies, { ...replyData, id: Date.now() }]);
                                                }
                                                
                                                setNewReply('');
                                            } catch (error) {
                                                console.error('댓글 저장 오류:', error);
                                                alert('댓글 저장에 실패했습니다.');
                                            }
                                        }
                                    }}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                                >
                                    댓글 작성
                                </button>
                            </div>
                        </div>

                        {/* 댓글 목록 */}
                        <div className="space-y-4">
                            {replies.length === 0 ? (
                                <div className="text-center py-8 text-gray-500">
                                    <div className="text-4xl mb-2">💬</div>
                                    <p>첫 번째 댓글을 작성해보세요!</p>
                                </div>
                            ) : (
                                replies.map((reply, index) => (
                                    <div key={reply.id || index} className="border-b border-gray-100 pb-4">
                                        <div className="flex items-center justify-between text-sm text-gray-500 mb-2">
                                            <div className="flex items-center">
                                                <span className="bg-blue-100 text-blue-600 px-2 py-1 rounded mr-2">
                                                    {reply.author_nickname || '익명'}
                                                </span>
                                                <span>{new Date(reply.created_at).toLocaleDateString('ko-KR')} {new Date(reply.created_at).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</span>
                                            </div>
                                        </div>
                                        <p className="text-gray-800 leading-relaxed">{reply.content}</p>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        // 재산세 계산 함수 (2025년 한국 기준)
        const calculatePropertyTax = (homeValue) => {
            if (!homeValue || homeValue === 0) return 0;
            
            // 주택 공시가격 (만원 → 원)
            const publicValue = homeValue * 10000;
            
            // 과세표준 = 공시가격 × 공정시장가액비율(60%)
            const taxBase = publicValue * 0.6;
            
            // 재산세 = 과세표준 × 세율(0.4%) - 누진공제(63만원)
            const annualPropertyTax = Math.max(0, (taxBase * 0.004) - 630000);
            
            // 월 재산세
            return Math.round(annualPropertyTax / 12);
        };

        // 원본 계산기 완전 통합 (planb-calculator.html에서 추출)
        const OriginalCalculator = ({ savedCalculations = [], onCalculationComplete, setCurrentView }) => {
            const [calculatorStep, setCalculatorStep] = useState(1);
            const [formData, setFormData] = useState({
                age: '', health: '보통', mode: '균형',
                housingType: '', // 주거형태: 'owned_living', 'owned_renting', 'jeonse', 'monthly', 'none'
                financialAssets: '', severancePay: '', 
                // 주거 관련 (주거형태별로 다름)
                homeValue: '', homeMortgage: '', homeMortgageInterest: '',
                ownedHouseDeposit: '', currentDeposit: '', currentRentType: '', currentRent: '',
                jeonseDeposit: '', monthlyDeposit: '', monthlyRent: '',
                investmentRealEstate: '', investmentLoan: '', investmentLoanInterest: '',
                debt: '', debtInterest: '', depositLoan: '', depositLoanInterest: '', inheritance: '',
                nationalPension: '', privatePension: '', housingPension: '', 
                // 은퇴 월 수입
                rentalIncome: '', workIncome: '', financialIncome: '', otherIncome: ''
            });
            const [calculatorResult, setCalculatorResult] = useState(null);
            const [averageData, setAverageData] = useState(null);
            const [showAssetDetail, setShowAssetDetail] = useState(false);
            const [showInheritanceGuide, setShowInheritanceGuide] = useState(false);
            const [lifeExpectancy, setLifeExpectancy] = useState(100);
            const [enableDownsizing, setEnableDownsizing] = useState(false);
            const [isResultSaved, setIsResultSaved] = useState(false);
            const [expenseData, setExpenseData] = useState({
                food: '', communication: '', utilities: '', medical: '', hobby: '', vehicle: '', etc: ''
            });
            const [showExpenseModal, setShowExpenseModal] = useState(false);

            const handleInputChange = (field, value) => {
                const cleanValue = value === '' ? '' : value;
                setFormData({ ...formData, [field]: cleanValue });
            };

            // 다음 단계로 이동하면서 페이지 상단으로 스크롤
            const goToNextStep = (step) => {
                setCalculatorStep(step);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // 나이 입력 시 평균 데이터 업데이트
            useEffect(() => {
                if (formData.age) {
                    setAverageData(getAverageDataByAge(parseInt(formData.age)));
                }
            }, [formData.age]);

            // 기대수명 변경 시 계산 결과 업데이트 (입력 중이 아닐 때만)
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    calculateResults();
                    setIsResultSaved(false);
                }
            }, [lifeExpectancy, enableDownsizing]);

            const getAverageDataByAge = (age) => {
                if (age >= 60) return { financialAssets: 8000, severancePay: 3000, homeValue: 25000, nationalPension: 120, privatePension: 50, debt: 500 };
                if (age >= 55) return { financialAssets: 6500, severancePay: 4000, homeValue: 28000, nationalPension: 100, privatePension: 40, debt: 800 };
                if (age >= 50) return { financialAssets: 5000, severancePay: 5000, homeValue: 30000, nationalPension: 80, privatePension: 30, debt: 1200 };
                if (age >= 45) return { financialAssets: 3500, severancePay: 3500, homeValue: 32000, nationalPension: 60, privatePension: 20, debt: 1500 };
                return { financialAssets: 2000, severancePay: 2000, homeValue: 25000, nationalPension: 40, privatePension: 10, debt: 1000 };
            };

            const formatResultAmount = (amount) => {
                if (amount >= 100000000) {
                    const 억 = Math.floor(amount / 100000000);
                    const 만 = Math.round((amount % 100000000) / 10000);
                    if (만 === 0) return `${억}억원`;
                    return `${억}억 ${만}만원`;
                }
                if (amount >= 10000) {
                    return `${Math.round(amount / 10000)}만원`;
                }
                return `${Math.round(amount).toLocaleString()}원`;
            };
            
            // 컴포넌트 마운트시 저장된 데이터 확인만 (자동 불러오기 안함)
            useEffect(() => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    // 저장된 데이터가 있다는 것만 확인, 자동 불러오기는 하지 않음
                    console.log('저장된 계산결과가 있습니다.');
                }
            }, []);

            const formatAmount = (value) => {
                if (!value || value === '' || value === '0') return '💰 0원';
                const num = parseInt(value);
                if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                return `💰 ${num.toLocaleString()}만원`;
            };

            // AmountInput 컴포넌트

            // 원본 calculateResults 함수 (planb-calculator.html에서 추출)
            const calculateResults = () => {
                const age = parseInt(formData.age);
                
                // 자산 계산 (만원 → 원)
                let housingAsset = 0;
                let housingDebt = 0;
                let monthlyHousingCost = 0;
                
                // 월 대출 이자 (개별 합산)
                const monthlyLoanInterest = 
                    ((parseInt(formData.homeMortgageInterest) || 0) + 
                     (parseInt(formData.investmentLoanInterest) || 0) + 
                     (parseInt(formData.debtInterest) || 0) + 
                     (parseInt(formData.depositLoanInterest) || 0)) * 10000;
                
                if (formData.housingType === 'owned_living') {
                    housingAsset = (parseInt(formData.homeValue) || 0) * 10000;
                    housingDebt = (parseInt(formData.homeMortgage) || 0) * 10000;
                } else if (formData.housingType === 'owned_renting') {
                    housingAsset = (parseInt(formData.homeValue) || 0) * 10000;
                    housingDebt = (parseInt(formData.homeMortgage) || 0) * 10000;
                    if (formData.currentRentType === 'monthly') {
                        monthlyHousingCost = (parseInt(formData.currentRent) || 0) * 10000;
                    }
                } else if (formData.housingType === 'jeonse') {
                    housingAsset = (parseInt(formData.jeonseDeposit) || 0) * 10000;
                } else if (formData.housingType === 'monthly') {
                    housingAsset = (parseInt(formData.monthlyDeposit) || 0) * 10000;
                    monthlyHousingCost = (parseInt(formData.monthlyRent) || 0) * 10000;
                }

                const assets = {
                    financial: (parseInt(formData.financialAssets) || 0) * 10000,
                    severance: (parseInt(formData.severancePay) || 0) * 10000,
                    housing: housingAsset,
                    currentDeposit: (parseInt(formData.currentDeposit) || 0) * 10000,
                    housingDebt: housingDebt,
                    monthlyHousingCost: monthlyHousingCost,
                    investment: (parseInt(formData.investmentRealEstate) || 0) * 10000,
                    investmentLoan: (parseInt(formData.investmentLoan) || 0) * 10000,
                    debt: (parseInt(formData.debt) || 0) * 10000,
                    depositLoan: (parseInt(formData.depositLoan) || 0) * 10000,
                    inheritance: (parseInt(formData.inheritance) || 0) * 10000
                };
                
                // 주거형태별 자산 반영 비율
                const housingPensionAmount = (parseInt(formData.housingPension) || 0);
                let housingValueRatio = 0;
                
                if (formData.housingType === 'owned_living') {
                    if (housingPensionAmount > 0) {
                        housingValueRatio = 1.0;
                    } else if (enableDownsizing) {
                        housingValueRatio = 0.75;
                    } else {
                        housingValueRatio = 0;
                    }
                } else if (formData.housingType === 'owned_renting') {
                    if (enableDownsizing) {
                        housingValueRatio = 0.75;
                    } else {
                        housingValueRatio = 0;
                    }
                } else if (formData.housingType === 'jeonse' || formData.housingType === 'monthly') {
                    housingValueRatio = 1.0;
                }
                
                const ownedHouseDepositDebt = (parseInt(formData.ownedHouseDeposit) || 0) * 10000;
                
                // 주택 매각 시 실제 매각 가능 금액 계산
                let realizedHousingAsset = 0;
                if (formData.housingType === 'owned_living' && enableDownsizing) {
                    realizedHousingAsset = Math.max(0, (assets.housing * housingValueRatio) - assets.housingDebt);
                } else if (formData.housingType === 'owned_renting' && enableDownsizing) {
                    realizedHousingAsset = Math.max(0, (assets.housing * housingValueRatio) - ownedHouseDepositDebt - assets.housingDebt);
                } else {
                    realizedHousingAsset = assets.housing * housingValueRatio;
                }
                
                // 주택연금 선택 시 주택 자산 처리
                let housingAssetForUsable = realizedHousingAsset;
                if (parseInt(formData.housingPension) > 0) {
                    housingAssetForUsable = 0;
                }
                
                const usableAssetsGross = assets.financial + assets.severance + housingAssetForUsable;
                const usableAssets = usableAssetsGross;
                
                const totalDebts = (enableDownsizing ? 0 : assets.housingDebt) + assets.investmentLoan + assets.debt + assets.depositLoan +
                    (enableDownsizing && formData.housingType === 'owned_renting' ? 0 : ownedHouseDepositDebt);
                
                const unusableAssets = assets.investment + assets.inheritance +
                    (!enableDownsizing && !parseInt(formData.housingPension) && parseInt(formData.homeValue) > 0 ? (parseInt(formData.homeValue) || 0) * 10000 : 0);
                
                const allAssets = assets.financial + assets.severance + assets.housing + assets.currentDeposit + assets.investment + assets.inheritance;
                const totalAssets = Math.max(0, allAssets - totalDebts);
                
                const emergencyFund = assets.financial * 0.1;
                const availableAssets = Math.max(0, usableAssets - emergencyFund);
                
                const yearsToLive = lifeExpectancy - age;
                const annualWithdrawal = availableAssets / yearsToLive;
                const dailyAmount = annualWithdrawal / 365;
                const monthlyAmount = annualWithdrawal / 12;
                
                const monthlyPension = (parseInt(formData.nationalPension) || 0) + (parseInt(formData.privatePension) || 0) + (parseInt(formData.housingPension) || 0);
                const monthlyOtherIncome = (parseInt(formData.rentalIncome) || 0) + (parseInt(formData.workIncome) || 0) + (parseInt(formData.financialIncome) || 0) + (parseInt(formData.otherIncome) || 0);
                
                // 재산세 계산 (주택 소유시에만)
                const monthlyPropertyTax = (formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') ? 
                    calculatePropertyTax(parseInt(formData.homeValue) || 0) : 0;
                
                const totalMonthlyAvailable = Math.round(monthlyAmount) + (monthlyPension * 10000) + (monthlyOtherIncome * 10000) - monthlyHousingCost - monthlyLoanInterest - monthlyPropertyTax;
                const totalDailyAvailable = Math.round(totalMonthlyAvailable / 30.4);
                
                const result = {
                    dailyAmount: Math.round(dailyAmount),
                    monthlyAmount: Math.round(monthlyAmount),
                    annualAmount: Math.round(annualWithdrawal),
                    totalDailyAvailable: totalDailyAvailable,
                    totalMonthlyAvailable: Math.round(totalMonthlyAvailable),
                    monthlyLivingCost: Math.round(totalMonthlyAvailable),
                    totalAssets: Math.round(totalAssets / 10000), // 만원 단위로 변환
                    assetSufficiencyYears: yearsToLive,
                    housingType: formData.housingType,
                    yearsToLive: yearsToLive,
                    assetBreakdown: {
                        totalAssets, usableAssets, usableAssetsGross, unusableAssets, availableAssets, emergencyFund, totalDebts,
                        financial: assets.financial, severance: assets.severance,
                        housing: assets.housing, realizedHousingAsset: realizedHousingAsset, currentDeposit: assets.currentDeposit, housingDebt: assets.housingDebt, housingValueRatio: housingValueRatio,
                        monthlyHousingCost: assets.monthlyHousingCost,
                        investment: assets.investment, investmentLoan: assets.investmentLoan,
                        debt: assets.debt, inheritance: assets.inheritance, 
                        housingPensionAmount: housingPensionAmount,
                        housingType: formData.housingType,
                        enableDownsizing: enableDownsizing,
                        ownedHouseDepositDebt: ownedHouseDepositDebt
                    },
                    monthlyPension: monthlyPension * 10000,
                    monthlyOtherIncome: monthlyOtherIncome * 10000,
                    monthlyHousingCost: monthlyHousingCost,
                    monthlyLoanInterest: monthlyLoanInterest,
                    monthlyPropertyTax: monthlyPropertyTax,
                    safetyLevel: totalMonthlyAvailable >= 2500000 ? '안전' : totalMonthlyAvailable >= 1800000 ? '보통' : '주의' // KB금융 최소 251만원(안전), 정부 적정 177만원(보통), 정부 최소 124만원(주의)
                };

                setCalculatorResult(result);
                
                // 세션 생성을 위한 콜백 호출
                if (onCalculationComplete) {
                    onCalculationComplete(result);
                }
                
                setCalculatorStep(4);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };


            const openExpenseModal = () => {
                setShowExpenseModal(true);
            };

            const closeExpenseModal = () => {
                setShowExpenseModal(false);
            };

            const handleExpenseChange = (field, value) => {
                setExpenseData({ ...expenseData, [field]: value });
            };
            
            // 지출 입력 컴포넌트 (AmountInput과 동일한 스타일)
            const ExpenseInput = ({ label, field, value, placeholder }) => {
                const formatAmount = (value) => {
                    if (!value || value === '' || value === '0') return '💰 0원';
                    const num = parseInt(value);
                    if (num >= 10000) return `💰 ${(num / 10000).toFixed(1)}억원`;
                    if (num >= 1000) return `💰 ${Math.round(num / 1000)}천만원`;
                    return `💰 ${num.toLocaleString()}만원`;
                };

                return (
                    <div>
                        <label className="block text-xl font-semibold text-gray-800 mb-3">{label}</label>
                        <input
                            type="text"
                            inputMode="numeric"
                            pattern="[0-9]*"
                            value={value}
                            onChange={(e) => {
                                const numValue = e.target.value.replace(/[^0-9]/g, '');
                                handleExpenseChange(field, numValue);
                            }}
                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                            placeholder={placeholder}
                            autoComplete="off"
                        />
                        <div className="text-green-600 font-semibold text-lg mt-1">
                            {formatAmount(value)}
                        </div>
                    </div>
                );
            };

            // 2024년 통계청 가계동향조사 데이터 (만원 단위)
            const getStatKoreaData = () => ({
                food: 41, // 식료품·비주류음료 41.2만원
                communication: 14, // 통신비 (정보통신 포함) 14만원 추정
                utilities: 35, // 주거·수도·광열 35만원
                medical: 24, // 보건 23.9만원
                hobby: 31, // 오락·문화 31만원 추정
                vehicle: 33, // 교통비 33.5만원
                etc: 20 // 기타 (의류·신발, 가정용품 등) 20만원 추정
            });
            
            const submitExpenseData = () => {
                // 통계청 데이터와 비교
                const statData = getStatKoreaData();
                const userTotal = Object.values(expenseData).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                const statTotal = Object.values(statData).reduce((sum, val) => sum + val, 0);
                
                setExpenseComparison({
                    user: expenseData,
                    stat: statData,
                    userTotal: userTotal,
                    statTotal: statTotal
                });
                
                setShowExpenseModal(false);
                setShowComparisonModal(true);
            };
            
            const [expenseComparison, setExpenseComparison] = useState(null);
            const [showComparisonModal, setShowComparisonModal] = useState(false);
            
            // 계산결과 저장 함수 (익명)
            const saveCalculationResult = () => {
                if (!calculatorResult) return;
                
                // localStorage에 익명으로 저장
                const savedResult = {
                    ...calculatorResult,
                    formData: formData,
                    lifeExpectancy: lifeExpectancy,
                    enableDownsizing: enableDownsizing,
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('planb_calculation_result', JSON.stringify(savedResult));
                setIsResultSaved(true);
                
                showNotification('저장 완료', '계산결과가 저장되었습니다! 💾\n브라우저에 저장되어 언제든 다시 확인할 수 있습니다.', 'success');
            };
            
            // 저장된 계산결과 불러오기 (localStorage)
            const loadCalculationResult = () => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    try {
                        const savedData = JSON.parse(saved);
                        setFormData(savedData.formData);
                        setCalculatorResult(savedData);
                        setLifeExpectancy(savedData.lifeExpectancy);
                        setEnableDownsizing(savedData.enableDownsizing);
                        setCalculatorStep(4);
                        setIsResultSaved(true);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        showNotification('불러오기 완료', '저장된 계산결과를 불러왔습니다! 📊', 'success');
                    } catch (error) {
                        console.error('저장된 데이터 불러오기 실패:', error);
                        showNotification('불러오기 실패', '저장된 데이터를 불러오는데 실패했습니다.', 'error');
                    }
                } else {
                    showNotification('저장된 데이터 없음', '아직 저장된 계산결과가 없습니다.', 'info');
                }
            };
            

            // 추가 필수 함수들
            const [activeTab, setActiveTab] = useState('expense');

            const joinCommunity = () => {
                showNotification('커뮤니티 출시 예정', '커뮤니티 기능이 곧 출시됩니다! 🎉\n비슷한 고민을 가진 분들과 소통할 수 있어요.', 'info');
            };

            // 기대수명 변경 시 결과 재계산
            const recalculateWithLifeExpectancy = () => {
                if (calculatorResult && lifeExpectancy) {
                    const yearsToLive = lifeExpectancy - parseInt(formData.age);
                    const monthlyAmount = calculatorResult.assetBreakdown?.availableAssets ? 
                        Math.floor(calculatorResult.assetBreakdown.availableAssets / yearsToLive / 12) : 0;
                    
                    const totalMonthlyAvailable = monthlyAmount + (calculatorResult.monthlyPension || 0) + 
                        (calculatorResult.monthlyOtherIncome || 0) - (calculatorResult.monthlyHousingCost || 0) - 
                        (calculatorResult.monthlyLoanInterest || 0) - (calculatorResult.monthlyPropertyTax || 0);
                    
                    const updatedResult = {
                        ...calculatorResult,
                        yearsToLive: yearsToLive,
                        monthlyAmount: monthlyAmount,
                        totalMonthlyAvailable: totalMonthlyAvailable,
                        totalDailyAvailable: Math.floor(totalMonthlyAvailable / 30),
                        safetyLevel: totalMonthlyAvailable >= 2500000 ? '안전' : totalMonthlyAvailable >= 1800000 ? '보통' : '주의'
                    };
                    
                    setCalculatorResult(updatedResult);
                }
            };

            // 기대수명이 변경될 때마다 재계산
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    recalculateWithLifeExpectancy();
                }
            }, [lifeExpectancy]);

            // 다운사이징 옵션 변경 시 재계산
            useEffect(() => {
                if (calculatorResult && calculatorStep === 4) {
                    // 다운사이징 옵션 변경시 재계산 수행
                    calculateResults();
                }
            }, [enableDownsizing]);

            // 1단계 렌더링
            if (calculatorStep === 1) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => setCurrentView('main')}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    메인으로 돌아가기
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🧮 은퇴생활비 계산기</h1>
                                <p className="text-xl text-gray-600">나이와 건강상태를 입력해주세요</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '33%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">1단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="space-y-6">
                                    <div className="mb-6">
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🎂 나이</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            pattern="[0-9]*"
                                            value={formData.age}
                                            onChange={(e) => {
                                                const numValue = e.target.value.replace(/[^0-9]/g, '');
                                                handleInputChange('age', numValue);
                                            }}
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            placeholder=""
                                            autoComplete="off"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">💪 건강 상태</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.health}
                                            onChange={(e) => handleInputChange('health', e.target.value)}
                                        >
                                            <option value="양호">양호 (운동 규칙적, 큰 질병 없음)</option>
                                            <option value="보통">보통 (일반적인 건강 상태)</option>
                                            <option value="주의필요">주의필요 (만성질환 있거나 관리 필요)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🎯 생활 모드</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.mode}
                                            onChange={(e) => handleInputChange('mode', e.target.value)}
                                        >
                                            <option value="보수적">보수적 (안전 우선, 여유자금 확보)</option>
                                            <option value="균형">균형 (평균적인 생활 수준 유지)</option>
                                            <option value="적극적">적극적 (여유있는 생활, 취미활동)</option>
                                        </select>
                                    </div>

                                    <button
                                        onClick={() => goToNextStep(2)}
                                        className="btn-primary w-full text-xl py-4"
                                        disabled={!formData.age || !formData.health || !formData.mode}
                                    >
                                        다음 단계 →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 2단계 렌더링 (자산 정보)
            if (calculatorStep === 2) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(1)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    이전 단계
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🏠 자산 정보</h1>
                                <p className="text-xl text-gray-600">현재 보유하고 계신 자산을 입력해주세요</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '66%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">2단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="bg-green-50 border-l-4 border-green-400 p-6 mb-8 rounded-r-lg">
                                    <p className="text-lg text-green-800">
                                        😊 <strong>정확한 수치를 모르시는 경우에는</strong><br/>
                                        알고 계신 대략적인 금액을 입력하시면 됩니다.
                                    </p>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xl font-semibold text-gray-800 mb-3">🏠 주거 형태</label>
                                        <select
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            value={formData.housingType}
                                            onChange={(e) => handleInputChange('housingType', e.target.value)}
                                        >
                                            <option value="">선택하세요</option>
                                            <option value="owned_living">자가 소유 + 거주</option>
                                            <option value="owned_renting">자가 소유 + 전세/월세 거주</option>
                                            <option value="jeonse">전세</option>
                                            <option value="monthly">월세</option>
                                            <option value="none">무주택</option>
                                        </select>
                                    </div>

                                    <AmountInput
                                        label="🏦 현금 및 현금성 자산 (예금·적금·주식·펀드 등, 단위: 만원)"
                                        value={formData.financialAssets}
                                        onChange={(v) => handleInputChange('financialAssets', v)}
                                        placeholder=""
                                    />

                                    <AmountInput
                                        label="💼 퇴직금 (은퇴시 받을 퇴직금 또는 현재 남아있는 퇴직금, 단위: 만원)"
                                        value={formData.severancePay}
                                        onChange={(v) => handleInputChange('severancePay', v)}
                                        placeholder=""
                                    />

                                    {/* 주거형태별 조건부 필드 */}
                                    {(formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') && (
                                        <>
                                            <AmountInput
                                                label="🏠 자가 소유 주택 시세 (단위: 만원)"
                                                value={formData.homeValue}
                                                onChange={(v) => handleInputChange('homeValue', v)}
                                                placeholder=""
                                            />
                                            <AmountInput
                                                label="🏠 주택담보대출 잔액 (단위: 만원)"
                                                value={formData.homeMortgage}
                                                onChange={(v) => handleInputChange('homeMortgage', v)}
                                                placeholder=""
                                            />
                                            {formData.homeMortgage && parseInt(formData.homeMortgage) > 0 && (
                                                <div className="space-y-4">
                                                    <AmountInput
                                                        label="💳 월 대출상환액 (매달 나가는 돈, 단위: 만원)"
                                                        value={formData.homeMortgagePayment}
                                                        onChange={(v) => handleInputChange('homeMortgagePayment', v)}
                                                        placeholder="예: 50만원"
                                                    />
                                                    
                                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                                        <div className="flex items-center mb-3">
                                                            <input
                                                                type="checkbox"
                                                                id="knowLoanEndYear"
                                                                checked={formData.knowLoanEndYear || false}
                                                                onChange={(e) => handleInputChange('knowLoanEndYear', e.target.checked)}
                                                                className="mr-2 scale-125"
                                                            />
                                                            <label htmlFor="knowLoanEndYear" className="text-blue-800 font-semibold">
                                                                📅 대출 완료 예정년도를 알고 있어요
                                                            </label>
                                                        </div>
                                                        
                                                        {!formData.knowLoanEndYear && (
                                                            <p className="text-blue-700 text-sm">
                                                                ℹ️ 체크하지 않으면 <strong>보수적으로 계산</strong>합니다.<br/>
                                                                (은퇴 후에도 계속 상환한다고 가정)
                                                            </p>
                                                        )}
                                                    </div>

                                                    {formData.knowLoanEndYear && (
                                                        <div>
                                                            <label className="block text-xl font-semibold text-gray-800 mb-3">📅 대출 완료 예정년도</label>
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                pattern="[0-9]*"
                                                                value={formData.loanEndYear || ''}
                                                                onChange={(e) => {
                                                                    const year = e.target.value.replace(/[^0-9]/g, '');
                                                                    if (year.length <= 4) {
                                                                        handleInputChange('loanEndYear', year);
                                                                    }
                                                                }}
                                                                className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                                placeholder="예: 2030"
                                                            />
                                                            {formData.loanEndYear && (
                                                                <div className="text-green-600 font-semibold text-lg mt-1">
                                                                    ✅ {formData.loanEndYear}년 이후 월 {formData.homeMortgagePayment ? parseInt(formData.homeMortgagePayment).toLocaleString() : 0}만원 절약!
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {formData.housingType === 'owned_renting' && (
                                        <>
                                            <AmountInput
                                                label="🏠 내 소유 집 임차인 보증금 (내가 받은 보증금, 단위: 만원)"
                                                value={formData.ownedHouseDeposit}
                                                onChange={(v) => handleInputChange('ownedHouseDeposit', v)}
                                                placeholder=""
                                            />

                                            <AmountInput
                                                label="🏠 현재 거주지 보증금 (내가 낸 보증금, 단위: 만원)"
                                                value={formData.currentDeposit}
                                                onChange={(v) => handleInputChange('currentDeposit', v)}
                                                placeholder=""
                                            />
                                            
                                            <AmountInput
                                                label="💳 보증금 대출 잔액 (단위: 만원)"
                                                value={formData.depositLoan}
                                                onChange={(v) => handleInputChange('depositLoan', v)}
                                                placeholder=""
                                            />
                                            {formData.depositLoan && parseInt(formData.depositLoan) > 0 && (
                                                <div className="space-y-4">
                                                    <AmountInput
                                                        label="💳 보증금 대출 월 상환액 (매달 나가는 돈, 단위: 만원)"
                                                        value={formData.depositLoanPayment}
                                                        onChange={(v) => handleInputChange('depositLoanPayment', v)}
                                                        placeholder="예: 30만원"
                                                    />
                                                    
                                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                                        <div className="flex items-center mb-3">
                                                            <input
                                                                type="checkbox"
                                                                id="knowDepositLoanEndYear"
                                                                checked={formData.knowDepositLoanEndYear || false}
                                                                onChange={(e) => handleInputChange('knowDepositLoanEndYear', e.target.checked)}
                                                                className="mr-2 scale-125"
                                                            />
                                                            <label htmlFor="knowDepositLoanEndYear" className="text-blue-800 font-semibold">
                                                                📅 대출 완료 예정년도를 알고 있어요
                                                            </label>
                                                        </div>
                                                    </div>

                                                    {formData.knowDepositLoanEndYear && (
                                                        <div>
                                                            <label className="block text-xl font-semibold text-gray-800 mb-3">📅 대출 완료 예정년도</label>
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                pattern="[0-9]*"
                                                                value={formData.depositLoanEndYear || ''}
                                                                onChange={(e) => {
                                                                    const year = e.target.value.replace(/[^0-9]/g, '');
                                                                    if (year.length <= 4) {
                                                                        handleInputChange('depositLoanEndYear', year);
                                                                    }
                                                                }}
                                                                className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                                placeholder="예: 2028"
                                                            />
                                                            {formData.depositLoanEndYear && (
                                                                <div className="text-green-600 font-semibold text-lg mt-1">
                                                                    ✅ {formData.depositLoanEndYear}년 이후 월 {formData.depositLoanPayment ? parseInt(formData.depositLoanPayment).toLocaleString() : 0}만원 절약!
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            <div className="mb-6">
                                                <label className="block text-xl font-semibold text-gray-800 mb-3">🏠 현재 거주 형태</label>
                                                <select
                                                    className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                                    value={formData.currentRentType}
                                                    onChange={(e) => handleInputChange('currentRentType', e.target.value)}
                                                >
                                                    <option value="">선택하세요</option>
                                                    <option value="jeonse">전세</option>
                                                    <option value="monthly">월세</option>
                                                </select>
                                            </div>

                                            {formData.currentRentType === 'monthly' && (
                                                <AmountInput
                                                    label="🏠 현재 거주지 월세 (내가 내는 월세, 단위: 만원)"
                                                    value={formData.currentRent}
                                                    onChange={(v) => handleInputChange('currentRent', v)}
                                                    placeholder=""
                                                    />
                                            )}
                                        </>
                                    )}

                                    {formData.housingType === 'jeonse' && (
                                        <AmountInput
                                            label="🏠 전세보증금 (단위: 만원)"
                                            value={formData.jeonseDeposit}
                                            onChange={(v) => handleInputChange('jeonseDeposit', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    {formData.housingType === 'monthly' && (
                                        <>
                                            <AmountInput
                                                label="🏠 월세보증금 (단위: 만원)"
                                                value={formData.monthlyDeposit}
                                                onChange={(v) => handleInputChange('monthlyDeposit', v)}
                                                placeholder=""
                                            />
                                            <AmountInput
                                                label="🏠 월세 (단위: 만원)"
                                                value={formData.monthlyRent}
                                                onChange={(v) => handleInputChange('monthlyRent', v)}
                                                placeholder=""
                                            />
                                        </>
                                    )}

                                    <AmountInput
                                        label="🏢 수익형 부동산 (오피스텔·상가 등, 단위: 만원)"
                                        value={formData.investmentRealEstate}
                                        onChange={(v) => handleInputChange('investmentRealEstate', v)}
                                        placeholder=""
                                        averageAmount={0}
                                    />

                                    <AmountInput
                                        label="🏢 수익형 부동산 대출 잔액 (단위: 만원)"
                                        value={formData.investmentLoan}
                                        onChange={(v) => handleInputChange('investmentLoan', v)}
                                        placeholder=""
                                        averageAmount={0}
                                    />
                                    {formData.investmentLoan && parseInt(formData.investmentLoan) > 0 && (
                                        <AmountInput
                                            label="💳 수익형 부동산 대출 월 이자 (단위: 만원)"
                                            value={formData.investmentLoanInterest}
                                            onChange={(v) => handleInputChange('investmentLoanInterest', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    <AmountInput
                                        label="💳 기타 대출 잔액 (단위: 만원)"
                                        value={formData.debt}
                                        onChange={(v) => handleInputChange('debt', v)}
                                        placeholder=""
                                    />
                                    {formData.debt && parseInt(formData.debt) > 0 && (
                                        <AmountInput
                                            label="💳 기타 대출 월 이자 (단위: 만원)"
                                            value={formData.debtInterest}
                                            onChange={(v) => handleInputChange('debtInterest', v)}
                                            placeholder=""
                                            averageAmount={0}
                                        />
                                    )}

                                    <div className="mb-6">
                                        <div className="flex items-center gap-2 mb-3">
                                            <label className="block text-xl font-semibold text-gray-800">👨‍👩‍👧‍👦 가족 증여 또는 상속 예정액 (단위: 만원)</label>
                                            <button
                                                onClick={() => setShowInheritanceGuide(!showInheritanceGuide)}
                                                className="text-blue-500 bg-blue-50 rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-blue-100"
                                            >
                                                ?
                                            </button>
                                        </div>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            pattern="[0-9]*"
                                            value={formData.inheritance}
                                            onChange={(e) => {
                                                const numValue = e.target.value.replace(/[^0-9]/g, '');
                                                handleInputChange('inheritance', numValue === '' ? '' : numValue);
                                            }}
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg"
                                            placeholder=""
                                            autoComplete="off"
                                        />
                                        <div className="text-green-600 font-semibold text-lg mt-1">{formatAmount(formData.inheritance)}</div>
                                        
                                        {showInheritanceGuide && (
                                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-3 rounded-r-lg">
                                                <div className="text-yellow-800">
                                                    <p className="font-semibold mb-2">📊 참고 가이드라인</p>
                                                    <ul className="text-sm space-y-1">
                                                        <li>• <strong>생애 평균:</strong> 약 2,000만원 (한국조세재정연구원 2022)</li>
                                                        <li>• <strong>부모 1인당:</strong> 평균 1,000만원 내외</li>
                                                        <li>• <strong>시기:</strong> 대부분 50-70대에 받음</li>
                                                        <li>• <strong>형태:</strong> 현금, 부동산, 주식 등 다양</li>
                                                    </ul>
                                                    <p className="text-xs mt-2 text-yellow-700">
                                                        * 가족 상황에 따라 큰 차이가 있으니 예상 가능한 금액만 입력하세요
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-4 mt-8">
                                        <button
                                            onClick={() => goToNextStep(1)}
                                            className="flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200"
                                        >
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                            </svg>
                                            이전 단계
                                        </button>
                                        <button
                                            onClick={() => goToNextStep(3)}
                                            className="btn-primary flex-1"
                                            disabled={!formData.housingType}
                                        >
                                            다음 단계 →
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 3단계 렌더링 (추가 수입·지출)
            if (calculatorStep === 3) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(2)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    이전 단계
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">📋 추가 수입·지출</h1>
                                <p className="text-xl text-gray-600">매달 들어오는 연금이나 나가는 고정비용 (선택사항)</p>
                                <div className="w-full bg-gray-200 rounded-full h-4 mt-6 max-w-md mx-auto">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{width: '100%'}}></div>
                                </div>
                                <p className="text-lg text-gray-500 mt-3">3단계 / 3단계</p>
                            </div>

                            <div className="card">
                                <div className="bg-green-50 border-l-4 border-green-400 p-6 mb-8 rounded-r-lg">
                                    <p className="text-lg text-green-800">
                                        😊 <strong>정확한 수치를 모르시는 경우에는</strong><br/>
                                        알고 계신 대략적인 금액을 입력하시면 됩니다.
                                    </p>
                                </div>

                                <h2 className="text-2xl font-bold mb-6 text-gray-800">📈 매달 받는 연금 (단위: 만원)</h2>
                                
                                <AmountInput
                                    label="🏛️ 국민연금 (월 수령액)"
                                    value={formData.nationalPension}
                                    onChange={(v) => handleInputChange('nationalPension', v)}
                                    placeholder=""
                                />
                                
                                <AmountInput
                                    label="💰 개인연금 (월 수령액)"
                                    value={formData.privatePension}
                                    onChange={(v) => handleInputChange('privatePension', v)}
                                    placeholder=""
                                />
                                
                                <AmountInput
                                    label="🏠 주택연금 (월 수령액)"
                                    value={formData.housingPension}
                                    onChange={(v) => handleInputChange('housingPension', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />

                                <h2 className="text-2xl font-bold mb-6 mt-8 text-gray-800">💼 기타 월 수입 (단위: 만원)</h2>
                                
                                <AmountInput
                                    label="🏠 임대소득 (월 수령액)"
                                    value={formData.rentalIncome}
                                    onChange={(v) => handleInputChange('rentalIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="💼 근로소득 (파트타임, 자문료 등)"
                                    value={formData.workIncome}
                                    onChange={(v) => handleInputChange('workIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="💰 금융소득 (배당금, 이자 등)"
                                    value={formData.financialIncome}
                                    onChange={(v) => handleInputChange('financialIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />
                                
                                <AmountInput
                                    label="📚 기타소득 (강의, 로열티 등)"
                                    value={formData.otherIncome}
                                    onChange={(v) => handleInputChange('otherIncome', v)}
                                    placeholder=""
                                    averageAmount={0}
                                />

                                <div className="flex gap-4 mt-8">
                                    <button
                                        onClick={() => goToNextStep(2)}
                                        className="flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors duration-200"
                                    >
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                        </svg>
                                        이전 단계
                                    </button>
                                    <button
                                        onClick={calculateResults}
                                        className="btn-primary flex-1"
                                    >
                                        🚀 은퇴생활비 계산하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 결과 화면 (원본에서 추출한 완전한 버전)
            if (calculatorStep === 4 && calculatorResult) {
                return (
                    <div className="min-h-screen py-8 px-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <button
                                    onClick={() => goToNextStep(3)}
                                    className="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                    </svg>
                                    다시 계산하기
                                </button>
                                <div className="flex-1"></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-3">🎉 은퇴생활비 계산 완료!</h1>
                            </div>

                            <div className="card mb-6">
                                <div className="text-center">
                                    <div className="text-5xl font-bold text-blue-600 mb-4">
                                        하루 {formatResultAmount(calculatorResult.totalDailyAvailable)}
                                    </div>
                                    <div className="text-3xl text-gray-600 mb-4">
                                        월 {formatResultAmount(calculatorResult.totalMonthlyAvailable)}
                                    </div>
                                    
                                    {/* 안전 수준 표시 */}
                                    <div className={`inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4 ${
                                        calculatorResult.safetyLevel === '안전' ? 'bg-green-500' :
                                        calculatorResult.safetyLevel === '보통' ? 'bg-yellow-500' : 'bg-red-500'
                                    }`}>
                                        {calculatorResult.safetyLevel} 수준
                                    </div>
                                    
                                    {/* 기대수명 조정 */}
                                    <div className="bg-blue-50 p-4 rounded-lg mb-4 max-w-md mx-auto">
                                        <div className="flex items-center justify-center gap-3 mb-2">
                                            <span className="text-sm font-medium text-blue-800">기대수명:</span>
                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={() => setLifeExpectancy(Math.max(70, lifeExpectancy - 5))}
                                                    className="w-8 h-8 bg-blue-200 hover:bg-blue-300 rounded-full flex items-center justify-center text-blue-700 font-bold"
                                                >
                                                    -
                                                </button>
                                                <span className="font-bold text-lg text-blue-600 min-w-[50px] text-center">{lifeExpectancy}세</span>
                                                <button 
                                                    onClick={() => setLifeExpectancy(Math.min(110, lifeExpectancy + 5))}
                                                    className="w-8 h-8 bg-blue-200 hover:bg-blue-300 rounded-full flex items-center justify-center text-blue-700 font-bold"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                        <div className="text-xs text-blue-600 text-center">
                                            {formData.age}세부터 {lifeExpectancy}세까지 ({lifeExpectancy - parseInt(formData.age)}년간) 자산 보존
                                        </div>
                                    </div>

                                    
                                    {/* 계산 결과 저장 */}
                                    {!isResultSaved ? (
                                        <div className="text-center mb-6">
                                            <button
                                                onClick={saveCalculationResult}
                                                className="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300"
                                            >
                                                💾 내 계산결과 저장하기
                                            </button>
                                            <div className="text-sm text-blue-600 mt-2 font-medium">
                                                계산 결과를 저장하면 나와 비슷한 사람들과 이야기할 수 있어요!
                                            </div>
                                            <div className="text-sm text-gray-500 mt-1">
                                                언제든지 다시 계산하고 업데이트 할 수 있습니다
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center mb-6">
                                            <div className="inline-block px-6 py-3 bg-green-100 text-green-800 rounded-lg font-semibold">
                                                ✅ 계산결과가 저장되었습니다!
                                            </div>
                                            <div className="text-sm text-gray-500 mt-2">
                                                언제든지 다시 계산하고 업데이트 할 수 있습니다
                                            </div>
                                            <div className="text-sm text-blue-600 mt-1 font-medium">
                                                👇 아래에서 비슷한 분들과 소통해보세요
                                            </div>
                                        </div>
                                    )}
                                    
                                </div>
                            </div>
                            
                            {/* 커뮤니티 섹션 - 저장 후에만 표시 */}
                            {isResultSaved && (
                                <div className="card mb-6">
                                    <h3 className="text-xl font-bold mb-4">👥 나와 비슷한 사람들과 소통해보세요</h3>
                                
                                    {/* 탭 네비게이션 */}
                                    <div className="grid grid-cols-3 gap-2 mb-6">
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'expense' 
                                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            onClick={() => setActiveTab('expense')}
                                        >
                                            📊 지출내역 공유
                                        </button>
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'community' 
                                                    ? 'bg-gradient-to-r from-green-500 to-blue-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200 animate-pulse'
                                            }`}
                                            onClick={() => setActiveTab('community')}
                                        >
                                            💬 커뮤니티 참여
                                        </button>
                                        <button
                                            className={`py-3 px-3 rounded-lg font-semibold transition-all duration-300 text-sm ${
                                                activeTab === 'expert' 
                                                    ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg' 
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            onClick={() => setActiveTab('expert')}
                                        >
                                            🔍 전문가 찾기
                                        </button>
                                    </div>

                                    {/* 지출내역 공유 탭 */}
                                    {activeTab === 'expense' && (
                                        <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg">
                                            <div className="bg-white p-4 rounded-lg mb-4">
                                                <p className="text-gray-800 font-semibold">
                                                    💰 <strong>지출내역 입력</strong> 후<br/>
                                                    비슷한 사람들이 어떻게 돈을 쓰고 있는지 확인할 수 있습니다.
                                                </p>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2 mb-4 text-xs">
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"식비는 얼마가 적당할까요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"다른사람은 의료비를 얼마나 쓸까요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"취미·여가비 현실적인 기준은?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-purple-600">"차량유지비는 얼마나 나올까요?"</div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-purple-100 p-3 rounded-lg mb-4 text-center">
                                                <p className="text-purple-800 font-semibold">
                                                    📈 <strong>더 나은 서비스 제공을 위해서만 익명으로 활용됩니다</strong>
                                                </p>
                                                <p className="text-purple-700 text-sm">내 또래의 실제 지출 패턴을 확인하세요</p>
                                            </div>
                                            
                                            <button
                                                onClick={openExpenseModal}
                                                className="w-full text-lg py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold transform hover:scale-105 transition-all duration-300"
                                            >
                                                📝 지출내역 입력하기
                                            </button>
                                        </div>
                                    )}

                                    {/* 커뮤니티 참여 탭 */}
                                    {activeTab === 'community' && (
                                        <div className="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg">
                                            <div className="bg-white p-4 rounded-lg mb-4">
                                                <p className="text-gray-800 font-semibold">
                                                    🤝 <strong>익명 라이프스타일 커뮤니티</strong>에서<br/>
                                                    비슷한 자산과 나이대({formData.age}세)의 사람들과 솔직한 경험을 나누어보세요.
                                                </p>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2 mb-4 text-xs">
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"실제로 이 돈으로 살 수 있나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"예상치 못한 비용들은 뭐가 있나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"어떤 서비스들을 실제로 이용하시나요?"</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg text-center">
                                                    <div className="font-bold text-blue-600">"은퇴 생활의 현실적인 팁들"</div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-green-100 p-3 rounded-lg mb-4 text-center">
                                                <p className="text-green-800 font-semibold">
                                                    ✨ <strong>금융상품 판매는 일체 없습니다</strong> ✨
                                                </p>
                                                <p className="text-green-700 text-sm">순수 라이프스타일 커뮤니티입니다</p>
                                            </div>
                                            
                                            <button
                                                onClick={joinCommunity}
                                                className="w-full text-lg py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg font-semibold transform hover:scale-105 transition-all duration-300"
                                            >
                                                🤝 익명 커뮤니티 참여하기
                                            </button>
                                        </div>
                                    )}

                                    {/* 전문가 찾기 탭 */}
                                    {activeTab === 'expert' && (
                                        <ExpertFinderComponent currentUser={currentUser} />
                                    )}
                                </div>
                            )}

                            <div className="card mb-6">
                                <h3 className="text-xl font-bold mb-4">💰 수입 구성</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span>자산을 활용한 생활비:</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold">{formatResultAmount(calculatorResult.monthlyAmount)}/월</span>
                                            <button
                                                onClick={() => setShowAssetDetail(!showAssetDetail)}
                                                className="text-white text-sm px-3 py-2 bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors font-semibold shadow-md animate-pulse"
                                            >
                                                {showAssetDetail ? '📊 계산과정 숨기기' : '📊 계산과정 보기'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {!showAssetDetail && (
                                        <div className="text-center mt-2">
                                            <p className="text-xs text-blue-600">💡 계산과정을 보시면 자산 분류와 주택 매각 옵션을 확인할 수 있습니다</p>
                                        </div>
                                    )}

                                    {/* 자산 계산 상세 설명 */}
                                    {showAssetDetail && (
                                        <div className="bg-blue-50 p-4 rounded-lg mt-3 space-y-3 text-sm">
                                            <div className="font-semibold text-blue-800 mb-2">📊 계산 과정</div>
                                            
                                            <div className="space-y-3">
                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="font-medium">• 순 자산:</span>
                                                        <span className="font-bold">{formatResultAmount(calculatorResult.assetBreakdown?.totalAssets || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600 mb-3">입력하신 모든 자산을 생활비로 쓸 수 있는 자산과 쓸 수 없는 자산으로 구분했습니다</p>
                                                    
                                                    {/* 자산 구분 테이블 */}
                                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                                        {/* 돈이 나오는 자산 */}
                                                        <div className="bg-green-50 p-2 rounded border border-green-200">
                                                            <div className="font-semibold text-green-800 mb-2">💰 생활비로 쓸 수 있는 자산</div>
                                                            <div className="space-y-1 text-green-700">
                                                                {parseInt(formData.financialAssets) > 0 && <div>• 현금성 자산: {formatResultAmount(parseInt(formData.financialAssets) * 10000)}</div>}
                                                                {parseInt(formData.severancePay) > 0 && <div>• 퇴직금: {formatResultAmount(parseInt(formData.severancePay) * 10000)}</div>}
                                                                {formData.homeValue && parseInt(formData.homeValue) > 0 && enableDownsizing && (
                                                                    <div>• 주택 (매각): {formatResultAmount(calculatorResult.assetBreakdown?.realizedHousingAsset || 0)}</div>
                                                                )}
                                                                {parseInt(formData.housingPension) > 0 && (
                                                                    <div>• 주택 (주택연금): {formatResultAmount(parseInt(formData.homeValue) * 10000)}</div>
                                                                )}
                                                                {formData.jeonseDeposit && parseInt(formData.jeonseDeposit) > 0 && <div>• 전세보증금: {formatResultAmount(parseInt(formData.jeonseDeposit) * 10000)}</div>}
                                                                {formData.monthlyDeposit && parseInt(formData.monthlyDeposit) > 0 && <div>• 월세보증금: {formatResultAmount(parseInt(formData.monthlyDeposit) * 10000)}</div>}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* 돈이 나오지 않는 자산 */}
                                                        <div className="bg-gray-50 p-2 rounded border border-gray-200">
                                                            <div className="font-semibold text-gray-800 mb-2">🏠 생활비로 쓸 수 없는 자산</div>
                                                            <div className="space-y-1 text-gray-600">
                                                                {formData.homeValue && parseInt(formData.homeValue) > 0 && !enableDownsizing && !parseInt(formData.housingPension) && (
                                                                    <div>• {formData.housingType === 'owned_living' ? '거주용' : '임대용'} 주택: {formatResultAmount(parseInt(formData.homeValue) * 10000)}</div>
                                                                )}
                                                                {formData.investmentRealEstate && parseInt(formData.investmentRealEstate) > 0 && (
                                                                    <div>• 수익형 부동산: {formatResultAmount(parseInt(formData.investmentRealEstate) * 10000)}</div>
                                                                )}
                                                                {formData.currentDeposit && parseInt(formData.currentDeposit) > 0 && <div>• 거주지 보증금: {formatResultAmount(parseInt(formData.currentDeposit) * 10000)}</div>}
                                                                {formData.inheritance && parseInt(formData.inheritance) > 0 && <div>• 증여/상속 예정: {formatResultAmount(parseInt(formData.inheritance) * 10000)}</div>}
                                                                {(!formData.homeValue || parseInt(formData.homeValue) === 0 || 
                                                                  (formData.housingType === 'owned_living' && (enableDownsizing || parseInt(formData.housingPension))) ||
                                                                  (formData.housingType === 'owned_renting' && enableDownsizing)) && 
                                                                 (!formData.inheritance || parseInt(formData.inheritance) === 0) &&
                                                                 (!formData.currentDeposit || parseInt(formData.currentDeposit) === 0) && (
                                                                    <div className="text-gray-400 italic">해당 없음</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* 부채 차감 */}
                                                    {((formData.debt && parseInt(formData.debt) > 0) || (formData.homeMortgage && parseInt(formData.homeMortgage) > 0) || (formData.investmentLoan && parseInt(formData.investmentLoan) > 0) || (formData.depositLoan && parseInt(formData.depositLoan) > 0) || (formData.ownedHouseDeposit && parseInt(formData.ownedHouseDeposit) > 0)) && (
                                                        <div className="mt-3 p-2 bg-red-50 rounded border border-red-200">
                                                            <div className="font-semibold text-red-800 mb-1 text-xs">💳 부채 차감</div>
                                                            <div className="space-y-1 text-xs text-red-700">
                                                                {formData.debt && parseInt(formData.debt) > 0 && <div>• 기타 대출: -{formatResultAmount(parseInt(formData.debt) * 10000)}</div>}
                                                                {formData.homeMortgage && parseInt(formData.homeMortgage) > 0 && <div>• 주택대출: -{formatResultAmount(parseInt(formData.homeMortgage) * 10000)}</div>}
                                                                {formData.investmentLoan && parseInt(formData.investmentLoan) > 0 && <div>• 투자대출: -{formatResultAmount(parseInt(formData.investmentLoan) * 10000)}</div>}
                                                                {formData.depositLoan && parseInt(formData.depositLoan) > 0 && <div>• 보증금 대출: -{formatResultAmount(parseInt(formData.depositLoan) * 10000)}</div>}
                                                                {formData.ownedHouseDeposit && parseInt(formData.ownedHouseDeposit) > 0 && <div>• 임차인 보증금: -{formatResultAmount(parseInt(formData.ownedHouseDeposit) * 10000)}</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* 주택 매각 옵션 */}
                                                {(formData.housingType === 'owned_living' || formData.housingType === 'owned_renting') && !parseInt(formData.housingPension) && (
                                                    <div className="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-300 mt-3">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <span className="text-sm font-medium text-orange-800">🏠 주택 매각 옵션</span>
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={enableDownsizing}
                                                                    onChange={(e) => setEnableDownsizing(e.target.checked)}
                                                                    className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500"
                                                                />
                                                                <span className="text-sm font-medium text-orange-800">매각했을 때 생활비 계산하기</span>
                                                            </label>
                                                        </div>
                                                        <div className="text-xs text-orange-600">
                                                            주택을 매각하면 더 많은 은퇴생활비를 확보할 수 있어요.
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 비상자금 제외:</span>
                                                        <span className="font-bold text-red-600">-{formatResultAmount(calculatorResult.assetBreakdown?.emergencyFund || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">예상치 못한 의료비 등을 위해 현금성 자산의 10%를 비상자금으로 보존합니다</p>
                                                </div>

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 생활비로 쓸 수 있는 자산:</span>
                                                        <span className="font-bold text-green-600">{formatResultAmount(calculatorResult.assetBreakdown?.availableAssets || 0)}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">비상자금까지 차감하고 기대수명까지 소비할 수 있는 자산입니다</p>
                                                </div>

                                                <div className="bg-white p-3 rounded-lg">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-medium">• 소비 예상 기간:</span>
                                                        <span className="font-bold text-blue-600">{calculatorResult.yearsToLive || 0}년</span>
                                                    </div>
                                                    <p className="text-xs text-gray-600">현재 나이부터 기대수명까지 자산을 소비하는 기간입니다</p>
                                                </div>

                                                <div className="bg-blue-100 p-3 rounded-lg border-t-2 border-blue-300">
                                                    <div className="text-center font-bold text-green-600 text-lg">
                                                        소비 가능한 자산은 연간 {formatResultAmount(calculatorResult.monthlyAmount * 12)}, 월간 {formatResultAmount(calculatorResult.monthlyAmount)} 입니다.
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="text-xs text-blue-700 mt-3 p-3 bg-blue-100 rounded border-l-4 border-blue-400">
                                                💡 <strong>계산 공식:</strong> 생활비로 쓸 수 있는 자산 ÷ 소비예상기간 ÷ 12개월 = 월 사용 가능 금액<br/>
                                                <div className="mt-2 p-2 bg-yellow-50 rounded border border-yellow-200">
                                                    <strong>⚠️ 중요:</strong> 이 계산은 <strong>{lifeExpectancy}세까지</strong> 자산을 소비한다고 가정하고 계산되었습니다.(투자수익률을 배제)
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {calculatorResult.monthlyPension > 0 && (
                                        <div className="flex justify-between text-green-700">
                                            <span>+ 연금 수입:</span>
                                            <span className="font-bold">+{formatResultAmount(calculatorResult.monthlyPension)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyOtherIncome > 0 && (
                                        <div className="flex justify-between text-green-700">
                                            <span>+ 기타 월 수입:</span>
                                            <span className="font-bold">+{formatResultAmount(calculatorResult.monthlyOtherIncome)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyHousingCost > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월세 지출:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyHousingCost)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyLoanInterest > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월 대출 이자:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyLoanInterest)}/월</span>
                                        </div>
                                    )}
                                    {calculatorResult.monthlyPropertyTax > 0 && (
                                        <div className="flex justify-between text-red-700">
                                            <span>- 월 재산세:</span>
                                            <span className="font-bold">-{formatResultAmount(calculatorResult.monthlyPropertyTax)}/월</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between font-bold pt-2 border-t border-blue-200 text-lg">
                                        <span>월간 총 은퇴생활비:</span>
                                        <span className="text-blue-600">{formatResultAmount(calculatorResult.totalMonthlyAvailable)}/월</span>
                                    </div>
                                </div>
                            </div>


                            <div className="text-center space-y-3">
                                <button
                                    onClick={() => goToNextStep(1)}
                                    className="text-gray-500 underline hover:text-gray-700"
                                >
                                    다시 계산하기
                                </button>
                            </div>

                            {/* 지출내역 입력 모달 */}
                            {showExpenseModal && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-8">
                                    <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto relative">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-center flex-1">📊 월 지출내역 입력</h3>
                                            <button
                                                onClick={closeExpenseModal}
                                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold ml-4"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        <div className="space-y-6">
                                            <ExpenseInput
                                                label="🍽️ 식비"
                                                field="food"
                                                value={expenseData.food}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="📱 통신비"
                                                field="communication"
                                                value={expenseData.communication}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="💡 공과금"
                                                field="utilities"
                                                value={expenseData.utilities}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🏥 의료비"
                                                field="medical"
                                                value={expenseData.medical}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🎯 취미·여가비"
                                                field="hobby"
                                                value={expenseData.hobby}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="🚗 차량유지비 (기름값 등)"
                                                field="vehicle"
                                                value={expenseData.vehicle}
                                                placeholder=""
                                            />
                                            <ExpenseInput
                                                label="📦 기타"
                                                field="etc"
                                                value={expenseData.etc}
                                                placeholder=""
                                            />
                                        </div>
                                        <div className="flex gap-3 mt-6">
                                            <button
                                                onClick={closeExpenseModal}
                                                className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400"
                                            >
                                                취소
                                            </button>
                                            <button
                                                onClick={submitExpenseData}
                                                className="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                            >
                                                저장
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* 지출내역 비교 결과 모달 */}
                            {showComparisonModal && expenseComparison && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto relative">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-center flex-1">📊 지출 패턴 비교 결과</h3>
                                            <button
                                                onClick={() => setShowComparisonModal(false)}
                                                className="text-gray-500 hover:text-gray-700 text-2xl font-bold ml-4"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        
                                        {/* 전체 비교 */}
                                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg mb-6">
                                            <div className="grid grid-cols-2 gap-4 text-center">
                                                <div>
                                                    <p className="text-sm text-gray-600 mb-1">내 지출 총액</p>
                                                    <p className="text-2xl font-bold text-blue-600">{expenseComparison.userTotal.toLocaleString()}만원</p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-gray-600 mb-1">통계청 평균 (2024년)</p>
                                                    <p className="text-2xl font-bold text-purple-600">{expenseComparison.statTotal.toLocaleString()}만원</p>
                                                </div>
                                            </div>
                                            
                                            <div className="text-center mt-4">
                                                {expenseComparison.userTotal > expenseComparison.statTotal ? (
                                                    <p className="text-red-600 font-semibold">
                                                        📈 평균보다 {(expenseComparison.userTotal - expenseComparison.statTotal).toLocaleString()}만원 더 지출
                                                    </p>
                                                ) : expenseComparison.userTotal < expenseComparison.statTotal ? (
                                                    <p className="text-green-600 font-semibold">
                                                        📉 평균보다 {(expenseComparison.statTotal - expenseComparison.userTotal).toLocaleString()}만원 절약
                                                    </p>
                                                ) : (
                                                    <p className="text-gray-600 font-semibold">
                                                        ✅ 평균과 동일한 수준
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* 항목별 비교 */}
                                        <div className="space-y-3">
                                            <h4 className="text-lg font-bold mb-3">항목별 상세 비교</h4>
                                            
                                            {Object.entries({
                                                food: '🍽️ 식비',
                                                communication: '📱 통신비', 
                                                utilities: '💡 공과금',
                                                medical: '🏥 의료비',
                                                hobby: '🎯 취미·여가비',
                                                vehicle: '🚗 차량유지비',
                                                etc: '📦 기타'
                                            }).map(([key, label]) => {
                                                const userAmount = parseInt(expenseComparison.user[key]) || 0;
                                                const statAmount = expenseComparison.stat[key];
                                                const difference = userAmount - statAmount;
                                                const percentage = statAmount > 0 ? Math.round((difference / statAmount) * 100) : 0;
                                                
                                                return (
                                                    <div key={key} className="border rounded-lg p-4">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="font-semibold">{label}</span>
                                                            <span className={`text-sm font-bold ${
                                                                difference > 0 ? 'text-red-600' : 
                                                                difference < 0 ? 'text-green-600' : 'text-gray-600'
                                                            }`}>
                                                                {difference > 0 ? `+${difference}만원` : 
                                                                 difference < 0 ? `${difference}만원` : '±0만원'}
                                                                {percentage !== 0 && ` (${percentage > 0 ? '+' : ''}${percentage}%)`}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between text-sm">
                                                            <span>내 지출: <strong>{userAmount.toLocaleString()}만원</strong></span>
                                                            <span>평균: <strong>{statAmount.toLocaleString()}만원</strong></span>
                                                        </div>
                                                        
                                                        {/* 비교 바 */}
                                                        <div className="mt-2 bg-gray-200 rounded-full h-2 relative">
                                                            <div 
                                                                className="bg-purple-400 h-2 rounded-full" 
                                                                style={{width: `${Math.min(100, (statAmount / Math.max(userAmount, statAmount)) * 100)}%`}}
                                                            ></div>
                                                            <div 
                                                                className="bg-blue-500 h-2 rounded-full absolute top-0" 
                                                                style={{width: `${Math.min(100, (userAmount / Math.max(userAmount, statAmount)) * 100)}%`}}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        <div className="text-xs text-gray-500 mt-4 p-3 bg-gray-50 rounded">
                                            📊 기준: 통계청 2024년 가계동향조사 (전국 평균)
                                        </div>
                                        
                                        <div className="flex gap-3 mt-6">
                                            <button
                                                onClick={() => setShowComparisonModal(false)}
                                                className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600"
                                            >
                                                확인
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                        </div>
                    </div>
                );
            }

            return <div>잘못된 단계입니다.</div>;
        };

        // 게스트 사용자 관리
        const createGuestUser = () => {
            const guestId = crypto.randomUUID();
            const guestNickname = authManager.nicknameGen.generate();
            const guestUser = {
                id: guestId,
                email: null,
                nickname: guestNickname,
                isGuest: true,
                createdAt: new Date().toISOString()
            };
            localStorage.setItem('planb_guest_user', JSON.stringify(guestUser));
            return guestUser;
        };

        // 메인 App 컴포넌트
        const PlanBApp = () => {
            const [currentView, setCurrentView] = useState('login'); // 로그인 화면으로 바로 시작
            const [selectedPost, setSelectedPost] = useState(null); // 선택된 게시글 상태
            const [savedCalculations, setSavedCalculations] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isGuest, setIsGuest] = useState(false);
            const [authMode, setAuthMode] = useState('login'); // 'login' 또는 'signup'
            const [showAuthForm, setShowAuthForm] = useState(false); // 웰컴 페이지에서 폼 표시 여부
            const [showGuestConfirmModal, setShowGuestConfirmModal] = useState(false);
            const [showCommunityAccessModal, setShowCommunityAccessModal] = useState(false);
            const [showCalculationRequiredModal, setShowCalculationRequiredModal] = useState(false);
            const [showNotificationModal, setShowNotificationModal] = useState(false);
            const [notificationContent, setNotificationContent] = useState({ title: '', message: '', type: 'info' });
            const [showMobileMenu, setShowMobileMenu] = useState(false);

            // 외부 클릭시 메뉴 닫기
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showMobileMenu && !event.target.closest('nav')) {
                        setShowMobileMenu(false);
                    }
                };
                
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [showMobileMenu]);
            
            // 통합 알림 모달 함수
            const showNotification = (title, message, type = 'info') => {
                setNotificationContent({ title, message, type });
                setShowNotificationModal(true);
            };
            
            // 컴포넌트 마운트시 인증 상태 확인
            useEffect(() => {
                initializeApp();
            }, []);

            const initializeApp = async () => {
                try {
                    // 게스트 데이터 초기화 (일회성 사용)
                    localStorage.removeItem('planb_guest_user');
                    localStorage.removeItem('planb_calculation_result');
                    
                    // 사용자가 명시적으로 로그아웃했는지 확인
                    const userLoggedOut = localStorage.getItem('planb_user_logged_out');
                    if (userLoggedOut === 'true') {
                        // 로그아웃 상태이므로 자동 로그인 건너뛰기
                        console.log('사용자가 로그아웃한 상태입니다');
                        return;
                    }
                    
                    // 현재 사용자 확인 (회원만)
                    const user = await authManager.getCurrentUser();
                    if (user) {
                        setCurrentUser(user);
                        setIsAuthenticated(true);
                        setCurrentView('main');
                        const isAdmin = isAdminUser(user);
                        console.log(`자동 로그인됨: ${user.email}${isAdmin ? ' (관리자 권한)' : ' (일반 사용자)'}`);
                        
                        // 기존 계산 결과 불러오기
                        loadSavedCalculations();
                    }
                    // 게스트는 항상 welcome 화면부터 시작
                } catch (error) {
                    console.error('앱 초기화 오류:', error);
                }
            };
            
            // 인증 성공 핸들러
            const handleAuthSuccess = (user) => {
                // 로그인 성공시 로그아웃 플래그 제거
                localStorage.removeItem('planb_user_logged_out');
                
                // 기존 게스트 데이터가 있다면 회원 계정으로 이관
                const guestCalculation = localStorage.getItem('planb_calculation_result');
                
                setCurrentUser(user);
                setIsAuthenticated(true);
                setIsGuest(false);
                setCurrentView('main');
                
                const isAdmin = isAdminUser(user);
                console.log(`로그인 완료: ${user.email}${isAdmin ? ' (관리자 권한)' : ' (일반 사용자)'}`);
                loadSavedCalculations();
                
                // 게스트 데이터 정리
                localStorage.removeItem('planb_guest_user');
                
                // 게스트 계산 결과가 있었다면 안내
                if (guestCalculation) {
                    setTimeout(() => {
                        showNotification(
                            '회원가입 완료!', 
                            '게스트로 작성한 계산 결과가\n회원 계정에 저장되었습니다.', 
                            'success'
                        );
                    }, 1000);
                }
            };
            
            // 게스트 모드 시작 핸들러
            const handleGuestStart = () => {
                setShowGuestConfirmModal(true);
            };
            
            // 게스트 모드 확인 후 시작
            const confirmGuestStart = () => {
                const guestUser = createGuestUser();
                setCurrentUser(guestUser);
                setIsGuest(true);
                setCurrentView('main');
                setShowGuestConfirmModal(false);
                console.log(`게스트 모드 시작: ${guestUser.nickname}`);
            };
            
            
            // 로그아웃 핸들러
            const handleLogout = async () => {
                if (isGuest) {
                    // 게스트 모드 종료
                    localStorage.removeItem('planb_guest_user');
                    localStorage.removeItem('planb_calculation_result');
                    setCurrentUser(null);
                    setIsGuest(false);
                    setCurrentView('login');
                    setSavedCalculations([]);
                } else {
                    // 회원 로그아웃
                    const result = await authManager.signOut();
                    if (result.success) {
                        // 로그아웃 상태를 localStorage에 저장
                        localStorage.setItem('planb_user_logged_out', 'true');
                        
                        setCurrentUser(null);
                        setIsAuthenticated(false);
                        setCurrentView('login');
                        setSavedCalculations([]);
                        localStorage.removeItem('planb_calculation_result');
                        console.log('로그아웃 완료 - 자동 로그인 비활성화');
                    }
                }
            };
            
            // 저장된 계산결과 불러오기
            const loadSavedCalculations = () => {
                const saved = localStorage.getItem('planb_calculation_result');
                if (saved) {
                    // 저장된 계산 결과가 있으면 계산기 화면으로 이동하여 결과 표시
                    setSavedCalculations([JSON.parse(saved)]);
                }
                // 저장된 결과가 없어도 정상적인 상황이므로 alert 제거
            };

            // 계산 완료시 결과 저장 및 커뮤니티 안내
            const handleCalculationComplete = async (calculationResult) => {
                try {
                    // 계산 결과를 localStorage와 Supabase에 저장
                    localStorage.setItem('planb_calculation_result', JSON.stringify(calculationResult));
                    
                    if (currentUser) {
                        // 회원인 경우 Supabase에도 저장
                        const { error } = await supabase
                            .from('user_calculations')
                            .upsert({
                                user_id: currentUser.id,
                                calculation_data: calculationResult,
                                updated_at: new Date().toISOString()
                            });
                        
                        if (error) {
                            console.error('계산 결과 저장 오류:', error);
                        }
                    }
                    
                    // 계산 완료 - 별도 안내 없이 조용히 완료
                    
                } catch (error) {
                    console.error('계산 완료 처리 실패:', error);
                }
            };

            // 커뮤니티 접근 체크 (모든 사용자가 목록 보기 가능, 상호작용만 제한)
            const handleCommunityAccess = () => {
                console.log('커뮤니티 접근 시도:', { isAuthenticated, isGuest, currentUser });
                
                // 게스트, 회원 모두 커뮤니티 목록 보기 허용
                // 인증되지 않은 사용자만 로그인 유도
                if (!isAuthenticated && !isGuest) {
                    console.log('로그인 폼 표시');
                    setAuthMode('login');
                    setCurrentView('login');
                    setShowAuthForm(true);
                    return;
                }
                
                console.log('커뮤니티 페이지로 이동');
                setCurrentView('community');
            };
            
            // 관리자 계정 목록 (개발자/테스트 계정)
            const isAdminUser = (user) => {
                if (!user || !user.email) return false;
                const adminEmails = [
                    'jwpaparoy@gmail.com',  // 개발자 계정
                    'knwwhr@gmail.com'      // 관리자 계정
                ];
                return adminEmails.includes(user.email.toLowerCase());
            };

            // 사용자 타입 확인 함수 (async)
            const getUserType = async (user) => {
                if (!user) return 'guest';
                if (isAdminUser(user)) return 'admin';
                
                // Supabase에서 expert_profiles 테이블 조회하여 전문가 여부 확인
                try {
                    const { data: expertProfile, error } = await supabase
                        .from('expert_profiles')
                        .select('id, verification_status')
                        .eq('email', user.email)
                        .single();
                    
                    if (expertProfile && expertProfile.verification_status === 'approved') {
                        return 'expert';
                    }
                } catch (error) {
                    // expert_profiles에 없으면 일반회원
                    console.log('Expert profile not found, user is regular member');
                }
                
                return 'member';
            };

            // 사용자 타입별 표시 이름
            const getUserTypeName = (userType) => {
                switch(userType) {
                    case 'admin': return '관리자';
                    case 'expert': return '전문가';
                    case 'member': return '일반회원';
                    default: return '게스트';
                }
            };

            // 커뮤니티 상호작용 체크 (상세보기/글쓰기)
            const checkCalculationForInteraction = (action) => {
                // 게스트인 경우 회원가입 유도
                if (isGuest) {
                    setShowCommunityAccessModal(true);
                    return false;
                }
                
                // 관리자 계정인 경우 모든 기능 접근 허용
                if (isAdminUser(currentUser)) {
                    console.log('관리자 계정으로 모든 기능 접근 허용:', currentUser.email);
                    return true;
                }
                
                // 일반 회원인 경우 계산 완료 체크
                const hasCalculation = localStorage.getItem('planb_calculation_result');
                if (!hasCalculation) {
                    setShowCalculationRequiredModal(true);
                    return false;
                }
                return true;
            };

            // 게시글 상세보기 핸들러 (프로그레시브 접근)
            const handlePostClick = (post) => {
                // 계산 완료 여부 체크
                if (!checkCalculationForInteraction('view_post')) {
                    return; // 모달이 표시됨
                }
                
                // 계산 완료된 사용자만 상세보기 가능
                setSelectedPost(post);
                setCurrentView('post-detail');
            };


            // 로그인 화면 (기본 화면)
            if (currentView === 'login') {
                return (
                    <AuthComponent 
                        onAuthSuccess={handleAuthSuccess} 
                        initialMode="login"
                        generateGuestUser={createGuestUser}
                    />
                );
            }


            // 마이페이지
            if (currentView === 'mypage') {
                return (
                    <MyPageComponent 
                        currentUser={currentUser}
                        onClose={() => setCurrentView('main')}
                        getUserType={getUserType}
                        getUserTypeName={getUserTypeName}
                    />
                );
            }
            

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* 상단 네비게이션 */}
                    <nav className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                {/* 로고 */}
                                <div 
                                    className="text-xl font-bold text-blue-600 cursor-pointer"
                                    onClick={() => setCurrentView('main')}
                                >
                                    플랜비
                                </div>

                                {/* 햄버거 버튼 */}
                                <button
                                    onClick={() => setShowMobileMenu(!showMobileMenu)}
                                    className="p-2 rounded-md text-gray-600 hover:text-blue-600 hover:bg-gray-100 transition-colors"
                                >
                                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        {showMobileMenu ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                        )}
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        {/* 드롭다운 메뉴 */}
                        {showMobileMenu && (
                            <div className="bg-white border-t border-gray-200 shadow-lg">
                                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 space-y-3">
                                    {/* 메인 메뉴들 */}
                                    <button
                                        className={`w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center ${
                                            currentView === 'calculator' 
                                                ? 'bg-blue-50 text-blue-600 font-semibold' 
                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                        }`}
                                        onClick={() => {
                                            setCurrentView('calculator');
                                            setShowMobileMenu(false);
                                        }}
                                    >
                                        <span className="mr-3">🧮</span>
                                        은퇴생활비 계산기
                                    </button>
                                    
                                    <button
                                        className={`w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center ${
                                            currentView === 'community' 
                                                ? 'bg-blue-50 text-blue-600 font-semibold' 
                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                        }`}
                                        onClick={() => {
                                            handleCommunityAccess();
                                            setShowMobileMenu(false);
                                        }}
                                    >
                                        <span className="mr-3">💬</span>
                                        커뮤니티
                                    </button>
                                    
                                    <button
                                        className={`w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center ${
                                            currentView === 'experts' 
                                                ? 'bg-blue-50 text-blue-600 font-semibold' 
                                                : 'text-gray-700 hover:bg-gray-50 hover:text-blue-600'
                                        }`}
                                        onClick={() => {
                                            setCurrentView('experts');
                                            setShowMobileMenu(false);
                                        }}
                                    >
                                        <span className="mr-3">🔍</span>
                                        전문가 찾기
                                    </button>
                                    
                                    {/* 구분선 */}
                                    <div className="border-t border-gray-200 pt-3 mt-3">
                                        {/* 사용자 정보 및 액션 */}
                                        {isGuest ? (
                                            <>
                                                <div className="px-4 py-2 text-amber-600 font-medium flex items-center">
                                                    <span className="mr-2">🌟</span>
                                                    {currentUser?.nickname} (게스트)
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setAuthMode('signup');
                                                        setCurrentView('login');
                                                        setShowAuthForm(true);
                                                        setShowMobileMenu(false);
                                                    }}
                                                    className="w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center"
                                                >
                                                    <span className="mr-3">✨</span>
                                                    회원가입하기
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        handleLogout();
                                                        setShowMobileMenu(false);
                                                    }}
                                                    className="w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-red-600 transition-colors flex items-center"
                                                >
                                                    <span className="mr-3">🚪</span>
                                                    나가기
                                                </button>
                                            </>
                                        ) : currentUser ? (
                                            <>
                                                <div className="px-4 py-2 text-gray-700 font-medium flex items-center">
                                                    <span className="mr-2">👤</span>
                                                    {currentUser?.nickname || currentUser?.email}
                                                    {isAdminUser(currentUser) && (
                                                        <span className="ml-2 text-red-500">👑</span>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setCurrentView('mypage');
                                                        setShowMobileMenu(false);
                                                    }}
                                                    className="w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-colors flex items-center"
                                                >
                                                    <span className="mr-3">⚙️</span>
                                                    마이페이지
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        handleLogout();
                                                        setShowMobileMenu(false);
                                                    }}
                                                    className="w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-red-600 transition-colors flex items-center"
                                                >
                                                    <span className="mr-3">🚪</span>
                                                    로그아웃
                                                </button>
                                            </>
                                        ) : (
                                            <button
                                                onClick={() => {
                                                    setAuthMode('login');
                                                    setCurrentView('login');
                                                    setShowAuthForm(true);
                                                    setShowMobileMenu(false);
                                                }}
                                                className="w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center"
                                            >
                                                <span className="mr-3">🔑</span>
                                                로그인
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </nav>
                    
                    {/* 메인 컨텐츠 영역 */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {currentView === 'main' && (
                            <div className="text-center">
                                <div className="mb-12">
                                    <h1 className="text-4xl font-bold text-gray-800 mb-4">
                                        플랜비
                                    </h1>
                                    <p className="text-xl text-gray-600 mb-8">
                                        행복한 은퇴생활의 시작
                                    </p>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                                    <div className="card hover:shadow-xl transition-shadow cursor-pointer hover-lift" 
                                         onClick={() => setCurrentView('calculator')}>
                                        <div className="text-4xl mb-4">🧮</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                                            은퇴생활비 계산기
                                        </h3>
                                        <p className="text-gray-600 mb-4">
                                            내가 가진 자산으로 평생 얼마나 쓸 수 있는지 계산해보세요
                                        </p>
                                        <div className="text-blue-600 font-semibold">
                                            클릭하면 무료 계산기로 이동합니다
                                        </div>
                                    </div>
                                    
                                    <div className="card hover:shadow-xl transition-shadow cursor-pointer hover-lift"
                                         onClick={handleCommunityAccess}>
                                        <div className="text-4xl mb-4">👥</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                                            커뮤니티
                                        </h3>
                                        <p className="text-gray-600 mb-4">
                                            같은 관심사를 가진 사람들의 경험과 정보를 얻어보세요
                                        </p>
                                        <div className="text-purple-600 font-semibold">
                                            클릭하면 커뮤니티로 이동합니다
                                        </div>
                                    </div>
                                    
                                    <div className="card hover:shadow-xl transition-shadow cursor-pointer hover-lift"
                                         onClick={() => setCurrentView('experts')}>
                                        <div className="text-4xl mb-4">🎯</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                                            전문가 찾기
                                        </h3>
                                        <p className="text-gray-600 mb-4">
                                            건강, 세무, 생활설계 전문가와 상담받아보세요
                                        </p>
                                        <div className="text-orange-600 font-semibold">
                                            클릭하면 전문가 매칭으로 이동합니다
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        )}
                        
                        {currentView === 'calculator' && <OriginalCalculator savedCalculations={savedCalculations} onCalculationComplete={handleCalculationComplete} setCurrentView={setCurrentView} />}
                        
                        
                        {currentView === 'community' && <CommunityApp setCurrentView={setCurrentView} currentUser={currentUser} checkCalculationForInteraction={checkCalculationForInteraction} handlePostClick={handlePostClick} isAdminUser={isAdminUser} />}
                        {currentView === 'post-detail' && selectedPost && <PostDetailPage post={selectedPost} setCurrentView={setCurrentView} currentUser={currentUser} checkCalculationForInteraction={checkCalculationForInteraction} isAdminUser={isAdminUser} />}
                        
                        {/* 전문가 찾기 페이지 - 모든 사용자 접근 가능 */}
                        {currentView === 'experts' && (
                            <div className="max-w-6xl mx-auto">
                                <div className="card">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                                        🔍 전문가 찾기
                                    </h2>
                                    <ExpertFinderComponent currentUser={currentUser} />
                                </div>
                            </div>
                        )}
                    </main>
                    
                    {/* 커뮤니티 접근 제한 모달 */}
                    {showCommunityAccessModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowCommunityAccessModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">🔒</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        커뮤니티 참여는 회원만 가능해요 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        게시글은 보셨는데 어떠세요?<br/>
                                        <strong>더 자세한 내용이 궁금하시죠?</strong><br/><br/>
                                        회원가입하시면 다른 분들과<br/>
                                        소통하고 정보를 나눌 수 있어요!
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowCommunityAccessModal(false);
                                                setAuthMode('signup');
                                                setCurrentView('login');
                                                setShowAuthForm(true);
                                            }}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                        >
                                            📝 회원가입하고<br/>
                                            상세내용 보기
                                        </button>
                                        <button
                                            onClick={() => setShowCommunityAccessModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            나중에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 계산 필요 안내 모달 */}
                    {showCalculationRequiredModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowCalculationRequiredModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">🧮</div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        궁금하시죠? 먼저 계산해보세요! 😊
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                                        다른 분들의 이야기를 보고 궁금하시죠?<br/>
                                        <strong>나는 얼마나 필요할까요?</strong><br/><br/>
                                        3분만 계산해보시면 더 재미있게<br/>
                                        커뮤니티를 이용하실 수 있어요!
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => {
                                                setShowCalculationRequiredModal(false);
                                                setCurrentView('calculator');
                                            }}
                                            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                        >
                                            🧮 바로 계산하러 가기
                                        </button>
                                        <button
                                            onClick={() => setShowCalculationRequiredModal(false)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm"
                                        >
                                            나중에 하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 통합 알림 모달 */}
                    {showNotificationModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl relative">
                                <button
                                    onClick={() => setShowNotificationModal(false)}
                                    className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                                <div className="text-center">
                                    <div className="text-4xl mb-4">
                                        {notificationContent.type === 'success' ? '✅' : 
                                         notificationContent.type === 'error' ? '❌' : 
                                         notificationContent.type === 'warning' ? '⚠️' : 'ℹ️'}
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-3">
                                        {notificationContent.title}
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-6 leading-relaxed whitespace-pre-line">
                                        {notificationContent.message}
                                    </p>
                                    <button
                                        onClick={() => setShowNotificationModal(false)}
                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm"
                                    >
                                        확인
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 푸터 */}
                    <footer className="bg-gray-800 text-white mt-16">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <div className="text-center">
                                <h3 className="text-xl font-bold mb-4">플랜비</h3>
                                <p className="text-gray-300 mb-4">
                                    든든한 은퇴를 위한 커뮤니티 플랫폼
                                </p>
                                <div className="text-gray-400 text-sm">
                                    © 2025 플랜비. All rights reserved.
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // AuthManager는 이미 위에서 초기화되었음
        
        // React 앱 렌더링
        console.log('React 및 ReactDOM 로드됨:', { React, ReactDOM });
        console.log('Root element 찾기:', document.getElementById('root'));
        
        // React 앱 바로 렌더링
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<PlanBApp />);
            console.log('React 앱 렌더링 성공');
        } catch (error) {
            console.error('React 앱 렌더링 에러:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h1>플랜비</h1>
                    <p style="color: red;">오류가 발생했습니다.</p>
                    <p style="color: red; font-size: 12px;">${error.message}</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">새로고침</button>
                </div>
            `;
        }
    </script>
</body>
</html>